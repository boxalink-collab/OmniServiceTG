<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OmniService TG ‚Äî RH Manager</title>
<link rel="icon" href="../assets/logo.png" type="image/png"/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--blue:#1E6FBE;--blue-d:#155A9C;--blue-s:rgba(30,111,190,.1);--ora:#F5820A;--dark:#1A1A2E;--mid:#4A4A6A;--light:#9999BB;--border:#E8EAF0;--bg:#F4F6FA;--green:#2E7D32;--red:#C62828;--teal:#00695C}
html,body{height:100%;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--dark)}

#splash{position:fixed;inset:0;z-index:9999;background:#0a1220;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px}
.sp-logo{font-size:52px;animation:popIn .6s cubic-bezier(.34,1.56,.64,1) .3s both}
.sp-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:#fff;animation:fadeUp .5s ease .7s both}
.sp-sub{font-size:11px;color:rgba(255,255,255,.4);letter-spacing:1px;text-transform:uppercase;animation:fadeUp .5s ease .9s both}
.sp-bar{width:160px;height:2px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden;animation:fadeUp .4s ease 1s both}
.sp-bar-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--blue));animation:load 1.4s ease 1.1s both}
@keyframes load{0%{width:0}100%{width:100%}}
#splash.out{animation:splashOut .4s ease forwards}
@keyframes splashOut{to{opacity:0;pointer-events:none}}
@keyframes popIn{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes fadeUp{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}

/* LOGIN */
#login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0e1420,#1a2540);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;display:none}
.login-box{background:#fff;border-radius:24px;padding:36px 28px;width:100%;max-width:360px;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.4)}
.login-logo{font-size:44px;margin-bottom:10px}
.login-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:var(--dark);margin-bottom:4px}
.login-sub{font-size:12px;color:var(--light);margin-bottom:20px}
.login-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(0,105,92,.08);color:var(--teal);border:1px solid rgba(0,105,92,.2);border-radius:999px;padding:4px 14px;font-size:11px;font-weight:700;margin-bottom:18px}
.inp{width:100%;padding:13px 16px;border:1.5px solid var(--border);border-radius:12px;font-size:14px;font-family:'Poppins',sans-serif;outline:none;transition:.2s;background:#fafbfd;margin-bottom:12px}
.inp:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(0,105,92,.1)}
.btn-login{width:100%;padding:14px;background:linear-gradient(135deg,var(--teal),#004D40);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer}
.login-err{color:var(--red);font-size:12px;margin-top:8px;min-height:18px}

/* LAYOUT */
#app{display:none;min-height:100vh}
.top-header{background:linear-gradient(135deg,#1A1A2E,#0D2929);padding:16px 24px;display:flex;align-items:center;justify-content:space-between}
.th-left{display:flex;align-items:center;gap:12px}
.th-icon{font-size:28px}
.th-name{font-family:'Nunito',sans-serif;font-size:18px;font-weight:900;color:#fff}
.th-role{font-size:11px;color:rgba(255,255,255,.4);margin-top:1px}
.btn-logout-top{background:rgba(255,255,255,.1);border:none;color:rgba(255,255,255,.7);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:12px;font-family:'Poppins',sans-serif}

/* TABS */
.tabs{background:#fff;border-bottom:1px solid var(--border);display:flex;padding:0 16px;overflow-x:auto;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab-btn{padding:14px 16px;border:none;background:none;font-size:12px;font-weight:600;font-family:'Poppins',sans-serif;color:var(--light);cursor:pointer;position:relative;transition:.2s;white-space:nowrap}
.tab-btn.on{color:var(--teal)}
.tab-btn.on::after{content:'';position:absolute;bottom:0;left:10%;right:10%;height:2px;background:var(--teal);border-radius:2px}
.tab-count{background:var(--teal);color:#fff;border-radius:999px;padding:1px 6px;font-size:10px;margin-left:4px}

/* MAIN */
.main-content{padding:20px;max-width:1100px;margin:0 auto}

/* KPI */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}
.kpi-card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);border-top:3px solid var(--teal)}
.kpi-num{font-family:'Nunito',sans-serif;font-size:26px;font-weight:900;color:var(--dark)}
.kpi-lbl{font-size:11px;color:var(--light);margin-top:2px}
.online-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--green);margin-right:4px;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* SECTION CARD */
.section-card{background:#fff;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.06);margin-bottom:20px;overflow:hidden}
.section-head{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.section-title{font-size:15px;font-weight:700}
.section-head-right{display:flex;align-items:center;gap:8px}
.btn-add{background:linear-gradient(135deg,var(--teal),#004D40);color:#fff;border:none;padding:9px 16px;border-radius:10px;font-size:12px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer}
.search-inp{padding:8px 14px;border:1.5px solid var(--border);border-radius:10px;font-size:12px;font-family:'Poppins',sans-serif;outline:none;width:200px}
.search-inp:focus{border-color:var(--teal)}
.role-filter{padding:8px 12px;border:1.5px solid var(--border);border-radius:10px;font-size:12px;font-family:'Poppins',sans-serif;outline:none;cursor:pointer}

/* AGENT TABLE */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
th{padding:10px 14px;text-align:left;font-weight:700;color:var(--light);font-size:11px;border-bottom:1px solid var(--border);background:#FAFBFD;white-space:nowrap}
td{padding:12px 14px;border-bottom:1px solid var(--border);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:#F0FAFA}
.agent-name{font-weight:700;color:var(--dark)}
.agent-email{font-size:11px;color:var(--light)}
.pill{border-radius:999px;padding:3px 10px;font-size:10px;font-weight:700;white-space:nowrap}
.r-livreur{background:#E3F2FD;color:#1565C0}
.r-comptable{background:#E8F5E9;color:var(--green)}
.r-stats{background:rgba(123,31,162,.08);color:#7B1FA2}
.r-comm{background:rgba(194,24,91,.08);color:#C2185B}
.r-rh{background:rgba(0,105,92,.08);color:var(--teal)}
.r-agent{background:#FFF3E0;color:#E65100}
.r-admin{background:#1A1A2E;color:#fff}
.s-actif{background:#E8F5E9;color:var(--green)}
.s-inactif{background:#FFEBEE;color:var(--red)}
.s-dispo{background:#E8F5E9;color:var(--green)}
.s-pause{background:#FFF3E0;color:#E65100}
.btn-row{display:flex;gap:6px}
.btn-edit-sm{padding:5px 10px;border-radius:6px;border:1.5px solid var(--border);background:#fff;font-size:10px;cursor:pointer;font-family:'Poppins',sans-serif;color:var(--mid)}
.btn-del-sm{padding:5px 8px;border-radius:6px;border:1.5px solid rgba(198,40,40,.3);background:#fff;font-size:10px;cursor:pointer;color:var(--red)}
.btn-reset-sm{padding:5px 10px;border-radius:6px;border:1.5px solid rgba(30,111,190,.3);background:#fff;font-size:10px;cursor:pointer;color:var(--blue);font-family:'Poppins',sans-serif}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:.25s;padding:20px}
.modal-overlay.show{opacity:1;pointer-events:all}
.modal-box{background:#fff;border-radius:20px;padding:28px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;transform:translateY(20px) scale(.97);transition:.3s}
.modal-overlay.show .modal-box{transform:none}
.modal-title{font-size:17px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between}
.modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--light)}
.form-group{margin-bottom:14px}
.form-label{font-size:12px;font-weight:600;color:var(--mid);margin-bottom:6px;display:block}
.form-inp{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:10px;font-size:13px;font-family:'Poppins',sans-serif;outline:none;transition:.2s}
.form-inp:focus{border-color:var(--teal)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn-save{width:100%;padding:13px;background:linear-gradient(135deg,var(--teal),#004D40);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer;margin-top:6px}
.pw-info{background:var(--blue-s);border-radius:10px;padding:12px;font-size:12px;color:var(--blue);margin-bottom:12px}

/* PERF TABLE */
.perf-bar-wrap{width:100%;background:var(--bg);border-radius:999px;height:6px;overflow:hidden}
.perf-bar{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--teal),var(--blue))}

/* TOAST */
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:#1A1A2E;color:#fff;padding:12px 22px;border-radius:12px;font-size:13px;font-weight:600;z-index:9998;transition:.35s;opacity:0;max-width:90%;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div id="splash">
  <div class="sp-logo">üë•</div>
  <div class="sp-title">OmniService TG</div>
  <div class="sp-sub">Interface RH / Manager</div>
  <div class="sp-bar"><div class="sp-bar-fill"></div></div>
</div>

<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">üë•</div>
    <div class="login-title">Espace RH / Manager</div>
    <div class="login-sub">OmniService TG</div>
    <div class="login-badge">üîê Acc√®s RH</div>
    <input class="inp" type="email" id="login-email" placeholder="Email RH"/>
    <input class="inp" type="password" id="login-password" placeholder="Mot de passe"/>
    <button class="btn-login" onclick="doLogin()" id="btn-login">Se connecter</button>
    <div class="login-err" id="login-err"></div>
  </div>
</div>

<div id="app">
  <div class="top-header">
    <div class="th-left">
      <div class="th-icon">üë•</div>
      <div>
        <div class="th-name" id="top-name">RH Manager</div>
        <div class="th-role">Gestion des agents ¬∑ OmniService TG</div>
      </div>
    </div>
    <button class="btn-logout-top" onclick="doLogout()">‚Ü© D√©connexion</button>
  </div>

  <div class="tabs">
    <button class="tab-btn on" id="tab-agents" onclick="showTab('agents')">üë§ Agents <span class="tab-count" id="count-agents">0</span></button>
    <button class="tab-btn" id="tab-performances" onclick="showTab('performances')">üìä Performances</button>
    <button class="tab-btn" id="tab-actifs" onclick="showTab('actifs')">üü¢ En ligne <span class="tab-count" id="count-actifs" style="background:var(--green)">0</span></button>
  </div>

  <div class="main-content">
    <!-- KPI -->
    <div class="kpi-row">
      <div class="kpi-card"><div class="kpi-num" id="k-total">‚Äî</div><div class="kpi-lbl">Agents total</div></div>
      <div class="kpi-card" style="border-color:var(--green)"><div class="kpi-num" id="k-actifs"><span class="online-dot"></span><span id="k-actifs-n">‚Äî</span></div><div class="kpi-lbl">En ligne maintenant</div></div>
      <div class="kpi-card" style="border-color:var(--blue)"><div class="kpi-num" id="k-livreurs">‚Äî</div><div class="kpi-lbl">Livreurs</div></div>
      <div class="kpi-card" style="border-color:var(--ora)"><div class="kpi-num" id="k-inactifs">‚Äî</div><div class="kpi-lbl">Inactifs</div></div>
    </div>

    <!-- AGENTS -->
    <div id="view-agents">
      <div class="section-card">
        <div class="section-head">
          <div class="section-title">üë§ Gestion des agents</div>
          <div class="section-head-right">
            <input class="search-inp" type="text" placeholder="üîç Rechercher..." id="search-agents" oninput="filterAgents()"/>
            <select class="role-filter" id="filter-role" onchange="filterAgents()">
              <option value="">Tous les r√¥les</option>
              <option value="livreur">Livreur</option>
              <option value="comptable">Comptable</option>
              <option value="stats">Statisticien</option>
              <option value="comm">Communication</option>
              <option value="rh">RH</option>
              <option value="agent">Agent terrain</option>
            </select>
            <button class="btn-add" onclick="openModal()">+ Nouvel agent</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Agent</th><th>R√¥le</th><th>Zone</th><th>T√©l√©phone</th><th>Statut</th><th>Derni√®re connexion</th><th>Actions</th></tr></thead>
            <tbody id="agents-tbody"><tr><td colspan="7" style="text-align:center;padding:30px;color:var(--light)">Chargement...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PERFORMANCES -->
    <div id="view-performances" style="display:none">
      <div class="section-card">
        <div class="section-head"><div class="section-title">üìä Performance des livreurs</div></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Livreur</th><th>Zone</th><th>Livraisons totales</th><th>Ce mois</th><th>Performance</th><th>Statut actuel</th></tr></thead>
            <tbody id="perf-tbody"><tr><td colspan="6" style="text-align:center;padding:30px;color:var(--light)">Chargement...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- EN LIGNE -->
    <div id="view-actifs" style="display:none">
      <div class="section-card">
        <div class="section-head">
          <div class="section-title">üü¢ Agents connect√©s maintenant</div>
          <button class="btn-add" style="background:var(--blue)" onclick="loadActifs()">üîÑ Actualiser</button>
        </div>
        <div id="actifs-grid" style="padding:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
          <div style="color:var(--light);font-size:12px">Chargement...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL AGENT -->
<div class="modal-overlay" id="modal-agent">
  <div class="modal-box">
    <div class="modal-title">
      <span id="modal-title-txt">‚ûï Nouvel agent</span>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <input type="hidden" id="edit-uid"/>
    <div class="pw-info" id="pw-info">üîë Un email d'invitation et un mot de passe temporaire seront g√©n√©r√©s automatiquement. L'agent peut ensuite changer son mot de passe.</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Pr√©nom *</label>
        <input class="form-inp" id="f-prenom" placeholder="Pr√©nom"/>
      </div>
      <div class="form-group">
        <label class="form-label">Nom *</label>
        <input class="form-inp" id="f-nom" placeholder="Nom de famille"/>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Email professionnel *</label>
      <input class="form-inp" type="email" id="f-email" placeholder="prenom@omniservicetg.com"/>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">R√¥le *</label>
        <select class="form-inp" id="f-role">
          <option value="livreur">üõµ Livreur</option>
          <option value="comptable">üí∞ Comptable</option>
          <option value="stats">üìä Statisticien</option>
          <option value="comm">üì£ Communication</option>
          <option value="rh">üë• RH/Manager</option>
          <option value="agent">üîß Agent terrain</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Zone (livreurs)</label>
        <input class="form-inp" id="f-zone" placeholder="Adidogom√©, B√®..."/>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">T√©l√©phone</label>
      <input class="form-inp" id="f-telephone" placeholder="+228 XX XX XX XX"/>
    </div>
    <div id="pw-section">
      <div class="form-group">
        <label class="form-label">Mot de passe temporaire *</label>
        <input class="form-inp" type="text" id="f-password" placeholder="Min. 8 caract√®res" value="OmniService2024!"/>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Statut</label>
      <select class="form-inp" id="f-actif">
        <option value="true">‚úÖ Actif</option>
        <option value="false">‚ùå Inactif</option>
      </select>
    </div>
    <button class="btn-save" id="modal-save-btn" onclick="saveAgent()">üíæ Cr√©er l'agent</button>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, query, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, orderBy, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtDK7-iDRy1E-kjZubjyjkPW7Th33BMyU",
  authDomain: "omniservicetg-59df3.firebaseapp.com",
  projectId: "omniservicetg-59df3",
  storageBucket: "omniservicetg-59df3.firebasestorage.app",
  messagingSenderId: "196278567761",
  appId: "1:196278567761:web:4f6416acaab58b67bf4970"
};
const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);
const auth = getAuth(fbApp);

let agents = [];
let agentsFiltered = [];
let allOrders = [];
let currentUser = null;

// SPLASH
setTimeout(() => {
  document.getElementById('splash').classList.add('out');
  setTimeout(() => document.getElementById('splash').style.display = 'none', 400);
}, 2500);

// AUTH
onAuthStateChanged(auth, async user => {
  if (user) {
    const snap = await getDoc(doc(db,'agents',user.uid));
    if (!snap.exists() || !['rh','admin'].includes(snap.data().role)) {
      await signOut(auth); showLogin('‚ùå Acc√®s r√©serv√© au RH/Admin'); return;
    }
    currentUser = {uid:user.uid,...snap.data()};
    document.getElementById('top-name').textContent = snap.data().nom || user.email;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    loadAll();
  } else { showLogin(); }
});

function showLogin(err='') {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  if (err) document.getElementById('login-err').textContent = err;
}
window.doLogin = async function() {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-password').value;
  const btn = document.getElementById('btn-login');
  if (!email||!pass) { document.getElementById('login-err').textContent='‚ö†Ô∏è Champs requis'; return; }
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span>';
  try { await signInWithEmailAndPassword(auth,email,pass); }
  catch(e) { document.getElementById('login-err').textContent='‚ùå Identifiants incorrects'; }
  finally { btn.disabled=false; btn.textContent='Se connecter'; }
};
window.doLogout = async () => await signOut(auth);

async function loadAll() {
  try {
    const [agSnap, ordSnap] = await Promise.all([
      getDocs(collection(db,'agents')),
      getDocs(query(collection(db,'commandes'), where('statut','==','Termin√©e')))
    ]);
    agents = agSnap.docs.map(d => ({uid:d.id,...d.data()}));
    agentsFiltered = [...agents];
    allOrders = ordSnap.docs.map(d => ({id:d.id,...d.data()}));
    renderKPIs();
    renderAgents();
    renderPerf();
  } catch(e) { showToast('‚ùå Erreur chargement'); }
}

function renderKPIs() {
  const actifs = agents.filter(a=>a.statut==='disponible').length;
  const livreurs = agents.filter(a=>a.role==='livreur').length;
  const inactifs = agents.filter(a=>a.actif===false).length;
  document.getElementById('k-total').textContent = agents.length;
  document.getElementById('k-actifs-n').textContent = actifs;
  document.getElementById('k-livreurs').textContent = livreurs;
  document.getElementById('k-inactifs').textContent = inactifs;
  document.getElementById('count-agents').textContent = agents.length;
  document.getElementById('count-actifs').textContent = actifs;
}

// TABS
window.showTab = function(tab) {
  ['agents','performances','actifs'].forEach(t => {
    document.getElementById('view-'+t).style.display = t===tab?'block':'none';
    document.getElementById('tab-'+t).classList.toggle('on', t===tab);
  });
  if (tab === 'actifs') loadActifs();
};

window.filterAgents = function() {
  const q = document.getElementById('search-agents').value.toLowerCase();
  const role = document.getElementById('filter-role').value;
  agentsFiltered = agents.filter(a => {
    const matchQ = !q || (a.nom||'').toLowerCase().includes(q) || (a.email||'').toLowerCase().includes(q);
    const matchR = !role || a.role === role;
    return matchQ && matchR;
  });
  renderAgents();
};

const ROLE_LABELS = {livreur:'üõµ Livreur',comptable:'üí∞ Comptable',stats:'üìä Statisticien',comm:'üì£ Communication',rh:'üë• RH',agent:'üîß Agent terrain',admin:'üîë Admin'};
const ROLE_CLASSES = {livreur:'r-livreur',comptable:'r-comptable',stats:'r-stats',comm:'r-comm',rh:'r-rh',agent:'r-agent',admin:'r-admin'};

function renderAgents() {
  const tbody = document.getElementById('agents-tbody');
  if (!agentsFiltered.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--light)">Aucun agent trouv√©</td></tr>';
    return;
  }
  tbody.innerHTML = agentsFiltered.map(a => {
    const roleLabel = ROLE_LABELS[a.role] || a.role;
    const roleClass = ROLE_CLASSES[a.role] || '';
    const isActif = a.actif !== false;
    const isOnline = a.statut === 'disponible';
    const lastConn = a.derniere_connexion ? new Date(a.derniere_connexion.seconds*1000).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
    return `<tr>
      <td><div class="agent-name">${a.nom||'‚Äî'}</div><div class="agent-email">${a.email||'‚Äî'}</div></td>
      <td><span class="pill ${roleClass}">${roleLabel}</span></td>
      <td>${a.zone||'‚Äî'}</td>
      <td>${a.telephone||'‚Äî'}</td>
      <td><span class="pill ${isActif?'s-actif':'s-inactif'}">${isActif?'‚úÖ Actif':'‚ùå Inactif'}</span>${isOnline?` <span class="pill s-dispo" style="margin-left:4px">üü¢ Dispo</span>`:''}</td>
      <td>${lastConn}</td>
      <td><div class="btn-row">
        <button class="btn-edit-sm" onclick="editAgent('${a.uid}')">‚úèÔ∏è</button>
        <button class="btn-reset-sm" onclick="resetPw('${a.uid}','${a.email||''}')">üîë</button>
        <button class="btn-del-sm" onclick="deleteAgent('${a.uid}','${a.nom||a.email||''}')">üóë</button>
      </div></td>
    </tr>`;
  }).join('');
}

function renderPerf() {
  const livreurs = agents.filter(a=>a.role==='livreur');
  const now = new Date(); const monthStart = new Date(now.getFullYear(),now.getMonth(),1);
  const tbody = document.getElementById('perf-tbody');
  if (!livreurs.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--light)">Aucun livreur</td></tr>';
    return;
  }
  const sorted = livreurs.map(l => {
    const orders = allOrders.filter(o=>o.livreurId===l.uid);
    const monthOrders = orders.filter(o => o.livraisonAt && new Date(o.livraisonAt.seconds*1000)>=monthStart);
    return {...l, total:orders.length, mois:monthOrders.length};
  }).sort((a,b)=>b.total-a.total);
  const maxTotal = sorted[0]?.total||1;
  tbody.innerHTML = sorted.map(l => {
    const pct = Math.round(l.total/maxTotal*100);
    const isOnline = l.statut==='disponible';
    return `<tr>
      <td><div class="agent-name">${l.nom||'‚Äî'}</div><div class="agent-email">${l.email||'‚Äî'}</div></td>
      <td>${l.zone||'‚Äî'}</td>
      <td style="font-weight:700;font-size:14px;color:var(--blue)">${l.total}</td>
      <td>${l.mois}</td>
      <td><div class="perf-bar-wrap"><div class="perf-bar" style="width:${pct}%"></div></div><div style="font-size:10px;color:var(--light);margin-top:2px">${pct}%</div></td>
      <td><span class="pill ${isOnline?'s-dispo':'s-pause'}">${isOnline?'üü¢ Dispo':'‚è∏ Pause'}</span></td>
    </tr>`;
  }).join('');
}

window.loadActifs = function() {
  const actifs = agents.filter(a=>a.statut==='disponible'&&a.actif!==false);
  const grid = document.getElementById('actifs-grid');
  if (!actifs.length) {
    grid.innerHTML = '<div style="color:var(--light);font-size:13px;text-align:center;padding:30px">Aucun agent en ligne actuellement</div>';
    return;
  }
  grid.innerHTML = actifs.map(a => {
    const roleLabel = ROLE_LABELS[a.role]||a.role;
    return `<div style="background:#fff;border-radius:14px;padding:16px;border:1.5px solid rgba(0,105,92,.2);box-shadow:0 2px 10px rgba(0,0,0,.06)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <div style="width:10px;height:10px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite"></div>
        <span style="font-weight:700;font-size:13px">${a.nom||'‚Äî'}</span>
      </div>
      <div style="font-size:11px;color:var(--light);">${roleLabel}</div>
      ${a.zone ? `<div style="font-size:11px;color:var(--mid);margin-top:3px">üìç ${a.zone}</div>` : ''}
    </div>`;
  }).join('');
};

// MODAL
window.openModal = function() {
  document.getElementById('edit-uid').value = '';
  document.getElementById('modal-title-txt').textContent = '‚ûï Nouvel agent';
  document.getElementById('modal-save-btn').textContent = 'üíæ Cr√©er l\'agent';
  document.getElementById('pw-section').style.display = 'block';
  document.getElementById('pw-info').style.display = 'block';
  ['f-prenom','f-nom','f-email','f-zone','f-telephone'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-role').value = 'livreur';
  document.getElementById('f-actif').value = 'true';
  document.getElementById('f-password').value = 'OmniService2024!';
  document.getElementById('modal-agent').classList.add('show');
};

window.editAgent = function(uid) {
  const a = agents.find(x=>x.uid===uid);
  if (!a) return;
  document.getElementById('edit-uid').value = uid;
  document.getElementById('modal-title-txt').textContent = '‚úèÔ∏è Modifier ‚Äî '+(a.nom||a.email);
  document.getElementById('modal-save-btn').textContent = 'üíæ Enregistrer';
  document.getElementById('pw-section').style.display = 'none';
  document.getElementById('pw-info').style.display = 'none';
  document.getElementById('f-prenom').value = (a.nom||'').split(' ')[0]||'';
  document.getElementById('f-nom').value = (a.nom||'').split(' ').slice(1).join(' ')||'';
  document.getElementById('f-email').value = a.email||'';
  document.getElementById('f-role').value = a.role||'livreur';
  document.getElementById('f-zone').value = a.zone||'';
  document.getElementById('f-telephone').value = a.telephone||'';
  document.getElementById('f-actif').value = a.actif===false ? 'false' : 'true';
  document.getElementById('modal-agent').classList.add('show');
};

window.closeModal = () => document.getElementById('modal-agent').classList.remove('show');

window.saveAgent = async function() {
  const prenom = document.getElementById('f-prenom').value.trim();
  const nom = document.getElementById('f-nom').value.trim();
  const email = document.getElementById('f-email').value.trim();
  const role = document.getElementById('f-role').value;
  if (!email || !role) { showToast('‚ö†Ô∏è Email et r√¥le requis'); return; }
  
  const btn = document.getElementById('modal-save-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Enregistrement...';
  
  const editUid = document.getElementById('edit-uid').value;
  const data = {
    nom: [prenom, nom].filter(Boolean).join(' ') || email.split('@')[0],
    email, role,
    zone: document.getElementById('f-zone').value.trim()||null,
    telephone: document.getElementById('f-telephone').value.trim()||null,
    actif: document.getElementById('f-actif').value === 'true',
    updatedAt: serverTimestamp()
  };

  try {
    if (editUid) {
      await updateDoc(doc(db,'agents',editUid), data);
      showToast('‚úÖ Agent mis √† jour !');
    } else {
      // Cr√©er compte Firebase Auth + Firestore
      const pass = document.getElementById('f-password').value;
      if (!pass || pass.length < 8) { showToast('‚ö†Ô∏è Mot de passe min. 8 caract√®res'); return; }
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      data.createdAt = serverTimestamp();
      data.statut = 'indisponible';
      await setDoc(doc(db,'agents',cred.user.uid), data);
      showToast('‚úÖ Agent cr√©√© ! Email: '+email+' / Pass: '+pass);
    }
    closeModal();
    loadAll();
  } catch(e) {
    if (e.code === 'auth/email-already-in-use') showToast('‚ùå Cet email est d√©j√† utilis√©');
    else showToast('‚ùå Erreur : '+e.message);
  } finally { btn.disabled=false; btn.textContent='üíæ Enregistrer'; }
};

window.resetPw = function(uid, email) {
  const newPw = prompt(`Nouveau mot de passe pour ${email} :\n(Min. 8 caract√®res)`);
  if (!newPw || newPw.length < 8) { showToast('‚ö†Ô∏è Mot de passe trop court'); return; }
  // Note: Pour changer le mot de passe d'un autre utilisateur, 
  // il faudrait Firebase Admin SDK c√¥t√© serveur.
  // Ici on affiche le mot de passe pour que l'admin le communique manuellement.
  showToast('‚ÑπÔ∏è Communiquez ce mot de passe √† l\'agent : '+newPw);
};

window.deleteAgent = async function(uid, nom) {
  if (!confirm(`D√©sactiver l'agent "${nom}" ?\n\nIl ne pourra plus se connecter.`)) return;
  try {
    await updateDoc(doc(db,'agents',uid), {actif:false,updatedAt:serverTimestamp()});
    showToast('‚úÖ Agent d√©sactiv√©');
    loadAll();
  } catch(e) { showToast('‚ùå Erreur'); }
};

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3500);
}

document.getElementById('modal-agent').addEventListener('click', e => {
  if (e.target === document.getElementById('modal-agent')) closeModal();
});
</script>
</body>
</html>
