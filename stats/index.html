<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OmniService TG ‚Äî Statisticien</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--blue:#1565C0;--blue2:#1E88E5;--blue-s:rgba(21,101,192,.1);--blue-d:#0D47A1;--ora:#F5820A;--ora-s:rgba(245,130,10,.1);--ora-d:#E65100;--dark:#0D2137;--mid:#3A5068;--light:#7A95B0;--border:#D6E4F0;--bg:#F0F4FF;--card:#fff;--green:#2E7D32;--red:#C62828;--purple:#6A1B9A;--teal:#00695C;}
html,body{height:100%;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--dark)}
#splash{position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#0D2137,#1565C0);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px}
.sp-logo{font-size:56px;animation:popIn .6s cubic-bezier(.34,1.56,.64,1) .3s both}
.sp-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:#fff;animation:fadeUp .5s ease .7s both}
.sp-sub{font-size:11px;color:rgba(255,255,255,.5);letter-spacing:1px;text-transform:uppercase;animation:fadeUp .5s ease .9s both}
.sp-bar{width:160px;height:3px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;margin-top:8px;animation:fadeUp .4s ease 1s both}
.sp-bar-fill{height:100%;background:linear-gradient(90deg,var(--ora),var(--blue2));animation:load 1.4s ease 1.1s both}
@keyframes load{0%{width:0}100%{width:100%}}
#splash.out{animation:splashOut .4s ease forwards}
@keyframes splashOut{to{opacity:0;pointer-events:none}}
@keyframes popIn{from{transform:scale(0) rotate(-20deg);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes fadeUp{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
#login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0D2137,#1565C0 60%,#0D47A1);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
.login-box{background:#fff;border-radius:24px;padding:36px 28px;width:100%;max-width:380px;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.35)}
.login-logo{font-size:52px;margin-bottom:8px}
.login-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:var(--dark);margin-bottom:4px}
.login-sub{font-size:12px;color:var(--light);margin-bottom:16px}
.login-badge{display:inline-flex;align-items:center;gap:6px;background:var(--ora-s);color:var(--ora-d);border:1px solid rgba(245,130,10,.3);border-radius:999px;padding:4px 14px;font-size:11px;font-weight:700;letter-spacing:.5px;margin-bottom:20px}
.code-lbl{font-size:11px;font-weight:700;color:var(--mid);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;text-align:left;display:block}
.code-inp{width:100%;padding:16px;border:2px solid var(--border);border-radius:14px;font-size:24px;font-weight:900;font-family:'Nunito',sans-serif;text-align:center;letter-spacing:4px;text-transform:uppercase;outline:none;transition:.2s;background:#f8faff;color:var(--dark)}
.code-inp:focus{border-color:var(--blue);background:#fff;box-shadow:0 0 0 4px var(--blue-s)}
.code-inp::placeholder{font-size:14px;letter-spacing:1px;font-weight:400;color:var(--light)}
.btn-login{width:100%;padding:14px;background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer;margin-top:6px}
.login-err{color:var(--red);font-size:12px;margin-top:10px;min-height:18px;font-weight:600}
.login-hint{font-size:11px;color:var(--light);margin-top:12px}
.top-header{background:linear-gradient(135deg,#0D2137,#1565C0);padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.th-left{display:flex;align-items:center;gap:12px}
.th-icon{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--ora),var(--ora-d));display:flex;align-items:center;justify-content:center;font-size:22px}
.th-name{font-family:'Nunito',sans-serif;font-size:17px;font-weight:900;color:#fff}
.th-role{font-size:10px;color:rgba(255,255,255,.5)}
.th-code{background:rgba(245,130,10,.2);border:1px solid rgba(245,130,10,.4);color:#FFB74D;border-radius:999px;padding:3px 12px;font-size:10px;font-weight:800;font-family:'Nunito',sans-serif;letter-spacing:1px}
.btn-logout-top{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;font-family:'Poppins',sans-serif}
.period-bar{background:#fff;padding:12px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;overflow-x:auto;scrollbar-width:none}
.period-btn{padding:7px 16px;border-radius:999px;border:1.5px solid var(--border);background:none;font-size:12px;font-weight:600;cursor:pointer;font-family:'Poppins',sans-serif;color:var(--mid);white-space:nowrap;transition:.2s}
.period-btn.on{background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border-color:transparent}
.main-content{padding:20px;max-width:1100px;margin:0 auto}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px}
.kpi-card{background:#fff;border-radius:16px;padding:18px;box-shadow:0 2px 12px rgba(21,101,192,.08);border-left:4px solid var(--blue)}
.kpi-k1{border-color:var(--blue)}.kpi-k2{border-color:var(--green)}.kpi-k3{border-color:var(--ora)}.kpi-k4{border-color:var(--purple)}.kpi-k5{border-color:var(--red)}.kpi-k6{border-color:var(--teal)}
.kpi-label{font-size:9px;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px}
.kpi-value{font-family:'Nunito',sans-serif;font-size:26px;font-weight:900;color:var(--dark)}
.kpi-sub{font-size:10px;color:var(--light);margin-top:4px}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
@media(max-width:768px){.two-col{grid-template-columns:1fr}}
.stat-card{background:#fff;border-radius:16px;box-shadow:0 2px 12px rgba(21,101,192,.08);overflow:hidden}
.stat-head{padding:14px 16px;border-bottom:1px solid var(--border)}
.stat-title{font-size:13px;font-weight:700;color:var(--dark)}
.stat-body{padding:14px 16px}
.line-chart-wrap{position:relative;height:120px;margin-bottom:8px}
svg.line-chart{width:100%;height:100%}
.hbar-item{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.hbar-label{font-size:11px;color:var(--mid);width:90px;flex-shrink:0;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.hbar-track{flex:1;height:10px;background:var(--bg);border-radius:5px;overflow:hidden}
.hbar-fill{height:100%;border-radius:5px;transition:.5s}
.hbar-val{font-size:11px;font-weight:700;color:var(--dark);width:36px;text-align:right}
.heat-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:3px}
.heat-cell{height:28px;border-radius:4px;position:relative;cursor:default}
.heat-tooltip{display:none;position:absolute;bottom:110%;left:50%;transform:translateX(-50%);background:var(--dark);color:#fff;font-size:9px;padding:3px 7px;border-radius:5px;white-space:nowrap;z-index:10}
.heat-cell:hover .heat-tooltip{display:block}
.heat-lbl-row{display:grid;grid-template-columns:repeat(12,1fr);gap:3px;margin-top:4px}
.heat-lbl{font-size:9px;color:var(--light);text-align:center}
.rank-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
.rank-item:last-child{border-bottom:none}
.rank-num{width:24px;height:24px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;color:var(--mid)}
.rank-num.top{background:linear-gradient(135deg,var(--ora),var(--ora-d));color:#fff}
.rank-info{flex:1;min-width:0}
.rank-name{font-size:12px;font-weight:700;color:var(--dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rank-sub{font-size:10px;color:var(--light)}
.rank-val{font-size:14px;font-weight:800;color:var(--blue);font-family:'Nunito',sans-serif}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--dark);color:#fff;padding:12px 22px;border-radius:12px;font-size:13px;font-weight:600;z-index:9998;transition:.35s;opacity:0;max-width:90vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}
</style>
</head>
<body>
<div id="splash">
  <div class="sp-logo">üìä</div>
  <div class="sp-title">OmniService TG</div>
  <div class="sp-sub">Interface Statisticien</div>
  <div class="sp-bar"><div class="sp-bar-fill"></div></div>
</div>

<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">üìä</div>
    <div class="login-title">Espace Statisticien</div>
    <div class="login-sub">OmniService TG</div>
    <div class="login-badge">üîë Connexion par code</div>
    <span class="code-lbl">Votre code d'acc√®s</span>
    <input class="code-inp" type="text" id="login-code" placeholder="St0001"
      maxlength="10" autocomplete="off" spellcheck="false"
      oninput="this.value=this.value.toUpperCase()"
      onkeydown="if(event.key==='Enter') doLogin()"/>
    <button class="btn-login" onclick="doLogin()" id="btn-login">üöÄ Se connecter</button>
    <div class="login-err" id="login-err"></div>
    <div class="login-hint">Code fourni par votre responsable RH.</div>
  </div>
</div>

<div id="app" style="display:none">
  <div class="top-header">
    <div class="th-left">
      <div class="th-icon">üìä</div>
      <div><div class="th-name" id="top-name">Statisticien</div><div class="th-role">Tableau de bord analytique ¬∑ OmniService TG</div></div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <span class="th-code" id="top-code">‚Äî</span>
      <button class="btn-logout-top" onclick="doLogout()">‚Ü© D√©connexion</button>
    </div>
  </div>

  <div class="period-bar">
    <button class="period-btn on" onclick="setPeriode(7,this)">7 jours</button>
    <button class="period-btn" onclick="setPeriode(30,this)">30 jours</button>
    <button class="period-btn" onclick="setPeriode(90,this)">3 mois</button>
    <button class="period-btn" onclick="setPeriode(365,this)">1 an</button>
    <button class="period-btn" onclick="setPeriode(0,this)">Tout</button>
  </div>

  <div class="main-content">
    <div class="kpi-grid">
      <div class="kpi-card kpi-k1"><div class="kpi-label">Commandes totales</div><div class="kpi-value" id="k-total">‚Äî</div><div class="kpi-sub" id="k-total-sub">chargement...</div></div>
      <div class="kpi-card kpi-k2"><div class="kpi-label">Termin√©es</div><div class="kpi-value" id="k-term">‚Äî</div><div class="kpi-sub" id="k-term-pct">‚Äî</div></div>
      <div class="kpi-card kpi-k3"><div class="kpi-label">CA Total</div><div class="kpi-value" id="k-ca">‚Äî</div><div class="kpi-sub">FCFA</div></div>
      <div class="kpi-card kpi-k4"><div class="kpi-label">Panier moyen</div><div class="kpi-value" id="k-panier">‚Äî</div><div class="kpi-sub">FCFA / commande</div></div>
      <div class="kpi-card kpi-k5"><div class="kpi-label">Annul√©es</div><div class="kpi-value" id="k-annulees">‚Äî</div><div class="kpi-sub" id="k-annulees-pct">‚Äî</div></div>
      <div class="kpi-card kpi-k6"><div class="kpi-label">Clients uniques</div><div class="kpi-value" id="k-clients">‚Äî</div><div class="kpi-sub">comptes actifs</div></div>
    </div>

    <div class="two-col">
      <div class="stat-card"><div class="stat-head"><div class="stat-title">üìà √âvolution CA (30 jours)</div></div>
        <div class="stat-body"><div class="line-chart-wrap"><svg class="line-chart" id="line-chart" viewBox="0 0 300 100" preserveAspectRatio="none"></svg></div>
        <div style="font-size:10px;color:var(--light);text-align:center" id="line-legend">CA par jour</div></div></div>
      <div class="stat-card"><div class="stat-head"><div class="stat-title">üçΩ Par service</div></div>
        <div class="stat-body" id="service-bars">Chargement...</div></div>
    </div>

    <div class="two-col">
      <div class="stat-card"><div class="stat-head"><div class="stat-title">‚è∞ Commandes par heure</div></div>
        <div class="stat-body">
          <div class="heat-grid" id="heat-grid"></div>
          <div class="heat-lbl-row" id="heat-lbls"></div>
        </div></div>
      <div class="stat-card"><div class="stat-head"><div class="stat-title">üìç Top zones</div></div>
        <div class="stat-body" id="zones-list">Chargement...</div></div>
    </div>

    <div class="two-col">
      <div class="stat-card"><div class="stat-head"><div class="stat-title">üèÜ Articles les plus command√©s</div></div>
        <div class="stat-body" id="articles-rank">Chargement...</div></div>
      <div class="stat-card"><div class="stat-head"><div class="stat-title">üõµ Top livreurs</div></div>
        <div class="stat-body" id="livreurs-rank">Chargement...</div></div>
    </div>
  </div>
</div>
<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, query, getDocs, doc, getDoc, setDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const fbApp = initializeApp({apiKey:"AIzaSyDtDK7-iDRy1E-kjZubjyjkPW7Th33BMyU",authDomain:"omniservicetg-59df3.firebaseapp.com",projectId:"omniservicetg-59df3",storageBucket:"omniservicetg-59df3.firebasestorage.app",messagingSenderId:"196278567761",appId:"1:196278567761:web:4f6416acaab58b67bf4970"});
const db=getFirestore(fbApp);const auth=getAuth(fbApp);
let allOrders=[],periodeDays=7;

setTimeout(()=>{const s=document.getElementById('splash');s.classList.add('out');setTimeout(()=>s.style.display='none',400);},2500);

onAuthStateChanged(auth, async user=>{
  if(user&&user.isAnonymous){
    try{
      const snap=await getDoc(doc(db,'agents',user.uid));
      if(snap.exists()&&['stats','admin'].includes(snap.data().role)&&snap.data().actif!==false){
        document.getElementById('top-name').textContent=snap.data().prenom||snap.data().nom||'Statisticien';
        document.getElementById('top-code').textContent=snap.data().code||'‚Äî';
        document.getElementById('login-screen').style.display='none';
        document.getElementById('app').style.display='block';
        loadData();
      }else{await signOut(auth);showLogin('‚ùå Acc√®s non autoris√©');}
    }catch(e){showLogin();}
  }else if(!user){showLogin();}
});

function showLogin(err=''){
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('app').style.display='none';
  if(err)document.getElementById('login-err').textContent=err;
}

window.doLogin=async function(){
  const code=document.getElementById('login-code').value.trim().toUpperCase();
  const errEl=document.getElementById('login-err');const btn=document.getElementById('btn-login');
  if(!code){errEl.textContent='‚ö†Ô∏è Saisissez votre code';return;}
  btn.disabled=true;btn.innerHTML='<span class="spinner"></span> V√©rification...';errEl.textContent='';
  try{
    const ls=await getDoc(doc(db,'agents_login',code));
    if(!ls.exists()){errEl.textContent='‚ùå Code inconnu. Contactez votre RH.';return;}
    const ld=ls.data();
    if(!['stats','admin'].includes(ld.role)){errEl.textContent='‚ùå Ce code n\'est pas un code Statisticien.';return;}
    if(ld.actif===false){errEl.textContent='‚õî Compte d√©sactiv√©.';return;}
    btn.innerHTML='<span class="spinner"></span> Connexion...';
    const cred=await signInAnonymously(auth);const aUid=cred.user.uid;
    const ps=await getDoc(doc(db,'agents',ld.agentUid));const pd=ps.exists()?ps.data():{code,role:ld.role,actif:true};
    await setDoc(doc(db,'agents',aUid),{...pd,uid:aUid,codeRef:ld.agentUid,derniere_connexion:serverTimestamp()});
  }catch(e){console.error(e);errEl.textContent='‚ùå Erreur r√©seau.';}
  finally{btn.disabled=false;btn.textContent='üöÄ Se connecter';}
};
window.doLogout=async()=>{await signOut(auth);};

async function loadData(){
  try{const snap=await getDocs(query(collection(db,'commandes'),orderBy('createdAt','desc')));allOrders=snap.docs.map(d=>({id:d.id,...d.data()}));renderAll();}
  catch(e){toast('‚ùå Erreur chargement donn√©es');}
}

window.setPeriode=function(days,btn){
  periodeDays=days;document.querySelectorAll('.period-btn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');renderAll();
};

function getFiltered(){
  if(periodeDays===0)return allOrders;
  const cutoff=new Date();cutoff.setDate(cutoff.getDate()-periodeDays);cutoff.setHours(0,0,0,0);
  return allOrders.filter(o=>o.createdAt&&new Date(o.createdAt.seconds*1000)>=cutoff);
}

function renderAll(){const o=getFiltered();renderKPIs(o);renderLineChart(o);renderServiceBars(o);renderHeatmap(o);renderZones(o);renderArticles(o);renderLivreurs(o);}

function renderKPIs(orders){
  const t=orders.filter(o=>o.statut==='Termin√©e');const ann=orders.filter(o=>o.statut==='Annul√©e');
  const ca=t.reduce((s,o)=>s+(Number(o.total)||0),0);const panier=t.length>0?Math.round(ca/t.length):0;
  const uids=new Set(orders.map(o=>o.uid).filter(Boolean));
  const fmt=v=>v>=1000000?(v/1000000).toFixed(1)+'M':v>=1000?(v/1000).toFixed(0)+'k':v;
  document.getElementById('k-total').textContent=orders.length;
  document.getElementById('k-total-sub').textContent=periodeDays>0?periodeDays+' derniers jours':'total';
  document.getElementById('k-term').textContent=t.length;
  document.getElementById('k-term-pct').textContent=orders.length>0?Math.round(t.length/orders.length*100)+'% succ√®s':'‚Äî';
  document.getElementById('k-ca').textContent=fmt(ca);
  document.getElementById('k-panier').textContent=panier.toLocaleString('fr-FR');
  document.getElementById('k-annulees').textContent=ann.length;
  document.getElementById('k-annulees-pct').textContent=orders.length>0?Math.round(ann.length/orders.length*100)+'% annulation':'‚Äî';
  document.getElementById('k-clients').textContent=uids.size;
}

function renderLineChart(orders){
  const days=30;const buckets=[];
  for(let i=days-1;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);d.setHours(0,0,0,0);const d2=new Date(d);d2.setHours(23,59,59,999);
    const ca=orders.filter(o=>{if(!o.createdAt)return false;const dt=new Date(o.createdAt.seconds*1000);return dt>=d&&dt<=d2&&o.statut==='Termin√©e';}).reduce((s,o)=>s+(Number(o.total)||0),0);
    buckets.push(ca);}
  const max=Math.max(...buckets,1);
  const pts=buckets.map((v,i)=>{const x=i/(days-1)*280+10;const y=90-(v/max*80);return `${x},${y}`;}).join(' ');
  const apts=`10,90 `+buckets.map((v,i)=>{const x=i/(days-1)*280+10;const y=90-(v/max*80);return `${x},${y}`;}).join(' ')+` 290,90`;
  document.getElementById('line-chart').innerHTML=`
    <defs><linearGradient id="aG" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="rgba(21,101,192,.25)"/><stop offset="100%" stop-color="rgba(21,101,192,0)"/></linearGradient></defs>
    <polygon points="${apts}" fill="url(#aG)"/>
    <polyline points="${pts}" fill="none" stroke="var(--blue)" stroke-width="1.5" stroke-linejoin="round"/>
    ${buckets.map((v,i)=>{if(!v)return'';const x=i/(days-1)*280+10;const y=90-(v/max*80);return`<circle cx="${x}" cy="${y}" r="2" fill="var(--blue)"/>`;}).join('')}`;
}

function renderServiceBars(orders){
  const counts={};orders.forEach(o=>{const s=o.serviceName||o.service||'Autre';counts[s]=(counts[s]||0)+1;});
  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,6);const max=sorted[0]?.[1]||1;
  const colors=['var(--blue)','var(--ora)','var(--green)','var(--purple)','var(--teal)','var(--red)'];
  document.getElementById('service-bars').innerHTML=sorted.map(([name,count],i)=>`
    <div class="hbar-item"><div class="hbar-label">${name}</div><div class="hbar-track"><div class="hbar-fill" style="width:${count/max*100}%;background:${colors[i%colors.length]}"></div></div><div class="hbar-val">${count}</div></div>`).join('')||'<div style="color:var(--light);font-size:12px">Aucune donn√©e</div>';
}

function renderHeatmap(orders){
  const hours=Array(24).fill(0);orders.forEach(o=>{if(o.createdAt)hours[new Date(o.createdAt.seconds*1000).getHours()]++;});
  const max=Math.max(...hours,1);
  document.getElementById('heat-grid').innerHTML=hours.slice(0,24).map((v,h)=>`<div class="heat-cell" style="background:rgba(21,101,192,${0.05+v/max*0.85})"><div class="heat-tooltip">${h}h: ${v} cmd</div></div>`).join('');
  document.getElementById('heat-lbls').innerHTML=[0,2,4,6,8,10,12,14,16,18,20,22].map(h=>`<div class="heat-lbl">${h}h</div>`).join('');
}

function renderZones(orders){
  const zones={};orders.forEach(o=>{if(o.zone||o.adresse){const z=o.zone||(o.adresse||'').split(',').pop().trim()||'Inconnu';zones[z]=(zones[z]||0)+1;}});
  const sorted=Object.entries(zones).sort((a,b)=>b[1]-a[1]).slice(0,6);
  if(!sorted.length){document.getElementById('zones-list').innerHTML='<div style="color:var(--light);font-size:12px">Aucune donn√©e de zone</div>';return;}
  const max=sorted[0][1];
  document.getElementById('zones-list').innerHTML=sorted.map(([zone,count],i)=>`<div class="rank-item"><div class="rank-num ${i<3?'top':''}">${i+1}</div><div class="rank-info"><div class="rank-name">üìç ${zone}</div><div class="rank-sub">${count} commande${count>1?'s':''}</div></div><div class="rank-val">${Math.round(count/max*100)}%</div></div>`).join('');
}

function renderArticles(orders){
  const arts={};orders.forEach(o=>{if(o.items){try{const it=typeof o.items==='string'?JSON.parse(o.items):o.items;if(Array.isArray(it))it.forEach(a=>{const n=a.name||a.nom||'?';arts[n]=(arts[n]||0)+(a.qty||a.quantite||1);});}catch(e){}}});
  const sorted=Object.entries(arts).sort((a,b)=>b[1]-a[1]).slice(0,5);
  document.getElementById('articles-rank').innerHTML=sorted.length?sorted.map(([n,q],i)=>`<div class="rank-item"><div class="rank-num ${i<3?'top':''}">${i+1}</div><div class="rank-info"><div class="rank-name">${n}</div><div class="rank-sub">command√© ${q} fois</div></div><div class="rank-val">${q}√ó</div></div>`).join(''):'<div style="color:var(--light);font-size:12px">Aucune donn√©e articles</div>';
}

function renderLivreurs(orders){
  const livs={};orders.filter(o=>o.statut==='Termin√©e').forEach(o=>{if(o.livreurNom){if(!livs[o.livreurNom])livs[o.livreurNom]={n:0,ca:0};livs[o.livreurNom].n++;livs[o.livreurNom].ca+=Number(o.total)||0;}});
  const sorted=Object.entries(livs).sort((a,b)=>b[1].n-a[1].n).slice(0,5);
  document.getElementById('livreurs-rank').innerHTML=sorted.length?sorted.map(([nom,d],i)=>`<div class="rank-item"><div class="rank-num ${i<3?'top':''}">${i+1}</div><div class="rank-info"><div class="rank-name">üõµ ${nom}</div><div class="rank-sub">${d.n} livraison${d.n>1?'s':''}</div></div><div class="rank-val">${d.n}</div></div>`).join(''):'<div style="color:var(--light);font-size:12px">Aucune donn√©e livreur</div>';
}

function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);}
</script>
</body>
</html>
