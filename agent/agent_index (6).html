<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>OmniService TG ‚Äî Agent</title>
<meta name="theme-color" content="#1A1A2E"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Agent OmniTG"/>
<link rel="manifest" href="manifest.json"/>
<link rel="icon" href="../assets/logo.png" type="image/png"/>
<link rel="apple-touch-icon" href="../assets/logo.png"/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>

<!-- Firebase SDK compat ‚Äî pas de module ES6 -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --dark:#1A1A2E;--mid:#4A4A6A;--light:#9999BB;--border:#E8EAF0;--bg:#F4F6FA;
  --green:#2E7D32;--red:#C62828;--ora:#F5820A;
  --acc:#1E6FBE;--acc-d:#155A9C;--acc-s:rgba(30,111,190,.1);
  --orange:#E65100;--orange-s:rgba(230,81,0,.1);
  --sh:0 2px 12px rgba(0,0,0,.07);
}
html,body{height:100%;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--dark);}

/* ‚ïê‚ïê SPLASH ‚ïê‚ïê */
#splash{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(145deg,#0a1628,#1E6FBE 55%,#0a1628);}
#splash::before{content:'';position:absolute;inset:0;
  background-image:linear-gradient(rgba(255,255,255,.025) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,255,255,.025) 1px,transparent 1px);
  background-size:40px 40px;}
.sp-o{position:absolute;border-radius:50%;pointer-events:none;}
.sp-o1{width:400px;height:400px;top:-100px;right:-90px;
  background:radial-gradient(circle,rgba(30,111,190,.2) 0%,transparent 70%);
  animation:spO 4s ease-in-out infinite alternate;}
.sp-o2{width:300px;height:300px;bottom:-80px;left:-70px;
  background:radial-gradient(circle,rgba(30,111,190,.3) 0%,transparent 70%);
  animation:spO 4s ease-in-out infinite alternate-reverse;}
@keyframes spO{from{transform:scale(1)}to{transform:scale(1.18) translate(8px,-8px)}}
.sp-c{position:relative;z-index:2;text-align:center;padding:32px;}
.sp-badge{display:inline-block;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);
  border-radius:999px;padding:5px 16px;font-size:10px;font-weight:800;letter-spacing:1.5px;
  color:rgba(255,255,255,.8);text-transform:uppercase;margin-bottom:20px;animation:spFu .5s .3s both;}
.sp-logo{width:100px;height:100px;border-radius:26px;margin:0 auto 20px;
  background:rgba(255,255,255,.12);border:1.5px solid rgba(255,255,255,.2);
  display:flex;align-items:center;justify-content:center;overflow:hidden;animation:spPi .8s .4s both;}
.sp-logo img{width:76px;height:76px;object-fit:contain;}
.sp-title{font-family:'Nunito',sans-serif;font-size:30px;font-weight:900;color:#fff;margin-bottom:4px;animation:spFu .6s .8s both;}
.sp-title .o{color:var(--ora)}
.sp-tag{font-size:11px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px;animation:spFu .6s 1s both;}
.sp-bar{width:200px;height:2px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden;margin:24px auto 0;animation:spFu .5s 1.2s both;}
.sp-bar-f{height:100%;background:linear-gradient(90deg,rgba(30,111,190,.7),#90CAF9,var(--acc));animation:spBl 1.8s 1.3s both;}
@keyframes spBl{0%{width:0}100%{width:100%}}
@keyframes spFu{from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes spPi{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}

/* ‚ïê‚ïê LOGIN ‚ïê‚ïê */
#login-screen{min-height:100vh;background:linear-gradient(145deg,#0a1628,#1E6FBE 55%,#0a1628);
  display:none;align-items:center;justify-content:center;padding:20px;}
.lbox{background:#fff;border-radius:24px;padding:36px 28px;width:100%;max-width:380px;
  text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.45);}
.l-logo{width:72px;height:72px;background:linear-gradient(135deg,var(--dark),var(--mid));
  border-radius:18px;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.l-logo img{width:56px;height:56px;object-fit:contain;}
.l-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:var(--dark);margin-bottom:2px;}
.l-role{display:inline-block;background:#E3F2FD;color:var(--acc);font-size:11px;font-weight:700;padding:3px 12px;border-radius:999px;margin-bottom:6px;}
.l-sub{font-size:12px;color:var(--light);margin-bottom:22px;}
.code-row{display:flex;gap:8px;justify-content:center;margin-bottom:18px;}
.code-digit{width:46px;height:56px;border:2px solid var(--border);border-radius:12px;text-align:center;
  font-size:20px;font-weight:800;font-family:'Nunito',sans-serif;color:var(--dark);
  background:var(--bg);outline:none;transition:border-color .2s,background .2s;text-transform:uppercase;}
.code-digit:focus{border-color:var(--acc);background:#fff;box-shadow:0 0 0 3px var(--acc-s);}
.code-digit.filled{border-color:var(--acc);background:var(--acc-s);color:var(--acc);}
.l-btn{width:100%;background:linear-gradient(135deg,var(--acc),var(--acc-d));color:#fff;border:none;
  border-radius:999px;padding:14px;font-size:14px;font-weight:700;cursor:pointer;
  font-family:'Poppins',sans-serif;box-shadow:0 4px 16px var(--acc-s);transition:opacity .2s;}
.l-btn:hover{opacity:.9;}
.l-err{color:var(--red);font-size:12px;font-weight:600;margin-top:10px;min-height:18px;}
.l-info{margin-top:14px;font-size:11px;color:var(--light);background:var(--bg);border-radius:9px;padding:10px 12px;text-align:left;line-height:1.7;}

/* ‚ïê‚ïê INTERFACE AGENT ‚ïê‚ïê */
#agent-ui{display:none;min-height:100vh;background:var(--bg);}
.topbar{background:var(--dark);padding:0 20px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
.tb-left{display:flex;align-items:center;gap:12px;}
.tb-logo{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;overflow:hidden;}
.tb-logo img{width:28px;height:28px;object-fit:contain;}
.tb-brand{font-family:'Nunito',sans-serif;font-size:16px;font-weight:900;color:#fff;}
.tb-brand .o{color:var(--ora)}
.tb-right{display:flex;align-items:center;gap:10px;}
.tb-agent-info{text-align:right;}
.tb-agent-name{font-size:13px;font-weight:700;color:#fff;}
.tb-agent-role{font-size:10px;color:rgba(255,255,255,.4);}
.tb-code{background:rgba(30,111,190,.3);color:#90CAF9;font-size:10px;font-weight:800;font-family:monospace;padding:4px 10px;border-radius:6px;border:1px solid rgba(30,111,190,.4);}
.quit-btn{background:rgba(198,40,40,.2);color:#ff8a80;border:none;border-radius:8px;padding:8px 14px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Poppins',sans-serif;}
.quit-btn:hover{background:rgba(198,40,40,.35);}
.agent-content{max-width:700px;margin:0 auto;padding:28px 20px 56px;}

/* WELCOME */
.welcome-card{background:linear-gradient(135deg,var(--dark),#2A2A4E);border-radius:18px;padding:24px;margin-bottom:24px;color:#fff;position:relative;overflow:hidden;}
.welcome-card::before{content:'';position:absolute;top:-40px;right:-40px;width:180px;height:180px;border-radius:50%;background:rgba(30,111,190,.15);}
.wc-label{font-size:10px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.wc-name{font-family:'Nunito',sans-serif;font-size:26px;font-weight:900;}
.wc-role{font-size:13px;color:rgba(255,255,255,.5);margin-top:4px;}
.wc-zone{display:inline-block;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:4px 12px;font-size:11px;color:rgba(255,255,255,.7);margin-top:10px;}

/* KPI ‚Äî 4 cases */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:24px;}
.kpi-card{background:#fff;border-radius:14px;padding:14px 10px;box-shadow:var(--sh);text-align:center;}
.kpi-val{font-family:'Nunito',sans-serif;font-size:24px;font-weight:900;color:var(--dark);}
.kpi-lbl{font-size:9px;color:var(--light);font-weight:600;margin-top:2px;}
.kpi-card.k-new .kpi-val{color:var(--acc);}
.kpi-card.k-prog .kpi-val{color:var(--orange);}
.kpi-card.k-run .kpi-val{color:#F57F17;}
.kpi-card.k-done .kpi-val{color:var(--green);}

/* FILTRES */
.filter-tabs{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px;}
.ftab{flex-shrink:0;background:#fff;border:1.5px solid var(--border);border-radius:999px;padding:7px 14px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;color:var(--mid);transition:all .15s;white-space:nowrap;}
.ftab.on{background:var(--acc);color:#fff;border-color:var(--acc);}

/* SECTION TITLE */
.sec-title{font-family:'Nunito',sans-serif;font-size:17px;font-weight:900;color:var(--dark);margin-bottom:14px;}

/* TASK CARD */
.task-card{background:#fff;border-radius:16px;padding:20px;box-shadow:var(--sh);margin-bottom:14px;border-left:4px solid var(--border);}
.task-card.s-confirmee{border-left-color:var(--acc);}
.task-card.s-en-cours{border-left-color:var(--orange);}
.task-card.s-terminee{border-left-color:var(--green);opacity:.75;}
.task-card.p-haute{border-left-color:var(--red);}
.tc-head{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;gap:8px;}
.tc-service{font-size:15px;font-weight:700;color:var(--dark);}
.tc-ref{font-size:10px;font-family:monospace;color:var(--acc);font-weight:700;}
.tc-body{display:grid;gap:6px;margin-bottom:14px;}
.tc-row{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--mid);}
.tc-ico{width:20px;text-align:center;flex-shrink:0;}
.tc-val{font-weight:600;color:var(--dark);}
.tc-note{background:#FFF8E1;border-radius:10px;padding:12px;font-size:12px;color:#5D4037;margin-bottom:14px;border-left:3px solid #FFB300;}
.tc-note-label{font-size:10px;font-weight:700;text-transform:uppercase;color:#F9A825;letter-spacing:.5px;margin-bottom:4px;}
.tc-actions{display:flex;gap:8px;flex-wrap:wrap;}

/* BOUTONS D'ACTION ‚Äî 3 √©tats progressifs */
.btn-confirm{background:linear-gradient(135deg,var(--acc),var(--acc-d));color:#fff;border:none;border-radius:999px;padding:10px 20px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;}
.btn-start{background:linear-gradient(135deg,var(--orange),#BF360C);color:#fff;border:none;border-radius:999px;padding:10px 20px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;}
.btn-done{background:linear-gradient(135deg,var(--green),#1B5E20);color:#fff;border:none;border-radius:999px;padding:10px 20px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;}
.btn-call{background:#E3F2FD;color:var(--acc);border-radius:999px;padding:10px 16px;font-size:12px;font-weight:700;text-decoration:none;display:inline-block;}

/* PILLS */
.pill{font-size:10px;font-weight:700;padding:4px 10px;border-radius:999px;display:inline-block;}
.p-conf{background:#E3F2FD;color:#1565C0;}
.p-prog{background:#FFF3E0;color:#E65100;}
.p-run{background:#FFF8E1;color:#F57F17;}
.p-term{background:#E8F5E9;color:var(--green);}
.p-haute{background:#FFEBEE;color:var(--red);}
.p-norm{background:#E3F2FD;color:var(--acc);}
.p-basse{background:#EEE;color:#757575;}

/* EMPTY / LOADING */
.empty-box{background:#fff;border-radius:16px;padding:48px;text-align:center;box-shadow:var(--sh);}
.empty-ico{font-size:40px;margin-bottom:12px;}
.empty-txt{font-size:13px;color:var(--light);line-height:1.6;}
.spinner{display:inline-block;width:28px;height:28px;border:3px solid rgba(30,111,190,.2);border-top-color:var(--acc);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* NOTIFICATION BELL */
.notif-btn{position:relative;background:rgba(255,255,255,.1);border:none;border-radius:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;}
.notif-dot{position:absolute;top:4px;right:4px;width:10px;height:10px;background:#FF5252;border-radius:50%;border:2px solid var(--dark);display:none;}
.notif-dot.on{display:block;}

/* NOTIFICATION PANEL */
.notif-panel{position:fixed;top:60px;right:0;width:340px;max-height:70vh;background:#fff;box-shadow:-4px 0 24px rgba(0,0,0,.15);z-index:200;display:none;flex-direction:column;border-radius:0 0 0 16px;overflow:hidden;}
.notif-panel.show{display:flex;}
.notif-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.notif-title{font-size:14px;font-weight:700;color:var(--dark);}
.notif-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--mid);}
.notif-body{overflow-y:auto;flex:1;}
.notif-item{padding:13px 18px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;}
.notif-item:hover{background:var(--bg);}
.notif-item.unread{background:#E3F2FD;}
.notif-item-title{font-size:12px;font-weight:700;color:var(--dark);margin-bottom:3px;}
.notif-item-body{font-size:11px;color:var(--mid);line-height:1.5;}
.notif-item-date{font-size:10px;color:var(--light);margin-top:4px;}

/* ANNONCES SECTION */
.ann-section{background:#fff;border-radius:16px;padding:20px;box-shadow:var(--sh);margin-bottom:24px;border-left:4px solid #7B1FA2;}
.ann-section-title{font-size:14px;font-weight:700;color:#7B1FA2;margin-bottom:12px;}
.ann-card{background:#F3E5F5;border-radius:10px;padding:12px 14px;margin-bottom:8px;border-left:3px solid #AB47BC;}
.ann-card-title{font-size:12px;font-weight:700;color:#6A1B9A;margin-bottom:4px;}
.ann-card-body{font-size:12px;color:#4A148C;line-height:1.5;}
.ann-card-date{font-size:10px;color:#9C27B0;margin-top:5px;}

/* LOCATION BUTTON */
.btn-locate{background:linear-gradient(135deg,#1B5E20,#2E7D32);color:#fff;border:none;border-radius:999px;padding:10px 16px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;text-decoration:none;display:inline-flex;align-items:center;gap:5px;}

/* COMMANDE DETAIL BOX */
.cmd-detail{background:var(--bg);border-radius:10px;padding:12px 14px;margin-bottom:12px;border:1px solid var(--border);}
.cmd-detail-title{font-size:10px;font-weight:700;text-transform:uppercase;color:var(--light);letter-spacing:.5px;margin-bottom:8px;}
.cmd-item{display:flex;justify-content:space-between;align-items:flex-start;padding:4px 0;border-bottom:1px solid rgba(0,0,0,.04);font-size:12px;}
.cmd-item:last-child{border-bottom:none;}
.cmd-item-label{color:var(--light);font-weight:500;}
.cmd-item-val{color:var(--dark);font-weight:600;text-align:right;max-width:180px;word-break:break-word;}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--dark);color:#fff;border-radius:12px;padding:13px 20px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;box-shadow:0 8px 28px rgba(0,0,0,.3);}
.toast.show{opacity:1;}

@media(max-width:480px){
  .topbar{padding:0 14px;}
  .tb-agent-info{display:none;}
  .agent-content{padding:20px 14px 40px;}
  .kpi-row{grid-template-columns:repeat(2,1fr);}
}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-o sp-o1"></div><div class="sp-o sp-o2"></div>
  <div class="sp-c">
    <div class="sp-badge">üèÉ Espace Agent</div>
    <div class="sp-logo"><img src="../assets/logo.png" alt="" onerror="this.parentElement.innerHTML='üèÉ'"/></div>
    <div class="sp-title">Omni<span class="o">Service</span> TG</div>
    <div class="sp-tag">Interface Agent de terrain</div>
    <div class="sp-bar"><div class="sp-bar-f"></div></div>
  </div>
</div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="lbox">
    <div class="l-logo"><img src="../assets/logo.png" alt="" onerror="this.parentElement.innerHTML='üèÉ'"/></div>
    <div class="l-title">OmniService <span style="color:var(--ora)">TG</span></div>
    <div class="l-role">üèÉ Agent de terrain</div>
    <div class="l-sub">Saisissez votre code RH pour acc√©der √† vos missions</div>
    <div class="code-row">
      <input type="text" class="code-digit" maxlength="1" id="cd0" autocomplete="off" inputmode="text"/>
      <input type="text" class="code-digit" maxlength="1" id="cd1" autocomplete="off" inputmode="text"/>
      <input type="text" class="code-digit" maxlength="1" id="cd2" autocomplete="off" inputmode="text"/>
      <input type="text" class="code-digit" maxlength="1" id="cd3" autocomplete="off" inputmode="text"/>
      <input type="text" class="code-digit" maxlength="1" id="cd4" autocomplete="off" inputmode="text"/>
      <input type="text" class="code-digit" maxlength="1" id="cd5" autocomplete="off" inputmode="text"/>
    </div>
    <button class="l-btn" id="login-btn">Acc√©der √† mes missions ‚Üí</button>
    <div class="l-err" id="l-err"></div>
    <div class="l-info"><b>Acc√®s agents uniquement.</b><br/>Votre code RH √† 6 caract√®res vous a √©t√© remis par le service RH lors de votre onboarding.</div>
  </div>
</div>

<!-- INTERFACE AGENT -->
<div id="agent-ui">
  <div class="topbar">
    <div class="tb-left">
      <div class="tb-logo"><img src="../assets/logo.png" alt="" onerror="this.parentElement.innerHTML='üèÉ'"/></div>
      <div class="tb-brand">Omni<span class="o">Service</span></div>
    </div>
    <div class="tb-right">
      <div class="tb-agent-info">
        <div class="tb-agent-name" id="tb-name">‚Äî</div>
        <div class="tb-agent-role" id="tb-role">‚Äî</div>
      </div>
      <div class="tb-code" id="tb-code">‚Äî‚Äî</div>
      <button class="notif-btn" id="notif-btn" title="Notifications">üîî<span class="notif-dot" id="notif-dot"></span></button>
      <button class="quit-btn" id="quit-btn">üö™ Quitter</button>
    </div>
  </div>

  <div class="agent-content">

    <!-- PANEL NOTIFICATIONS -->
    <div class="notif-panel" id="notif-panel">
      <div class="notif-header">
        <span class="notif-title">üîî Notifications</span>
        <button class="notif-close" id="notif-close">‚úï</button>
      </div>
      <div class="notif-body" id="notif-body"><div style="padding:20px;text-align:center;color:var(--light);font-size:12px;">Chargement‚Ä¶</div></div>
    </div>

    <div class="welcome-card">
      <div style="position:relative;z-index:1">
        <div class="wc-label">Bonjour üëã</div>
        <div class="wc-name" id="wc-name">‚Äî</div>
        <div class="wc-role" id="wc-role">‚Äî</div>
        <div class="wc-zone" id="wc-zone">üìç ‚Äî</div>
      </div>
    </div>

    <!-- KPI 4 cases -->
    <div class="kpi-row">
      <div class="kpi-card k-new"><div class="kpi-val" id="kpi-new">‚Äî</div><div class="kpi-lbl">Nouvelles</div></div>
      <div class="kpi-card k-prog"><div class="kpi-val" id="kpi-conf">‚Äî</div><div class="kpi-lbl">Confirm√©es</div></div>
      <div class="kpi-card k-run"><div class="kpi-val" id="kpi-prog">‚Äî</div><div class="kpi-lbl">En cours</div></div>
      <div class="kpi-card k-done"><div class="kpi-val" id="kpi-done">‚Äî</div><div class="kpi-lbl">Termin√©es</div></div>
    </div>

    <!-- Filtres 4 groupes -->
    <div id="annonces-agent-section" style="display:none" class="ann-section">
      <div class="ann-section-title">üì£ Annonces des Op√©rations</div>
      <div id="annonces-agent-list"><div style="font-size:12px;color:var(--light)">Chargement‚Ä¶</div></div>
    </div>

    <!-- Filtres 4 groupes -->
    <div class="filter-tabs" id="filter-tabs">
      <button class="ftab on" data-tab="actives">üìã Toutes actives</button>
      <button class="ftab" data-tab="Assign√©e">üì© Assign√©es</button>
      <button class="ftab" data-tab="Confirm√©e">üì¨ Confirm√©es</button>
      <button class="ftab" data-tab="En cours">üöÄ En cours</button>
      <button class="ftab" data-tab="Termin√©e">‚úÖ Termin√©es</button>
    </div>

    <div class="sec-title" id="sec-title">üìã Mes missions actives</div>
    <div id="tasks-container"><div class="empty-box"><div class="spinner"></div></div></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê INTERFACE AGENT DE COMMUNICATION ‚ïê‚ïê‚ïê‚ïê -->
<div id="comm-ui" style="display:none;min-height:100vh;background:var(--bg)">
  <div class="topbar" style="background:linear-gradient(135deg,#6A1B9A,#AB47BC)">
    <div class="tb-left">
      <div class="tb-logo"><img src="../assets/logo.png" alt="" onerror="this.parentElement.innerHTML='üì¢'"/></div>
      <div class="tb-brand">Omni<span class="o">Service</span> <span style="font-size:11px;color:rgba(255,255,255,.6);font-weight:400">‚Äî Communication</span></div>
    </div>
    <div class="tb-right">
      <div class="tb-agent-info">
        <div class="tb-agent-name" id="comm-name">‚Äî</div>
        <div class="tb-agent-role" style="color:rgba(255,255,255,.5)">üì¢ Agent Communication</div>
      </div>
      <button class="quit-btn" id="comm-quit-btn">üö™ Quitter</button>
    </div>
  </div>

  <div style="max-width:800px;margin:0 auto;padding:28px 20px 56px">

    <!-- Welcome -->
    <div style="background:linear-gradient(135deg,#6A1B9A,#9C27B0);border-radius:18px;padding:22px;margin-bottom:24px;color:#fff;position:relative;overflow:hidden">
      <div style="font-size:10px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Espace</div>
      <div style="font-family:'Nunito',sans-serif;font-size:24px;font-weight:900" id="comm-welcome-name">‚Äî</div>
      <div style="font-size:13px;color:rgba(255,255,255,.5);margin-top:4px">Gestion du contenu client ‚Äî Bandeaux ¬∑ Articles ¬∑ Catalogues ¬∑ Prix</div>
      <div style="position:absolute;top:-30px;right:-30px;width:150px;height:150px;border-radius:50%;background:rgba(255,255,255,.06)"></div>
    </div>

    <!-- Tabs -->
    <div style="display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;padding-bottom:4px">
      <button class="ftab on" data-comm="bandeaux">üñºÔ∏è Bandeaux</button>
      <button class="ftab" data-comm="articles">üì∞ Articles</button>
      <button class="ftab" data-comm="catalogue">üì¶ Catalogue / Prix</button>
      <button class="ftab" data-comm="services">‚öôÔ∏è Services</button>
      <button class="ftab" data-comm="masquer">üôà Masquer</button>
    </div>

    <!-- Section bandeaux -->
    <div id="comm-section-bandeaux">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div class="sec-title" style="margin-bottom:0">üñºÔ∏è Bandeaux promotionnels</div>
        <button class="btn-confirm" style="padding:9px 18px;font-size:12px" id="comm-btn-new-bandeau">‚ûï Nouveau</button>
      </div>
      <div id="comm-bandeaux-list"><div class="empty-box"><div class="spinner"></div></div></div>
    </div>

    <!-- Section articles -->
    <div id="comm-section-articles" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div class="sec-title" style="margin-bottom:0">üì∞ Articles & Actualit√©s</div>
        <button class="btn-confirm" style="padding:9px 18px;font-size:12px" id="comm-btn-new-article">‚ûï Nouveau</button>
      </div>
      <div id="comm-articles-list"><div class="empty-box"><div class="spinner"></div></div></div>
    </div>

    <!-- Section catalogue/prix -->
    <div id="comm-section-catalogue" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div class="sec-title" style="margin-bottom:0">üì¶ Catalogue & Prix</div>
        <button class="btn-confirm" style="padding:9px 18px;font-size:12px" id="comm-btn-new-produit">‚ûï Ajouter</button>
      </div>
      <div id="comm-catalogue-list"><div class="empty-box"><div class="spinner"></div></div></div>
    </div>

    <!-- Section services -->
    <div id="comm-section-services" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div class="sec-title" style="margin-bottom:0">‚öôÔ∏è Services propos√©s</div>
        <button class="btn-confirm" style="padding:9px 18px;font-size:12px" id="comm-btn-new-service">‚ûï Ajouter</button>
      </div>
      <div id="comm-services-list"><div class="empty-box"><div class="spinner"></div></div></div>
    </div>

    <!-- Section masquer -->
    <div id="comm-section-masquer" style="display:none">
      <div class="sec-title">üôà G√©rer la visibilit√©</div>
      <div style="font-size:12px;color:var(--light);margin-bottom:16px">Masquez ou affichez les √©l√©ments sur la page client.</div>
      <div id="comm-masquer-list"><div class="empty-box"><div class="spinner"></div></div></div>
    </div>

  </div>
</div>

<!-- MODAL COMM BANDEAU -->
<div class="modal-overlay" id="comm-modal-bandeau">
  <div class="modal">
    <button class="modal-close" data-comm-close="bandeau">‚úï</button>
    <div class="modal-title">üñºÔ∏è Bandeau promotionnel</div>
    <input type="hidden" id="cb-id"/>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Titre *</label>
    <input type="text" class="f-inp" id="cb-titre" placeholder="Ex : Promo de la semaine"/>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Sous-titre / Texte</label>
    <input type="text" class="f-inp" id="cb-subtxt" placeholder="Description courte"/>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">URL de l'image</label>
    <input type="text" class="f-inp" id="cb-img" placeholder="https://..."/>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Couleur fond</label>
    <input type="color" class="f-inp" id="cb-color" value="#1E6FBE" style="height:44px;padding:4px 8px"/>
    <div style="display:flex;gap:8px;margin-top:4px">
      <button class="modal-save-btn" id="cb-save">üíæ Enregistrer</button>
    </div>
    <div class="l-err" id="cb-err"></div>
  </div>
</div>

<!-- MODAL COMM ARTICLE -->
<div class="modal-overlay" id="comm-modal-article">
  <div class="modal">
    <button class="modal-close" data-comm-close="article">‚úï</button>
    <div class="modal-title">üì∞ Article</div>
    <input type="hidden" id="ca-id"/>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Titre *</label>
    <input type="text" class="f-inp" id="ca-titre" placeholder="Titre de l'article"/>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Contenu *</label>
    <textarea class="f-ta" id="ca-contenu" placeholder="Corps de l'article..." style="min-height:120px"></textarea>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">URL image (optionnel)</label>
    <input type="text" class="f-inp" id="ca-img" placeholder="https://..."/>
    <button class="modal-save-btn" id="ca-save">üíæ Publier</button>
    <div class="l-err" id="ca-err"></div>
  </div>
</div>

<!-- MODAL COMM PRODUIT -->
<div class="modal-overlay" id="comm-modal-produit">
  <div class="modal">
    <button class="modal-close" data-comm-close="produit">‚úï</button>
    <div class="modal-title">üì¶ Produit / Service</div>
    <input type="hidden" id="cp-id"/>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Nom *</label>
    <input type="text" class="f-inp" id="cp-nom" placeholder="Nom du produit"/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div><label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Prix *</label><input type="text" class="f-inp" id="cp-prix" placeholder="Ex : 5 000 FCFA"/></div>
      <div><label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Cat√©gorie</label><input type="text" class="f-inp" id="cp-cat" placeholder="Ex : Livraison"/></div>
    </div>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Description</label>
    <textarea class="f-ta" id="cp-desc" placeholder="Description..."></textarea>
    <button class="modal-save-btn" id="cp-save">üíæ Enregistrer</button>
    <div class="l-err" id="cp-err"></div>
  </div>
</div>

<!-- MODAL COMM SERVICE -->
<div class="modal-overlay" id="comm-modal-service">
  <div class="modal">
    <button class="modal-close" data-comm-close="service">‚úï</button>
    <div class="modal-title">‚öôÔ∏è Service propos√©</div>
    <input type="hidden" id="cs-id"/>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Nom du service *</label>
    <input type="text" class="f-inp" id="cs-nom" placeholder="Ex : Livraison express"/>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Ic√¥ne (emoji)</label>
    <input type="text" class="f-inp" id="cs-ico" placeholder="üõµ"/>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Description</label>
    <textarea class="f-ta" id="cs-desc" placeholder="Description du service..."></textarea>
    <label style="display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:5px;text-transform:uppercase">Prix de base</label>
    <input type="text" class="f-inp" id="cs-prix" placeholder="Ex : √Ä partir de 2 000 FCFA"/>
    <button class="modal-save-btn" id="cs-save">üíæ Enregistrer</button>
    <div class="l-err" id="cs-err"></div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE CONFIG ‚Äî SDK compat
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
firebase.initializeApp({
  apiKey:"AIzaSyDtDK7-iDRy1E-kjZubjyjkPW7Th33BMyU",
  authDomain:"omniservicetg-59df3.firebaseapp.com",
  projectId:"omniservicetg-59df3",
  storageBucket:"omniservicetg-59df3.firebasestorage.app",
  messagingSenderId:"196278567761",
  appId:"1:196278567761:web:4f6416acaab58b67bf4970"
});
var db = firebase.firestore();

var RL = {livreur:'üõµ Livreur',securite:'üîí Agent s√©curit√©',entretien:'üßπ Agent entretien',depannage:'üîß Agent d√©pannage',commercial:'üíº Agent commercial',comm:'üì¢ Communication',ops:'‚öôÔ∏è Op√©rations'};

var currentAgent = null;
var myTasks      = [];
var currentTab   = 'actives';
var unsubNotif   = null;
var seenNotifs   = {};

// ‚îÄ‚îÄ Splash ‚îÄ‚îÄ
function hideSplash(){
  var s = document.getElementById('splash');
  if(!s||s._g) return; s._g=true;
  s.style.transition='opacity .5s,transform .5s';
  s.style.opacity='0'; s.style.transform='scale(1.03)'; s.style.pointerEvents='none';
  // R√©v√©ler le login screen quand le splash dispara√Æt
  document.getElementById('login-screen').style.display='flex';
  setTimeout(function(){ if(s.parentNode) s.parentNode.removeChild(s); }, 520);
}
setTimeout(hideSplash, 2800);

// ‚ïê‚ïê‚ïê‚ïê CODE INPUT ‚ïê‚ïê‚ïê‚ïê
var digits = [0,1,2,3,4,5].map(function(i){ return document.getElementById('cd'+i); });

digits.forEach(function(inp, i){
  inp.addEventListener('input', function(){
    inp.value = inp.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(-1);
    inp.classList.toggle('filled', inp.value.length > 0);
    document.getElementById('l-err').textContent = '';
    if(inp.value && i < 5) digits[i+1].focus();
    if(i === 5 && inp.value) doCodeLogin();
  });
  inp.addEventListener('keydown', function(e){
    if(e.key === 'Backspace'){
      if(!inp.value && i > 0){ digits[i-1].focus(); }
      if(inp.value){ inp.value=''; inp.classList.remove('filled'); }
      e.preventDefault();
    }
    if(e.key === 'ArrowLeft'  && i > 0) digits[i-1].focus();
    if(e.key === 'ArrowRight' && i < 5) digits[i+1].focus();
    if(e.key === 'Enter') doCodeLogin();
  });
});

document.getElementById('login-btn').addEventListener('click', doCodeLogin);

function getCode(){
  return digits.map(function(d){ return d.value; }).join('').toUpperCase();
}
function clearCode(){
  digits.forEach(function(d){ d.value=''; d.classList.remove('filled'); });
  digits[0].focus();
}

// ‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê
function doCodeLogin(){
  var code = getCode();
  var err  = document.getElementById('l-err');
  var btn  = document.getElementById('login-btn');
  err.textContent = '';
  if(code.length < 6){ err.textContent = '‚ö†Ô∏è Saisissez les 6 caract√®res de votre code.'; return; }
  btn.disabled = true; btn.textContent = '‚è≥ V√©rification‚Ä¶';
  db.collection('agents').where('code','==',code).get()
    .then(function(snap){
      if(snap.empty){
        err.textContent = '‚ùå Code incorrect. V√©rifiez avec le RH.';
        clearCode(); return;
      }
      var agentDoc = snap.docs[0];
      var agent = Object.assign({id: agentDoc.id}, agentDoc.data());
      if(agent.actif === false){
        err.textContent = '‚õî Votre compte est d√©sactiv√©. Contactez le RH.';
        clearCode(); return;
      }
      // Enregistrer la connexion
      db.collection('agents').doc(agent.id).update({
        derniere_connexion: firebase.firestore.FieldValue.serverTimestamp()
      });
      currentAgent = agent;
      showAgentUI();
    })
    .catch(function(e){ err.textContent = '‚ùå Erreur : ' + e.message; })
    .finally(function(){ btn.disabled = false; btn.textContent = 'Acc√©der √† mes missions ‚Üí'; });
}

// ‚ïê‚ïê‚ïê‚ïê INTERFACE AGENT ‚ïê‚ïê‚ïê‚ïê
function showAgentUI(){
  document.getElementById('login-screen').style.display = 'none';
  var a = currentAgent;

  // AGENT DE COMMUNICATION ‚Üí interface d√©di√©e
  if(a.role === 'comm'){
    showCommUI(a);
    return;
  }

  document.getElementById('agent-ui').style.display     = 'block';
  document.getElementById('tb-name').textContent  = a.nom  || 'Agent';
  document.getElementById('tb-role').textContent  = RL[a.role] || a.role || '‚Äî';
  document.getElementById('tb-code').textContent  = a.code || '‚Äî';
  document.getElementById('wc-name').textContent  = a.nom  || 'Agent';
  document.getElementById('wc-role').textContent  = RL[a.role] || a.role || '‚Äî';
  document.getElementById('wc-zone').textContent  = 'üìç ' + (a.zone || '‚Äî');
  loadMyTasks();
  loadAnnoncesAgent();
  listenNotifications();
}

document.getElementById('quit-btn').addEventListener('click', function(){
  if(unsubNotif){ unsubNotif(); unsubNotif=null; }
  seenNotifs = {};
  currentAgent = null; myTasks = [];
  document.getElementById('agent-ui').style.display    = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('notif-panel').classList.remove('show');
  document.getElementById('notif-dot').classList.remove('on');
  clearCode();
});

// ‚ïê‚ïê‚ïê‚ïê CHARGEMENT DES T√ÇCHES ‚ïê‚ïê‚ïê‚ïê
function loadMyTasks(){
  document.getElementById('tasks-container').innerHTML = '<div class="empty-box"><div class="spinner"></div></div>';
  db.collection('commandes').where('agentId','==',currentAgent.id).get()
    .then(function(snap){
      myTasks = snap.docs.map(function(d){ return Object.assign({id:d.id}, d.data()); });
      myTasks.sort(function(a,b){
        return (b.createdAt&&b.createdAt.toMillis?b.createdAt.toMillis():0)
              -(a.createdAt&&a.createdAt.toMillis?a.createdAt.toMillis():0);
      });
      updateKPIs();
      renderTasks();
    })
    .catch(function(e){
      document.getElementById('tasks-container').innerHTML =
        '<div class="empty-box"><div class="empty-ico">‚ö†Ô∏è</div><div class="empty-txt">Erreur : '+e.message+'</div></div>';
    });
}

// ‚ïê‚ïê‚ïê‚ïê KPI ‚ïê‚ïê‚ïê‚ïê
function updateKPIs(){
  document.getElementById('kpi-new').textContent  = myTasks.filter(function(t){ return t.statut==='Assign√©e'; }).length;
  document.getElementById('kpi-conf').textContent = myTasks.filter(function(t){ return t.statut==='Confirm√©e'; }).length;
  document.getElementById('kpi-prog').textContent = myTasks.filter(function(t){ return t.statut==='En cours'; }).length;
  document.getElementById('kpi-done').textContent = myTasks.filter(function(t){ return t.statut==='Termin√©e'; }).length;
}

// ‚ïê‚ïê‚ïê‚ïê FILTRES ‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.ftab').forEach(function(btn){
  btn.addEventListener('click', function(){
    currentTab = btn.dataset.tab;
    document.querySelectorAll('.ftab').forEach(function(b){ b.classList.remove('on'); });
    btn.classList.add('on');
    var titles = {
      'actives':'üìã Mes missions actives',
      'Assign√©e':'üì© T√¢ches assign√©es ‚Äî √† confirmer',
      'Confirm√©e':'üì¨ T√¢ches confirm√©es ‚Äî √† d√©marrer',
      'En cours':'üöÄ T√¢ches en cours d\'ex√©cution',
      'Termin√©e':'‚úÖ T√¢ches termin√©es'
    };
    document.getElementById('sec-title').textContent = titles[currentTab]||'';
    renderTasks();
  });
});

// ‚ïê‚ïê‚ïê‚ïê RENDU ‚ïê‚ïê‚ïê‚ïê
function renderTasks(){
  var list;
  if(currentTab === 'actives'){
    list = myTasks.filter(function(t){ return ['Assign√©e','Confirm√©e','En cours'].includes(t.statut); });
  } else {
    list = myTasks.filter(function(t){ return t.statut === currentTab; });
  }

  var el = document.getElementById('tasks-container');
  if(!list.length){
    var msgs = {
      'actives':'Aucune mission active pour le moment.<br/>Le responsable des op√©rations vous assignera bient√¥t une t√¢che.',
      'Assign√©e':'Aucune t√¢che assign√©e en attente.',
      'Confirm√©e':'Aucune t√¢che confirm√©e en attente.',
      'En cours':'Aucune t√¢che en cours d\'ex√©cution.',
      'Termin√©e':'Aucune t√¢che termin√©e pour l\'instant.'
    };
    el.innerHTML = '<div class="empty-box"><div class="empty-ico">üéâ</div><div class="empty-txt">'+(msgs[currentTab]||'')+'</div></div>';
    return;
  }

  el.innerHTML = list.map(function(t){
    var isAss   = t.statut === 'Assign√©e';
    var isConf  = t.statut === 'Confirm√©e';
    var isProg  = t.statut === 'En cours';
    var isTerm  = t.statut === 'Termin√©e';
    var cardCls = 'task-card '+(isAss?'s-confirmee':isConf?'s-confirmee':isProg?'s-en-cours':isTerm?'s-terminee':'')+(t.priorite==='Haute'?' p-haute':'');
    var pillSt  = isAss?'p-norm':isConf?'p-conf':isProg?'p-run':isTerm?'p-term':'p-norm';
    var pillPr  = t.priorite==='Haute'?'p-haute':t.priorite==='Basse'?'p-basse':'p-norm';

    // Construire le bloc d√©tails commande ‚Äî affiche tous les champs pertinents du document
    var EXCLUDED = ['id','agentId','statut','priorite','createdAt','updatedAt','uid','noteAgent'];
    var LABELS = {
      serviceName:'Service', service:'Service', clientNom:'Client', nomClient:'Client',
      clientTel:'T√©l√©phone', phone:'T√©l√©phone', clientVille:'Ville',
      adresseLivraison:'Adresse', adresse:'Adresse',
      besoin:'D√©tails', description:'D√©tails',
      quantite:'Quantit√©', montant:'Montant (FCFA)', options:'Options',
      produits:'Produits', mode_paiement:'Mode de paiement',
      typeService:'Type', categorie:'Cat√©gorie', sousCategorie:'Sous-cat√©gorie',
      duree:'Dur√©e', dateIntervention:'Date d\'intervention',
      etage:'√âtage', superficie:'Superficie', codePromo:'Code promo',
      nbPersonnes:'Nb personnes', poids:'Poids', dimensions:'Dimensions',
      remarques:'Remarques', commentaire:'Commentaire', instructions:'Instructions'
    };
    var items = [];
    var seen = {};
    // D'abord les champs connus dans un ordre logique
    ['serviceName','service','typeService','categorie','sousCategorie',
     'quantite','montant','options','produits','mode_paiement',
     'besoin','description','remarques','commentaire','instructions',
     'dateIntervention','duree','etage','superficie','nbPersonnes',
     'poids','dimensions','codePromo'
    ].forEach(function(k){
      if(t[k]!==undefined && t[k]!==null && t[k]!=='') {
        if(!seen[LABELS[k]||k]){
          seen[LABELS[k]||k]=true;
          items.push([LABELS[k]||k, String(t[k])]);
        }
      }
    });
    // Ensuite tous les autres champs inconnus non exclus
    Object.keys(t).forEach(function(k){
      if(EXCLUDED.indexOf(k)>-1) return;
      if(seen[LABELS[k]||k]) return;
      if(t[k]===undefined||t[k]===null||t[k]==='') return;
      if(typeof t[k]==='object') return; // timestamps
      if(k.startsWith('client')||k==='nomClient'||k==='phone'||k==='adresse'||k==='adresseLivraison'||k==='clientVille') return;
      seen[LABELS[k]||k]=true;
      items.push([LABELS[k]||k, String(t[k])]);
    });
    var cmdDetail = '';
    if(items.length){
      cmdDetail = '<div class="cmd-detail">'
        +'<div class="cmd-detail-title">üìã D√©tails de la commande</div>'
        +items.map(function(kv){ return '<div class="cmd-item"><span class="cmd-item-label">'+kv[0]+'</span><span class="cmd-item-val">'+kv[1]+'</span></div>'; }).join('')
        +'</div>';
    }

    // Boutons selon statut ‚Äî flux : Assign√©e ‚Üí Confirm√©e (par l'agent) ‚Üí En cours ‚Üí Termin√©e
    var actions = '';
    if(isAss){
      // La commande vient d'atterrir : l'agent confirme la r√©ception
      actions += '<button class="btn-confirm" data-action="confirmer" data-id="'+t.id+'">üì¨ Confirmer la mission</button>';
    }
    if(isConf){
      // L'agent a confirm√©, il peut d√©marrer
      actions += '<button class="btn-start" data-action="demarrer" data-id="'+t.id+'">üöÄ D√©marrer la mission</button>';
    }
    if(isProg){
      actions += '<button class="btn-done" data-action="terminer" data-id="'+t.id+'">‚úÖ Marquer comme termin√©e</button>';
    }

    // Bouton t√©l√©phone
    if(t.phone||t.clientTel){
      actions += '<a class="btn-call" href="tel:'+(t.phone||t.clientTel)+'">üìû Appeler</a>';
    }

    // Bouton localisation (Google Maps + Waze)
    var adresse = t.adresseLivraison||t.adresse||t.clientVille||'';
    if(adresse){
      var mapsUrl = 'https://maps.google.com/?q='+encodeURIComponent(adresse);
      var wazeUrl = 'https://waze.com/ul?q='+encodeURIComponent(adresse)+'&navigate=yes';
      actions += '<a class="btn-locate" href="'+mapsUrl+'" target="_blank">üó∫Ô∏è Maps</a>'
               +'<a class="btn-locate" href="'+wazeUrl+'" target="_blank" style="background:linear-gradient(135deg,#005AFF,#00C0FF)">üöó Waze</a>';
    }

    return '<div class="'+cardCls+'">'
      +'<div class="tc-head">'
        +'<div><div class="tc-service">'+(t.serviceName||t.service||'Mission')+'</div>'
        +'<div class="tc-ref">#'+(t.id||'').slice(0,8).toUpperCase()+'</div></div>'
        +'<div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px">'
          +'<span class="pill '+pillSt+'">'+t.statut+'</span>'
          +'<span class="pill '+pillPr+'">'+(t.priorite||'Normale')+'</span>'
        +'</div>'
      +'</div>'
      +cmdDetail
      +'<div class="tc-body">'
        +'<div class="tc-row"><span class="tc-ico">üë§</span><span style="color:var(--light)">Client :</span> <span class="tc-val">'+(t.clientNom||t.nomClient||'‚Äî')+'</span></div>'
        +(t.phone||t.clientTel?'<div class="tc-row"><span class="tc-ico">üìû</span><a href="tel:'+(t.phone||t.clientTel)+'" style="color:var(--acc);font-weight:700;font-size:12px">'+(t.phone||t.clientTel)+'</a></div>':'')
        +(adresse?'<div class="tc-row"><span class="tc-ico">üìç</span><span class="tc-val">'+adresse+'</span></div>':'')
      +'</div>'
      +(t.noteAgent?'<div class="tc-note"><div class="tc-note-label">üìå Note des Op√©rations</div>'+t.noteAgent+'</div>':'')
      +'<div class="tc-actions">'+actions+'</div>'
      +'</div>';
  }).join('');

  // Attacher les actions
  el.querySelectorAll('[data-action]').forEach(function(btn){
    btn.addEventListener('click', function(){
      var id = btn.dataset.id;
      var action = btn.dataset.action;
      // Flux : Assign√©e ‚Üí [agent confirme] ‚Üí Confirm√©e (ops re√ßoit confirmation) ‚Üí En cours ‚Üí Termin√©e
      if(action === 'confirmer') doAction(id, 'Confirm√©e', 'üì¨ Mission confirm√©e ! Les op√©rations ont √©t√© notifi√©es.', '#1E6FBE');
      if(action === 'demarrer')  doAction(id, 'En cours',  'üöÄ Mission d√©marr√©e !', '#E65100');
      if(action === 'terminer')  doAction(id, 'Termin√©e',  '‚úÖ Mission termin√©e ! Bravo üéâ', '#2E7D32');
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê SON DE NOTIFICATION ‚ïê‚ïê‚ïê‚ïê
var _audioCtx = null;
function getAudioCtx(){
  if(!_audioCtx){
    try{ _audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){}
  }
  if(_audioCtx && _audioCtx.state==='suspended'){
    _audioCtx.resume();
  }
  return _audioCtx;
}
// D√©bloquer l'audio d√®s la premi√®re interaction utilisateur
document.addEventListener('click', function unblock(){
  getAudioCtx();
  document.removeEventListener('click', unblock);
}, {once:true});

function playNotifSound(type){
  try{
    var ctx = getAudioCtx();
    if(!ctx) return;
    function beep(freq, startT, dur, vol){
      var o = ctx.createOscillator();
      var g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.frequency.value = freq;
      o.type = 'sine';
      g.gain.setValueAtTime(vol||0.3, startT);
      g.gain.exponentialRampToValueAtTime(0.001, startT+dur);
      o.start(startT); o.stop(startT+dur+0.01);
    }
    var t = ctx.currentTime;
    if(type==='new'){
      beep(520, t,       0.12, 0.4);
      beep(780, t+0.15,  0.15, 0.4);
    } else {
      beep(660, t, 0.18, 0.28);
    }
  }catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê ANNONCES (depuis les Op√©rations) ‚ïê‚ïê‚ïê‚ïê
function loadAnnoncesAgent(){
  var role = currentAgent ? currentAgent.role : null;
  db.collection('annonces_ops').get().then(function(snap){
    var all = snap.docs.map(function(d){ return Object.assign({id:d.id}, d.data()); });
    // Filtrer selon cible
    var filtered = all.filter(function(a){
      return a.cible === 'tous' || a.cible === role;
    });
    filtered.sort(function(a,b){
      return (b.createdAt&&b.createdAt.toMillis?b.createdAt.toMillis():0)
            -(a.createdAt&&a.createdAt.toMillis?a.createdAt.toMillis():0);
    });
    var sec = document.getElementById('annonces-agent-section');
    var lst = document.getElementById('annonces-agent-list');
    if(!filtered.length){ sec.style.display='none'; return; }
    sec.style.display='block';
    lst.innerHTML = filtered.map(function(a){
      var d='';
      try{ d = a.createdAt?a.createdAt.toDate().toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'}):''; }catch(e){}
      return '<div class="ann-card">'
        +'<div class="ann-card-title">üì£ '+(a.titre||'‚Äî')+'</div>'
        +'<div class="ann-card-body">'+(a.message||'')+'</div>'
        +'<div class="ann-card-date">'+d+'</div>'
        +'</div>';
    }).join('');
  }).catch(function(e){ console.warn('Annonces:', e.message); });
}

// ‚ïê‚ïê‚ïê‚ïê NOTIFICATIONS (√©coute en temps r√©el des nouvelles commandes assign√©es) ‚ïê‚ïê‚ïê‚ïê
var unsubNotif = null;
var seenNotifs = {};
function listenNotifications(){
  if(unsubNotif) unsubNotif();
  if(!currentAgent) return;
  unsubNotif = db.collection('commandes').where('agentId','==',currentAgent.id)
    .onSnapshot(function(snap){
      var newNotifs = [];
      snap.docChanges().forEach(function(change){
        var d = Object.assign({id:change.doc.id}, change.doc.data());
        // Nouvelle t√¢che assign√©e
        if(change.type==='added' && d.statut==='Assign√©e' && !seenNotifs[d.id]){
          seenNotifs[d.id]=true;
          newNotifs.push({type:'new', data:d});
        }
        // Changement de statut
        if(change.type==='modified'){
          var key = d.id+'_'+d.statut;
          if(!seenNotifs[key]){
            seenNotifs[key]=true;
            newNotifs.push({type:'update', data:d});
          }
        }
      });
      if(newNotifs.length){
        document.getElementById('notif-dot').classList.add('on');
        newNotifs.forEach(function(n){
          if(n.type==='new'){
            playNotifSound('new');
            showToast('üì© Nouvelle mission assign√©e : '+(n.data.serviceName||n.data.service||''),'#1E6FBE');
          } else {
            playNotifSound('update');
          }
        });
        // Recharger les t√¢ches si n√©cessaire
        snap.docs.forEach(function(d){ 
          var existing = myTasks.find(function(t){ return t.id===d.id; });
          var fresh = Object.assign({id:d.id}, d.data());
          if(existing){ Object.assign(existing, fresh); } else { myTasks.push(fresh); }
        });
        updateKPIs(); renderTasks();
      }
      renderNotifPanel(snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); }));
    });
}

function renderNotifPanel(tasks){
  var body = document.getElementById('notif-body');
  var recent = tasks.filter(function(t){ return t.statut==='Assign√©e'||t.statut==='Confirm√©e'||t.statut==='En cours'; });
  if(!recent.length){ body.innerHTML='<div style="padding:24px;text-align:center;font-size:12px;color:var(--light)">Aucune notification.</div>'; return; }
  body.innerHTML = recent.map(function(t){
    var ico = t.statut==='Assign√©e'?'üì©':t.statut==='Confirm√©e'?'üì¨':t.statut==='En cours'?'üöÄ':'‚úÖ';
    return '<div class="notif-item unread">'
      +'<div class="notif-item-title">'+ico+' '+(t.serviceName||t.service||'Mission')+'</div>'
      +'<div class="notif-item-body">Client : '+(t.clientNom||t.nomClient||'‚Äî')+'<br/>Statut : '+t.statut+'</div>'
      +'</div>';
  }).join('');
}

// ‚îÄ‚îÄ Notification panel toggle ‚îÄ‚îÄ
document.getElementById('notif-btn').addEventListener('click', function(){
  var panel = document.getElementById('notif-panel');
  panel.classList.toggle('show');
  document.getElementById('notif-dot').classList.remove('on');
});
document.getElementById('notif-close').addEventListener('click', function(){
  document.getElementById('notif-panel').classList.remove('show');
});

// ‚ïê‚ïê‚ïê‚ïê ACTION ‚ïê‚ïê‚ïê‚ïê
function doAction(id, newStatut, msg, color){
  db.collection('commandes').doc(id).update({
    statut: newStatut,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(function(){
    var t = myTasks.find(function(x){ return x.id === id; });
    if(t) t.statut = newStatut;
    updateKPIs();
    renderTasks();
    showToast(msg, color);
  }).catch(function(e){ showToast('‚ùå '+e.message, '#C62828'); });
}

// ‚ïê‚ïê‚ïê‚ïê COMMUNICATION UI ‚ïê‚ïê‚ïê‚ïê
var COMM_SECS = ['bandeaux','articles','catalogue','services','masquer'];

function showCommUI(agent){
  document.getElementById('comm-ui').style.display='block';
  document.getElementById('comm-name').textContent = agent.nom||'Agent';
  document.getElementById('comm-welcome-name').textContent = agent.nom||'Agent Communication';
  loadCommSection('bandeaux');
}

function loadCommSection(sec){
  COMM_SECS.forEach(function(s){
    var el=document.getElementById('comm-section-'+s);
    if(el) el.style.display = s===sec?'block':'none';
  });
  document.querySelectorAll('[data-comm]').forEach(function(b){ b.classList.toggle('on', b.dataset.comm===sec); });
  if(sec==='bandeaux')   loadCommBandeaux();
  if(sec==='articles')   loadCommArticles();
  if(sec==='catalogue')  loadCommCatalogue();
  if(sec==='services')   loadCommServices();
  if(sec==='masquer')    loadCommMasquer();
}

document.querySelectorAll('[data-comm]').forEach(function(btn){
  btn.addEventListener('click', function(){ loadCommSection(btn.dataset.comm); });
});

document.getElementById('comm-quit-btn').addEventListener('click', function(){
  currentAgent=null; myTasks=[];
  document.getElementById('comm-ui').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  clearCode();
});

// ‚îÄ‚îÄ Close comm modals ‚îÄ‚îÄ
document.querySelectorAll('[data-comm-close]').forEach(function(btn){
  btn.addEventListener('click', function(){
    document.getElementById('comm-modal-'+btn.dataset.commClose).classList.remove('show');
  });
});

// ‚îÄ‚îÄ Bandeaux ‚îÄ‚îÄ
function loadCommBandeaux(){
  var el=document.getElementById('comm-bandeaux-list');
  el.innerHTML='<div class="empty-box"><div class="spinner"></div></div>';
  db.collection('bandeaux').get().then(function(snap){
    var list=snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
    if(!list.length){ el.innerHTML='<div class="empty-box"><div class="empty-ico">üñºÔ∏è</div><div class="empty-txt">Aucun bandeau.</div></div>'; return; }
    el.innerHTML=list.map(function(b){
      return '<div style="background:#fff;border-radius:14px;padding:16px;box-shadow:var(--sh);margin-bottom:12px;border-left:4px solid '+(b.couleur||'#1E6FBE')+'">'
        +'<div style="display:flex;justify-content:space-between;align-items:flex-start">'
        +'<div><div style="font-size:14px;font-weight:700;color:var(--dark)">'+(b.titre||'‚Äî')+'</div>'
        +'<div style="font-size:12px;color:var(--mid);margin-top:3px">'+(b.soustitre||'')+'</div>'
        +(b.actif===false?'<span style="font-size:10px;background:#FFEBEE;color:var(--red);border-radius:4px;padding:2px 7px;margin-top:5px;display:inline-block">Masqu√©</span>':'<span style="font-size:10px;background:#E8F5E9;color:var(--green);border-radius:4px;padding:2px 7px;margin-top:5px;display:inline-block">Visible</span>')
        +'</div>'
        +'<div style="display:flex;gap:6px">'
        +'<button class="btn-call" style="padding:7px 12px;font-size:11px" data-edit-bandeau="'+b.id+'">‚úèÔ∏è</button>'
        +'<button style="background:#FFEBEE;color:var(--red);border:none;border-radius:8px;padding:7px 10px;cursor:pointer;font-size:12px" data-toggle-bandeau="'+b.id+'" data-actif="'+(b.actif===false?'true':'false')+'">'+(b.actif===false?'üëÅÔ∏è':'üôà')+'</button>'
        +'<button style="background:#FFEBEE;color:var(--red);border:none;border-radius:8px;padding:7px 10px;cursor:pointer;font-size:12px" data-del-bandeau="'+b.id+'">üóëÔ∏è</button>'
        +'</div></div></div>';
    }).join('');
    el.querySelectorAll('[data-edit-bandeau]').forEach(function(btn){
      btn.addEventListener('click',function(){ openCommModal('bandeau', btn.dataset.editBandeau); });
    });
    el.querySelectorAll('[data-toggle-bandeau]').forEach(function(btn){
      btn.addEventListener('click',function(){
        var actif = btn.dataset.actif==='true';
        db.collection('bandeaux').doc(btn.dataset.toggleBandeau).update({actif:actif})
          .then(function(){ loadCommBandeaux(); showToast(actif?'üëÅÔ∏è Affich√©':'üôà Masqu√©','#2E7D32'); });
      });
    });
    el.querySelectorAll('[data-del-bandeau]').forEach(function(btn){
      btn.addEventListener('click',function(){
        if(!confirm('Supprimer ce bandeau ?')) return;
        db.collection('bandeaux').doc(btn.dataset.delBandeau).delete().then(function(){ loadCommBandeaux(); showToast('üóëÔ∏è Supprim√©','#C62828'); });
      });
    });
  });
}

document.getElementById('comm-btn-new-bandeau').addEventListener('click',function(){ openCommModal('bandeau',null); });
document.getElementById('cb-save').addEventListener('click',function(){
  var titre=document.getElementById('cb-titre').value.trim();
  var err=document.getElementById('cb-err'); err.textContent='';
  if(!titre){ err.textContent='‚ö†Ô∏è Titre obligatoire.'; return; }
  var data={titre:titre,soustitre:document.getElementById('cb-subtxt').value.trim(),imageUrl:document.getElementById('cb-img').value.trim(),couleur:document.getElementById('cb-color').value,actif:true,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
  var id=document.getElementById('cb-id').value;
  var p=id?db.collection('bandeaux').doc(id).update(data):db.collection('bandeaux').add(Object.assign({createdAt:firebase.firestore.FieldValue.serverTimestamp()},data));
  p.then(function(){ document.getElementById('comm-modal-bandeau').classList.remove('show'); loadCommBandeaux(); showToast('üíæ Bandeau enregistr√©','#2E7D32'); })
   .catch(function(e){ err.textContent='‚ùå '+e.message; });
});

// ‚îÄ‚îÄ Articles ‚îÄ‚îÄ
function loadCommArticles(){
  var el=document.getElementById('comm-articles-list');
  el.innerHTML='<div class="empty-box"><div class="spinner"></div></div>';
  db.collection('articles').get().then(function(snap){
    var list=snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
    if(!list.length){ el.innerHTML='<div class="empty-box"><div class="empty-ico">üì∞</div><div class="empty-txt">Aucun article.</div></div>'; return; }
    el.innerHTML=list.map(function(a){
      return '<div style="background:#fff;border-radius:14px;padding:16px;box-shadow:var(--sh);margin-bottom:12px;border-left:4px solid #1E6FBE">'
        +'<div style="display:flex;justify-content:space-between;align-items:flex-start">'
        +'<div><div style="font-size:14px;font-weight:700;color:var(--dark)">'+(a.titre||'‚Äî')+'</div>'
        +'<div style="font-size:11px;color:var(--mid);margin-top:3px;max-height:40px;overflow:hidden">'+(a.contenu||'').substring(0,100)+'‚Ä¶</div>'
        +(a.actif===false?'<span style="font-size:10px;background:#FFEBEE;color:var(--red);border-radius:4px;padding:2px 7px;margin-top:5px;display:inline-block">Masqu√©</span>':'<span style="font-size:10px;background:#E8F5E9;color:var(--green);border-radius:4px;padding:2px 7px;margin-top:5px;display:inline-block">Visible</span>')
        +'</div>'
        +'<div style="display:flex;gap:6px">'
        +'<button class="btn-call" style="padding:7px 12px;font-size:11px" data-edit-article="'+a.id+'">‚úèÔ∏è</button>'
        +'<button style="background:#FFEBEE;color:var(--red);border:none;border-radius:8px;padding:7px 10px;cursor:pointer;font-size:12px" data-toggle-article="'+a.id+'" data-actif="'+(a.actif===false?'true':'false')+'">'+(a.actif===false?'üëÅÔ∏è':'üôà')+'</button>'
        +'<button style="background:#FFEBEE;color:var(--red);border:none;border-radius:8px;padding:7px 10px;cursor:pointer;font-size:12px" data-del-article="'+a.id+'">üóëÔ∏è</button>'
        +'</div></div></div>';
    }).join('');
    el.querySelectorAll('[data-edit-article]').forEach(function(btn){ btn.addEventListener('click',function(){ openCommModal('article', btn.dataset.editArticle); }); });
    el.querySelectorAll('[data-toggle-article]').forEach(function(btn){
      btn.addEventListener('click',function(){
        db.collection('articles').doc(btn.dataset.toggleArticle).update({actif:btn.dataset.actif==='true'}).then(function(){ loadCommArticles(); });
      });
    });
    el.querySelectorAll('[data-del-article]').forEach(function(btn){
      btn.addEventListener('click',function(){
        if(!confirm('Supprimer cet article ?')) return;
        db.collection('articles').doc(btn.dataset.delArticle).delete().then(function(){ loadCommArticles(); showToast('üóëÔ∏è Supprim√©','#C62828'); });
      });
    });
  });
}
document.getElementById('comm-btn-new-article').addEventListener('click',function(){ openCommModal('article',null); });
document.getElementById('ca-save').addEventListener('click',function(){
  var titre=document.getElementById('ca-titre').value.trim(), contenu=document.getElementById('ca-contenu').value.trim();
  var err=document.getElementById('ca-err'); err.textContent='';
  if(!titre||!contenu){ err.textContent='‚ö†Ô∏è Titre et contenu obligatoires.'; return; }
  var data={titre:titre,contenu:contenu,imageUrl:document.getElementById('ca-img').value.trim(),actif:true,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
  var id=document.getElementById('ca-id').value;
  var p=id?db.collection('articles').doc(id).update(data):db.collection('articles').add(Object.assign({createdAt:firebase.firestore.FieldValue.serverTimestamp()},data));
  p.then(function(){ document.getElementById('comm-modal-article').classList.remove('show'); loadCommArticles(); showToast('üì∞ Article publi√©','#2E7D32'); })
   .catch(function(e){ err.textContent='‚ùå '+e.message; });
});

// ‚îÄ‚îÄ Catalogue / Prix ‚îÄ‚îÄ
function loadCommCatalogue(){
  var el=document.getElementById('comm-catalogue-list');
  el.innerHTML='<div class="empty-box"><div class="spinner"></div></div>';
  db.collection('catalogue').get().then(function(snap){
    var list=snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
    if(!list.length){ el.innerHTML='<div class="empty-box"><div class="empty-ico">üì¶</div><div class="empty-txt">Aucun produit.</div></div>'; return; }
    el.innerHTML='<div style="background:#fff;border-radius:14px;box-shadow:var(--sh);overflow:hidden">'
      +'<div style="display:grid;grid-template-columns:1fr 130px 120px 80px;padding:10px 16px;background:var(--bg);font-size:10px;font-weight:700;color:var(--light);text-transform:uppercase;border-bottom:1px solid var(--border)"><div>Produit</div><div>Cat√©gorie</div><div>Prix</div><div></div></div>'
      +list.map(function(p){
        return '<div style="display:grid;grid-template-columns:1fr 130px 120px 80px;padding:13px 16px;border-bottom:1px solid var(--border);align-items:center;font-size:12px">'
          +'<div><div style="font-weight:700;color:var(--dark)">'+(p.nom||'‚Äî')+'</div><div style="font-size:11px;color:var(--light)">'+(p.description||'').substring(0,60)+'</div>'+(p.actif===false?'<span style="font-size:10px;color:var(--red)">Masqu√©</span>':'')+'</div>'
          +'<div style="color:var(--mid)">'+(p.categorie||'‚Äî')+'</div>'
          +'<div style="font-weight:700;color:var(--dark)">'+(p.prix||'‚Äî')+'</div>'
          +'<div style="display:flex;gap:4px">'
          +'<button class="btn-call" style="padding:5px 9px;font-size:11px" data-edit-produit="'+p.id+'">‚úèÔ∏è</button>'
          +'<button style="background:#FFEBEE;color:var(--red);border:none;border-radius:7px;padding:5px 8px;cursor:pointer" data-del-produit="'+p.id+'">üóëÔ∏è</button>'
          +'</div></div>';
      }).join('')+'</div>';
    el.querySelectorAll('[data-edit-produit]').forEach(function(btn){ btn.addEventListener('click',function(){ openCommModal('produit',btn.dataset.editProduit); }); });
    el.querySelectorAll('[data-del-produit]').forEach(function(btn){
      btn.addEventListener('click',function(){
        if(!confirm('Supprimer ?')) return;
        db.collection('catalogue').doc(btn.dataset.delProduit).delete().then(function(){ loadCommCatalogue(); showToast('üóëÔ∏è Supprim√©','#C62828'); });
      });
    });
  });
}
document.getElementById('comm-btn-new-produit').addEventListener('click',function(){ openCommModal('produit',null); });
document.getElementById('cp-save').addEventListener('click',function(){
  var nom=document.getElementById('cp-nom').value.trim(), prix=document.getElementById('cp-prix').value.trim();
  var err=document.getElementById('cp-err'); err.textContent='';
  if(!nom||!prix){ err.textContent='‚ö†Ô∏è Nom et prix obligatoires.'; return; }
  var data={nom:nom,prix:prix,categorie:document.getElementById('cp-cat').value.trim(),description:document.getElementById('cp-desc').value.trim(),actif:true,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
  var id=document.getElementById('cp-id').value;
  var p=id?db.collection('catalogue').doc(id).update(data):db.collection('catalogue').add(Object.assign({createdAt:firebase.firestore.FieldValue.serverTimestamp()},data));
  p.then(function(){ document.getElementById('comm-modal-produit').classList.remove('show'); loadCommCatalogue(); showToast('üíæ Produit enregistr√©','#2E7D32'); })
   .catch(function(e){ err.textContent='‚ùå '+e.message; });
});

// ‚îÄ‚îÄ Services ‚îÄ‚îÄ
function loadCommServices(){
  var el=document.getElementById('comm-services-list');
  el.innerHTML='<div class="empty-box"><div class="spinner"></div></div>';
  db.collection('services').get().then(function(snap){
    var list=snap.docs.map(function(d){ return Object.assign({id:d.id},d.data()); });
    if(!list.length){ el.innerHTML='<div class="empty-box"><div class="empty-ico">‚öôÔ∏è</div><div class="empty-txt">Aucun service.</div></div>'; return; }
    el.innerHTML=list.map(function(s){
      return '<div style="background:#fff;border-radius:14px;padding:16px;box-shadow:var(--sh);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;gap:12px">'
        +'<div style="display:flex;align-items:center;gap:12px">'
        +'<div style="font-size:28px">'+(s.icone||'‚öôÔ∏è')+'</div>'
        +'<div><div style="font-size:14px;font-weight:700;color:var(--dark)">'+(s.nom||'‚Äî')+'</div><div style="font-size:11px;color:var(--mid)">'+(s.description||'')+'</div><div style="font-size:11px;color:var(--acc);font-weight:700;margin-top:2px">'+(s.prix||'')+'</div>'+(s.actif===false?'<span style="font-size:10px;color:var(--red)">Masqu√©</span>':'')+'</div>'
        +'</div>'
        +'<div style="display:flex;gap:5px">'
        +'<button class="btn-call" style="padding:7px 11px;font-size:11px" data-edit-service="'+s.id+'">‚úèÔ∏è</button>'
        +'<button style="background:#FFEBEE;color:var(--red);border:none;border-radius:8px;padding:7px 10px;cursor:pointer" data-toggle-service="'+s.id+'" data-actif="'+(s.actif===false?'true':'false')+'">'+(s.actif===false?'üëÅÔ∏è':'üôà')+'</button>'
        +'<button style="background:#FFEBEE;color:var(--red);border:none;border-radius:8px;padding:7px 10px;cursor:pointer" data-del-service="'+s.id+'">üóëÔ∏è</button>'
        +'</div></div>';
    }).join('');
    el.querySelectorAll('[data-edit-service]').forEach(function(btn){ btn.addEventListener('click',function(){ openCommModal('service',btn.dataset.editService); }); });
    el.querySelectorAll('[data-toggle-service]').forEach(function(btn){
      btn.addEventListener('click',function(){
        db.collection('services').doc(btn.dataset.toggleService).update({actif:btn.dataset.actif==='true'}).then(function(){ loadCommServices(); });
      });
    });
    el.querySelectorAll('[data-del-service]').forEach(function(btn){
      btn.addEventListener('click',function(){
        if(!confirm('Supprimer ?')) return;
        db.collection('services').doc(btn.dataset.delService).delete().then(function(){ loadCommServices(); showToast('üóëÔ∏è Supprim√©','#C62828'); });
      });
    });
  });
}
document.getElementById('comm-btn-new-service').addEventListener('click',function(){ openCommModal('service',null); });
document.getElementById('cs-save').addEventListener('click',function(){
  var nom=document.getElementById('cs-nom').value.trim();
  var err=document.getElementById('cs-err'); err.textContent='';
  if(!nom){ err.textContent='‚ö†Ô∏è Nom obligatoire.'; return; }
  var data={nom:nom,icone:document.getElementById('cs-ico').value.trim()||'‚öôÔ∏è',description:document.getElementById('cs-desc').value.trim(),prix:document.getElementById('cs-prix').value.trim(),actif:true,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
  var id=document.getElementById('cs-id').value;
  var p=id?db.collection('services').doc(id).update(data):db.collection('services').add(Object.assign({createdAt:firebase.firestore.FieldValue.serverTimestamp()},data));
  p.then(function(){ document.getElementById('comm-modal-service').classList.remove('show'); loadCommServices(); showToast('üíæ Service enregistr√©','#2E7D32'); })
   .catch(function(e){ err.textContent='‚ùå '+e.message; });
});

// ‚îÄ‚îÄ Masquer / Visibilit√© ‚îÄ‚îÄ
function loadCommMasquer(){
  var el=document.getElementById('comm-masquer-list');
  el.innerHTML='<div class="empty-box"><div class="spinner"></div></div>';
  var collections=[{key:'bandeaux',label:'üñºÔ∏è Bandeaux'},{key:'articles',label:'üì∞ Articles'},{key:'catalogue',label:'üì¶ Catalogue'},{key:'services',label:'‚öôÔ∏è Services'}];
  var allItems=[];
  var pending=collections.length;
  collections.forEach(function(c){
    db.collection(c.key).get().then(function(snap){
      snap.docs.forEach(function(d){ allItems.push(Object.assign({id:d.id,_collection:c.key,_label:c.label},d.data())); });
      pending--;
      if(pending===0) renderMasquer(el,allItems);
    }).catch(function(){ pending--; if(pending===0) renderMasquer(el,allItems); });
  });
}
function renderMasquer(el,items){
  if(!items.length){ el.innerHTML='<div class="empty-box"><div class="empty-txt">Aucun √©l√©ment.</div></div>'; return; }
  el.innerHTML='<div style="background:#fff;border-radius:14px;box-shadow:var(--sh);overflow:hidden">'
    +items.map(function(item){
      var visible=item.actif!==false;
      return '<div style="display:flex;align-items:center;justify-content:space-between;padding:13px 16px;border-bottom:1px solid var(--border);font-size:12px">'
        +'<div>'
        +'<span style="font-size:10px;background:var(--bg);border-radius:4px;padding:2px 7px;color:var(--mid);font-weight:600;margin-right:8px">'+item._label+'</span>'
        +'<span style="font-weight:700;color:var(--dark)">'+(item.titre||item.nom||'‚Äî')+'</span>'
        +'</div>'
        +'<button style="background:'+(visible?'#FFF3E0':'#E8F5E9')+';color:'+(visible?'#E65100':'var(--green)')+';border:none;border-radius:8px;padding:7px 14px;font-size:11px;font-weight:700;cursor:pointer" data-toggle-vis="'+item.id+'" data-col="'+item._collection+'" data-actif="'+visible+'">'+(visible?'üôà Masquer':'üëÅÔ∏è Afficher')+'</button>'
        +'</div>';
    }).join('')+'</div>';
  el.querySelectorAll('[data-toggle-vis]').forEach(function(btn){
    btn.addEventListener('click',function(){
      var newVal=btn.dataset.actif==='true'?false:true;
      db.collection(btn.dataset.col).doc(btn.dataset.toggleVis).update({actif:newVal})
        .then(function(){ loadCommMasquer(); showToast(newVal?'üëÅÔ∏è Affich√©':'üôà Masqu√©','#2E7D32'); });
    });
  });
}

// ‚îÄ‚îÄ Open Comm Modal (create or edit) ‚îÄ‚îÄ
function openCommModal(type, id){
  var modal=document.getElementById('comm-modal-'+type);
  // Reset
  if(type==='bandeau'){ document.getElementById('cb-id').value=''; document.getElementById('cb-titre').value=''; document.getElementById('cb-subtxt').value=''; document.getElementById('cb-img').value=''; document.getElementById('cb-color').value='#1E6FBE'; document.getElementById('cb-err').textContent=''; }
  if(type==='article'){ document.getElementById('ca-id').value=''; document.getElementById('ca-titre').value=''; document.getElementById('ca-contenu').value=''; document.getElementById('ca-img').value=''; document.getElementById('ca-err').textContent=''; }
  if(type==='produit'){ document.getElementById('cp-id').value=''; document.getElementById('cp-nom').value=''; document.getElementById('cp-prix').value=''; document.getElementById('cp-cat').value=''; document.getElementById('cp-desc').value=''; document.getElementById('cp-err').textContent=''; }
  if(type==='service'){ document.getElementById('cs-id').value=''; document.getElementById('cs-nom').value=''; document.getElementById('cs-ico').value=''; document.getElementById('cs-desc').value=''; document.getElementById('cs-prix').value=''; document.getElementById('cs-err').textContent=''; }

  if(id){
    var colMap={bandeau:'bandeaux',article:'articles',produit:'catalogue',service:'services'};
    db.collection(colMap[type]).doc(id).get().then(function(d){
      if(!d.exists) return;
      var data=d.data();
      if(type==='bandeau'){ document.getElementById('cb-id').value=id; document.getElementById('cb-titre').value=data.titre||''; document.getElementById('cb-subtxt').value=data.soustitre||''; document.getElementById('cb-img').value=data.imageUrl||''; document.getElementById('cb-color').value=data.couleur||'#1E6FBE'; }
      if(type==='article'){ document.getElementById('ca-id').value=id; document.getElementById('ca-titre').value=data.titre||''; document.getElementById('ca-contenu').value=data.contenu||''; document.getElementById('ca-img').value=data.imageUrl||''; }
      if(type==='produit'){ document.getElementById('cp-id').value=id; document.getElementById('cp-nom').value=data.nom||''; document.getElementById('cp-prix').value=data.prix||''; document.getElementById('cp-cat').value=data.categorie||''; document.getElementById('cp-desc').value=data.description||''; }
      if(type==='service'){ document.getElementById('cs-id').value=id; document.getElementById('cs-nom').value=data.nom||''; document.getElementById('cs-ico').value=data.icone||''; document.getElementById('cs-desc').value=data.description||''; document.getElementById('cs-prix').value=data.prix||''; }
    });
  }
  modal.classList.add('show');
}

// ‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê
function showToast(msg, bg){
  var t = document.getElementById('toast');
  t.textContent = msg; t.style.background = bg||'#1A1A2E';
  t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 3200);
}
</script>
</body>
</html>
