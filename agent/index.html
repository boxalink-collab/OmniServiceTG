<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>OmniService TG ‚Äî Agent</title>
<meta name="theme-color" content="#1A1A2E"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Agent OmniTG"/>
<link rel="manifest" href="manifest.json"/>
<link rel="icon" href="../assets/logo.png" type="image/png"/>
<link rel="apple-touch-icon" href="../assets/logo.png"/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>

<!-- Firebase SDK compat ‚Äî pas de module ES6 -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --dark:#1A1A2E;--mid:#4A4A6A;--light:#9999BB;--border:#E8EAF0;--bg:#F4F6FA;
  --green:#2E7D32;--red:#C62828;--ora:#F5820A;
  --acc:#1E6FBE;--acc-d:#155A9C;--acc-s:rgba(30,111,190,.1);
  --orange:#E65100;--orange-s:rgba(230,81,0,.1);
  --sh:0 2px 12px rgba(0,0,0,.07);
}
html,body{height:100%;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--dark);}

/* ‚ïê‚ïê SPLASH ‚ïê‚ïê */
#splash{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(145deg,#0a1628,#1E6FBE 55%,#0a1628);}
#splash::before{content:'';position:absolute;inset:0;
  background-image:linear-gradient(rgba(255,255,255,.025) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,255,255,.025) 1px,transparent 1px);
  background-size:40px 40px;}
.sp-o{position:absolute;border-radius:50%;pointer-events:none;}
.sp-o1{width:400px;height:400px;top:-100px;right:-90px;
  background:radial-gradient(circle,rgba(30,111,190,.2) 0%,transparent 70%);
  animation:spO 4s ease-in-out infinite alternate;}
.sp-o2{width:300px;height:300px;bottom:-80px;left:-70px;
  background:radial-gradient(circle,rgba(30,111,190,.3) 0%,transparent 70%);
  animation:spO 4s ease-in-out infinite alternate-reverse;}
@keyframes spO{from{transform:scale(1)}to{transform:scale(1.18) translate(8px,-8px)}}
.sp-c{position:relative;z-index:2;text-align:center;padding:32px;}
.sp-badge{display:inline-block;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);
  border-radius:999px;padding:5px 16px;font-size:10px;font-weight:800;letter-spacing:1.5px;
  color:rgba(255,255,255,.8);text-transform:uppercase;margin-bottom:20px;animation:spFu .5s .3s both;}
.sp-logo{width:100px;height:100px;border-radius:26px;margin:0 auto 20px;
  background:rgba(255,255,255,.12);border:1.5px solid rgba(255,255,255,.2);
  display:flex;align-items:center;justify-content:center;overflow:hidden;animation:spPi .8s .4s both;}
.sp-logo img{width:76px;height:76px;object-fit:contain;}
.sp-title{font-family:'Nunito',sans-serif;font-size:30px;font-weight:900;color:#fff;margin-bottom:4px;animation:spFu .6s .8s both;}
.sp-title .o{color:var(--ora)}
.sp-tag{font-size:11px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px;animation:spFu .6s 1s both;}
.sp-bar{width:200px;height:2px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden;margin:24px auto 0;animation:spFu .5s 1.2s both;}
.sp-bar-f{height:100%;background:linear-gradient(90deg,rgba(30,111,190,.7),#90CAF9,var(--acc));animation:spBl 1.8s 1.3s both;}
@keyframes spBl{0%{width:0}100%{width:100%}}
@keyframes spFu{from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes spPi{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}

/* ‚ïê‚ïê LOGIN ‚ïê‚ïê */
#login-screen{min-height:100vh;background:linear-gradient(145deg,#0a1628,#1E6FBE 55%,#0a1628);
  display:flex;align-items:center;justify-content:center;padding:20px;}
.lbox{background:#fff;border-radius:24px;padding:36px 28px;width:100%;max-width:380px;
  text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.45);}
.l-logo{width:72px;height:72px;background:linear-gradient(135deg,var(--dark),var(--mid));
  border-radius:18px;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.l-logo img{width:56px;height:56px;object-fit:contain;}
.l-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:var(--dark);margin-bottom:2px;}
.l-role{display:inline-block;background:#E3F2FD;color:var(--acc);font-size:11px;font-weight:700;padding:3px 12px;border-radius:999px;margin-bottom:6px;}
.l-sub{font-size:12px;color:var(--light);margin-bottom:22px;}
.code-row{display:flex;gap:8px;justify-content:center;margin-bottom:18px;}
.code-digit{width:46px;height:56px;border:2px solid var(--border);border-radius:12px;text-align:center;
  font-size:20px;font-weight:800;font-family:'Nunito',sans-serif;color:var(--dark);
  background:var(--bg);outline:none;transition:border-color .2s,background .2s;text-transform:uppercase;}
.code-digit:focus{border-color:var(--acc);background:#fff;box-shadow:0 0 0 3px var(--acc-s);}
.code-digit.filled{border-color:var(--acc);background:var(--acc-s);color:var(--acc);}
.l-btn{width:100%;background:linear-gradient(135deg,var(--acc),var(--acc-d));color:#fff;border:none;
  border-radius:999px;padding:14px;font-size:14px;font-weight:700;cursor:pointer;
  font-family:'Poppins',sans-serif;box-shadow:0 4px 16px var(--acc-s);transition:opacity .2s;}
.l-btn:hover{opacity:.9;}
.l-err{color:var(--red);font-size:12px;font-weight:600;margin-top:10px;min-height:18px;}
.l-info{margin-top:14px;font-size:11px;color:var(--light);background:var(--bg);border-radius:9px;padding:10px 12px;text-align:left;line-height:1.7;}

/* ‚ïê‚ïê INTERFACE AGENT ‚ïê‚ïê */
#agent-ui{display:none;min-height:100vh;background:var(--bg);}
.topbar{background:var(--dark);padding:0 20px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
.tb-left{display:flex;align-items:center;gap:12px;}
.tb-logo{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;overflow:hidden;}
.tb-logo img{width:28px;height:28px;object-fit:contain;}
.tb-brand{font-family:'Nunito',sans-serif;font-size:16px;font-weight:900;color:#fff;}
.tb-brand .o{color:var(--ora)}
.tb-right{display:flex;align-items:center;gap:10px;}
.tb-agent-info{text-align:right;}
.tb-agent-name{font-size:13px;font-weight:700;color:#fff;}
.tb-agent-role{font-size:10px;color:rgba(255,255,255,.4);}
.tb-code{background:rgba(30,111,190,.3);color:#90CAF9;font-size:10px;font-weight:800;font-family:monospace;padding:4px 10px;border-radius:6px;border:1px solid rgba(30,111,190,.4);}
.quit-btn{background:rgba(198,40,40,.2);color:#ff8a80;border:none;border-radius:8px;padding:8px 14px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Poppins',sans-serif;}
.quit-btn:hover{background:rgba(198,40,40,.35);}
.agent-content{max-width:700px;margin:0 auto;padding:28px 20px 56px;}

/* WELCOME */
.welcome-card{background:linear-gradient(135deg,var(--dark),#2A2A4E);border-radius:18px;padding:24px;margin-bottom:24px;color:#fff;position:relative;overflow:hidden;}
.welcome-card::before{content:'';position:absolute;top:-40px;right:-40px;width:180px;height:180px;border-radius:50%;background:rgba(30,111,190,.15);}
.wc-label{font-size:10px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.wc-name{font-family:'Nunito',sans-serif;font-size:26px;font-weight:900;}
.wc-role{font-size:13px;color:rgba(255,255,255,.5);margin-top:4px;}
.wc-zone{display:inline-block;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:4px 12px;font-size:11px;color:rgba(255,255,255,.7);margin-top:10px;}

/* KPI ‚Äî 4 cases */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:24px;}
.kpi-card{background:#fff;border-radius:14px;padding:14px 10px;box-shadow:var(--sh);text-align:center;}
.kpi-val{font-family:'Nunito',sans-serif;font-size:24px;font-weight:900;color:var(--dark);}
.kpi-lbl{font-size:9px;color:var(--light);font-weight:600;margin-top:2px;}
.kpi-card.k-new .kpi-val{color:var(--acc);}
.kpi-card.k-prog .kpi-val{color:var(--orange);}
.kpi-card.k-run .kpi-val{color:#F57F17;}
.kpi-card.k-done .kpi-val{color:var(--green);}

/* FILTRES */
.filter-tabs{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px;}
.ftab{flex-shrink:0;background:#fff;border:1.5px solid var(--border);border-radius:999px;padding:7px 14px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;color:var(--mid);transition:all .15s;white-space:nowrap;}
.ftab.on{background:var(--acc);color:#fff;border-color:var(--acc);}

/* SECTION TITLE */
.sec-title{font-family:'Nunito',sans-serif;font-size:17px;font-weight:900;color:var(--dark);margin-bottom:14px;}

/* TASK CARD */
.task-card{background:#fff;border-radius:16px;padding:20px;box-shadow:var(--sh);margin-bottom:14px;border-left:4px solid var(--border);}
.task-card.s-confirmee{border-left-color:var(--acc);}
.task-card.s-en-cours{border-left-color:var(--orange);}
.task-card.s-terminee{border-left-color:var(--green);opacity:.75;}
.task-card.p-haute{border-left-color:var(--red);}
.tc-head{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;gap:8px;}
.tc-service{font-size:15px;font-weight:700;color:var(--dark);}
.tc-ref{font-size:10px;font-family:monospace;color:var(--acc);font-weight:700;}
.tc-body{display:grid;gap:6px;margin-bottom:14px;}
.tc-row{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--mid);}
.tc-ico{width:20px;text-align:center;flex-shrink:0;}
.tc-val{font-weight:600;color:var(--dark);}
.tc-note{background:#FFF8E1;border-radius:10px;padding:12px;font-size:12px;color:#5D4037;margin-bottom:14px;border-left:3px solid #FFB300;}
.tc-note-label{font-size:10px;font-weight:700;text-transform:uppercase;color:#F9A825;letter-spacing:.5px;margin-bottom:4px;}
.tc-actions{display:flex;gap:8px;flex-wrap:wrap;}

/* BOUTONS D'ACTION ‚Äî 3 √©tats progressifs */
.btn-confirm{background:linear-gradient(135deg,var(--acc),var(--acc-d));color:#fff;border:none;border-radius:999px;padding:10px 20px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;}
.btn-start{background:linear-gradient(135deg,var(--orange),#BF360C);color:#fff;border:none;border-radius:999px;padding:10px 20px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;}
.btn-done{background:linear-gradient(135deg,var(--green),#1B5E20);color:#fff;border:none;border-radius:999px;padding:10px 20px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;}
.btn-call{background:#E3F2FD;color:var(--acc);border-radius:999px;padding:10px 16px;font-size:12px;font-weight:700;text-decoration:none;display:inline-block;}

/* PILLS */
.pill{font-size:10px;font-weight:700;padding:4px 10px;border-radius:999px;display:inline-block;}
.p-conf{background:#E3F2FD;color:#1565C0;}
.p-prog{background:#FFF3E0;color:#E65100;}
.p-run{background:#FFF8E1;color:#F57F17;}
.p-term{background:#E8F5E9;color:var(--green);}
.p-haute{background:#FFEBEE;color:var(--red);}
.p-norm{background:#E3F2FD;color:var(--acc);}
.p-basse{background:#EEE;color:#757575;}

/* EMPTY / LOADING */
.empty-box{background:#fff;border-radius:16px;padding:48px;text-align:center;box-shadow:var(--sh);}
.empty-ico{font-size:40px;margin-bottom:12px;}
.empty-txt{font-size:13px;color:var(--light);line-height:1.6;}
.spinner{display:inline-block;width:28px;height:28px;border:3px solid rgba(30,111,190,.2);border-top-color:var(--acc);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--dark);color:#fff;border-radius:12px;padding:13px 20px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;box-shadow:0 8px 28px rgba(0,0,0,.3);}
.toast.show{opacity:1;}

@media(max-width:480px){
  .topbar{padding:0 14px;}
  .tb-agent-info{display:none;}
  .agent-content{padding:20px 14px 40px;}
  .kpi-row{grid-template-columns:repeat(2,1fr);}
}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-o sp-o1"></div><div class="sp-o sp-o2"></div>
  <div class="sp-c">
    <div class="sp-badge">üèÉ Espace Agent</div>
    <div class="sp-logo"><img src="../assets/logo.png" alt="" onerror="this.parentElement.innerHTML='üèÉ'"/></div>
    <div class="sp-title">Omni<span class="o">Service</span> TG</div>
    <div class="sp-tag">Interface Agent de terrain</div>
    <div class="sp-bar"><div class="sp-bar-f"></div></div>
  </div>
</div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="lbox">
    <div class="l-logo"><img src="../assets/logo.png" alt="" onerror="this.parentElement.innerHTML='üèÉ'"/></div>
    <div class="l-title">OmniService <span style="color:var(--ora)">TG</span></div>
    <div class="l-role">üèÉ Agent de terrain</div>
    <div class="l-sub">Saisissez votre code RH pour acc√©der √† vos missions</div>
    <div class="code-row">
      <input type="text" class="code-digit" maxlength="1" id="cd0" autocomplete="off" inputmode="text"/>
      <input type="text" class="code-digit" maxlength="1" id="cd1" autocomplete="off" inputmode="text"/>
      <input type="text" class="code-digit" maxlength="1" id="cd2" autocomplete="off" inputmode="text"/>
      <input type="text" class="code-digit" maxlength="1" id="cd3" autocomplete="off" inputmode="text"/>
      <input type="text" class="code-digit" maxlength="1" id="cd4" autocomplete="off" inputmode="text"/>
      <input type="text" class="code-digit" maxlength="1" id="cd5" autocomplete="off" inputmode="text"/>
    </div>
    <button class="l-btn" id="login-btn">Acc√©der √† mes missions ‚Üí</button>
    <div class="l-err" id="l-err"></div>
    <div class="l-info"><b>Acc√®s agents uniquement.</b><br/>Votre code RH √† 6 caract√®res vous a √©t√© remis par le service RH lors de votre onboarding.</div>
  </div>
</div>

<!-- INTERFACE AGENT -->
<div id="agent-ui">
  <div class="topbar">
    <div class="tb-left">
      <div class="tb-logo"><img src="../assets/logo.png" alt="" onerror="this.parentElement.innerHTML='üèÉ'"/></div>
      <div class="tb-brand">Omni<span class="o">Service</span></div>
    </div>
    <div class="tb-right">
      <div class="tb-agent-info">
        <div class="tb-agent-name" id="tb-name">‚Äî</div>
        <div class="tb-agent-role" id="tb-role">‚Äî</div>
      </div>
      <div class="tb-code" id="tb-code">‚Äî‚Äî</div>
      <button class="quit-btn" id="quit-btn">üö™ Quitter</button>
    </div>
  </div>

  <div class="agent-content">
    <div class="welcome-card">
      <div style="position:relative;z-index:1">
        <div class="wc-label">Bonjour üëã</div>
        <div class="wc-name" id="wc-name">‚Äî</div>
        <div class="wc-role" id="wc-role">‚Äî</div>
        <div class="wc-zone" id="wc-zone">üìç ‚Äî</div>
      </div>
    </div>

    <!-- KPI 4 cases -->
    <div class="kpi-row">
      <div class="kpi-card k-new"><div class="kpi-val" id="kpi-new">‚Äî</div><div class="kpi-lbl">Nouvelles</div></div>
      <div class="kpi-card k-prog"><div class="kpi-val" id="kpi-conf">‚Äî</div><div class="kpi-lbl">Confirm√©es</div></div>
      <div class="kpi-card k-run"><div class="kpi-val" id="kpi-prog">‚Äî</div><div class="kpi-lbl">En cours</div></div>
      <div class="kpi-card k-done"><div class="kpi-val" id="kpi-done">‚Äî</div><div class="kpi-lbl">Termin√©es</div></div>
    </div>

    <!-- Filtres 4 groupes -->
    <div class="filter-tabs" id="filter-tabs">
      <button class="ftab on" data-tab="actives">üìã Toutes actives</button>
      <button class="ftab" data-tab="Confirm√©e">üì¨ Confirm√©es</button>
      <button class="ftab" data-tab="En cours">üöÄ En cours</button>
      <button class="ftab" data-tab="Termin√©e">‚úÖ Termin√©es</button>
    </div>

    <div class="sec-title" id="sec-title">üìã Mes missions actives</div>
    <div id="tasks-container"><div class="empty-box"><div class="spinner"></div></div></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE CONFIG ‚Äî SDK compat
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
firebase.initializeApp({
  apiKey:"AIzaSyDtDK7-iDRy1E-kjZubjyjkPW7Th33BMyU",
  authDomain:"omniservicetg-59df3.firebaseapp.com",
  projectId:"omniservicetg-59df3",
  storageBucket:"omniservicetg-59df3.firebasestorage.app",
  messagingSenderId:"196278567761",
  appId:"1:196278567761:web:4f6416acaab58b67bf4970"
});
var db = firebase.firestore();

var RL = {livreur:'üõµ Livreur',securite:'üîí Agent s√©curit√©',entretien:'üßπ Agent entretien',depannage:'üîß Agent d√©pannage',commercial:'üíº Agent commercial',comm:'üì¢ Communication',ops:'‚öôÔ∏è Op√©rations'};

var currentAgent = null;
var myTasks      = [];
var currentTab   = 'actives';

// ‚îÄ‚îÄ Splash ‚îÄ‚îÄ
function hideSplash(){
  var s = document.getElementById('splash');
  if(!s||s._g) return; s._g=true;
  s.style.transition='opacity .5s,transform .5s';
  s.style.opacity='0'; s.style.transform='scale(1.03)'; s.style.pointerEvents='none';
  setTimeout(function(){ if(s.parentNode) s.parentNode.removeChild(s); }, 520);
}
setTimeout(hideSplash, 2800);

// ‚ïê‚ïê‚ïê‚ïê CODE INPUT ‚ïê‚ïê‚ïê‚ïê
var digits = [0,1,2,3,4,5].map(function(i){ return document.getElementById('cd'+i); });

digits.forEach(function(inp, i){
  inp.addEventListener('input', function(){
    inp.value = inp.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(-1);
    inp.classList.toggle('filled', inp.value.length > 0);
    document.getElementById('l-err').textContent = '';
    if(inp.value && i < 5) digits[i+1].focus();
    if(i === 5 && inp.value) doCodeLogin();
  });
  inp.addEventListener('keydown', function(e){
    if(e.key === 'Backspace'){
      if(!inp.value && i > 0){ digits[i-1].focus(); }
      if(inp.value){ inp.value=''; inp.classList.remove('filled'); }
      e.preventDefault();
    }
    if(e.key === 'ArrowLeft'  && i > 0) digits[i-1].focus();
    if(e.key === 'ArrowRight' && i < 5) digits[i+1].focus();
    if(e.key === 'Enter') doCodeLogin();
  });
});

document.getElementById('login-btn').addEventListener('click', doCodeLogin);

function getCode(){
  return digits.map(function(d){ return d.value; }).join('').toUpperCase();
}
function clearCode(){
  digits.forEach(function(d){ d.value=''; d.classList.remove('filled'); });
  digits[0].focus();
}

// ‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê
function doCodeLogin(){
  var code = getCode();
  var err  = document.getElementById('l-err');
  var btn  = document.getElementById('login-btn');
  err.textContent = '';
  if(code.length < 6){ err.textContent = '‚ö†Ô∏è Saisissez les 6 caract√®res de votre code.'; return; }
  btn.disabled = true; btn.textContent = '‚è≥ V√©rification‚Ä¶';
  db.collection('agents').where('code','==',code).get()
    .then(function(snap){
      if(snap.empty){
        err.textContent = '‚ùå Code incorrect. V√©rifiez avec le RH.';
        clearCode(); return;
      }
      var agentDoc = snap.docs[0];
      var agent = Object.assign({id: agentDoc.id}, agentDoc.data());
      if(agent.actif === false){
        err.textContent = '‚õî Votre compte est d√©sactiv√©. Contactez le RH.';
        clearCode(); return;
      }
      // Enregistrer la connexion
      db.collection('agents').doc(agent.id).update({
        derniere_connexion: firebase.firestore.FieldValue.serverTimestamp()
      });
      currentAgent = agent;
      showAgentUI();
    })
    .catch(function(e){ err.textContent = '‚ùå Erreur : ' + e.message; })
    .finally(function(){ btn.disabled = false; btn.textContent = 'Acc√©der √† mes missions ‚Üí'; });
}

// ‚ïê‚ïê‚ïê‚ïê INTERFACE AGENT ‚ïê‚ïê‚ïê‚ïê
function showAgentUI(){
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('agent-ui').style.display     = 'block';
  var a = currentAgent;
  document.getElementById('tb-name').textContent  = a.nom  || 'Agent';
  document.getElementById('tb-role').textContent  = RL[a.role] || a.role || '‚Äî';
  document.getElementById('tb-code').textContent  = a.code || '‚Äî';
  document.getElementById('wc-name').textContent  = a.nom  || 'Agent';
  document.getElementById('wc-role').textContent  = RL[a.role] || a.role || '‚Äî';
  document.getElementById('wc-zone').textContent  = 'üìç ' + (a.zone || '‚Äî');
  loadMyTasks();
}

document.getElementById('quit-btn').addEventListener('click', function(){
  currentAgent = null; myTasks = [];
  document.getElementById('agent-ui').style.display    = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  clearCode();
});

// ‚ïê‚ïê‚ïê‚ïê CHARGEMENT DES T√ÇCHES ‚ïê‚ïê‚ïê‚ïê
function loadMyTasks(){
  document.getElementById('tasks-container').innerHTML = '<div class="empty-box"><div class="spinner"></div></div>';
  db.collection('commandes').where('agentId','==',currentAgent.id).get()
    .then(function(snap){
      myTasks = snap.docs.map(function(d){ return Object.assign({id:d.id}, d.data()); });
      myTasks.sort(function(a,b){
        return (b.createdAt&&b.createdAt.toMillis?b.createdAt.toMillis():0)
              -(a.createdAt&&a.createdAt.toMillis?a.createdAt.toMillis():0);
      });
      updateKPIs();
      renderTasks();
    })
    .catch(function(e){
      document.getElementById('tasks-container').innerHTML =
        '<div class="empty-box"><div class="empty-ico">‚ö†Ô∏è</div><div class="empty-txt">Erreur : '+e.message+'</div></div>';
    });
}

// ‚ïê‚ïê‚ïê‚ïê KPI ‚ïê‚ïê‚ïê‚ïê
function updateKPIs(){
  document.getElementById('kpi-new').textContent  = myTasks.filter(function(t){ return t.statut==='En attente'; }).length;
  document.getElementById('kpi-conf').textContent = myTasks.filter(function(t){ return t.statut==='Confirm√©e'; }).length;
  document.getElementById('kpi-prog').textContent = myTasks.filter(function(t){ return t.statut==='En cours'; }).length;
  document.getElementById('kpi-done').textContent = myTasks.filter(function(t){ return t.statut==='Termin√©e'; }).length;
}

// ‚ïê‚ïê‚ïê‚ïê FILTRES ‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.ftab').forEach(function(btn){
  btn.addEventListener('click', function(){
    currentTab = btn.dataset.tab;
    document.querySelectorAll('.ftab').forEach(function(b){ b.classList.remove('on'); });
    btn.classList.add('on');
    var titles = {
      'actives':'üìã Mes missions actives',
      'Confirm√©e':'üì¨ T√¢ches confirm√©es ‚Äî √† d√©marrer',
      'En cours':'üöÄ T√¢ches en cours d\'ex√©cution',
      'Termin√©e':'‚úÖ T√¢ches termin√©es'
    };
    document.getElementById('sec-title').textContent = titles[currentTab]||'';
    renderTasks();
  });
});

// ‚ïê‚ïê‚ïê‚ïê RENDU ‚ïê‚ïê‚ïê‚ïê
function renderTasks(){
  var list;
  if(currentTab === 'actives'){
    list = myTasks.filter(function(t){ return ['Confirm√©e','En cours'].includes(t.statut); });
  } else {
    list = myTasks.filter(function(t){ return t.statut === currentTab; });
  }

  var el = document.getElementById('tasks-container');
  if(!list.length){
    var msgs = {
      'actives':'Aucune mission active pour le moment.<br/>Le responsable des op√©rations vous assignera bient√¥t une t√¢che.',
      'Confirm√©e':'Aucune t√¢che confirm√©e en attente.',
      'En cours':'Aucune t√¢che en cours d\'ex√©cution.',
      'Termin√©e':'Aucune t√¢che termin√©e pour l\'instant.'
    };
    el.innerHTML = '<div class="empty-box"><div class="empty-ico">üéâ</div><div class="empty-txt">'+(msgs[currentTab]||'')+'</div></div>';
    return;
  }

  el.innerHTML = list.map(function(t){
    var isProg  = t.statut === 'En cours';
    var isConf  = t.statut === 'Confirm√©e';
    var isTerm  = t.statut === 'Termin√©e';
    var isAtt   = t.statut === 'En attente';
    var cardCls = 'task-card '+(isConf?'s-confirmee':isProg?'s-en-cours':isTerm?'s-terminee':'')+(t.priorite==='Haute'?' p-haute':'');
    var pillSt  = isConf?'p-conf':isProg?'p-run':isTerm?'p-term':'p-norm';
    var pillPr  = t.priorite==='Haute'?'p-haute':t.priorite==='Basse'?'p-basse':'p-norm';

    // Boutons selon statut
    var actions = '';
    if(isAtt || isConf){
      // "Confirmer" = l'agent confirme r√©ception ‚Üí passe √† Confirm√©e si En attente
      // "En cours"  = l'agent d√©marre
    }
    if(isAtt){
      actions += '<button class="btn-confirm" data-action="confirmer" data-id="'+t.id+'">üì¨ Confirmer r√©ception</button>';
    }
    if(isConf){
      actions += '<button class="btn-start" data-action="demarrer" data-id="'+t.id+'">üöÄ D√©marrer la mission</button>';
    }
    if(isProg){
      actions += '<button class="btn-done" data-action="terminer" data-id="'+t.id+'">‚úÖ Marquer comme termin√©e</button>';
    }
    if(t.phone||t.clientTel){
      actions += '<a class="btn-call" href="tel:'+(t.phone||t.clientTel)+'">üìû Appeler</a>';
    }

    return '<div class="'+cardCls+'">'
      +'<div class="tc-head">'
        +'<div><div class="tc-service">'+(t.serviceName||t.service||'Mission')+'</div>'
        +'<div class="tc-ref">#'+(t.id||'').slice(0,8).toUpperCase()+'</div></div>'
        +'<div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px">'
          +'<span class="pill '+pillSt+'">'+t.statut+'</span>'
          +'<span class="pill '+pillPr+'">'+(t.priorite||'Normale')+'</span>'
        +'</div>'
      +'</div>'
      +'<div class="tc-body">'
        +'<div class="tc-row"><span class="tc-ico">üë§</span><span style="color:var(--light)">Client :</span> <span class="tc-val">'+(t.clientNom||t.nomClient||'‚Äî')+'</span></div>'
        +(t.phone||t.clientTel?'<div class="tc-row"><span class="tc-ico">üìû</span><a href="tel:'+(t.phone||t.clientTel)+'" style="color:var(--acc);font-weight:700;font-size:12px">'+(t.phone||t.clientTel)+'</a></div>':'')
        +(t.adresseLivraison||t.adresse?'<div class="tc-row"><span class="tc-ico">üìç</span><span class="tc-val">'+(t.adresseLivraison||t.adresse)+'</span></div>':'')
        +(t.besoin||t.description?'<div class="tc-row"><span class="tc-ico">üìù</span><span style="font-size:11px;color:var(--mid)">'+(t.besoin||t.description)+'</span></div>':'')
      +'</div>'
      +(t.noteAgent?'<div class="tc-note"><div class="tc-note-label">üìå Note des Op√©rations</div>'+t.noteAgent+'</div>':'')
      +'<div class="tc-actions">'+actions+'</div>'
      +'</div>';
  }).join('');

  // Attacher les actions
  el.querySelectorAll('[data-action]').forEach(function(btn){
    btn.addEventListener('click', function(){
      var id = btn.dataset.id;
      var action = btn.dataset.action;
      if(action === 'confirmer') doAction(id, 'Confirm√©e', 'üì¨ T√¢che confirm√©e !', '#1E6FBE');
      if(action === 'demarrer')  doAction(id, 'En cours',  'üöÄ Mission d√©marr√©e !', '#E65100');
      if(action === 'terminer')  doAction(id, 'Termin√©e',  '‚úÖ Mission termin√©e ! Bravo üéâ', '#2E7D32');
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê ACTION ‚ïê‚ïê‚ïê‚ïê
function doAction(id, newStatut, msg, color){
  db.collection('commandes').doc(id).update({
    statut: newStatut,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(function(){
    var t = myTasks.find(function(x){ return x.id === id; });
    if(t) t.statut = newStatut;
    updateKPIs();
    renderTasks();
    showToast(msg, color);
  }).catch(function(e){ showToast('‚ùå '+e.message, '#C62828'); });
}

// ‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê
function showToast(msg, bg){
  var t = document.getElementById('toast');
  t.textContent = msg; t.style.background = bg||'#1A1A2E';
  t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 3200);
}
</script>
</body>
</html>
