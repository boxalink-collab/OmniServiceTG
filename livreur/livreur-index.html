<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OmniService TG ‚Äî Livreur</title>
<link rel="icon" href="../assets/logo.png" type="image/png"/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --blue:#1565C0;--blue2:#1E88E5;--blue-s:rgba(21,101,192,.1);--blue-d:#0D47A1;
  --ora:#F5820A;--ora-s:rgba(245,130,10,.1);--ora-d:#E65100;
  --dark:#0D2137;--mid:#3A5068;--light:#7A95B0;
  --border:#D6E4F0;--bg:#F0F4FF;--card:#fff;
  --green:#2E7D32;--red:#C62828;--nav-h:64px;
}
html,body{height:100%;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--dark);overflow-x:hidden}
/* SPLASH */
#splash{position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#0D2137,#1565C0);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px}
.sp-logo{font-size:56px;animation:popIn .6s cubic-bezier(.34,1.56,.64,1) .3s both}
.sp-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:#fff;animation:fadeUp .5s ease .7s both}
.sp-sub{font-size:11px;color:rgba(255,255,255,.5);letter-spacing:1px;text-transform:uppercase;animation:fadeUp .5s ease .9s both}
.sp-bar{width:160px;height:3px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;margin-top:8px;animation:fadeUp .4s ease 1s both}
.sp-bar-fill{height:100%;background:linear-gradient(90deg,var(--ora),var(--blue2));animation:load 1.4s ease 1.1s both}
@keyframes load{0%{width:0}100%{width:100%}}
#splash.out{animation:splashOut .4s ease forwards}
@keyframes splashOut{to{opacity:0;pointer-events:none}}
@keyframes popIn{from{transform:scale(0) rotate(-20deg);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes fadeUp{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
/* LOGIN */
#login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0D2137,#1565C0 60%,#0D47A1);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
.login-box{background:#fff;border-radius:24px;padding:36px 28px;width:100%;max-width:380px;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.35)}
.login-logo{font-size:52px;margin-bottom:8px}
.login-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:var(--dark);margin-bottom:4px}
.login-sub{font-size:12px;color:var(--light);margin-bottom:16px}
.login-badge{display:inline-flex;align-items:center;gap:6px;background:var(--ora-s);color:var(--ora-d);border:1px solid rgba(245,130,10,.3);border-radius:999px;padding:4px 14px;font-size:11px;font-weight:700;letter-spacing:.5px;margin-bottom:20px}
.code-lbl{font-size:11px;font-weight:700;color:var(--mid);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;text-align:left;display:block}
.code-inp{width:100%;padding:16px;border:2px solid var(--border);border-radius:14px;font-size:24px;font-weight:900;font-family:'Nunito',sans-serif;text-align:center;letter-spacing:4px;text-transform:uppercase;outline:none;transition:.2s;background:#f8faff;color:var(--dark)}
.code-inp:focus{border-color:var(--blue);background:#fff;box-shadow:0 0 0 4px var(--blue-s)}
.code-inp::placeholder{font-size:14px;letter-spacing:1px;font-weight:400;color:var(--light)}
.btn-login{width:100%;padding:14px;background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer;margin-top:6px;transition:.2s}
.btn-login:active{transform:scale(.98)}
.login-err{color:var(--red);font-size:12px;margin-top:10px;min-height:18px;font-weight:600}
.login-hint{font-size:11px;color:var(--light);margin-top:12px;line-height:1.6}
/* TOP BAR */
.top-bar{background:linear-gradient(135deg,#0D2137,#1565C0);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 2px 12px rgba(13,33,55,.3)}
.top-bar-left{display:flex;align-items:center;gap:10px}
.top-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--ora),var(--ora-d));display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;box-shadow:0 2px 8px rgba(245,130,10,.4)}
.top-name{font-family:'Nunito',sans-serif;font-size:16px;font-weight:900;color:#fff}
.top-role{font-size:10px;color:rgba(255,255,255,.5);margin-top:1px}
.btn-logout{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8);padding:6px 14px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;font-family:'Poppins',sans-serif}
.code-badge-top{background:rgba(245,130,10,.2);border:1px solid rgba(245,130,10,.4);color:#FFB74D;border-radius:999px;padding:3px 12px;font-size:10px;font-weight:800;font-family:'Nunito',sans-serif;letter-spacing:1px}
/* SPINNER */
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
/* TOAST */
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--dark);color:#fff;padding:12px 22px;border-radius:12px;font-size:13px;font-weight:600;z-index:9998;transition:.35s;opacity:0;max-width:90vw;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.25)}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}
#app{display:none;flex-direction:column;height:100vh;overflow:hidden}
.status-bar{background:var(--blue-d);padding:10px 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.status-toggle{display:flex;background:rgba(255,255,255,.1);border-radius:999px;padding:3px;gap:2px}
.status-btn{padding:6px 14px;border-radius:999px;border:none;font-size:11px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer;transition:.2s;color:rgba(255,255,255,.5);background:transparent}
.status-btn.on.disponible{background:var(--green);color:#fff}
.status-btn.on.indispo{background:var(--red);color:#fff}
.stats-mini{display:flex;gap:16px}
.stat-mini-num{font-family:'Nunito',sans-serif;font-size:17px;font-weight:900;color:#fff}
.stat-mini-lbl{font-size:9px;color:rgba(255,255,255,.4);text-transform:uppercase}
.badge-live{background:rgba(46,125,50,.25);border:1px solid rgba(46,125,50,.4);color:#81C784;border-radius:999px;padding:4px 10px;font-size:10px;font-weight:700;display:flex;align-items:center;gap:4px}
.badge-live::before{content:'';width:6px;height:6px;border-radius:50%;background:#4CAF50;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.3)}}
.tabs{display:flex;background:#fff;border-bottom:2px solid var(--border);flex-shrink:0}
.tab-btn{flex:1;padding:12px 0;border:none;background:none;font-size:11px;font-weight:700;font-family:'Poppins',sans-serif;color:var(--light);cursor:pointer;position:relative;transition:.2s}
.tab-btn.on{color:var(--blue)}
.tab-btn.on::after{content:'';position:absolute;bottom:-2px;left:15%;right:15%;height:2px;background:var(--ora);border-radius:2px}
.tab-count{background:var(--red);color:#fff;border-radius:999px;padding:1px 6px;font-size:10px;margin-left:3px}
.content{flex:1;overflow-y:auto;padding:16px}
.cmd-card{background:var(--card);border-radius:16px;margin-bottom:12px;box-shadow:0 2px 12px rgba(21,101,192,.08);overflow:hidden;border:1.5px solid transparent;transition:.2s}
.cmd-card.urgent{border-color:var(--ora);animation:urgentB 1.5s ease infinite alternate}
@keyframes urgentB{from{border-color:rgba(245,130,10,.3)}to{border-color:var(--ora)}}
.cmd-header{padding:14px 16px 10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.cmd-emoji{font-size:26px;flex-shrink:0}
.cmd-service-name{font-size:13px;font-weight:700;color:var(--dark)}
.cmd-ref{font-size:10px;color:var(--light);margin-top:1px}
.cmd-statut{border-radius:999px;padding:4px 10px;font-size:10px;font-weight:700;white-space:nowrap}
.s-attente{background:#FFF3E0;color:#E65100}
.s-route{background:#E3F2FD;color:#1565C0}
.s-livree{background:#E8F5E9;color:var(--green)}
.cmd-body{padding:0 16px 12px;border-top:1px solid var(--border)}
.cmd-info-row{display:flex;align-items:flex-start;gap:8px;margin-top:10px;font-size:12px}
.cmd-info-val{color:var(--mid);flex:1}
.cmd-info-val strong{color:var(--dark);font-weight:700}
.cmd-actions{display:flex;gap:8px;padding:10px 16px 14px;flex-wrap:wrap}
.btn-a{flex:1;min-width:0;padding:10px 8px;border:none;border-radius:10px;font-size:12px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer;transition:.2s;text-align:center}
.btn-a:active{transform:scale(.97)}
.btn-route{background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff}
.btn-livree{background:linear-gradient(135deg,var(--green),#1B5E20);color:#fff}
.btn-maps{background:var(--blue-s);color:var(--blue);border:1px solid rgba(21,101,192,.2)}
.btn-call{background:rgba(46,125,50,.1);color:var(--green);border:1px solid rgba(46,125,50,.2)}
.btn-prob{background:rgba(198,40,40,.08);color:var(--red);border:1px solid rgba(198,40,40,.2)}
.hist-card{background:#fff;border-radius:12px;padding:14px 16px;margin-bottom:10px;box-shadow:0 2px 8px rgba(21,101,192,.06);display:flex;align-items:center;gap:12px}
.hist-icon{width:40px;height:40px;border-radius:10px;background:var(--blue-s);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.hist-name{font-size:13px;font-weight:700;color:var(--dark)}
.hist-date{font-size:11px;color:var(--light);margin-top:1px}
.profil-section{background:#fff;border-radius:16px;padding:20px;margin-bottom:12px;box-shadow:0 2px 12px rgba(21,101,192,.08)}
.profil-header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
.profil-avatar{width:68px;height:68px;border-radius:50%;background:linear-gradient(135deg,var(--ora),var(--ora-d));display:flex;align-items:center;justify-content:center;font-size:34px;box-shadow:0 4px 16px rgba(245,130,10,.3)}
.profil-stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.profil-stat{background:var(--bg);border-radius:12px;padding:14px;text-align:center}
.profil-stat-num{font-family:'Nunito',sans-serif;font-size:26px;font-weight:900;color:var(--blue)}
.profil-stat-lbl{font-size:11px;color:var(--light);margin-top:2px}
.profil-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
.profil-row:last-child{border-bottom:none}
.profil-row-label{font-size:13px;color:var(--mid)}
.profil-row-val{font-size:13px;font-weight:600;color:var(--dark)}
.profil-code{font-family:'Nunito',sans-serif;font-size:16px;font-weight:900;background:var(--ora-s);color:var(--ora-d);border:1px solid rgba(245,130,10,.3);border-radius:8px;padding:4px 12px;letter-spacing:2px}
.empty-state{text-align:center;padding:52px 20px;color:var(--light)}
.empty-ico{font-size:52px;margin-bottom:12px}
.empty-title{font-size:15px;font-weight:700;color:var(--mid);margin-bottom:6px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:.25s}
.modal-overlay.show{opacity:1;pointer-events:all}
.modal-sheet{background:#fff;border-radius:24px 24px 0 0;padding:24px 20px 40px;width:100%;max-width:500px;transform:translateY(100%);transition:.3s cubic-bezier(.4,0,.2,1)}
.modal-overlay.show .modal-sheet{transform:translateY(0)}
.modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px}
.modal-title{font-size:16px;font-weight:700;margin-bottom:16px;text-align:center;color:var(--dark)}
textarea.modal-inp{width:100%;padding:12px;border:1.5px solid var(--border);border-radius:12px;font-family:'Poppins',sans-serif;font-size:13px;resize:none;height:100px;outline:none}
textarea.modal-inp:focus{border-color:var(--blue)}
.btn-modal-sub{width:100%;padding:14px;background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer;margin-top:10px}
.btn-modal-cancel{width:100%;padding:12px;background:none;border:1.5px solid var(--border);border-radius:12px;font-size:13px;font-weight:600;font-family:'Poppins',sans-serif;cursor:pointer;margin-top:8px;color:var(--mid)}
</style>
</head>
<body>
<div id="splash">
  <div class="sp-logo">üõµ</div>
  <div class="sp-title">OmniService TG</div>
  <div class="sp-sub">Interface Livreur</div>
  <div class="sp-bar"><div class="sp-bar-fill"></div></div>
</div>

<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">üõµ</div>
    <div class="login-title">Espace Livreur</div>
    <div class="login-sub">OmniService TG</div>
    <div class="login-badge">üîë Connexion par code</div>
    <span class="code-lbl">Votre code d'acc√®s</span>
    <input class="code-inp" type="text" id="login-code" placeholder="LIXXXX"
      maxlength="10" autocomplete="off" spellcheck="false"
      oninput="this.value=this.value.toUpperCase()"
      onkeydown="if(event.key==='Enter') doLogin()"/>
    <button class="btn-login" onclick="doLogin()" id="btn-login">üöÄ Se connecter</button>
    <div class="login-err" id="login-err"></div>
    <div class="login-hint">Code fourni par votre responsable RH.</div>
  </div>
</div>

<div id="app">
  <div class="top-bar">
    <div class="top-bar-left">
      <div class="top-avatar">üõµ</div>
      <div>
        <div class="top-name" id="top-name">Chargement...</div>
        <div class="top-role" id="top-zone">Zone : ‚Äî</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="badge-live" id="badge-dispo">Disponible</div>
      <button class="btn-logout" onclick="doLogout()">‚Ü©</button>
    </div>
  </div>

  <div class="status-bar">
    <div>
      <div style="font-size:10px;color:rgba(255,255,255,.5);font-weight:600;margin-bottom:4px">MON STATUT</div>
      <div class="status-toggle">
        <button class="status-btn on disponible" id="btn-dispo" onclick="setStatus('disponible')">‚úÖ Disponible</button>
        <button class="status-btn" id="btn-indispo" onclick="setStatus('indisponible')">‚è∏ Pause</button>
      </div>
    </div>
    <div class="stats-mini">
      <div style="text-align:center"><div class="stat-mini-num" id="stat-today">0</div><div class="stat-mini-lbl">Aujourd'hui</div></div>
      <div style="text-align:center"><div class="stat-mini-num" id="stat-total">0</div><div class="stat-mini-lbl">Total</div></div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn on" id="tab-actives" onclick="showTab('actives')">üõµ En cours <span class="tab-count" id="count-actives">0</span></button>
    <button class="tab-btn" id="tab-attente" onclick="showTab('attente')">‚è≥ Attente <span class="tab-count" id="count-attente" style="background:var(--ora)">0</span></button>
    <button class="tab-btn" id="tab-historique" onclick="showTab('historique')">üìã Historique</button>
    <button class="tab-btn" id="tab-profil" onclick="showTab('profil')">üë§ Profil</button>
  </div>

  <div class="content">
    <div id="view-actives"><div id="list-actives"><div class="empty-state"><div class="empty-ico">üõµ</div><div class="empty-title">Aucune livraison en cours</div><p>Prenez en charge une commande dans "Attente"</p></div></div></div>
    <div id="view-attente" style="display:none"><div id="list-attente"><div class="empty-state"><div class="empty-ico">üì¶</div><div class="empty-title">Aucune commande en attente</div></div></div></div>
    <div id="view-historique" style="display:none"><div id="list-historique"><div class="empty-state"><div class="empty-ico">üìã</div><div class="empty-title">Aucun historique</div></div></div></div>
    <div id="view-profil" style="display:none">
      <div class="profil-section">
        <div class="profil-header">
          <div class="profil-avatar">üõµ</div>
          <div>
            <div style="font-family:'Nunito',sans-serif;font-size:20px;font-weight:900;color:var(--dark)" id="profil-nom">‚Äî</div>
            <div style="font-size:12px;color:var(--blue);font-weight:600;margin-top:2px">üõµ Livreur ¬∑ OmniService TG</div>
          </div>
        </div>
        <div class="profil-stat-grid">
          <div class="profil-stat"><div class="profil-stat-num" id="p-livrees">0</div><div class="profil-stat-lbl">Livraisons totales</div></div>
          <div class="profil-stat"><div class="profil-stat-num" id="p-today">0</div><div class="profil-stat-lbl">Aujourd'hui</div></div>
        </div>
        <div class="profil-row"><span class="profil-row-label">üîë Code</span><span class="profil-row-val"><span class="profil-code" id="p-code">‚Äî</span></span></div>
        <div class="profil-row"><span class="profil-row-label">üì± T√©l√©phone</span><span class="profil-row-val" id="p-phone">‚Äî</span></div>
        <div class="profil-row"><span class="profil-row-label">üìç Zone</span><span class="profil-row-val" id="p-zone">‚Äî</span></div>
        <div class="profil-row"><span class="profil-row-label">üü¢ Statut</span><span class="profil-row-val" id="p-statut">Disponible</span></div>
      </div>
      <button style="width:100%;padding:14px;background:rgba(198,40,40,.08);color:var(--red);border:1px solid rgba(198,40,40,.2);border-radius:12px;font-size:14px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer" onclick="doLogout()">‚Ü© Se d√©connecter</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-prob">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">‚ö†Ô∏è Signaler un probl√®me</div>
    <textarea class="modal-inp" id="prob-text" placeholder="D√©crivez le probl√®me..."></textarea>
    <button class="btn-modal-sub" onclick="submitProbleme()">üì§ Envoyer</button>
    <button class="btn-modal-cancel" onclick="closeModal('modal-prob')">Annuler</button>
  </div>
</div>
<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, query, where, getDocs, doc, updateDoc,
  addDoc, serverTimestamp, onSnapshot, getDoc, setDoc, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
  getAuth, signInAnonymously, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const fbApp = initializeApp({
  apiKey:"AIzaSyDtDK7-iDRy1E-kjZubjyjkPW7Th33BMyU",
  authDomain:"omniservicetg-59df3.firebaseapp.com",
  projectId:"omniservicetg-59df3",
  storageBucket:"omniservicetg-59df3.firebasestorage.app",
  messagingSenderId:"196278567761",
  appId:"1:196278567761:web:4f6416acaab58b67bf4970"
});
const db   = getFirestore(fbApp);
const auth = getAuth(fbApp);

let agentData = null, currentCmdId = null, unsubscribes = [];

// ‚îÄ‚îÄ Splash ‚îÄ‚îÄ
setTimeout(() => {
  const s = document.getElementById('splash');
  s.classList.add('out');
  setTimeout(() => s.style.display='none', 400);
}, 2500);

// ‚îÄ‚îÄ Auth state : ne s'active QUE pour les sessions anonymes (livreurs) ‚îÄ‚îÄ
onAuthStateChanged(auth, async (user) => {
  if (user && user.isAnonymous) {
    // V√©rifier que le code livreur est bien enregistr√©
    const savedCode = localStorage.getItem('omni_livreur_code');
    if (!savedCode) { await signOut(auth); showLogin(); return; }
    try {
      const snap = await getDoc(doc(db, 'agents', user.uid));
      if (snap.exists() && snap.data().actif !== false && snap.data().role === 'livreur') {
        agentData = { uid: user.uid, ...snap.data() };
        initApp();
      } else {
        await signOut(auth);
        localStorage.removeItem('omni_livreur_code');
        showLogin();
      }
    } catch(e) { showLogin(); }
  } else if (!user) {
    showLogin();
  }
  // si user && !user.isAnonymous ‚Üí on ignore (ne concerne pas cette interface)
});

function showLogin(err='') {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  if (err) document.getElementById('login-err').textContent = err;
}

window.doLogin = async function() {
  const code = document.getElementById('login-code').value.trim().toUpperCase();
  const errEl = document.getElementById('login-err');
  const btn   = document.getElementById('btn-login');
  if (!code) { errEl.textContent = '‚ö†Ô∏è Saisissez votre code'; return; }
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> V√©rification...';
  errEl.textContent = '';
  try {
    // √âtape 1 : v√©rifier dans agents_login (collection publique)
    const loginSnap = await getDoc(doc(db, 'agents_login', code));
    if (!loginSnap.exists()) {
      errEl.textContent = '‚ùå Code inconnu. V√©rifiez avec votre RH.';
      btn.disabled=false; btn.textContent='üöÄ Se connecter'; return;
    }
    const loginData = loginSnap.data();
    if (loginData.role !== 'livreur') { errEl.textContent = '‚ùå Ce code n\'est pas un code livreur.'; btn.disabled=false; btn.textContent='üöÄ Se connecter'; return; }
    if (loginData.actif === false) { errEl.textContent = '‚õî Compte d√©sactiv√©. Contactez votre responsable.'; btn.disabled=false; btn.textContent='üöÄ Se connecter'; return; }
    if (!loginData.agentUid) { errEl.textContent = '‚ùå Code mal configur√© (agentUid manquant). Contactez votre RH.'; btn.disabled=false; btn.textContent='üöÄ Se connecter'; return; }

    // √âtape 2 : session Firebase anonyme
    btn.innerHTML = '<span class="spinner"></span> Connexion s√©curis√©e...';
    const cred = await signInAnonymously(auth);
    const anonUid = cred.user.uid;

    // √âtape 3 : r√©cup√©rer profil complet et cr√©er agents/{anonUid}
    const profileSnap = await getDoc(doc(db, 'agents', loginData.agentUid));
    const profileData = profileSnap.exists() ? profileSnap.data() : { code, role:'livreur', actif:true };
    await setDoc(doc(db, 'agents', anonUid), {
      ...profileData, uid: anonUid, code: code, role: loginData.role, actif: true,
      codeRef: loginData.agentUid, derniere_connexion: serverTimestamp()
    });

    localStorage.setItem('omni_livreur_code', code);
    // onAuthStateChanged se charge de la suite

  } catch(e) {
    console.error(e);
    if(e.code==='permission-denied'){errEl.textContent='‚ùå Acc√®s refus√© par Firestore.';}
    else{errEl.textContent='‚ùå Erreur : '+(e.message||'Probl√®me r√©seau.');}
    btn.disabled=false; btn.textContent='üöÄ Se connecter';
  }
};

window.doLogout = async function() {
  unsubscribes.forEach(u => u()); unsubscribes = [];
  agentData = null;
  localStorage.removeItem('omni_livreur_code');
  document.getElementById('login-code').value = '';
  await signOut(auth);
};

function initApp() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  const nom = (agentData.prenom||'') + ' ' + (agentData.nom||'');
  document.getElementById('top-name').textContent = nom.trim() || 'Livreur';
  document.getElementById('top-zone').textContent = 'Zone : ' + (agentData.zone || '‚Äî');
  document.getElementById('profil-nom').textContent = nom.trim() || 'Livreur';
  document.getElementById('p-code').textContent = agentData.code || '‚Äî';
  document.getElementById('p-phone').textContent = agentData.telephone || '‚Äî';
  document.getElementById('p-zone').textContent = agentData.zone || '‚Äî';
  const st = agentData.statut || 'disponible';
  document.getElementById('btn-dispo').className = 'status-btn' + (st==='disponible'?' on disponible':'');
  document.getElementById('btn-indispo').className = 'status-btn' + (st==='indisponible'?' on indispo':'');
  document.getElementById('badge-dispo').textContent = st==='disponible'?'Disponible':'En pause';
  document.getElementById('p-statut').textContent = st==='disponible'?'üü¢ Disponible':'‚è∏ En pause';
  loadCommandes(); loadStats();
}

function loadCommandes() {
  const q1 = query(collection(db,'commandes'),where('livreurId','==',agentData.uid),where('statut','in',['En route','Confirm√©e']));
  unsubscribes.push(onSnapshot(q1, s => {
    renderActives(s.docs.map(d=>({id:d.id,...d.data()})));
    document.getElementById('count-actives').textContent = s.size;
  }));
  const q2 = query(collection(db,'commandes'),where('statut','==','En attente'));
  unsubscribes.push(onSnapshot(q2, s => {
    renderAttente(s.docs.map(d=>({id:d.id,...d.data()})));
    document.getElementById('count-attente').textContent = s.size;
  }));
  const q3 = query(collection(db,'commandes'),where('livreurId','==',agentData.uid),where('statut','in',['Termin√©e','Annul√©e']),orderBy('createdAt','desc'),limit(30));
  unsubscribes.push(onSnapshot(q3, s => renderHistorique(s.docs.map(d=>({id:d.id,...d.data()})))));
}

function svcEmoji(s){return{food:'üçΩ',restaurant:'üç¥',delivery:'üì¶',clothes:'üëó',kits:'üéÅ',cleaning:'üßπ'}[s]||'üì¶'}

function cmdCard(c, mode) {
  const sc = c.statut==='En route'?'s-route':'s-attente';
  const hr = c.createdAt?new Date(c.createdAt.seconds*1000).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}):'‚Äî';
  const btns = mode==='attente'
    ? `<div class="cmd-actions"><button class="btn-a btn-route" onclick="prendrEnCharge('${c.id}')">‚úÖ Prendre en charge</button></div>`
    : `<div class="cmd-actions">
        <button class="btn-a btn-maps" onclick="openMaps('${(c.adresse||'').replace(/'/g,"\\'")}')">üó∫ Maps</button>
        <button class="btn-a btn-call" onclick="appeler('${c.telephone||c.phone||''}')">üìû Appeler</button>
        <button class="btn-a btn-livree" onclick="marquerLivree('${c.id}')">‚úÖ Livr√©e</button>
        <button class="btn-a btn-prob" onclick="openProbleme('${c.id}')">‚ö†Ô∏è Probl√®me</button>
      </div>`;
  return `<div class="cmd-card${c.urgent?' urgent':''}">
    <div class="cmd-header">
      <div style="display:flex;align-items:center;gap:8px;flex:1">
        <div class="cmd-emoji">${svcEmoji(c.service)}</div>
        <div><div class="cmd-service-name">${c.serviceName||c.service||'Commande'}</div><div class="cmd-ref">#${c.id.slice(0,8).toUpperCase()} ¬∑ ${hr}</div></div>
      </div>
      <span class="cmd-statut ${sc}">${c.statut}</span>
    </div>
    <div class="cmd-body">
      ${c.adresse?`<div class="cmd-info-row"><span style="font-size:14px">üìç</span><div class="cmd-info-val"><strong>Adresse :</strong> ${c.adresse}</div></div>`:''}
      ${c.prenom||c.nom?`<div class="cmd-info-row"><span style="font-size:14px">üë§</span><div class="cmd-info-val"><strong>Client :</strong> ${c.prenom||''} ${c.nom||''}</div></div>`:''}
      ${c.telephone||c.phone?`<div class="cmd-info-row"><span style="font-size:14px">üì±</span><div class="cmd-info-val"><strong>T√©l :</strong> ${c.telephone||c.phone}</div></div>`:''}
      ${c.modePaiement?`<div class="cmd-info-row"><span style="font-size:14px">üí≥</span><div class="cmd-info-val"><strong>Paiement :</strong> ${c.modePaiement}${c.total?' ‚Äî '+Number(c.total).toLocaleString('fr-FR')+' FCFA':''}</div></div>`:''}
      ${c.notes?`<div class="cmd-info-row"><span style="font-size:14px">üìù</span><div class="cmd-info-val">${c.notes}</div></div>`:''}
    </div>${btns}</div>`;
}

function renderActives(cmds){document.getElementById('list-actives').innerHTML=cmds.length?cmds.map(c=>cmdCard(c,'active')).join(''):'<div class="empty-state"><div class="empty-ico">üõµ</div><div class="empty-title">Aucune livraison en cours</div></div>'}
function renderAttente(cmds){document.getElementById('list-attente').innerHTML=cmds.length?cmds.map(c=>cmdCard(c,'attente')).join(''):'<div class="empty-state"><div class="empty-ico">üì¶</div><div class="empty-title">Aucune commande en attente</div></div>'}
function renderHistorique(cmds){
  const el=document.getElementById('list-historique');
  if(!cmds.length){el.innerHTML='<div class="empty-state"><div class="empty-ico">üìã</div><div class="empty-title">Aucun historique</div></div>';return}
  el.innerHTML=cmds.map(c=>{
    const d=c.createdAt?new Date(c.createdAt.seconds*1000).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'}):'‚Äî';
    return `<div class="hist-card"><div class="hist-icon">${svcEmoji(c.service)}</div><div style="flex:1"><div class="hist-name">${c.serviceName||c.service||'Commande'}</div><div class="hist-date">üìÖ ${d} ¬∑ #${c.id.slice(0,8).toUpperCase()}</div></div><div style="text-align:right"><span style="font-size:11px;font-weight:700;padding:3px 8px;border-radius:999px;background:${c.statut==='Termin√©e'?'#E8F5E9':'#FFEBEE'};color:${c.statut==='Termin√©e'?'var(--green)':'var(--red)'}">${c.statut}</span>${c.total?`<div style="font-size:12px;font-weight:700;color:var(--blue);margin-top:3px">${Number(c.total).toLocaleString('fr-FR')} FCFA</div>`:''}</div></div>`;
  }).join('');
}

window.prendrEnCharge = async function(id){
  const nom=(agentData.prenom||'')+' '+(agentData.nom||'');
  try{await updateDoc(doc(db,'commandes',id),{statut:'En route',livreurId:agentData.uid,livreurNom:nom.trim()||agentData.code,livreurCode:agentData.code,prisEnChargeAt:serverTimestamp()});toast('üõµ Commande prise en charge !');showTab('actives');}catch(e){toast('‚ùå '+e.message);}
};
window.marquerLivree = async function(id){
  if(!confirm('Confirmer la livraison ?'))return;
  try{await updateDoc(doc(db,'commandes',id),{statut:'Termin√©e',livraisonAt:serverTimestamp()});toast('‚úÖ Livraison confirm√©e !');loadStats();}catch(e){toast('‚ùå '+e.message);}
};
window.openProbleme = function(id){currentCmdId=id;document.getElementById('prob-text').value='';document.getElementById('modal-prob').classList.add('show');};
window.submitProbleme = async function(){
  const t=document.getElementById('prob-text').value.trim();
  if(!t){toast('‚ö†Ô∏è D√©crivez le probl√®me');return;}
  const nom=(agentData.prenom||'')+' '+(agentData.nom||'');
  try{
    await addDoc(collection(db,'problemes'),{commandeId:currentCmdId,livreurId:agentData.uid,livreurNom:nom.trim()||agentData.code,livreurCode:agentData.code,description:t,createdAt:serverTimestamp()});
    await updateDoc(doc(db,'commandes',currentCmdId),{statut:'Probl√®me',probleme:t});
    closeModal('modal-prob'); toast('üì§ Probl√®me signal√©');
  }catch(e){toast('‚ùå '+e.message);}
};
window.openMaps = a => {if(!a){toast('‚ö†Ô∏è Adresse non disponible');return;}window.open('https://maps.google.com/?q='+encodeURIComponent(a+', Lom√©, Togo'),'_blank');};
window.appeler  = t => {if(!t){toast('‚ö†Ô∏è Num√©ro non disponible');return;}window.location.href='tel:'+t;};
window.setStatus = async function(s){
  agentData.statut=s;
  document.getElementById('btn-dispo').className='status-btn'+(s==='disponible'?' on disponible':'');
  document.getElementById('btn-indispo').className='status-btn'+(s==='indisponible'?' on indispo':'');
  document.getElementById('badge-dispo').textContent=s==='disponible'?'Disponible':'En pause';
  document.getElementById('p-statut').textContent=s==='disponible'?'üü¢ Disponible':'‚è∏ En pause';
  try{await updateDoc(doc(db,'agents',agentData.uid),{statut:s,derniere_connexion:serverTimestamp()});}catch(e){}
};
async function loadStats(){
  try{
    const today=new Date();today.setHours(0,0,0,0);
    const s=await getDocs(query(collection(db,'commandes'),where('livreurId','==',agentData.uid),where('statut','==','Termin√©e')));
    const todayCnt=s.docs.filter(d=>{const ts=d.data().livraisonAt;return ts&&new Date(ts.seconds*1000)>=today;}).length;
    document.getElementById('stat-today').textContent=todayCnt;
    document.getElementById('stat-total').textContent=s.size;
    document.getElementById('p-livrees').textContent=s.size;
    document.getElementById('p-today').textContent=todayCnt;
  }catch(e){}
}
window.showTab = function(t){
  ['actives','attente','historique','profil'].forEach(x=>{
    document.getElementById('view-'+x).style.display=x===t?'block':'none';
    document.getElementById('tab-'+x).classList.toggle('on',x===t);
  });
};
window.closeModal = id => document.getElementById(id).classList.remove('show');
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);}
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('show');}));
</script>
</body>
</html>
