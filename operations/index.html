<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>OmniService TG â€” OpÃ©rations</title>
<meta name="theme-color" content="#E65100"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Ops OmniTG"/>
<link rel="manifest" href="manifest.json"/>
<link rel="icon" href="../assets/logo.png" type="image/png"/>
<link rel="apple-touch-icon" href="../assets/logo.png"/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>

<script>
(function(){
  function _hs(){
    var s=document.getElementById('splash');
    if(!s||s._g)return;s._g=true;
    s.style.transition='opacity .5s,transform .5s';
    s.style.opacity='0';s.style.transform='scale(1.03)';s.style.pointerEvents='none';
    setTimeout(function(){if(s.parentNode)s.parentNode.removeChild(s);},520);
  }
  document.addEventListener('DOMContentLoaded',function(){setTimeout(_hs,2800);setTimeout(_hs,6000);});
  if(document.readyState!=='loading'){setTimeout(_hs,2800);setTimeout(_hs,6000);}
  window._hideSplash=_hs;
})();
</script>

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --acc:#E65100;--acc-d:#BF360C;--acc-s:rgba(230,81,0,.1);
  --blue:#1E6FBE;--blue-d:#155A9C;--blue-s:rgba(30,111,190,.1);
  --ora:#F5820A;--dark:#1A1A2E;--mid:#4A4A6A;--light:#9999BB;
  --border:#E8EAF0;--bg:#F4F6FA;--green:#2E7D32;--red:#C62828;
  --sh:0 2px 12px rgba(0,0,0,.07);
}
html,body{height:100%;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--dark);overflow:hidden}

/* â•â• SPLASH â•â• */
#splash{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(145deg,#1a0800,#BF360C 55%,#1a0800);}
#splash::before{content:'';position:absolute;inset:0;
  background-image:linear-gradient(rgba(255,255,255,.025) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,255,255,.025) 1px,transparent 1px);
  background-size:40px 40px;}
.sp-o{position:absolute;border-radius:50%;pointer-events:none;}
.sp-o1{width:400px;height:400px;top:-100px;right:-90px;
  background:radial-gradient(circle,rgba(245,130,10,.15) 0%,transparent 70%);
  animation:spO 4s ease-in-out infinite alternate;}
.sp-o2{width:300px;height:300px;bottom:-80px;left:-70px;
  background:radial-gradient(circle,rgba(230,81,0,.25) 0%,transparent 70%);
  animation:spO 4s ease-in-out infinite alternate-reverse;}
@keyframes spO{from{transform:scale(1)}to{transform:scale(1.18) translate(8px,-8px)}}
.sp-c{position:relative;z-index:2;text-align:center;padding:32px;}
.sp-badge{display:inline-block;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);
  border-radius:999px;padding:5px 16px;font-size:10px;font-weight:800;letter-spacing:1.5px;
  color:rgba(255,255,255,.8);text-transform:uppercase;margin-bottom:20px;animation:spFu .5s .3s both;}
.sp-logo{width:100px;height:100px;border-radius:26px;margin:0 auto 20px;
  background:rgba(255,255,255,.12);border:1.5px solid rgba(255,255,255,.2);
  display:flex;align-items:center;justify-content:center;overflow:hidden;animation:spPi .8s .4s both;}
.sp-logo img{width:76px;height:76px;object-fit:contain;}
.sp-title{font-family:'Nunito',sans-serif;font-size:30px;font-weight:900;color:#fff;margin-bottom:4px;animation:spFu .6s .8s both;}
.sp-title .o{color:var(--ora)}
.sp-tag{font-size:11px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px;animation:spFu .6s 1s both;}
.sp-bar{width:200px;height:2px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden;margin:24px auto 0;animation:spFu .5s 1.2s both;}
.sp-bar-f{height:100%;background:linear-gradient(90deg,rgba(230,81,0,.7),#FFCC80,var(--ora));animation:spBl 1.8s 1.3s both;}
@keyframes spBl{0%{width:0}100%{width:100%}}
@keyframes spFu{from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes spPi{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}

/* â•â• LOGIN â•â• */
#login-screen{position:fixed;inset:0;background:linear-gradient(145deg,#1a0800,#BF360C 55%,#1a0800);
  display:flex;align-items:center;justify-content:center;z-index:1000;padding:16px;}
.lbox{background:#fff;border-radius:24px;padding:36px 32px;width:100%;max-width:380px;
  text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.45);}
.l-logo{width:72px;height:72px;background:linear-gradient(135deg,var(--acc),var(--acc-d));
  border-radius:18px;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.l-logo img{width:56px;height:56px;object-fit:contain;}
.l-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:var(--dark);margin-bottom:2px;}
.l-role{display:inline-block;background:#FBE9E7;color:var(--acc);font-size:11px;font-weight:700;padding:3px 12px;border-radius:999px;margin-bottom:18px;}
.l-label{display:block;font-size:11px;font-weight:700;color:var(--mid);text-align:left;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px;}
.l-inp{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:11px;font-size:13px;font-family:'Poppins',sans-serif;margin-bottom:13px;outline:none;background:var(--bg);transition:border-color .2s;}
.l-inp:focus{border-color:var(--acc);background:#fff;}
.l-btn{width:100%;background:linear-gradient(135deg,var(--acc),var(--acc-d));color:#fff;border:none;border-radius:999px;padding:14px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;box-shadow:0 4px 16px var(--acc-s);transition:opacity .2s;}
.l-btn:hover{opacity:.9;}
.l-err{color:var(--red);font-size:12px;font-weight:600;margin-top:10px;min-height:18px;}
.l-info{margin-top:14px;font-size:11px;color:var(--light);background:var(--bg);border-radius:9px;padding:10px 12px;text-align:left;line-height:1.7;}

/* â•â• LAYOUT â•â• */
.layout{display:flex;height:100vh;overflow:hidden;}
.sidebar{width:252px;background:#1A1A2E;flex-shrink:0;display:flex;flex-direction:column;transition:transform .3s;z-index:100;}
.sb-brand{padding:20px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;gap:12px;}
.sb-lg{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,rgba(230,81,0,.4),rgba(191,54,12,.2));border:1px solid rgba(230,81,0,.5);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;}
.sb-lg img{width:32px;height:32px;object-fit:contain;}
.sb-nm{font-family:'Nunito',sans-serif;font-size:17px;font-weight:900;}
.sb-nm .b{color:#90CAF9}.sb-nm .o{color:var(--ora)}
.sb-su{font-size:10px;color:rgba(255,255,255,.3);margin-top:2px;}
.sb-nav{padding:16px 12px;flex:1;overflow-y:auto;}
.sb-sec{font-size:9px;font-weight:800;color:rgba(255,255,255,.2);text-transform:uppercase;letter-spacing:1px;padding:0 10px;margin:14px 0 6px;}
.sb-item{display:flex;align-items:center;gap:10px;padding:11px 12px;border-radius:10px;cursor:pointer;margin-bottom:3px;transition:background .15s;font-size:13px;font-weight:600;color:rgba(255,255,255,.5);border:none;background:transparent;width:100%;text-align:left;font-family:'Poppins',sans-serif;}
.sb-item:hover{background:rgba(255,255,255,.06);color:rgba(255,255,255,.85);}
.sb-item.on{background:rgba(230,81,0,.3);color:#fff;}
.sb-ico{font-size:16px;width:22px;text-align:center;flex-shrink:0;}
.sb-badge{margin-left:auto;background:var(--ora);color:#fff;font-size:9px;font-weight:700;padding:2px 7px;border-radius:999px;}
.sb-footer{padding:14px;border-top:1px solid rgba(255,255,255,.07);}
.sb-ai{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.sb-av{width:38px;height:38px;border-radius:10px;background:rgba(230,81,0,.25);border:1px solid rgba(230,81,0,.4);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.sb-an{font-size:12px;font-weight:700;color:rgba(255,255,255,.8);}
.sb-ae{font-size:10px;color:rgba(255,255,255,.3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.logout-btn{width:100%;background:rgba(198,40,40,.2);color:#ff8a80;border:none;border-radius:9px;padding:10px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Poppins',sans-serif;}
.logout-btn:hover{background:rgba(198,40,40,.35);}
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:300;background:var(--acc);color:#fff;border:none;border-radius:10px;width:40px;height:40px;font-size:18px;cursor:pointer;align-items:center;justify-content:center;}

/* â•â• MAIN â•â• */
.main{flex:1;overflow-y:auto;background:var(--bg);}
.main-inner{max-width:1100px;margin:0 auto;padding:28px 24px 56px;}
.pg-title{font-family:'Nunito',sans-serif;font-size:24px;font-weight:900;color:var(--dark);margin-bottom:4px;}
.pg-sub{font-size:12px;color:var(--light);margin-bottom:24px;}

/* KPI */
.kpi-row{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:24px;}
.kpi-card{background:#fff;border-radius:16px;padding:20px;box-shadow:var(--sh);position:relative;overflow:hidden;}
.kpi-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:var(--acc);}
.kpi-card.blue::after{background:var(--blue);}.kpi-card.green::after{background:var(--green);}.kpi-card.red::after{background:var(--red);}
.kpi-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;}
.kpi-ico-wrap{width:42px;height:42px;border-radius:12px;background:var(--acc-s);display:flex;align-items:center;justify-content:center;font-size:20px;}
.kpi-card.blue .kpi-ico-wrap{background:var(--blue-s);}.kpi-card.green .kpi-ico-wrap{background:rgba(46,125,50,.1);}.kpi-card.red .kpi-ico-wrap{background:rgba(198,40,40,.1);}
.kpi-val{font-family:'Nunito',sans-serif;font-size:28px;font-weight:900;color:var(--dark);}
.kpi-lbl{font-size:11px;color:var(--light);font-weight:600;margin-top:2px;}

/* PILLS */
.pill{font-size:10px;font-weight:700;padding:4px 10px;border-radius:999px;display:inline-block;}
.p-att{background:#FBE9E7;color:var(--acc);}
.p-conf{background:#E3F2FD;color:#1565C0;}
.p-prog{background:#E0F2F1;color:#004D40;}
.p-term{background:#E8F5E9;color:var(--green);}
.p-ann{background:#FFEBEE;color:var(--red);}
.p-livreur{background:#E3F2FD;color:#1565C0;}
.p-securite{background:#FFEBEE;color:#B71C1C;}
.p-entretien{background:#F3E5F5;color:#6A1B9A;}
.p-depannage{background:#FFF8E1;color:#F57F17;}
.p-commercial{background:#E8F5E9;color:#1B5E20;}
.p-comm{background:#FCE4EC;color:#C2185B;}
.p-online{background:#E8F5E9;color:var(--green);}
.p-offline{background:#EEE;color:#757575;}

/* FILTERS */
.filters-bar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center;}
.fbtn{background:#fff;border:1.5px solid var(--border);border-radius:999px;padding:7px 14px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;color:var(--mid);transition:all .15s;white-space:nowrap;}
.fbtn.on,.fbtn:hover{background:var(--acc);color:#fff;border-color:var(--acc);}
.fsearch input{padding:9px 14px;border:1.5px solid var(--border);border-radius:999px;font-size:12px;outline:none;font-family:'Poppins',sans-serif;background:#fff;min-width:180px;}
.fsearch input:focus{border-color:var(--acc);}
.action-btn{background:var(--acc);color:#fff;border:none;border-radius:999px;padding:9px 18px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;white-space:nowrap;}
.action-btn:hover{background:var(--acc-d);}

/* TABLE */
.wrap{background:#fff;border-radius:16px;box-shadow:var(--sh);overflow:hidden;}
.t-head{padding:11px 16px;background:var(--bg);font-size:10px;font-weight:700;color:var(--light);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);display:grid;gap:8px;align-items:center;}
.t-row{padding:13px 16px;border-bottom:1px solid var(--border);align-items:center;transition:background .1s;display:grid;gap:8px;}
.t-row:last-child{border-bottom:none;}.t-row:hover{background:#FAFBFC;}
.gcmd{grid-template-columns:110px 1fr 130px 90px 100px 120px;}
.gtask{grid-template-columns:42px 1fr 130px 1fr 100px 90px;}
.gagt{grid-template-columns:42px 1fr 130px 90px 110px 70px;}
.a-av{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,var(--acc),var(--acc-d));display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;font-weight:800;font-family:'Nunito',sans-serif;}
.a-name{font-size:13px;font-weight:700;color:var(--dark);}
.a-code{font-size:10px;color:var(--acc);font-weight:700;font-family:monospace;background:var(--acc-s);padding:2px 7px;border-radius:5px;margin-top:2px;display:inline-block;}

/* MOBILE CARD */
.mcrd{background:#fff;border-radius:14px;padding:15px;box-shadow:var(--sh);margin-bottom:10px;display:none;}
.mcrd-h{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
.mcrd-acts{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;}

/* ACTION BTNS */
.act-btns{display:flex;gap:5px;flex-wrap:wrap;}
.act-v{background:#FBE9E7;color:var(--acc);border:none;border-radius:7px;padding:6px 9px;font-size:12px;cursor:pointer;}
.act-a{background:var(--blue-s);color:var(--blue);border:none;border-radius:7px;padding:6px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;}
.act-g{background:rgba(46,125,50,.1);color:var(--green);border:none;border-radius:7px;padding:6px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;}
.act-d{background:#FFEBEE;color:var(--red);border:none;border-radius:7px;padding:6px 9px;font-size:12px;cursor:pointer;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:none;align-items:center;justify-content:center;padding:16px;}
.modal-overlay.show{display:flex;}
.modal{background:#fff;border-radius:18px;padding:28px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;position:relative;}
.modal-close{position:absolute;top:14px;right:14px;background:var(--bg);border:none;border-radius:9px;width:34px;height:34px;font-size:16px;cursor:pointer;color:var(--mid);}
.modal-title{font-family:'Nunito',sans-serif;font-size:20px;font-weight:900;color:var(--dark);margin-bottom:18px;}
.f-label{display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;}
.f-inp,.f-sel,.f-ta{width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:11px;font-family:'Poppins',sans-serif;font-size:13px;background:var(--bg);outline:none;margin-bottom:13px;transition:border-color .2s;appearance:none;color:var(--dark);}
.f-inp:focus,.f-sel:focus,.f-ta:focus{border-color:var(--acc);background:#fff;}
.f-ta{resize:vertical;min-height:80px;}
.f-2col{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.modal-save-btn{width:100%;background:linear-gradient(135deg,var(--acc),var(--acc-d));color:#fff;border:none;border-radius:999px;padding:13px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;}
.modal-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--bg);font-size:12px;}
.modal-key{color:var(--light);font-weight:600;min-width:120px;}
.modal-val{color:var(--dark);font-weight:600;text-align:right;word-break:break-word;}

/* CARDS (annonces/partenaires/visites) */
.item-card{background:#fff;border-radius:14px;padding:18px;box-shadow:var(--sh);margin-bottom:12px;border-left:4px solid var(--acc);}
.item-card.blue{border-left-color:var(--blue);}
.item-card-head{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px;gap:8px;}
.item-card-title{font-size:14px;font-weight:700;color:var(--dark);}
.item-card-body{font-size:12px;color:var(--mid);line-height:1.6;}

/* TOAST & SPINNER */
.toast{position:fixed;bottom:24px;right:24px;background:#1A1A2E;color:#fff;border-radius:12px;padding:13px 20px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;box-shadow:0 8px 28px rgba(0,0,0,.3);}
.toast.show{opacity:1;}
.spinner{display:inline-block;width:24px;height:24px;border:3px solid rgba(230,81,0,.2);border-top-color:var(--acc);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-msg{text-align:center;padding:48px;color:var(--light);font-size:13px;}

/* RESPONSIVE */
@media(max-width:768px){
  .sidebar{position:fixed;top:0;bottom:0;left:0;z-index:200;transform:translateX(-100%);}
  .sidebar.open{transform:translateX(0);}
  .hamburger{display:flex;}
  .main-inner{padding:60px 16px 40px;}
  .t-head,.t-row{display:none;}
  .mcrd{display:block;}
  .kpi-row{grid-template-columns:1fr 1fr;}
  .f-2col{grid-template-columns:1fr;}
}
@media(min-width:1000px){.kpi-row{grid-template-columns:repeat(4,1fr);}}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-o sp-o1"></div><div class="sp-o sp-o2"></div>
  <div class="sp-c">
    <div class="sp-badge">âš™ï¸ OpÃ©rations</div>
    <div class="sp-logo"><img src="../assets/logo.png" alt="" onerror="this.parentElement.innerHTML='âš™ï¸'"/></div>
    <div class="sp-title">Omni<span class="o">Service</span> TG</div>
    <div class="sp-tag">Centre des OpÃ©rations</div>
    <div class="sp-bar"><div class="sp-bar-f"></div></div>
  </div>
</div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="lbox">
    <div class="l-logo"><img src="../assets/logo.png" alt="" onerror="this.parentElement.innerHTML='âš™ï¸'"/></div>
    <div class="l-title">OmniService <span style="color:var(--ora)">TG</span></div>
    <div class="l-role">âš™ï¸ ChargÃ© des OpÃ©rations</div>
    <label class="l-label">Email</label>
    <input type="email" class="l-inp" id="l-email" value="ops@omniservicetg.com"/>
    <label class="l-label">Mot de passe</label>
    <input type="password" class="l-inp" id="l-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
    <button class="l-btn" id="login-btn">Se connecter â†’</button>
    <div class="l-err" id="l-err"></div>
    <div class="l-info"><b>AccÃ¨s rÃ©servÃ© :</b> Interface du ChargÃ© des OpÃ©rations d'OmniService TG uniquement.</div>
  </div>
</div>

<!-- INTERFACE OPS -->
<div class="layout" id="ops-ui" style="display:none">
  <button class="hamburger" onclick="toggleSidebar()">â˜°</button>

  <aside class="sidebar" id="sidebar">
    <div class="sb-brand">
      <div class="sb-lg"><img src="../assets/logo.png" alt="" onerror="this.parentElement.innerHTML='âš™ï¸'"/></div>
      <div><div class="sb-nm"><span class="b">Omni</span><span class="o">Service</span></div><div class="sb-su">OpÃ©rations</div></div>
    </div>
    <nav class="sb-nav">
      <div class="sb-sec">Tableau de bord</div>
      <button class="sb-item on" onclick="showSection('dashboard',this)"><span class="sb-ico">ğŸ </span>Vue d'ensemble</button>
      <div class="sb-sec">Commandes & Missions</div>
      <button class="sb-item" onclick="showSection('commandes',this)"><span class="sb-ico">ğŸ“¦</span>Commandes clients<span class="sb-badge" id="badge-cmd">0</span></button>
      <button class="sb-item" onclick="showSection('taches',this)"><span class="sb-ico">âœ…</span>TÃ¢ches en cours<span class="sb-badge" id="badge-taches">0</span></button>
      <div class="sb-sec">Agents</div>
      <button class="sb-item" onclick="showSection('agents',this)"><span class="sb-ico">ğŸ‘¥</span>Agents disponibles<span class="sb-badge" id="badge-agents">0</span></button>
      <div class="sb-sec">Communication</div>
      <button class="sb-item" onclick="showSection('annonces',this)"><span class="sb-ico">ğŸ“£</span>Annonces agents</button>
      <button class="sb-item" onclick="showSection('partenaires',this)"><span class="sb-ico">ğŸ¤</span>Partenaires</button>
      <button class="sb-item" onclick="showSection('visites',this)"><span class="sb-ico">ğŸ“</span>Visites terrain</button>
    </nav>
    <div class="sb-footer">
      <div class="sb-ai">
        <div class="sb-av">âš™ï¸</div>
        <div><div class="sb-an">ChargÃ© des Ops</div><div class="sb-ae" id="ops-email-disp"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="741b0407341b191a1d071106021d171100135a171b19">[email&#160;protected]</a></div></div>
      </div>
      <button class="logout-btn" onclick="doLogout()">ğŸšª Se dÃ©connecter</button>
    </div>
  </aside>

  <main class="main">
    <div class="main-inner">

      <!-- DASHBOARD -->
      <div id="section-dashboard">
        <div class="pg-title">âš™ï¸ Tableau de bord OpÃ©rations</div>
        <div class="pg-sub" id="ops-date"></div>
        <div class="kpi-row">
          <div class="kpi-card"><div class="kpi-top"><div class="kpi-ico-wrap">ğŸ“¦</div></div><div class="kpi-val" id="kpi-total">â€”</div><div class="kpi-lbl">Commandes totales</div></div>
          <div class="kpi-card"><div class="kpi-top"><div class="kpi-ico-wrap">â³</div></div><div class="kpi-val" id="kpi-att">â€”</div><div class="kpi-lbl">En attente</div></div>
          <div class="kpi-card blue"><div class="kpi-top"><div class="kpi-ico-wrap">ğŸš€</div></div><div class="kpi-val" id="kpi-prog">â€”</div><div class="kpi-lbl">En cours</div></div>
          <div class="kpi-card green"><div class="kpi-top"><div class="kpi-ico-wrap">âœ…</div></div><div class="kpi-val" id="kpi-term">â€”</div><div class="kpi-lbl">TerminÃ©es</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div style="background:#fff;border-radius:16px;padding:22px;box-shadow:var(--sh);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
              <div style="font-size:15px;font-weight:700;color:var(--dark);">ğŸ“‹ DerniÃ¨res commandes</div>
              <button class="action-btn" style="padding:6px 12px;font-size:11px;" onclick="loadDashboard()">ğŸ”„</button>
            </div>
            <div id="recent-orders"></div>
          </div>
          <div style="background:#fff;border-radius:16px;padding:22px;box-shadow:var(--sh);">
            <div style="font-size:15px;font-weight:700;color:var(--dark);margin-bottom:14px;">ğŸŸ¢ Agents en ligne</div>
            <div id="online-mini"></div>
          </div>
        </div>
      </div>

      <!-- COMMANDES -->
      <div id="section-commandes" style="display:none">
        <div class="pg-title">ğŸ“¦ Commandes clients</div>
        <div class="pg-sub">Assignez les commandes aux agents disponibles</div>
        <div class="filters-bar">
          <button class="fbtn on" onclick="filterOrders('all',this)">Toutes</button>
          <button class="fbtn" onclick="filterOrders('En attente',this)">â³ En attente</button>
          <button class="fbtn" onclick="filterOrders('ConfirmÃ©e',this)">âœ… ConfirmÃ©es</button>
          <button class="fbtn" onclick="filterOrders('En cours',this)">ğŸš€ En cours</button>
          <button class="fbtn" onclick="filterOrders('TerminÃ©e',this)">ğŸ‰ TerminÃ©es</button>
          <button class="fbtn" onclick="filterOrders('AnnulÃ©e',this)">âŒ AnnulÃ©es</button>
          <div class="fsearch"><input type="text" placeholder="ğŸ” RÃ©f, client, service..." oninput="searchOrders(this.value)"/></div>
        </div>
        <div class="wrap">
          <div class="t-head gcmd"><div>RÃ©f / Date</div><div>Client & Service</div><div>Agent</div><div>PrioritÃ©</div><div>Statut</div><div>Actions</div></div>
          <div id="orders-table"><div class="empty-msg"><div class="spinner"></div></div></div>
        </div>
        <div id="orders-mobile"></div>
      </div>

      <!-- TACHES -->
      <div id="section-taches" style="display:none">
        <div class="pg-title">âœ… TÃ¢ches en cours</div>
        <div class="pg-sub">Missions actuellement assignÃ©es aux agents</div>
        <div class="filters-bar">
          <button class="fbtn on" onclick="filterTasks('all',this)">Tous les rÃ´les</button>
          <button class="fbtn" onclick="filterTasks('livreur',this)">ğŸ›µ Livreurs</button>
          <button class="fbtn" onclick="filterTasks('securite',this)">ğŸ”’ SÃ©curitÃ©</button>
          <button class="fbtn" onclick="filterTasks('entretien',this)">ğŸ§¹ Entretien</button>
          <button class="fbtn" onclick="filterTasks('depannage',this)">ğŸ”§ DÃ©pannage</button>
          <button class="fbtn" onclick="filterTasks('commercial',this)">ğŸ’¼ Commercial</button>
          <button class="fbtn" onclick="filterTasks('comm',this)">ğŸ“¢ Comm.</button>
        </div>
        <div class="wrap">
          <div class="t-head gtask"><div></div><div>Agent</div><div>RÃ´le</div><div>Mission</div><div>Statut</div><div>Actions</div></div>
          <div id="tasks-table"><div class="empty-msg"><div class="spinner"></div></div></div>
        </div>
        <div id="tasks-mobile"></div>
      </div>

      <!-- AGENTS -->
      <div id="section-agents" style="display:none">
        <div class="pg-title">ğŸ‘¥ Agents disponibles</div>
        <div class="pg-sub">Agents enregistrÃ©s par le RH â€” statut et disponibilitÃ©</div>
        <div class="filters-bar">
          <button class="fbtn on" onclick="filterAgents('all',this)">Tous</button>
          <button class="fbtn" onclick="filterAgents('livreur',this)">ğŸ›µ Livreurs</button>
          <button class="fbtn" onclick="filterAgents('securite',this)">ğŸ”’ SÃ©curitÃ©</button>
          <button class="fbtn" onclick="filterAgents('entretien',this)">ğŸ§¹ Entretien</button>
          <button class="fbtn" onclick="filterAgents('depannage',this)">ğŸ”§ DÃ©pannage</button>
          <button class="fbtn" onclick="filterAgents('commercial',this)">ğŸ’¼ Commercial</button>
          <button class="fbtn" onclick="filterAgents('comm',this)">ğŸ“¢ Comm.</button>
          <div class="fsearch"><input type="text" placeholder="ğŸ” Nom, code..." oninput="searchAgents(this.value)"/></div>
        </div>
        <div class="wrap">
          <div class="t-head gagt"><div></div><div>Agent</div><div>RÃ´le</div><div>Zone</div><div>Statut</div><div>Voir</div></div>
          <div id="agents-table"><div class="empty-msg"><div class="spinner"></div></div></div>
        </div>
        <div id="agents-mobile"></div>
      </div>

      <!-- ANNONCES -->
      <div id="section-annonces" style="display:none">
        <div class="pg-title">ğŸ“£ Annonces agents</div>
        <div class="pg-sub">Messages publiÃ©s Ã  l'attention des agents de terrain</div>
        <button class="action-btn" style="margin-bottom:20px" onclick="openModal('annonce')">â• Nouvelle annonce</button>
        <div id="annonces-list"><div class="empty-msg"><div class="spinner"></div></div></div>
      </div>

      <!-- PARTENAIRES -->
      <div id="section-partenaires" style="display:none">
        <div class="pg-title">ğŸ¤ Partenaires</div>
        <div class="pg-sub">Entreprises et prestataires externes</div>
        <button class="action-btn" style="margin-bottom:20px" onclick="openModal('partenaire')">â• Ajouter un partenaire</button>
        <div id="partenaires-list"><div class="empty-msg"><div class="spinner"></div></div></div>
      </div>

      <!-- VISITES -->
      <div id="section-visites" style="display:none">
        <div class="pg-title">ğŸ“ Visites terrain</div>
        <div class="pg-sub">Planifiez les visites des agents commerciaux</div>
        <button class="action-btn" style="margin-bottom:20px" onclick="openModal('visite')">â• Planifier une visite</button>
        <div id="visites-list"><div class="empty-msg"><div class="spinner"></div></div></div>
      </div>

    </div>
  </main>
</div>

<!-- MODAL ASSIGNER -->
<div class="modal-overlay" id="modal-assigner">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('assigner')">âœ•</button>
    <div class="modal-title">ğŸ‘¤ Assigner un agent</div>
    <input type="hidden" id="assign-oid"/>
    <div style="background:var(--bg);border-radius:11px;padding:14px;margin-bottom:16px;font-size:12px;line-height:1.6" id="assign-info"></div>
    <label class="f-label">Agent *</label>
    <select class="f-sel" id="assign-agent"></select>
    <label class="f-label">PrioritÃ©</label>
    <select class="f-sel" id="assign-prio">
      <option value="Normale">Normale</option>
      <option value="Haute">âš¡ Haute</option>
      <option value="Basse">Basse</option>
    </select>
    <label class="f-label">Note pour l'agent (optionnel)</label>
    <textarea class="f-ta" id="assign-note" placeholder="Instructions, adresse prÃ©cise, contact client..."></textarea>
    <button class="modal-save-btn" onclick="confirmAssign()">âœ… Assigner la mission</button>
    <div class="l-err" id="assign-err"></div>
  </div>
</div>

<!-- MODAL DETAIL -->
<div class="modal-overlay" id="modal-detail">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('detail')">âœ•</button>
    <div class="modal-title" id="detail-title">DÃ©tail</div>
    <div id="detail-body"></div>
  </div>
</div>

<!-- MODAL ANNONCE -->
<div class="modal-overlay" id="modal-annonce">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('annonce')">âœ•</button>
    <div class="modal-title">ğŸ“£ Nouvelle annonce</div>
    <label class="f-label">Titre *</label>
    <input type="text" class="f-inp" id="ann-titre" placeholder="Ex : RÃ©union lundi 8h"/>
    <label class="f-label">Destinataires</label>
    <select class="f-sel" id="ann-cible">
      <option value="tous">Tous les agents</option>
      <option value="livreur">ğŸ›µ Livreurs</option>
      <option value="securite">ğŸ”’ SÃ©curitÃ©</option>
      <option value="entretien">ğŸ§¹ Entretien</option>
      <option value="depannage">ğŸ”§ DÃ©pannage</option>
      <option value="commercial">ğŸ’¼ Commercial</option>
      <option value="comm">ğŸ“¢ Communication</option>
    </select>
    <label class="f-label">Message *</label>
    <textarea class="f-ta" id="ann-msg" placeholder="Contenu de l'annonce..."></textarea>
    <button class="modal-save-btn" onclick="saveAnnonce()">ğŸ“£ Publier</button>
    <div class="l-err" id="ann-err"></div>
  </div>
</div>

<!-- MODAL PARTENAIRE -->
<div class="modal-overlay" id="modal-partenaire">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('partenaire')">âœ•</button>
    <div class="modal-title">ğŸ¤ Nouveau partenaire</div>
    <label class="f-label">Nom de l'entreprise *</label>
    <input type="text" class="f-inp" id="pt-nom" placeholder="Ex : TransTogo SARL"/>
    <div class="f-2col">
      <div><label class="f-label">Domaine *</label>
        <select class="f-sel" id="pt-dom" style="margin-bottom:0">
          <option value="">â€” Choisir â€”</option>
          <option>ğŸš› Transport</option><option>ğŸ”’ SÃ©curitÃ©</option><option>ğŸ§¹ Entretien</option>
          <option>ğŸ’» IT / Technique</option><option>ğŸ¥˜ Alimentation</option><option>ğŸ¢ Immobilier</option><option>ğŸ“¦ Autre</option>
        </select>
      </div>
      <div><label class="f-label">TÃ©lÃ©phone</label><input type="tel" class="f-inp" id="pt-tel" placeholder="+228 XX XX XX XX" style="margin-bottom:0"/></div>
    </div>
    <div style="margin-bottom:13px"></div>
    <label class="f-label">Contact rÃ©fÃ©rent</label>
    <input type="text" class="f-inp" id="pt-contact" placeholder="Nom du contact"/>
    <label class="f-label">Notes (optionnel)</label>
    <textarea class="f-ta" id="pt-notes" placeholder="Tarifs, conditions, remarques..."></textarea>
    <button class="modal-save-btn" onclick="savePartenaire()">ğŸ’¾ Enregistrer</button>
    <div class="l-err" id="pt-err"></div>
  </div>
</div>

<!-- MODAL VISITE -->
<div class="modal-overlay" id="modal-visite">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('visite')">âœ•</button>
    <div class="modal-title">ğŸ“ Planifier une visite</div>
    <label class="f-label">Agent commercial *</label>
    <select class="f-sel" id="vs-agent"></select>
    <label class="f-label">Prospect / Client *</label>
    <input type="text" class="f-inp" id="vs-client" placeholder="Nom ou raison sociale"/>
    <div class="f-2col">
      <div><label class="f-label">Date *</label><input type="date" class="f-inp" id="vs-date" style="margin-bottom:0"/></div>
      <div><label class="f-label">Heure</label><input type="time" class="f-inp" id="vs-heure" style="margin-bottom:0"/></div>
    </div>
    <div style="margin-bottom:13px"></div>
    <label class="f-label">Zone / Quartier *</label>
    <input type="text" class="f-inp" id="vs-zone" placeholder="Ex : AgoÃ¨, BÃ¨, Tokoin..."/>
    <label class="f-label">Objectif</label>
    <textarea class="f-ta" id="vs-obj" placeholder="PrÃ©sentation, relance, signature contrat..."></textarea>
    <button class="modal-save-btn" onclick="saveVisite()">ğŸ“ Planifier</button>
    <div class="l-err" id="vs-err"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="module">
import { initializeApp }    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc,
         doc, query, where, orderBy, serverTimestamp }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const fbConfig={apiKey:"AIzaSyDtDK7-iDRy1E-kjZubjyjkPW7Th33BMyU",authDomain:"omniservicetg-59df3.firebaseapp.com",projectId:"omniservicetg-59df3",storageBucket:"omniservicetg-59df3.firebasestorage.app",messagingSenderId:"196278567761",appId:"1:196278567761:web:4f6416acaab58b67bf4970"};
const fbApp=initializeApp(fbConfig);
const db=getFirestore(fbApp);
const auth=getAuth(fbApp);
const OPS_EMAIL='ops@omniservicetg.com';

const RL={livreur:'ğŸ›µ Livreur',securite:'ğŸ”’ SÃ©curitÃ©',entretien:'ğŸ§¹ Entretien',depannage:'ğŸ”§ DÃ©pannage',commercial:'ğŸ’¼ Commercial',comm:'ğŸ“¢ Communication',ops:'âš™ï¸ OpÃ©rations'};
const RC={livreur:'p-livreur',securite:'p-securite',entretien:'p-entretien',depannage:'p-depannage',commercial:'p-commercial',comm:'p-comm'};

let orders=[],agents=[],annonces=[],parts=[],visites=[];
let fStatut='all',fSearch='',fRole='all',fTask='all';

if(typeof window._hideSplash==='function')window._hideSplash();

onAuthStateChanged(auth,async user=>{
  if(typeof window._hideSplash==='function')window._hideSplash();
  if(user&&user.email===OPS_EMAIL){
    document.getElementById('login-screen').style.display='none';
    document.getElementById('ops-ui').style.display='flex';
    document.getElementById('ops-email-disp').textContent=user.email;
    document.getElementById('ops-date').textContent=new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
    await loadDashboard();
  }else{
    if(user){await signOut(auth);toast('â›” AccÃ¨s non autorisÃ©','#C62828');}
    document.getElementById('login-screen').style.display='flex';
    document.getElementById('ops-ui').style.display='none';
  }
});

async function doLogin(){
  const e=document.getElementById('l-email').value.trim(),p=document.getElementById('l-pass').value;
  const btn=document.getElementById('login-btn'),err=document.getElementById('l-err');
  err.textContent='';if(!e||!p){err.textContent='âš ï¸ Champs obligatoires.';return;}
  btn.disabled=true;btn.textContent='â³â€¦';
  try{await signInWithEmailAndPassword(auth,e,p);}
  catch(x){err.textContent=x.code?.includes('credential')||x.code?.includes('password')?'âŒ Email ou mot de passe incorrect.':'âŒ '+x.message;}
  finally{btn.disabled=false;btn.textContent='Se connecter â†’';}
}
window.doLogin=doLogin;
window.doLogout=async function(){await signOut(auth);};
window.toggleSidebar=function(){document.getElementById('sidebar').classList.toggle('open');};

// Les modules ES6 s'exÃ©cutent aprÃ¨s le DOM â€” on attache directement
const _loginBtn=document.getElementById('login-btn');
const _loginPass=document.getElementById('l-pass');
if(_loginBtn)_loginBtn.addEventListener('click',doLogin);
if(_loginPass)_loginPass.addEventListener('keydown',function(ev){if(ev.key==='Enter')doLogin();});

const SECS=['dashboard','commandes','taches','agents','annonces','partenaires','visites'];
window.showSection=function(id,btn){
  SECS.forEach(s=>{const el=document.getElementById('section-'+s);if(el)el.style.display=s===id?'block':'none';});
  document.querySelectorAll('.sb-item').forEach(b=>b.classList.remove('on'));
  if(btn)btn.classList.add('on');
  if(window.innerWidth<769)document.getElementById('sidebar').classList.remove('open');
  if(id==='commandes')loadOrders();
  if(id==='taches')loadTaches();
  if(id==='agents')loadAgents();
  if(id==='annonces')loadAnnonces();
  if(id==='partenaires')loadParts();
  if(id==='visites')loadVisites();
};

function toast(msg,bg='#1A1A2E'){const t=document.getElementById('toast');t.textContent=msg;t.style.background=bg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
function fmtD(ts){if(!ts)return'â€”';try{return ts.toDate().toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'});}catch(e){return'â€”';}}
function sp(s){return({'En attente':'p-att','ConfirmÃ©e':'p-conf','En cours':'p-prog','TerminÃ©e':'p-term','AnnulÃ©e':'p-ann'}[s]||'p-att');}

window.openModal=function(id,extra){
  if(id==='assigner'&&extra){
    const o=orders.find(x=>x.id===extra);if(!o)return;
    document.getElementById('assign-oid').value=extra;
    document.getElementById('assign-info').innerHTML=`<b>${o.serviceName||o.service||'â€”'}</b><br/><span style="color:var(--mid)">Client : ${o.clientNom||o.nomClient||'â€”'} Â· ${o.phone||o.clientTel||'â€”'}</span>`;
    document.getElementById('assign-agent').innerHTML='<option value="">â€” SÃ©lectionner â€”</option>'+agents.filter(a=>a.actif!==false).map(a=>`<option value="${a.id}">${RL[a.role]||a.role} Â· ${a.nom} (${a.code})</option>`).join('');
    document.getElementById('assign-note').value='';document.getElementById('assign-err').textContent='';
  }
  if(id==='visite'){
    document.getElementById('vs-agent').innerHTML='<option value="">â€” Choisir â€”</option>'+agents.filter(a=>a.role==='commercial'&&a.actif!==false).map(a=>`<option value="${a.id}">${a.nom} (${a.code})</option>`).join('');
  }
  document.getElementById('modal-'+id).classList.add('show');
};
window.closeModal=function(id){document.getElementById('modal-'+id).classList.remove('show');};

// â•â•â• DASHBOARD â•â•â•
async function loadDashboard(){
  try{
    const[os,as_]=await Promise.all([getDocs(collection(db,'commandes')),getDocs(collection(db,'agents'))]);
    orders=os.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
    agents=as_.docs.map(d=>({id:d.id,...d.data()}));
    const att=orders.filter(o=>o.statut==='En attente').length;
    const prog=orders.filter(o=>['ConfirmÃ©e','En cours'].includes(o.statut)).length;
    const term=orders.filter(o=>o.statut==='TerminÃ©e').length;
    document.getElementById('kpi-total').textContent=orders.length;
    document.getElementById('kpi-att').textContent=att;
    document.getElementById('kpi-prog').textContent=prog;
    document.getElementById('kpi-term').textContent=term;
    document.getElementById('badge-cmd').textContent=att;
    document.getElementById('badge-taches').textContent=prog;
    document.getElementById('badge-agents').textContent=agents.filter(a=>a.actif!==false).length;
    // DerniÃ¨res commandes
    document.getElementById('recent-orders').innerHTML=orders.slice(0,5).map(o=>`
      <div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border)">
        <span class="pill ${sp(o.statut)}">${o.statut||'â€”'}</span>
        <div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:700;color:var(--dark);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${o.serviceName||o.service||'â€”'}</div>
          <div style="font-size:10px;color:var(--light)">${o.clientNom||o.nomClient||'â€”'} Â· ${fmtD(o.createdAt)}</div></div>
        <span style="font-size:10px;font-family:monospace;color:var(--acc)">#${(o.id||'').slice(0,8).toUpperCase()}</span>
      </div>`).join('')||'<div class="empty-msg">Aucune commande.</div>';
    // Agents en ligne
    const now=Date.now(),online=agents.filter(a=>a.derniere_connexion&&(now-a.derniere_connexion.toMillis())<15*60*1000);
    document.getElementById('online-mini').innerHTML=online.length
      ?`<div style="display:flex;flex-wrap:wrap;gap:8px">`+online.map(a=>`<div style="background:var(--bg);border-radius:9px;padding:8px 12px;display:flex;align-items:center;gap:7px"><div style="width:7px;height:7px;border-radius:50%;background:var(--green)"></div><span style="font-size:12px;font-weight:600;color:var(--dark)">${a.nom}</span><span class="pill ${RC[a.role]||'p-livreur'}" style="font-size:9px;padding:2px 7px">${RL[a.role]||a.role}</span></div>`).join('')+`</div>`
      :'<div style="font-size:12px;color:var(--light);padding:8px 0">Aucun agent en ligne actuellement.</div>';
  }catch(e){console.error(e);}
}

// â•â•â• COMMANDES â•â•â•
async function loadOrders(){
  document.getElementById('orders-table').innerHTML='<div class="empty-msg"><div class="spinner"></div></div>';
  document.getElementById('orders-mobile').innerHTML='';
  try{
    const[os,as_]=await Promise.all([getDocs(collection(db,'commandes')),getDocs(collection(db,'agents'))]);
    orders=os.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));agents=as_.docs.map(d=>({id:d.id,...d.data()}));
  }catch(e){document.getElementById('orders-table').innerHTML='<div class="empty-msg">Erreur.</div>';return;}
  renderOrders();
}
function renderOrders(){
  let list=orders;
  if(fStatut!=='all')list=list.filter(o=>o.statut===fStatut);
  if(fSearch)list=list.filter(o=>(o.id||'').toLowerCase().includes(fSearch)||(o.clientNom||o.nomClient||'').toLowerCase().includes(fSearch)||(o.serviceName||o.service||'').toLowerCase().includes(fSearch));
  const dEl=document.getElementById('orders-table'),mEl=document.getElementById('orders-mobile');
  if(!list.length){dEl.innerHTML='<div class="empty-msg">Aucune commande.</div>';mEl.innerHTML='';return;}
  dEl.innerHTML=list.map(o=>{
    const ag=o.agentId?agents.find(a=>a.id===o.agentId):null;
    return`<div class="t-row gcmd">
      <div><div style="font-size:11px;font-weight:700;font-family:monospace;color:var(--acc)">#${(o.id||'').slice(0,8).toUpperCase()}</div><div style="font-size:10px;color:var(--light)">${fmtD(o.createdAt)}</div></div>
      <div><div style="font-size:13px;font-weight:700;color:var(--dark);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${o.clientNom||o.nomClient||'â€”'}</div><div style="font-size:11px;color:var(--light)">${o.serviceName||o.service||'â€”'}</div><div style="font-size:10px;color:var(--light)">${o.phone||o.clientTel||''}</div></div>
      <div>${ag?`<div class="a-code">${ag.code}</div><div style="font-size:11px;color:var(--mid);margin-top:2px">${ag.nom}</div>`:'<span style="font-size:11px;color:var(--light)">Non assignÃ©</span>'}</div>
      <div><span class="pill ${o.priorite==='Haute'?'p-att':o.priorite==='Basse'?'p-conf':'p-prog'}">${o.priorite||'Normale'}</span></div>
      <div><span class="pill ${sp(o.statut)}">${o.statut||'â€”'}</span></div>
      <div class="act-btns">
        <button class="act-v" onclick="voirCmd('${o.id}')">ğŸ‘ï¸</button>
        ${o.statut==='En attente'?`<button class="act-a" onclick="openModal('assigner','${o.id}')">ğŸ‘¤</button>`:''}
        ${['En attente','ConfirmÃ©e'].includes(o.statut)?`<button class="act-g" onclick="setStatut('${o.id}','En cours')">ğŸš€</button>`:''}
        ${o.statut==='En cours'?`<button class="act-g" onclick="setStatut('${o.id}','TerminÃ©e')">âœ…</button>`:''}
      </div>
    </div>`;
  }).join('');
  mEl.innerHTML=list.map(o=>{
    const ag=o.agentId?agents.find(a=>a.id===o.agentId):null;
    return`<div class="mcrd"><div class="mcrd-h"><div><div style="font-size:11px;font-family:monospace;color:var(--acc)">#${(o.id||'').slice(0,8).toUpperCase()}</div><div style="font-size:13px;font-weight:700;color:var(--dark);margin-top:2px">${o.clientNom||o.nomClient||'â€”'}</div><div style="font-size:11px;color:var(--light)">${o.serviceName||o.service||'â€”'}</div></div><span class="pill ${sp(o.statut)}">${o.statut||'â€”'}</span></div>
      <div style="font-size:11px;color:var(--mid)">Agent : ${ag?ag.nom+' ('+ag.code+')':'Non assignÃ©'}</div>
      <div style="font-size:10px;color:var(--light);margin-top:2px">${fmtD(o.createdAt)}</div>
      <div class="mcrd-acts"><button class="act-v" onclick="voirCmd('${o.id}')">ğŸ‘ï¸ Voir</button>${o.statut==='En attente'?`<button class="act-a" onclick="openModal('assigner','${o.id}')">ğŸ‘¤ Assigner</button>`:''}</div>
    </div>`;
  }).join('');
}
window.filterOrders=function(s,btn){fStatut=s;document.querySelectorAll('#section-commandes .fbtn').forEach(b=>b.classList.remove('on'));if(btn)btn.classList.add('on');renderOrders();};
window.searchOrders=function(v){fSearch=v.toLowerCase();renderOrders();};

window.voirCmd=function(id){
  const o=orders.find(x=>x.id===id);if(!o)return;
  const ag=o.agentId?agents.find(a=>a.id===o.agentId):null;
  document.getElementById('detail-title').textContent='ğŸ“¦ #'+(o.id||'').slice(0,8).toUpperCase();
  document.getElementById('detail-body').innerHTML=[['Service',o.serviceName||o.service||'â€”'],['Client',o.clientNom||o.nomClient||'â€”'],['TÃ©lÃ©phone',o.phone||o.clientTel||'â€”'],['Ville',o.clientVille||'â€”'],['Statut',o.statut||'â€”'],['PrioritÃ©',o.priorite||'Normale'],['Agent',ag?ag.nom+' ('+ag.code+')':'Non assignÃ©'],['Note',o.noteAgent||'â€”'],['Adresse',o.adresseLivraison||o.adresse||'â€”'],['Date',fmtD(o.createdAt)],['Description',o.besoin||o.description||'â€”']].map(([k,v])=>`<div class="modal-row"><div class="modal-key">${k}</div><div class="modal-val">${v}</div></div>`).join('');
  openModal('detail');
};
window.setStatut=async function(id,statut){
  try{await updateDoc(doc(db,'commandes',id),{statut,updatedAt:serverTimestamp()});const o=orders.find(x=>x.id===id);if(o)o.statut=statut;renderOrders();toast('âœ… '+statut,'#2E7D32');}
  catch(e){toast('âŒ '+e.message,'#C62828');}
};
window.confirmAssign=async function(){
  const oid=document.getElementById('assign-oid').value,aid=document.getElementById('assign-agent').value;
  const prio=document.getElementById('assign-prio').value,note=document.getElementById('assign-note').value.trim();
  const err=document.getElementById('assign-err');err.textContent='';
  if(!aid){err.textContent='âš ï¸ SÃ©lectionnez un agent.';return;}
  try{
    await updateDoc(doc(db,'commandes',oid),{agentId:aid,priorite:prio,noteAgent:note||null,statut:'ConfirmÃ©e',updatedAt:serverTimestamp()});
    const o=orders.find(x=>x.id===oid);if(o){o.agentId=aid;o.priorite=prio;o.noteAgent=note;o.statut='ConfirmÃ©e';}
    closeModal('assigner');renderOrders();toast('âœ… Mission assignÃ©e','#2E7D32');
  }catch(e){err.textContent='âŒ '+e.message;}
};

// â•â•â• TÃ‚CHES â•â•â•
async function loadTaches(){
  document.getElementById('tasks-table').innerHTML='<div class="empty-msg"><div class="spinner"></div></div>';
  try{
    const[os,as_]=await Promise.all([getDocs(collection(db,'commandes')),getDocs(collection(db,'agents'))]);
    orders=os.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));agents=as_.docs.map(d=>({id:d.id,...d.data()}));
  }catch(e){document.getElementById('tasks-table').innerHTML='<div class="empty-msg">Erreur.</div>';return;}
  renderTaches();
}
function renderTaches(){
  let list=orders.filter(o=>o.agentId&&['ConfirmÃ©e','En cours'].includes(o.statut));
  if(fTask!=='all')list=list.filter(o=>{const a=agents.find(x=>x.id===o.agentId);return a&&a.role===fTask;});
  const dEl=document.getElementById('tasks-table'),mEl=document.getElementById('tasks-mobile');
  if(!list.length){dEl.innerHTML='<div class="empty-msg">Aucune tÃ¢che en cours.</div>';mEl.innerHTML='';return;}
  dEl.innerHTML=list.map(o=>{const a=agents.find(x=>x.id===o.agentId);return`<div class="t-row gtask">
    <div class="a-av">${a?(a.nom||'?').charAt(0).toUpperCase():'?'}</div>
    <div><div class="a-name">${a?a.nom:'â€”'}</div><div class="a-code">${a?a.code:'â€”'}</div></div>
    <div>${a?`<span class="pill ${RC[a.role]||''}">${RL[a.role]||a.role}</span>`:'â€”'}</div>
    <div style="font-size:12px;color:var(--mid)">${o.serviceName||o.service||'â€”'} â€” ${o.clientNom||o.nomClient||'â€”'}</div>
    <div><span class="pill ${sp(o.statut)}">${o.statut}</span></div>
    <div class="act-btns"><button class="act-v" onclick="voirCmd('${o.id}')">ğŸ‘ï¸</button><button class="act-g" onclick="setStatut('${o.id}','TerminÃ©e')">âœ…</button></div>
  </div>`;}).join('');
  mEl.innerHTML=list.map(o=>{const a=agents.find(x=>x.id===o.agentId);return`<div class="mcrd"><div class="mcrd-h"><div style="display:flex;align-items:center;gap:10px"><div class="a-av">${a?(a.nom||'?').charAt(0).toUpperCase():'?'}</div><div><div class="a-name">${a?a.nom:'â€”'}</div><div class="a-code">${a?a.code:'â€”'}</div></div></div><span class="pill ${sp(o.statut)}">${o.statut}</span></div><div style="font-size:12px;color:var(--mid)">${o.serviceName||o.service||'â€”'} Â· ${o.clientNom||o.nomClient||'â€”'}</div><div class="mcrd-acts"><button class="act-v" onclick="voirCmd('${o.id}')">ğŸ‘ï¸</button><button class="act-g" onclick="setStatut('${o.id}','TerminÃ©e')">âœ… Terminer</button></div></div>`;}).join('');
}
window.filterTasks=function(r,btn){fTask=r;document.querySelectorAll('#section-taches .fbtn').forEach(b=>b.classList.remove('on'));if(btn)btn.classList.add('on');renderTaches();};

// â•â•â• AGENTS â•â•â•
async function loadAgents(){
  document.getElementById('agents-table').innerHTML='<div class="empty-msg"><div class="spinner"></div></div>';
  document.getElementById('agents-mobile').innerHTML='';
  try{const snap=await getDocs(collection(db,'agents'));agents=snap.docs.map(d=>({id:d.id,...d.data()}));}
  catch(e){document.getElementById('agents-table').innerHTML='<div class="empty-msg">Erreur.</div>';return;}
  renderAgents();
}
function renderAgents(){
  let list=agents;
  if(fRole!=='all')list=list.filter(a=>a.role===fRole);
  if(fSearch)list=list.filter(a=>(a.nom||'').toLowerCase().includes(fSearch)||(a.code||'').toLowerCase().includes(fSearch));
  const dEl=document.getElementById('agents-table'),mEl=document.getElementById('agents-mobile');
  if(!list.length){dEl.innerHTML='<div class="empty-msg">Aucun agent.</div>';mEl.innerHTML='';return;}
  const now=Date.now();
  dEl.innerHTML=list.map(a=>{const onl=a.derniere_connexion&&(now-a.derniere_connexion.toMillis())<15*60*1000;return`<div class="t-row gagt">
    <div class="a-av">${(a.nom||'?').charAt(0).toUpperCase()}</div>
    <div><div class="a-name">${a.nom||'â€”'}</div><div class="a-code">${a.code||'â€”'}</div></div>
    <div><span class="pill ${RC[a.role]||'p-livreur'}">${RL[a.role]||a.role||'â€”'}</span></div>
    <div style="font-size:12px;color:var(--mid)">${a.zone||'â€”'}</div>
    <div><span class="pill ${onl?'p-online':'p-offline'}">${onl?'ğŸŸ¢ En ligne':'âš« Hors ligne'}</span>${a.actif===false?'<br/><span class="pill p-ann" style="margin-top:3px;display:inline-block">Inactif</span>':''}</div>
    <div><button class="act-v" onclick="voirAgent('${a.id}')">ğŸ‘ï¸</button></div>
  </div>`;}).join('');
  mEl.innerHTML=list.map(a=>{const onl=a.derniere_connexion&&(now-a.derniere_connexion.toMillis())<15*60*1000;return`<div class="mcrd"><div class="mcrd-h"><div style="display:flex;align-items:center;gap:10px"><div class="a-av">${(a.nom||'?').charAt(0).toUpperCase()}</div><div><div class="a-name">${a.nom||'â€”'}</div><div class="a-code">${a.code||'â€”'}</div></div></div><span class="pill ${onl?'p-online':'p-offline'}">${onl?'ğŸŸ¢':'âš«'}</span></div><span class="pill ${RC[a.role]||'p-livreur'}">${RL[a.role]||a.role}</span> Â· <span style="font-size:11px;color:var(--light)">${a.zone||'â€”'}</span><div class="mcrd-acts"><button class="act-v" onclick="voirAgent('${a.id}')">ğŸ‘ï¸ Profil</button></div></div>`;}).join('');
}
window.filterAgents=function(r,btn){fRole=r;document.querySelectorAll('#section-agents .fbtn').forEach(b=>b.classList.remove('on'));if(btn)btn.classList.add('on');renderAgents();};
window.searchAgents=function(v){fSearch=v.toLowerCase();renderAgents();};
window.voirAgent=function(id){
  const a=agents.find(x=>x.id===id);if(!a)return;
  const now=Date.now(),onl=a.derniere_connexion&&(now-a.derniere_connexion.toMillis())<15*60*1000;
  document.getElementById('detail-title').textContent='ğŸ‘¤ '+a.nom;
  document.getElementById('detail-body').innerHTML=[['Nom',a.nom||'â€”'],['Code RH',a.code||'â€”'],['RÃ´le',RL[a.role]||a.role||'â€”'],['Zone',a.zone||'â€”'],['TÃ©lÃ©phone',a.telephone||'â€”'],['SpÃ©cialitÃ©',a.specialite||'â€”'],['Connexion',onl?'ğŸŸ¢ En ligne':'âš« Hors ligne'],['Compte',a.actif===false?'âŒ DÃ©sactivÃ©':'âœ… Actif']].map(([k,v])=>`<div class="modal-row"><div class="modal-key">${k}</div><div class="modal-val">${v}</div></div>`).join('');
  openModal('detail');
};

// â•â•â• ANNONCES â•â•â•
async function loadAnnonces(){
  document.getElementById('annonces-list').innerHTML='<div class="empty-msg"><div class="spinner"></div></div>';
  try{const snap=await getDocs(collection(db,'annonces_ops')));annonces=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));}catch(e){annonces=[];}
  const cL={tous:'Tous',livreur:'ğŸ›µ Livreurs',securite:'ğŸ”’ SÃ©curitÃ©',entretien:'ğŸ§¹ Entretien',depannage:'ğŸ”§ DÃ©pannage',commercial:'ğŸ’¼ Commercial',comm:'ğŸ“¢ Comm.'};
  document.getElementById('annonces-list').innerHTML=annonces.length
    ?annonces.map(a=>`<div class="item-card"><div class="item-card-head"><div class="item-card-title">ğŸ“£ ${a.titre||'â€”'}</div><div style="display:flex;align-items:center;gap:8px"><span class="pill p-prog">${cL[a.cible]||a.cible||'Tous'}</span><span style="font-size:10px;color:var(--light)">${fmtD(a.createdAt)}</span><button class="act-d" onclick="delItem('annonces_ops','${a.id}','annonce')">ğŸ—‘ï¸</button></div></div><div class="item-card-body">${a.message||''}</div></div>`).join('')
    :'<div class="empty-msg">Aucune annonce.</div>';
}
window.saveAnnonce=async function(){
  const titre=document.getElementById('ann-titre').value.trim(),cible=document.getElementById('ann-cible').value,msg=document.getElementById('ann-msg').value.trim();
  const err=document.getElementById('ann-err');err.textContent='';
  if(!titre||!msg){err.textContent='âš ï¸ Titre et message obligatoires.';return;}
  try{await addDoc(collection(db,'annonces_ops'),{titre,cible,message:msg,createdAt:serverTimestamp()});closeModal('annonce');document.getElementById('ann-titre').value='';document.getElementById('ann-msg').value='';toast('ğŸ“£ Annonce publiÃ©e','#2E7D32');loadAnnonces();}
  catch(e){err.textContent='âŒ '+e.message;}
};

// â•â•â• PARTENAIRES â•â•â•
async function loadParts(){
  document.getElementById('partenaires-list').innerHTML='<div class="empty-msg"><div class="spinner"></div></div>';
  try{const snap=await getDocs(collection(db,'partenaires_ops')));parts=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));}catch(e){parts=[];}
  document.getElementById('partenaires-list').innerHTML=parts.length
    ?`<div class="wrap"><div class="t-head" style="grid-template-columns:1fr 120px 140px 60px"><div>Entreprise</div><div>Domaine</div><div>Contact</div><div></div></div>`+parts.map(p=>`<div class="t-row" style="grid-template-columns:1fr 120px 140px 60px"><div><div style="font-size:13px;font-weight:700;color:var(--dark)">${p.nom||'â€”'}</div><div style="font-size:11px;color:var(--light)">${p.notes||''}</div></div><div><span class="pill p-prog">${p.domaine||'â€”'}</span></div><div style="font-size:12px;color:var(--mid)">${p.contact||'â€”'}<br/><span style="font-size:11px;color:var(--light)">${p.telephone||''}</span></div><div><button class="act-d" onclick="delItem('partenaires_ops','${p.id}','partenaire')">ğŸ—‘ï¸</button></div></div>`).join('')+`</div>`
    :'<div class="empty-msg">Aucun partenaire.</div>';
}
window.savePartenaire=async function(){
  const nom=document.getElementById('pt-nom').value.trim(),dom=document.getElementById('pt-dom').value;
  const err=document.getElementById('pt-err');err.textContent='';
  if(!nom||!dom){err.textContent='âš ï¸ Nom et domaine obligatoires.';return;}
  try{await addDoc(collection(db,'partenaires_ops'),{nom,domaine:dom,telephone:document.getElementById('pt-tel').value.trim(),contact:document.getElementById('pt-contact').value.trim(),notes:document.getElementById('pt-notes').value.trim(),createdAt:serverTimestamp()});closeModal('partenaire');['pt-nom','pt-tel','pt-contact','pt-notes'].forEach(id=>document.getElementById(id).value='');toast('âœ… Partenaire enregistrÃ©','#2E7D32');loadParts();}
  catch(e){err.textContent='âŒ '+e.message;}
};

// â•â•â• VISITES â•â•â•
async function loadVisites(){
  document.getElementById('visites-list').innerHTML='<div class="empty-msg"><div class="spinner"></div></div>';
  try{
    const snap=await getDocs(collection(db,'visites_ops')));visites=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
    if(!agents.length){const a=await getDocs(collection(db,'agents'));agents=a.docs.map(d=>({id:d.id,...d.data()}));}
  }catch(e){visites=[];}
  document.getElementById('visites-list').innerHTML=visites.length
    ?visites.map(v=>{const ag=agents.find(a=>a.id===v.agentId);return`<div class="item-card blue"><div class="item-card-head"><div class="item-card-title">ğŸ“ ${v.client||'â€”'}</div><div style="display:flex;align-items:center;gap:8px"><span class="pill p-conf">${v.date||'â€”'}${v.heure?' Â· '+v.heure:''}</span><button class="act-d" onclick="delItem('visites_ops','${v.id}','visite')">ğŸ—‘ï¸</button></div></div><div style="font-size:12px;color:var(--mid);margin-bottom:4px">Agent : ${ag?ag.nom+' ('+ag.code+')':'â€”'} Â· Zone : ${v.zone||'â€”'}</div><div class="item-card-body">${v.objectif||'â€”'}</div></div>`;}).join('')
    :'<div class="empty-msg">Aucune visite planifiÃ©e.</div>';
}
window.saveVisite=async function(){
  const aid=document.getElementById('vs-agent').value,client=document.getElementById('vs-client').value.trim(),date=document.getElementById('vs-date').value,zone=document.getElementById('vs-zone').value.trim();
  const err=document.getElementById('vs-err');err.textContent='';
  if(!aid||!client||!date||!zone){err.textContent='âš ï¸ Champs obligatoires manquants.';return;}
  try{await addDoc(collection(db,'visites_ops'),{agentId:aid,client,date,heure:document.getElementById('vs-heure').value,zone,objectif:document.getElementById('vs-obj').value.trim(),createdAt:serverTimestamp()});closeModal('visite');toast('ğŸ“ Visite planifiÃ©e','#2E7D32');loadVisites();}
  catch(e){err.textContent='âŒ '+e.message;}
};

// â•â•â• DELETE GÃ‰NÃ‰RIQUE â•â•â•
window.delItem=async function(col,id,type){
  if(!confirm('Supprimer ce '+type+' ?'))return;
  try{await deleteDoc(doc(db,col,id));toast('ğŸ—‘ SupprimÃ©','#C62828');
  if(col==='annonces_ops')loadAnnonces();
  else if(col==='partenaires_ops')loadParts();
  else if(col==='visites_ops')loadVisites();
  }catch(e){toast('âŒ '+e.message,'#C62828');}
};

</script>
</body>
</html>
