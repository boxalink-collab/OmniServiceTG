<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OmniService TG ‚Äî Comptable</title>
<link rel="icon" href="../assets/logo.png" type="image/png"/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--blue:#1E6FBE;--blue-d:#155A9C;--blue-s:rgba(30,111,190,.1);--ora:#F5820A;--dark:#1A1A2E;--mid:#4A4A6A;--light:#9999BB;--border:#E8EAF0;--bg:#F4F6FA;--green:#2E7D32;--red:#C62828;--purple:#7B1FA2}
html,body{height:100%;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--dark)}

/* SPLASH */
#splash{position:fixed;inset:0;z-index:9999;background:#0a1220;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px}
.sp-logo{font-size:52px;animation:popIn .6s cubic-bezier(.34,1.56,.64,1) .3s both}
.sp-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:#fff;animation:fadeUp .5s ease .7s both}
.sp-sub{font-size:11px;color:rgba(255,255,255,.4);letter-spacing:1px;text-transform:uppercase;animation:fadeUp .5s ease .9s both}
.sp-bar{width:160px;height:2px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden;animation:fadeUp .4s ease 1s both}
.sp-bar-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--green));animation:load 1.4s ease 1.1s both}
@keyframes load{0%{width:0}100%{width:100%}}
#splash.out{animation:splashOut .4s ease forwards}
@keyframes splashOut{to{opacity:0;pointer-events:none}}
@keyframes popIn{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes fadeUp{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}

/* LOGIN */
#login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0e1420,#1a2540);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;display:none}
.login-box{background:#fff;border-radius:24px;padding:36px 28px;width:100%;max-width:360px;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.4)}
.login-logo{font-size:44px;margin-bottom:10px}
.login-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:var(--dark);margin-bottom:4px}
.login-sub{font-size:12px;color:var(--light);margin-bottom:20px}
.login-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(46,125,50,.08);color:var(--green);border:1px solid rgba(46,125,50,.2);border-radius:999px;padding:4px 14px;font-size:11px;font-weight:700;margin-bottom:18px}
.inp{width:100%;padding:13px 16px;border:1.5px solid var(--border);border-radius:12px;font-size:14px;font-family:'Poppins',sans-serif;outline:none;transition:.2s;background:#fafbfd;margin-bottom:12px}
.inp:focus{border-color:var(--blue);box-shadow:0 0 0 3px var(--blue-s)}
.btn-login{width:100%;padding:14px;background:linear-gradient(135deg,var(--green),#1B5E20);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer}
.login-err{color:var(--red);font-size:12px;margin-top:8px;min-height:18px}

/* LAYOUT DESKTOP+MOBILE */
#app{display:none;min-height:100vh}
.top-header{background:linear-gradient(135deg,var(--dark),#2a2a4e);padding:16px 24px;display:flex;align-items:center;justify-content:space-between}
.th-left{display:flex;align-items:center;gap:12px}
.th-icon{font-size:28px}
.th-name{font-family:'Nunito',sans-serif;font-size:18px;font-weight:900;color:#fff}
.th-role{font-size:11px;color:rgba(255,255,255,.4);margin-top:1px}
.btn-logout-top{background:rgba(255,255,255,.1);border:none;color:rgba(255,255,255,.7);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:12px;font-family:'Poppins',sans-serif}

/* PERIOD FILTER */
.period-bar{background:#fff;padding:12px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;overflow-x:auto;scrollbar-width:none}
.period-bar::-webkit-scrollbar{display:none}
.period-btn{padding:7px 16px;border-radius:999px;border:1.5px solid var(--border);font-size:12px;font-weight:600;font-family:'Poppins',sans-serif;cursor:pointer;white-space:nowrap;transition:.2s;background:#fff;color:var(--mid)}
.period-btn.on{background:var(--blue);color:#fff;border-color:var(--blue)}
.date-range{display:flex;align-items:center;gap:6px;margin-left:auto}
.date-inp{padding:6px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-family:'Poppins',sans-serif;outline:none;color:var(--dark)}

/* STATS CARDS */
.main-content{padding:20px;max-width:1100px;margin:0 auto}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.kpi-card{background:#fff;border-radius:16px;padding:18px;box-shadow:0 2px 12px rgba(0,0,0,.06);position:relative;overflow:hidden}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi-ca::before{background:linear-gradient(90deg,var(--blue),#42A5F5)}
.kpi-cmds::before{background:linear-gradient(90deg,var(--ora),#FFB74D)}
.kpi-momo::before{background:linear-gradient(90deg,var(--green),#66BB6A)}
.kpi-cash::before{background:linear-gradient(90deg,var(--purple),#BA68C8)}
.kpi-label{font-size:11px;color:var(--light);font-weight:600;letter-spacing:.3px;margin-bottom:6px}
.kpi-value{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:var(--dark);margin-bottom:2px}
.kpi-sub{font-size:11px;color:var(--mid)}
.kpi-icon{font-size:28px;position:absolute;top:16px;right:16px;opacity:.15}

/* TABLE */
.section-card{background:#fff;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.06);margin-bottom:20px;overflow:hidden}
.section-head{padding:18px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.section-title{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px}
.btn-export{background:linear-gradient(135deg,var(--green),#1B5E20);color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer;display:flex;align-items:center;gap:6px}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
th{padding:10px 14px;text-align:left;font-weight:700;color:var(--light);font-size:11px;letter-spacing:.3px;border-bottom:1px solid var(--border);white-space:nowrap;background:#FAFBFD}
td{padding:12px 14px;border-bottom:1px solid var(--border);color:var(--dark);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:#F8FAFF}
.pill{border-radius:999px;padding:3px 10px;font-size:10px;font-weight:700;white-space:nowrap}
.p-momo{background:#E8F5E9;color:var(--green)}
.p-cash{background:rgba(123,31,162,.08);color:var(--purple)}
.p-livraison{background:var(--blue-s);color:var(--blue)}
.p-terminee{background:#E8F5E9;color:var(--green)}
.p-attente{background:#FFF3E0;color:#E65100}
.p-annulee{background:#FFEBEE;color:var(--red)}
.montant{font-weight:700;color:var(--blue)}

/* CHART BAR */
.chart-section{background:#fff;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.06);margin-bottom:20px;padding:20px}
.chart-title{font-size:14px;font-weight:700;margin-bottom:16px}
.bar-chart{display:flex;align-items:flex-end;gap:4px;height:100px;border-bottom:1px solid var(--border)}
.bar-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.bar{width:100%;border-radius:4px 4px 0 0;min-height:4px;transition:.4s;background:linear-gradient(180deg,var(--blue),var(--blue-d))}
.bar-lbl{font-size:9px;color:var(--light);margin-top:4px;text-align:center}
.bar-val{font-size:9px;color:var(--mid);font-weight:700}

/* PAYMENT DONUT TEXT */
.payment-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:16px}
.pay-item{display:flex;align-items:center;gap:10px;background:var(--bg);border-radius:10px;padding:12px}
.pay-color{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.pay-name{font-size:12px;color:var(--mid)}
.pay-val{font-family:'Nunito',sans-serif;font-size:16px;font-weight:900;color:var(--dark)}
.pay-pct{font-size:10px;color:var(--light)}

/* SOLDE BANNER */
.solde-banner{background:linear-gradient(135deg,#1B5E20,var(--green));border-radius:16px;padding:20px 24px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;color:#fff}
.solde-label{font-size:12px;opacity:.8;margin-bottom:4px}
.solde-value{font-family:'Nunito',sans-serif;font-size:32px;font-weight:900}
.solde-note{font-size:11px;opacity:.7;margin-top:2px}

/* TOAST */
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:#1A1A2E;color:#fff;padding:12px 22px;border-radius:12px;font-size:13px;font-weight:600;z-index:9998;transition:.35s;opacity:0;max-width:90%;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.3)}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-logo">üí∞</div>
  <div class="sp-title">OmniService TG</div>
  <div class="sp-sub">Interface Comptable</div>
  <div class="sp-bar"><div class="sp-bar-fill"></div></div>
</div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">üí∞</div>
    <div class="login-title">Espace Comptable</div>
    <div class="login-sub">OmniService TG</div>
    <div class="login-badge">üîê Acc√®s Comptable</div>
    <input class="inp" type="email" id="login-email" placeholder="Email comptable"/>
    <input class="inp" type="password" id="login-password" placeholder="Mot de passe"/>
    <button class="btn-login" onclick="doLogin()" id="btn-login">Se connecter</button>
    <div class="login-err" id="login-err"></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="top-header">
    <div class="th-left">
      <div class="th-icon">üí∞</div>
      <div>
        <div class="th-name" id="top-name">Comptable</div>
        <div class="th-role">Interface Comptable ¬∑ OmniService TG</div>
      </div>
    </div>
    <button class="btn-logout-top" onclick="doLogout()">‚Ü© D√©connexion</button>
  </div>

  <!-- PERIOD FILTER -->
  <div class="period-bar">
    <button class="period-btn on" onclick="setPeriode('today',this)">Aujourd'hui</button>
    <button class="period-btn" onclick="setPeriode('week',this)">Cette semaine</button>
    <button class="period-btn" onclick="setPeriode('month',this)">Ce mois</button>
    <button class="period-btn" onclick="setPeriode('all',this)">Tout</button>
    <div class="date-range">
      <input type="date" id="date-from" class="date-inp"/>
      <span style="color:var(--light);font-size:12px">‚Üí</span>
      <input type="date" id="date-to" class="date-inp"/>
      <button class="period-btn on" style="padding:7px 12px" onclick="setPeriodeCustom()">OK</button>
    </div>
  </div>

  <div class="main-content">
    <!-- SOLDE BANNER -->
    <div class="solde-banner">
      <div>
        <div class="solde-label">Chiffre d'affaires ‚Äî p√©riode s√©lectionn√©e</div>
        <div class="solde-value" id="kpi-ca-big">‚Äî FCFA</div>
        <div class="solde-note" id="kpi-period-label">Chargement...</div>
      </div>
      <div style="font-size:48px;opacity:.3">üìä</div>
    </div>

    <!-- KPI GRID -->
    <div class="kpi-grid">
      <div class="kpi-card kpi-ca">
        <div class="kpi-label">COMMANDES</div>
        <div class="kpi-value" id="kpi-count">‚Äî</div>
        <div class="kpi-sub" id="kpi-count-sub">chargement...</div>
        <div class="kpi-icon">üì¶</div>
      </div>
      <div class="kpi-card kpi-momo">
        <div class="kpi-label">MOBILE MONEY</div>
        <div class="kpi-value" id="kpi-momo">‚Äî</div>
        <div class="kpi-sub" id="kpi-momo-pct">‚Äî% du total</div>
        <div class="kpi-icon">üì±</div>
      </div>
      <div class="kpi-card kpi-cash">
        <div class="kpi-label">CASH</div>
        <div class="kpi-value" id="kpi-cash">‚Äî</div>
        <div class="kpi-sub" id="kpi-cash-pct">‚Äî% du total</div>
        <div class="kpi-icon">üíµ</div>
      </div>
      <div class="kpi-card kpi-cmds">
        <div class="kpi-label">ANNUL√âES</div>
        <div class="kpi-value" id="kpi-annulees">‚Äî</div>
        <div class="kpi-sub">commandes annul√©es</div>
        <div class="kpi-icon">‚ùå</div>
      </div>
    </div>

    <!-- CHART JOURS -->
    <div class="chart-section">
      <div class="chart-title">üìà √âvolution du CA (7 derniers jours)</div>
      <div class="bar-chart" id="bar-chart">
        <div style="color:var(--light);font-size:12px;padding:20px">Chargement...</div>
      </div>
    </div>

    <!-- R√âPARTITION PAIEMENT -->
    <div class="section-card">
      <div class="section-head">
        <div class="section-title">üí≥ R√©partition par mode de paiement</div>
      </div>
      <div class="payment-grid" id="payment-grid">
        <div style="color:var(--light);font-size:12px;padding:10px">Chargement...</div>
      </div>
    </div>

    <!-- TABLE COMMANDES -->
    <div class="section-card">
      <div class="section-head">
        <div class="section-title">üìã D√©tail des commandes</div>
        <div style="display:flex;gap:8px">
          <button class="btn-export" onclick="exportCSV()">üì• Export CSV</button>
          <button class="btn-export" style="background:linear-gradient(135deg,var(--red),#B71C1C)" onclick="printPage()">üñ® Imprimer</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="orders-table">
          <thead>
            <tr>
              <th>R√©f</th>
              <th>Date</th>
              <th>Service</th>
              <th>Client</th>
              <th>Paiement</th>
              <th>Montant</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody id="orders-tbody">
            <tr><td colspan="7" style="text-align:center;padding:30px;color:var(--light)">Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtDK7-iDRy1E-kjZubjyjkPW7Th33BMyU",
  authDomain: "omniservicetg-59df3.firebaseapp.com",
  projectId: "omniservicetg-59df3",
  storageBucket: "omniservicetg-59df3.firebasestorage.app",
  messagingSenderId: "196278567761",
  appId: "1:196278567761:web:4f6416acaab58b67bf4970"
};
const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);
const auth = getAuth(fbApp);

let allOrders = [];
let filteredOrders = [];
let periodeMode = 'today';
let dateFrom = null, dateTo = null;

// SPLASH
setTimeout(() => {
  document.getElementById('splash').classList.add('out');
  setTimeout(() => document.getElementById('splash').style.display = 'none', 400);
}, 2500);

// AUTH
onAuthStateChanged(auth, async (user) => {
  if (user) {
    const snap = await getDoc(doc(db,'agents',user.uid));
    if (!snap.exists() || snap.data().role !== 'comptable') {
      await signOut(auth);
      showLogin('‚ùå Acc√®s r√©serv√© aux comptables');
      return;
    }
    document.getElementById('top-name').textContent = snap.data().nom || user.email;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    loadAllOrders();
  } else { showLogin(); }
});

function showLogin(err='') {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  if (err) document.getElementById('login-err').textContent = err;
}

window.doLogin = async function() {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-password').value;
  const err = document.getElementById('login-err');
  const btn = document.getElementById('btn-login');
  if (!email||!pass) { err.textContent='‚ö†Ô∏è Champs requis'; return; }
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Connexion...';
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e) { err.textContent='‚ùå Identifiants incorrects'; }
  finally { btn.disabled=false; btn.textContent='Se connecter'; }
};
window.doLogout = async () => { await signOut(auth); };

// CHARGER TOUTES LES COMMANDES
async function loadAllOrders() {
  try {
    const snap = await getDocs(query(collection(db,'commandes'), orderBy('createdAt','desc')));
    allOrders = snap.docs.map(d => ({id:d.id,...d.data()}));
    applyFilter();
  } catch(e) { showToast('‚ùå Erreur chargement'); }
}

// P√âRIODE
window.setPeriode = function(mode, btn) {
  periodeMode = mode; dateFrom = null; dateTo = null;
  document.querySelectorAll('.period-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  applyFilter();
};
window.setPeriodeCustom = function() {
  const f = document.getElementById('date-from').value;
  const t = document.getElementById('date-to').value;
  if (!f||!t) { showToast('‚ö†Ô∏è S√©lectionnez les deux dates'); return; }
  periodeMode = 'custom'; dateFrom = new Date(f); dateTo = new Date(t); dateTo.setHours(23,59,59,999);
  applyFilter();
};

function applyFilter() {
  const now = new Date();
  let from, to;
  if (periodeMode === 'today') {
    from = new Date(now); from.setHours(0,0,0,0);
    to = new Date(now); to.setHours(23,59,59,999);
    document.getElementById('kpi-period-label').textContent = "Aujourd'hui";
  } else if (periodeMode === 'week') {
    from = new Date(now); from.setDate(now.getDate()-7); from.setHours(0,0,0,0);
    to = new Date(now); to.setHours(23,59,59,999);
    document.getElementById('kpi-period-label').textContent = "7 derniers jours";
  } else if (periodeMode === 'month') {
    from = new Date(now.getFullYear(), now.getMonth(), 1);
    to = new Date(now); to.setHours(23,59,59,999);
    document.getElementById('kpi-period-label').textContent = "Ce mois";
  } else if (periodeMode === 'custom' && dateFrom && dateTo) {
    from = dateFrom; to = dateTo;
    document.getElementById('kpi-period-label').textContent = from.toLocaleDateString('fr-FR')+' ‚Üí '+to.toLocaleDateString('fr-FR');
  } else {
    filteredOrders = [...allOrders];
    document.getElementById('kpi-period-label').textContent = "Toutes les commandes";
    renderDashboard(); return;
  }
  filteredOrders = allOrders.filter(o => {
    if (!o.createdAt) return false;
    const d = new Date(o.createdAt.seconds*1000);
    return d >= from && d <= to;
  });
  renderDashboard();
}

function renderDashboard() {
  const termin√©es = filteredOrders.filter(o => o.statut === 'Termin√©e');
  const annul√©es = filteredOrders.filter(o => o.statut === 'Annul√©e');
  const ca = termin√©es.reduce((s,o) => s + (Number(o.total)||0), 0);
  const momoOrders = termin√©es.filter(o => (o.modePaiement||'').toLowerCase().includes('mobile') || (o.modePaiement||'').toLowerCase().includes('momo') || (o.modePaiement||'').toLowerCase().includes('flooz'));
  const cashOrders = termin√©es.filter(o => (o.modePaiement||'').toLowerCase().includes('cash') || (o.modePaiement||'').toLowerCase().includes('livraison'));
  const momoCA = momoOrders.reduce((s,o)=>s+(Number(o.total)||0),0);
  const cashCA = cashOrders.reduce((s,o)=>s+(Number(o.total)||0),0);
  const momoP = ca > 0 ? Math.round(momoCA/ca*100) : 0;
  const cashP = ca > 0 ? Math.round(cashCA/ca*100) : 0;

  const fmt = v => v >= 1000000 ? (v/1000000).toFixed(1)+'M' : v >= 1000 ? (v/1000).toFixed(0)+'k' : v;

  document.getElementById('kpi-ca-big').textContent = Number(ca).toLocaleString('fr-FR') + ' FCFA';
  document.getElementById('kpi-count').textContent = termin√©es.length;
  document.getElementById('kpi-count-sub').textContent = filteredOrders.length + ' commandes totales';
  document.getElementById('kpi-momo').textContent = fmt(momoCA) + ' F';
  document.getElementById('kpi-momo-pct').textContent = momoP + '% du CA';
  document.getElementById('kpi-cash').textContent = fmt(cashCA) + ' F';
  document.getElementById('kpi-cash-pct').textContent = cashP + '% du CA';
  document.getElementById('kpi-annulees').textContent = annul√©es.length;

  renderChart();
  renderPayments(momoCA, cashCA, ca);
  renderTable();
}

function renderChart() {
  const days = 7;
  const buckets = [];
  for (let i=days-1; i>=0; i--) {
    const d = new Date(); d.setDate(d.getDate()-i); d.setHours(0,0,0,0);
    const d2 = new Date(d); d2.setHours(23,59,59,999);
    const orders = allOrders.filter(o => {
      if (!o.createdAt) return false;
      const dt = new Date(o.createdAt.seconds*1000);
      return dt >= d && dt <= d2 && o.statut === 'Termin√©e';
    });
    const ca = orders.reduce((s,o)=>s+(Number(o.total)||0),0);
    const lbl = d.toLocaleDateString('fr-FR',{weekday:'short'}).slice(0,3);
    buckets.push({lbl, ca});
  }
  const maxCa = Math.max(...buckets.map(b=>b.ca),1);
  const fmt = v => v >= 1000000 ? (v/1000000).toFixed(1)+'M' : v >= 1000 ? (v/1000).toFixed(0)+'k' : v;
  document.getElementById('bar-chart').innerHTML = buckets.map(b => {
    const h = Math.max(4, Math.round(b.ca/maxCa*90));
    return `<div class="bar-item">
      <div class="bar-val">${b.ca > 0 ? fmt(b.ca) : ''}</div>
      <div class="bar" style="height:${h}px" title="${Number(b.ca).toLocaleString('fr-FR')} FCFA"></div>
      <div class="bar-lbl">${b.lbl}</div>
    </div>`;
  }).join('');
}

function renderPayments(momo, cash, total) {
  const autres = total - momo - cash;
  const p = (v) => total > 0 ? Math.round(v/total*100) : 0;
  const fmt = v => Number(v).toLocaleString('fr-FR');
  document.getElementById('payment-grid').innerHTML = `
    <div class="pay-item"><div class="pay-color" style="background:var(--green)"></div><div><div class="pay-name">Mobile Money</div><div class="pay-val">${fmt(momo)} F</div><div class="pay-pct">${p(momo)}%</div></div></div>
    <div class="pay-item"><div class="pay-color" style="background:var(--purple)"></div><div><div class="pay-name">Cash</div><div class="pay-val">${fmt(cash)} F</div><div class="pay-pct">${p(cash)}%</div></div></div>
    <div class="pay-item"><div class="pay-color" style="background:var(--blue)"></div><div><div class="pay-name">Paiement livraison</div><div class="pay-val">${fmt(autres)} F</div><div class="pay-pct">${p(autres)}%</div></div></div>
    <div class="pay-item"><div class="pay-color" style="background:var(--ora)"></div><div><div class="pay-name">Total encaiss√©</div><div class="pay-val">${fmt(total)} F</div><div class="pay-pct">100%</div></div></div>`;
}

function renderTable() {
  const tbody = document.getElementById('orders-tbody');
  if (!filteredOrders.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--light)">Aucune commande pour cette p√©riode</td></tr>`;
    return;
  }
  const sClass = {Termin√©e:'p-terminee','En attente':'p-attente',Annul√©e:'p-annulee'};
  const pClass = m => {
    const ml = (m||'').toLowerCase();
    if (ml.includes('mobile')||ml.includes('momo')||ml.includes('flooz')) return 'p-momo';
    if (ml.includes('cash')) return 'p-cash';
    return 'p-livraison';
  };
  tbody.innerHTML = filteredOrders.map(o => {
    const date = o.createdAt ? new Date(o.createdAt.seconds*1000).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
    const statC = sClass[o.statut] || 'p-attente';
    return `<tr>
      <td style="font-weight:700;font-size:11px;color:var(--blue)">#${o.id.slice(0,8).toUpperCase()}</td>
      <td style="white-space:nowrap">${date}</td>
      <td>${o.serviceName||o.service||'‚Äî'}</td>
      <td>${o.prenom||''} ${o.nom||''}</td>
      <td><span class="pill ${pClass(o.modePaiement)}">${o.modePaiement||'‚Äî'}</span></td>
      <td class="montant">${o.total ? Number(o.total).toLocaleString('fr-FR')+' F' : '‚Äî'}</td>
      <td><span class="pill ${statC}">${o.statut||'‚Äî'}</span></td>
    </tr>`;
  }).join('');
}

// EXPORT CSV
window.exportCSV = function() {
  const headers = ['R√©f√©rence','Date','Service','Client','T√©l√©phone','Mode paiement','Montant','Statut'];
  const rows = filteredOrders.map(o => {
    const date = o.createdAt ? new Date(o.createdAt.seconds*1000).toLocaleString('fr-FR') : '';
    return [
      '#'+o.id.slice(0,8).toUpperCase(), date,
      o.serviceName||o.service||'', (o.prenom||'')+' '+(o.nom||''),
      o.telephone||o.phone||'', o.modePaiement||'',
      o.total||'', o.statut||''
    ].map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',');
  });
  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'omniservice-comptabilite-'+new Date().toISOString().slice(0,10)+'.csv';
  a.click(); showToast('‚úÖ Fichier CSV export√© !');
};

window.printPage = () => window.print();

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}
</script>
</body>
</html>
