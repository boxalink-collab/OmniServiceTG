<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OmniService TG ‚Äî Administration</title>
<link rel="icon" href="assets/logo.png" type="image/png"/>
<link rel="apple-touch-icon" href="assets/logo.png"/>
<!-- PWA Admin -->
<link rel="manifest" href="admin-manifest.json"/>
<meta name="theme-color" content="#1A1A2E"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Admin TG"/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--blue:#1E6FBE;--blue-d:#155A9C;--blue-s:rgba(30,111,190,.1);--ora:#F5820A;--ora-d:#D96E00;--dark:#1A1A2E;--mid:#4A4A6A;--light:#9999BB;--border:#E8EAF0;--bg:#F4F6FA;--green:#2E7D32;--red:#C62828;--purple:#7B1FA2}
html,body{height:100%;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--dark)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SPLASH SCREEN ADMIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#splash-screen{
  position:fixed;inset:0;z-index:9999;
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
  background:#0a1220;
}
/* Fond anim√© ‚Äî version sombre pour l'admin */
#splash-screen::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,#0a1220 0%,#1a2a50 40%,#0a1220 100%);
  animation:adminBgPulse 3s ease-in-out infinite alternate;
}
@keyframes adminBgPulse{
  from{background:linear-gradient(135deg,#0a1220 0%,#122040 40%,#0a1220 100%)}
  to{background:linear-gradient(135deg,#0a1220 0%,#1a2a50 50%,#0d1830 100%)}
}
/* Grille d√©corative fa√ßon dashboard */
#splash-screen::after{
  content:'';position:absolute;inset:0;
  background-image:
    linear-gradient(rgba(30,111,190,.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(30,111,190,.04) 1px, transparent 1px);
  background-size:40px 40px;
  animation:gridFade 0.8s ease 0.2s both;
}
@keyframes gridFade{from{opacity:0}to{opacity:1}}

/* Orbes lumineux */
.splash-orb{
  position:absolute;border-radius:50%;pointer-events:none;
  animation:orbFloat 4s ease-in-out infinite alternate;
}
.splash-orb-1{
  width:400px;height:400px;
  background:radial-gradient(circle,rgba(30,111,190,.18) 0%,transparent 70%);
  top:-100px;right:-100px;
}
.splash-orb-2{
  width:300px;height:300px;
  background:radial-gradient(circle,rgba(245,130,10,.12) 0%,transparent 70%);
  bottom:-80px;left:-80px;
  animation-delay:.8s;animation-direction:alternate-reverse;
}
@keyframes orbFloat{
  from{transform:scale(1) translate(0,0)}
  to{transform:scale(1.15) translate(10px,-10px)}
}

.splash-content{
  position:relative;z-index:2;
  display:flex;flex-direction:column;align-items:center;
  text-align:center;padding:32px;
}

/* Badge ADMIN au-dessus du logo */
.splash-admin-badge{
  background:linear-gradient(135deg,rgba(245,130,10,.2),rgba(245,130,10,.1));
  border:1px solid rgba(245,130,10,.35);
  border-radius:999px;padding:5px 16px;
  font-size:10px;font-weight:800;letter-spacing:1.5px;
  color:var(--ora);text-transform:uppercase;
  margin-bottom:20px;
  animation:splashTextIn 0.5s ease 0.3s both;
}

/* Logo */
.splash-logo-wrap{
  position:relative;margin-bottom:24px;
  animation:splashLogoIn 0.8s cubic-bezier(.34,1.56,.64,1) 0.4s both;
}
@keyframes splashLogoIn{
  from{transform:scale(0) rotate(-15deg);opacity:0}
  to{transform:scale(1) rotate(0);opacity:1}
}
/* Anneaux tournants */
.splash-ring-outer{
  position:absolute;inset:-18px;border-radius:50%;
  border:1.5px solid rgba(30,111,190,.2);
  animation:ringRotate 8s linear infinite;
}
.splash-ring-outer::before{
  content:'';position:absolute;top:-3px;left:50%;
  width:6px;height:6px;border-radius:50%;
  background:var(--blue);transform:translateX(-50%);
  box-shadow:0 0 8px var(--blue);
}
.splash-ring-inner{
  position:absolute;inset:-8px;border-radius:50%;
  border:1px solid rgba(245,130,10,.15);
  animation:ringRotate 5s linear infinite reverse;
}
.splash-ring-inner::before{
  content:'';position:absolute;bottom:-2px;left:50%;
  width:4px;height:4px;border-radius:50%;
  background:var(--ora);transform:translateX(-50%);
  box-shadow:0 0 6px var(--ora);
}
@keyframes ringRotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}

.splash-logo-box{
  width:110px;height:110px;border-radius:28px;
  background:linear-gradient(135deg,rgba(30,111,190,.15),rgba(21,90,156,.1));
  border:1.5px solid rgba(30,111,190,.25);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 0 1px rgba(255,255,255,.04),0 24px 60px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.07);
  backdrop-filter:blur(10px);overflow:hidden;
}
.splash-logo-box img{
  width:80px;height:80px;object-fit:contain;
  filter:drop-shadow(0 4px 16px rgba(30,111,190,.4));
}
.splash-fallback{font-size:50px;line-height:1}

.splash-brand{
  font-family:'Nunito',sans-serif;font-size:30px;font-weight:900;
  color:#fff;letter-spacing:-0.5px;margin-bottom:4px;
  animation:splashTextIn 0.6s ease 0.8s both;
}
.splash-blue{color:rgba(255,255,255,.9)}
.splash-ora{color:var(--ora)}
.splash-tagline{
  font-size:11px;color:rgba(255,255,255,.35);font-weight:500;
  letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;
  animation:splashTextIn 0.6s ease 1s both;
}
.splash-sep{
  width:40px;height:1px;background:linear-gradient(90deg,transparent,rgba(30,111,190,.5),transparent);
  margin:16px auto;
  animation:splashTextIn 0.5s ease 1.1s both;
}

/* Stats mini d√©co */
.splash-stats{
  display:flex;gap:24px;margin-bottom:32px;
  animation:splashTextIn 0.6s ease 1.2s both;
}
.splash-stat{text-align:center}
.splash-stat-num{font-family:'Nunito',sans-serif;font-size:18px;font-weight:900;color:#fff}
.splash-stat-lbl{font-size:9px;color:rgba(255,255,255,.25);font-weight:600;letter-spacing:.5px;text-transform:uppercase;margin-top:1px}

/* Barre de chargement */
.splash-loader{
  width:200px;height:2px;background:rgba(255,255,255,.07);
  border-radius:2px;overflow:hidden;
  animation:splashTextIn 0.5s ease 1.3s both;
}
.splash-loader-bar{
  height:100%;width:0;border-radius:2px;
  background:linear-gradient(90deg,var(--blue),rgba(255,255,255,.6),var(--ora));
  animation:splashLoad 1.6s cubic-bezier(.4,0,.2,1) 1.4s both;
}
@keyframes splashLoad{
  0%{width:0}55%{width:75%}100%{width:100%}
}
.splash-load-txt{
  margin-top:10px;font-size:10px;color:rgba(255,255,255,.2);
  letter-spacing:.5px;
  animation:splashTextIn 0.5s ease 1.4s both;
}

@keyframes splashTextIn{
  from{transform:translateY(12px);opacity:0}
  to{transform:translateY(0);opacity:1}
}

/* Masquage avec animation */
#splash-screen.hidden{
  animation:splashFadeOut 0.5s cubic-bezier(.4,0,.2,1) forwards;
  pointer-events:none;
}
@keyframes splashFadeOut{
  0%{opacity:1;transform:scale(1)}
  100%{opacity:0;transform:scale(1.03)}
}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0e1420,#1a2540);display:flex;align-items:center;justify-content:center;z-index:1000;padding:16px}
.login-box{background:#fff;border-radius:22px;padding:36px 32px;width:100%;max-width:380px;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.4)}
.login-logo{width:70px;height:70px;background:linear-gradient(135deg,var(--blue),var(--blue-d));border-radius:18px;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.login-logo img{width:58px;height:58px;object-fit:contain}
.login-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:var(--dark);margin-bottom:4px}
.login-label{display:block;font-size:11px;font-weight:700;color:var(--mid);text-align:left;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.login-inp{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:11px;font-size:13px;font-family:'Poppins',sans-serif;margin-bottom:13px;outline:none;background:var(--bg);transition:border-color .2s}
.login-inp:focus{border-color:var(--blue);background:#fff}
.login-btn{width:100%;background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border:none;border-radius:999px;padding:14px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;box-shadow:0 4px 16px rgba(30,111,190,.35);transition:all .2s}
.login-err{color:var(--red);font-size:12px;font-weight:600;margin-top:10px;min-height:18px}
#l-diag{margin-top:12px;text-align:left;display:none}
.diag-box{border-radius:11px;padding:13px 14px;font-size:11px;line-height:1.8;color:#fff}
.diag-ora{background:linear-gradient(135deg,#E65100,#F5820A)}
.diag-blue{background:linear-gradient(135deg,#155A9C,#1E6FBE)}
.diag-dark{background:linear-gradient(135deg,#1A1A2E,#2d2d4e)}
.diag-box a{color:rgba(255,255,255,.9);font-weight:700}
.login-hint{margin-top:14px;font-size:11px;color:var(--light);line-height:1.7;background:var(--bg);border-radius:9px;padding:10px 12px;text-align:left}
.login-hint b{color:var(--dark)}
/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.layout{display:flex;height:100vh;overflow:hidden}
.sidebar{width:240px;background:#1A1A2E;flex-shrink:0;display:flex;flex-direction:column;transition:transform .3s;z-index:100}
.sb-brand{padding:18px 20px 16px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;gap:12px}
.sb-brand-logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,rgba(30,111,190,.25),rgba(21,90,156,.15));border:1px solid rgba(30,111,190,.3);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0}
.sb-brand-logo img{width:30px;height:30px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(30,111,190,.4))}
.sb-brand-text{min-width:0}
.sb-logo{font-family:'Nunito',sans-serif;font-size:17px;font-weight:900}
.sb-logo .b{color:var(--blue)}.sb-logo .o{color:var(--ora)}
.sb-sub{font-size:10px;color:rgba(255,255,255,.3);margin-top:2px}
.sb-nav{padding:16px 12px;flex:1;overflow-y:auto}
.sb-sec{font-size:9px;font-weight:800;color:rgba(255,255,255,.2);text-transform:uppercase;letter-spacing:1px;padding:0 10px;margin:14px 0 6px}
.sb-item{display:flex;align-items:center;gap:10px;padding:11px 12px;border-radius:10px;cursor:pointer;margin-bottom:3px;transition:background .15s;font-size:13px;font-weight:600;color:rgba(255,255,255,.5);border:none;background:transparent;width:100%;text-align:left;font-family:'Poppins',sans-serif}
.sb-item:hover{background:rgba(255,255,255,.06);color:rgba(255,255,255,.85)}
.sb-item.on{background:rgba(30,111,190,.25);color:#fff}
.sb-ico{font-size:16px;width:22px;text-align:center;flex-shrink:0}
.sb-badge{margin-left:auto;background:var(--ora);color:#fff;font-size:9px;font-weight:700;padding:2px 7px;border-radius:999px}
.sb-footer{padding:14px;border-top:1px solid rgba(255,255,255,.07)}
.sb-email{font-size:11px;color:rgba(255,255,255,.3);margin-bottom:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.logout-btn{width:100%;background:rgba(198,40,40,.2);color:#ff8a80;border:none;border-radius:9px;padding:10px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Poppins',sans-serif;transition:background .2s}
.logout-btn:hover{background:rgba(198,40,40,.35)}
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:300;background:var(--blue);color:#fff;border:none;border-radius:10px;width:40px;height:40px;font-size:18px;cursor:pointer;align-items:center;justify-content:center}
/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{flex:1;overflow-y:auto;background:var(--bg)}
.main-inner{max-width:1100px;margin:0 auto;padding:28px 24px 48px}
.pg-title{font-family:'Nunito',sans-serif;font-size:24px;font-weight:900;color:var(--dark);margin-bottom:4px}
.pg-sub{font-size:12px;color:var(--light);margin-bottom:24px}
/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-row{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:24px}
.stat-card{background:#fff;border-radius:14px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.07)}
.stat-ico{font-size:22px;margin-bottom:6px}
.stat-val{font-family:'Nunito',sans-serif;font-size:30px;font-weight:900;color:var(--dark)}
.stat-lbl{font-size:11px;color:var(--light);font-weight:600}
.stats-tabs{display:flex;gap:6px;margin-bottom:18px;background:#fff;border-radius:12px;padding:5px;box-shadow:0 2px 10px rgba(0,0,0,.07);width:fit-content}
.stat-tab{padding:8px 18px;border-radius:9px;border:none;background:transparent;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;color:var(--mid);transition:all .2s}
.stat-tab.on{background:var(--blue);color:#fff}
/* ‚îÄ‚îÄ FILTRES ‚îÄ‚îÄ */
.filters-bar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.fbtn{background:#fff;border:1.5px solid var(--border);border-radius:999px;padding:7px 14px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;color:var(--mid);transition:all .15s;white-space:nowrap}
.fbtn.on,.fbtn:hover{background:var(--blue);color:#fff;border-color:var(--blue)}
.fsearch input{padding:9px 14px;border:1.5px solid var(--border);border-radius:999px;font-size:12px;outline:none;font-family:'Poppins',sans-serif;background:#fff;min-width:180px}
.fsearch input:focus{border-color:var(--blue)}
.refresh-btn{background:var(--blue);color:#fff;border:none;border-radius:999px;padding:9px 18px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;white-space:nowrap}
.refresh-btn:hover{background:var(--blue-d)}
/* ‚îÄ‚îÄ TABLE COMMANDES ‚îÄ‚îÄ */
.orders-wrap{background:#fff;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.07);overflow:hidden}
.orders-head{display:grid;grid-template-columns:100px 1fr 130px 110px 120px 170px;gap:10px;padding:11px 16px;background:var(--bg);font-size:10px;font-weight:700;color:var(--light);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.order-row{display:grid;grid-template-columns:100px 1fr 130px 110px 120px 170px;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border);align-items:center;transition:background .1s}
.order-row:last-child{border-bottom:none}
.order-row:hover{background:#FAFBFC}
.or-ref{font-size:11px;font-weight:700;color:var(--blue);cursor:pointer;text-decoration:underline;text-underline-offset:2px}
.or-name{font-size:12px;font-weight:600;color:var(--dark)}
.or-sub{font-size:10px;color:var(--light);margin-top:2px}
.pill{font-size:10px;font-weight:700;padding:4px 10px;border-radius:999px;display:inline-block}
.or-actions{display:flex;gap:6px;align-items:center}
.act-select{padding:6px 8px;border:1.5px solid var(--border);border-radius:8px;font-size:11px;font-family:'Poppins',sans-serif;cursor:pointer;outline:none;background:#fff;max-width:110px}
.act-save{background:var(--blue);color:#fff;border:none;border-radius:8px;padding:7px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;white-space:nowrap}
.act-save:hover{background:var(--blue-d)}
.act-del{background:#FFEBEE;color:var(--red);border:none;border-radius:8px;padding:7px 9px;font-size:13px;cursor:pointer}
.act-del:hover{background:#FFCDD2}
/* Mobile cards */
.order-card-m{background:#fff;border-radius:14px;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,.07);margin-bottom:10px;display:none}
.ocm-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.ocm-actions{display:flex;gap:6px;margin-top:12px;align-items:center}
.ocm-select{flex:1;padding:9px 10px;border:1.5px solid var(--border);border-radius:9px;font-size:12px;font-family:'Poppins',sans-serif;cursor:pointer;outline:none;background:var(--bg)}
/* ‚îÄ‚îÄ ARTICLES PANEL ‚îÄ‚îÄ */
.articles-panel{background:#fff;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.07);overflow:hidden;margin-top:20px}
.panel-hdr{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border)}
.panel-title{font-size:15px;font-weight:700;color:var(--dark)}
.add-btn{background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border:none;border-radius:999px;padding:9px 18px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;display:flex;align-items:center;gap:6px}
.add-btn:hover{opacity:.9}
.art-table-row{display:grid;grid-template-columns:46px 1fr 100px 100px 96px 110px;gap:10px;padding:12px 20px;border-bottom:1px solid var(--border);align-items:center;font-size:12px}
.badge-std{background:#E3F2FD;color:#1565C0;font-size:8px;font-weight:800;padding:2px 6px;border-radius:4px}
.badge-perso{background:#E8F5E9;color:#1B5E20;font-size:8px;font-weight:800;padding:2px 6px;border-radius:4px}
.badge-masque{background:#EEE;color:#888;font-size:8px;font-weight:800;padding:2px 6px;border-radius:4px}
.stock-btn{border:none;border-radius:7px;padding:5px 8px;font-size:12px;cursor:pointer;font-family:inherit}
.btn-en-stock{background:#E8F5E9;color:#2E7D32}.btn-epuise{background:#FFEBEE;color:#C62828}
.btn-masquer{background:#FFF3E0;color:#E65100}.btn-afficher{background:#E8F5E9;color:#2E7D32}
.art-table-head{background:var(--bg);font-size:10px;font-weight:700;color:var(--light);text-transform:uppercase;letter-spacing:.5px}
.art-table-row:last-child{border-bottom:none}
.art-emoji{font-size:26px;text-align:center}
.art-edit{background:var(--blue-s);color:var(--blue);border:none;border-radius:7px;padding:5px 9px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif}
.art-del{background:#FFEBEE;color:var(--red);border:none;border-radius:7px;padding:5px 8px;font-size:12px;cursor:pointer;margin-left:4px}
.svc-tabs{display:flex;gap:6px;padding:14px 20px 0;flex-wrap:wrap}
.svc-tab{padding:8px 16px;border-radius:999px;border:1.5px solid var(--border);font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;color:var(--mid);transition:all .2s;background:var(--bg)}
.svc-tab.on{background:var(--blue);color:#fff;border-color:var(--blue)}
/* ‚îÄ‚îÄ RESTAURANTS ‚îÄ‚îÄ */
.rst-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-top:16px}
.rst-admin-card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.07)}
.rst-admin-img{height:100px;background:linear-gradient(135deg,#1E6FBE,#0d3d6e);display:flex;align-items:center;justify-content:center;font-size:44px;position:relative;overflow:hidden}
.rst-admin-img img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.rst-admin-body{padding:12px 14px}
.rst-admin-name{font-size:14px;font-weight:700;color:var(--dark);margin-bottom:3px}
.rst-admin-spec{font-size:11px;color:var(--blue);margin-bottom:2px;font-weight:600}
.rst-admin-loc{font-size:11px;color:var(--light)}
.rst-admin-footer{display:flex;align-items:center;justify-content:space-between;padding:9px 14px;border-top:1px solid var(--border)}
.rst-menu-btn{background:var(--blue-s);color:var(--blue);border:none;border-radius:7px;padding:6px 12px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif}
.rst-menu-btn:hover{background:var(--blue);color:#fff}
/* ‚îÄ‚îÄ MENUS (articles d'un restaurant sp√©cifique) ‚îÄ‚îÄ */
.menu-panel-hdr{display:flex;align-items:center;gap:10px;padding:14px 18px;border-bottom:1px solid var(--border);background:var(--bg)}
.menu-back-btn{background:transparent;border:1.5px solid var(--border);border-radius:9px;padding:7px 12px;font-size:13px;cursor:pointer;font-family:'Poppins',sans-serif;color:var(--mid)}
.menu-back-btn:hover{background:#fff}

.partner-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-top:16px}
.partner-card{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.07)}
.partner-img{height:140px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:40px;overflow:hidden}
.partner-img img{width:100%;height:100%;object-fit:cover}
.partner-body{padding:12px 14px}
.partner-name{font-size:13px;font-weight:700;color:var(--dark);margin-bottom:3px}
.partner-desc{font-size:11px;color:var(--light);margin-bottom:8px}
.partner-actions{display:flex;gap:7px}
/* ‚îÄ‚îÄ PREVIEW ADCARD (aper√ßu fid√®le au style client) ‚îÄ‚îÄ */
.prev-adcard{
  display:flex;align-items:stretch;
  height:160px;border-radius:20px;overflow:hidden;
  box-shadow:0 6px 24px rgba(0,0,0,.18);
  margin-bottom:4px;
}
.prev-adcard-img{
  width:45%;flex-shrink:0;position:relative;
  display:flex;align-items:center;justify-content:center;overflow:hidden;
  background:linear-gradient(135deg,#1E6FBE,#0d3d6e);
  transition:background .3s;
}
.prev-adcard-img img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center}
.prev-adcard-gradient{position:absolute;inset:0;background:linear-gradient(to right,transparent 55%,rgba(0,0,0,.35) 100%);z-index:1}
.prev-adcard-emoji{font-size:62px;opacity:.55;position:relative;z-index:0;user-select:none}
.prev-adcard-badge{
  position:absolute;top:10px;left:10px;z-index:10;
  background:rgba(255,255,255,.92);color:var(--blue);
  font-size:9px;font-weight:800;padding:4px 10px;border-radius:999px;
  box-shadow:0 2px 8px rgba(0,0,0,.15);letter-spacing:.2px;
  max-width:calc(100% - 20px);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.prev-adcard-body{
  flex:1;background:#fff;padding:14px 14px 14px 12px;
  display:flex;flex-direction:column;justify-content:center;gap:3px;
}
.prev-adcard-promo{font-size:8.5px;font-weight:800;letter-spacing:1.2px;color:var(--ora);text-transform:uppercase}
.prev-adcard-title{font-family:'Nunito',sans-serif;font-size:15px;font-weight:900;color:var(--dark);line-height:1.25}
.prev-adcard-sub{font-size:10.5px;color:var(--light);margin-top:1px;line-height:1.4}
.prev-adcard-cta{
  margin-top:8px;display:none;align-items:center;align-self:flex-start;
  background:var(--blue);color:#fff;border-radius:999px;
  padding:6px 14px;font-size:11px;font-weight:700;font-family:'Poppins',sans-serif;
}
.prev-adcard-cta.show{display:inline-flex}
/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:none;align-items:center;justify-content:center;padding:16px}
.modal-overlay.show{display:flex}
.modal{background:#fff;border-radius:18px;padding:28px;max-width:480px;width:100%;max-height:90vh;overflow-y:auto;position:relative}
.modal-close{position:absolute;top:14px;right:14px;background:var(--bg);border:none;border-radius:9px;width:34px;height:34px;font-size:16px;cursor:pointer;color:var(--mid)}
.modal-title{font-family:'Nunito',sans-serif;font-size:19px;font-weight:900;color:var(--dark);margin-bottom:18px}
.f-label{display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.f-inp{width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:11px;font-family:'Poppins',sans-serif;font-size:13px;background:var(--bg);outline:none;margin-bottom:13px;transition:border-color .2s}
.f-inp:focus{border-color:var(--blue);background:#fff}
.f-sel{width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:11px;font-family:'Poppins',sans-serif;font-size:13px;background:var(--bg);outline:none;margin-bottom:13px;cursor:pointer}
.modal-save-btn{width:100%;background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border:none;border-radius:999px;padding:13px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif}
.modal-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--bg);font-size:12px}
.modal-key{color:var(--light);font-weight:600;min-width:110px}
.modal-val{color:var(--dark);font-weight:600;text-align:right;word-break:break-word;max-width:65%}
/* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
.settings-card{background:#fff;border-radius:16px;padding:24px;box-shadow:0 2px 10px rgba(0,0,0,.07);max-width:500px;margin-bottom:20px}
.settings-title{font-size:14px;font-weight:700;color:var(--dark);margin-bottom:18px;padding-bottom:12px;border-bottom:1px solid var(--border)}
/* ‚îÄ‚îÄ CHART BARS ‚îÄ‚îÄ */
.bar-row{margin-bottom:13px}
.bar-top{display:flex;justify-content:space-between;font-size:12px;font-weight:600;margin-bottom:5px}
.bar-bg{height:8px;background:var(--bg);border-radius:999px;overflow:hidden}
.bar-fill{height:100%;background:linear-gradient(135deg,var(--blue),var(--ora));border-radius:999px;transition:width .6s ease}
.monthly-chart{display:flex;align-items:flex-end;gap:6px;height:120px;padding:10px 0}
.monthly-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.monthly-bar{width:100%;background:linear-gradient(to top,var(--blue),rgba(30,111,190,.4));border-radius:4px 4px 0 0;min-height:4px;transition:height .5s ease}
.monthly-lbl{font-size:9px;color:var(--light);font-weight:600}
.monthly-val{font-size:9px;color:var(--dark);font-weight:700}
/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.empty-msg{text-align:center;padding:54px;color:var(--light);font-size:13px}
.spinner{display:inline-block;width:24px;height:24px;border:3px solid rgba(30,111,190,.2);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:24px;right:24px;background:#1A1A2E;color:#fff;border-radius:12px;padding:13px 20px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;box-shadow:0 8px 28px rgba(0,0,0,.3)}
.toast.show{opacity:1}
@media(max-width:768px){
  .sidebar{position:fixed;top:0;bottom:0;left:0;z-index:200;transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .hamburger{display:flex}
  .main-inner{padding:60px 16px 40px}
  .orders-head,.order-row{display:none}
  .order-card-m{display:block}
  .stats-row{grid-template-columns:1fr 1fr}
  .partner-grid{grid-template-columns:1fr}
  .art-table-row{grid-template-columns:36px 1fr 80px 90px}
  .splash-stats{gap:16px}
}
@media(min-width:769px){.order-card-m{display:none!important}}
@media(min-width:1000px){.stats-row{grid-template-columns:repeat(4,1fr)}}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SPLASH SCREEN ADMIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="splash-screen">
  <div class="splash-orb splash-orb-1"></div>
  <div class="splash-orb splash-orb-2"></div>

  <div class="splash-content">
    <div class="splash-admin-badge">‚öôÔ∏è &nbsp;Administration</div>

    <div class="splash-logo-wrap">
      <div class="splash-ring-outer"></div>
      <div class="splash-ring-inner"></div>
      <div class="splash-logo-box">
        <img src="../assets/logo.png" alt="OmniService TG" id="splash-img"
             onerror="this.outerHTML='<div class=splash-fallback>üõ°Ô∏è</div>'"/>
      </div>
    </div>

    <div class="splash-brand">
      <span class="splash-blue">Omni</span><span class="splash-ora">Service</span> <span class="splash-blue">TG</span>
    </div>
    <div class="splash-tagline">Tableau de bord administrateur</div>

    <div class="splash-sep"></div>

    <div class="splash-stats">
      <div class="splash-stat">
        <div class="splash-stat-num">üì¶</div>
        <div class="splash-stat-lbl">Commandes</div>
      </div>
      <div class="splash-stat">
        <div class="splash-stat-num">üìä</div>
        <div class="splash-stat-lbl">Statistiques</div>
      </div>
      <div class="splash-stat">
        <div class="splash-stat-num">üè∑Ô∏è</div>
        <div class="splash-stat-lbl">Catalogue</div>
      </div>
    </div>

    <div class="splash-loader">
      <div class="splash-loader-bar"></div>
    </div>
    <div class="splash-load-txt">Chargement du panneau d'administration...</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê -->
<div id="login-screen" style="display:none">
  <div class="login-box">
    <div class="login-logo">
      <img src="../assets/logo.png" alt="OmniService TG" onerror="this.parentElement.innerHTML='üõ°Ô∏è'"/>
    </div>
    <div class="login-title">OmniService <span style="color:var(--ora)">TG</span></div>
    <div style="font-size:12px;color:var(--light);margin-bottom:22px">Interface d'administration</div>
    <label class="login-label">Email</label>
    <input type="email" class="login-inp" id="l-email" placeholder="admin@omniservicetg.com" autocomplete="username"/>
    <label class="login-label">Mot de passe</label>
    <input type="password" class="login-inp" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"/>
    <button class="login-btn" onclick="doLogin()" id="login-btn">Se connecter ‚Üí</button>
    <div class="login-err" id="l-err"></div>
    <div id="l-diag"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê INTERFACE ADMIN ‚ïê‚ïê‚ïê‚ïê -->
<div class="layout" id="admin-ui" style="display:none">
  <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>

  <aside class="sidebar" id="sidebar">
    <div class="sb-brand">
      <div class="sb-brand-logo">
        <img src="../assets/logo.png" alt="OmniService TG"
             onerror="this.parentElement.innerHTML='üõ°Ô∏è'"/>
      </div>
      <div class="sb-brand-text">
        <div class="sb-logo"><span class="b">Omni</span><span class="o">Service</span> <span style="color:#fff">TG</span></div>
        <div class="sb-sub">Administration</div>
      </div>
    </div>
    <nav class="sb-nav">
      <div class="sb-sec">Principal</div>
      <button class="sb-item on" onclick="showSection('orders',this)"><span class="sb-ico">üì¶</span>Commandes<span class="sb-badge" id="badge-pending">0</span></button>
      <button class="sb-item" onclick="showSection('stats',this)"><span class="sb-ico">üìä</span>Statistiques</button>
      <div class="sb-sec">Catalogue</div>
      <button class="sb-item" onclick="showSection('articles',this)"><span class="sb-ico">üè∑Ô∏è</span>Articles &amp; Prix</button>
      <button class="sb-item" onclick="showSection('restaurants',this)"><span class="sb-ico">üçΩÔ∏è</span>Restaurants</button>
      <button class="sb-item" onclick="showSection('kits',this)"><span class="sb-ico">üéÅ</span>Kits &amp; PACKS</button>
      <button class="sb-item" onclick="showSection('partenaires',this)"><span class="sb-ico">ü§ù</span>Publications Partenaires</button>
      <div class="sb-sec">R√©glages</div>
      <button class="sb-item" onclick="showSection('settings',this)"><span class="sb-ico">‚öôÔ∏è</span>Param√®tres</button>
      <button class="sb-item" onclick="showSection('password',this)"><span class="sb-ico">üîë</span>Mot de passe</button>
    </nav>
    <div class="sb-footer">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <div style="width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,rgba(30,111,190,.25),rgba(21,90,156,.15));border:1px solid rgba(30,111,190,.3);display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden">
          <img src="../assets/logo.png" alt="" style="width:24px;height:24px;object-fit:contain"
               onerror="this.parentElement.innerHTML='üë§'"/>
        </div>
        <div style="min-width:0">
          <div style="font-size:10px;font-weight:700;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.5px">Connect√©</div>
          <div class="sb-email" id="admin-email-disp" style="margin:0">‚Äî</div>
        </div>
      </div>
      <button class="logout-btn" onclick="doLogout()">üö™ Se d√©connecter</button>
    </div>
  </aside>

  <main class="main">
    <div class="main-inner">

      <!-- ‚ïê‚ïê COMMANDES ‚ïê‚ïê -->
      <div id="section-orders">
        <div class="pg-title">Gestion des Commandes</div>
        <div class="pg-sub" id="last-refresh">Chargement...</div>
        <div class="stats-row">
          <div class="stat-card"><div class="stat-ico">‚è≥</div><div class="stat-val" id="s-att">0</div><div class="stat-lbl">En attente</div></div>
          <div class="stat-card"><div class="stat-ico">üü£</div><div class="stat-val" id="s-enc">0</div><div class="stat-lbl">En cours</div></div>
          <div class="stat-card"><div class="stat-ico">‚úÖ</div><div class="stat-val" id="s-ter">0</div><div class="stat-lbl">Termin√©es</div></div>
          <div class="stat-card"><div class="stat-ico">üì¶</div><div class="stat-val" id="s-tot">0</div><div class="stat-lbl">Total</div></div>
        </div>
        <div class="filters-bar">
          <button class="fbtn on" onclick="setFilter('all',this)">Toutes</button>
          <button class="fbtn" onclick="setFilter('En attente',this)">‚è≥ Attente</button>
          <button class="fbtn" onclick="setFilter('Confirm√©e',this)">üîµ Confirm√©es</button>
          <button class="fbtn" onclick="setFilter('En cours',this)">üü£ En cours</button>
          <button class="fbtn" onclick="setFilter('Termin√©e',this)">‚úÖ Termin√©es</button>
          <button class="fbtn" onclick="setFilter('Annul√©e',this)">‚ùå Annul√©es</button>
          <div class="fsearch"><input type="text" placeholder="üîç T√©l√©phone, service, r√©f..." oninput="doSearch(this.value)"/></div>
          <button class="refresh-btn" onclick="loadOrders()">üîÑ Actualiser</button>
        </div>
        <div class="orders-wrap">
          <div class="orders-head"><div>R√©f√©rence</div><div>Service</div><div>Client</div><div>Date</div><div>Statut</div><div>Actions</div></div>
          <div id="orders-body-desktop"><div style="text-align:center;padding:40px"><div class="spinner"></div></div></div>
        </div>
        <div id="orders-body-mobile"></div>
      </div>

      <!-- ‚ïê‚ïê STATISTIQUES ‚ïê‚ïê -->
      <div id="section-stats" style="display:none">
        <div class="pg-title">Statistiques</div>
        <div class="pg-sub">Vue d'ensemble des performances</div>
        <div class="stats-tabs">
          <button class="stat-tab on" onclick="setPeriod('day',this)">Aujourd'hui</button>
          <button class="stat-tab" onclick="setPeriod('week',this)">Cette semaine</button>
          <button class="stat-tab" onclick="setPeriod('month',this)">Ce mois</button>
          <button class="stat-tab" onclick="setPeriod('all',this)">Tout</button>
        </div>
        <div class="stats-row" style="grid-template-columns:repeat(3,1fr);max-width:700px;margin-top:16px">
          <div class="stat-card"><div class="stat-ico">üì¶</div><div class="stat-val" id="st-period-cnt">0</div><div class="stat-lbl" id="st-period-lbl">Commandes</div></div>
          <div class="stat-card"><div class="stat-ico">üí∞</div><div class="stat-val" id="st-period-rev" style="font-size:18px;margin-top:4px">0</div><div class="stat-lbl">Chiffre d'affaires</div></div>
          <div class="stat-card"><div class="stat-ico">üèÜ</div><div class="stat-val" id="st-top" style="font-size:16px;margin-top:4px">‚Äî</div><div class="stat-lbl">Service le + demand√©</div></div>
        </div>
        <div class="settings-card" style="max-width:700px">
          <div class="settings-title">üìÖ Commandes des 12 derniers mois</div>
          <div class="monthly-chart" id="monthly-chart"></div>
        </div>
        <div class="settings-card" style="max-width:600px">
          <div class="settings-title">R√©partition par service</div>
          <div id="st-breakdown"></div>
        </div>
      </div>

      <!-- ‚ïê‚ïê ARTICLES & PRIX ‚ïê‚ïê -->
      <div id="section-articles" style="display:none">
        <div class="pg-title">Articles &amp; Prix</div>
        <div class="pg-sub">G√©rez les articles affich√©s dans le catalogue client</div>
        <div class="articles-panel">
          <div class="svc-tabs">
            <button class="svc-tab on" onclick="loadArticles('food',this)">ü•ò Alimentation</button>
            <button class="svc-tab" onclick="loadArticles('clothes',this)">üëó Pr√™t-√†-porter</button>
          </div>
          <div class="panel-hdr" style="margin-top:0;border-top:1px solid var(--border)">
            <div class="panel-title" id="art-panel-title">Alimentation</div>
            <button class="add-btn" onclick="openArticleModal()">+ Ajouter un article</button>
          </div>
          <div id="articles-table">
            <div class="art-table-row art-table-head"><div></div><div>Article</div><div>Prix</div><div>Description</div><div>Dispo</div><div>Actions</div></div>
            <div style="text-align:center;padding:30px;color:var(--light)"><div class="spinner"></div></div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê RESTAURANTS ‚ïê‚ïê -->
      <div id="section-restaurants" style="display:none">
        <div class="pg-title">Restaurants</div>
        <div class="pg-sub">G√©rez les restaurants partenaires et leurs menus</div>

        <!-- Vue : liste des restaurants -->
        <div id="rst-view-list">
          <button class="add-btn" onclick="openRestaurantModal()" style="margin-bottom:16px">+ Ajouter un restaurant</button>
          <div class="rst-grid" id="rst-grid">
            <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--light)"><div class="spinner"></div></div>
          </div>
        </div>

        <!-- Vue : menus d'un restaurant -->
        <div id="rst-view-menus" style="display:none">
          <div class="menu-panel-hdr">
            <button class="menu-back-btn" onclick="showRstView('list')">‚Üê Retour</button>
            <div id="menu-rst-emoji" style="font-size:26px"></div>
            <div>
              <div id="menu-rst-name" style="font-size:14px;font-weight:700;color:var(--dark)"></div>
              <div style="font-size:11px;color:var(--light)">Gestion des plats &amp; menus</div>
            </div>
          </div>
          <div class="articles-panel" style="border-radius:0 0 16px 16px">
            <div class="panel-hdr" style="margin-top:0">
              <div class="panel-title" id="menu-panel-title">Plats du restaurant</div>
              <button class="add-btn" onclick="openMenuArticleModal()">+ Ajouter un plat</button>
            </div>
            <div id="menu-articles-table">
              <div class="art-table-row art-table-head"><div></div><div>Plat</div><div>Prix</div><div>Description</div><div>Dispo</div><div>Actions</div></div>
              <div style="text-align:center;padding:30px;color:var(--light)"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê KITS & PACKS ‚ïê‚ïê -->
      <div id="section-kits" style="display:none">
        <div class="pg-title">Kits &amp; PACKS</div>
        <div class="pg-sub">Cr√©ez des associations d'articles pr√™tes √† commander par les clients</div>

        <!-- Vue : liste des kits -->
        <div id="kits-view-list">
          <button class="add-btn" onclick="openKitModal()" style="margin-bottom:16px">+ Cr√©er un Kit/PACK</button>
          <div class="rst-grid" id="kits-admin-grid">
            <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--light)"><div class="spinner"></div></div>
          </div>
        </div>

        <!-- Vue : articles d'un kit -->
        <div id="kits-view-articles" style="display:none">
          <div class="menu-panel-hdr">
            <button class="menu-back-btn" onclick="showKitView('list')">&#8592; Retour</button>
            <div id="kit-detail-emoji" style="font-size:26px">&#127873;</div>
            <div>
              <div id="kit-detail-name" style="font-size:14px;font-weight:700;color:var(--dark)">Kit</div>
              <div style="font-size:11px;color:var(--light)">Articles inclus dans ce kit</div>
            </div>
          </div>
          <div class="articles-panel" style="border-radius:0 0 16px 16px">
            <div class="panel-hdr" style="margin-top:0">
              <div class="panel-title" id="kit-articles-panel-title">Articles du Kit</div>
              <button class="add-btn" onclick="openKitArticleModal()">+ Ajouter un article</button>
            </div>
            <div id="kit-articles-table">
              <div class="art-table-row art-table-head"><div></div><div>Article</div><div>Qte / Unite</div><div>Prix unit.</div><div>Actions</div></div>
              <div style="text-align:center;padding:30px;color:var(--light)"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê PARTENAIRES ‚ïê‚ïê -->
      <div id="section-partenaires" style="display:none">
        <div class="pg-title">Publications Partenaires</div>
        <div class="pg-sub">Les publications s'afficheront dans le slider de l'application client</div>
        <button class="add-btn" onclick="openPartnerModal()" style="margin-bottom:16px">+ Ajouter une publication</button>
        <div class="partner-grid" id="partner-grid">
          <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--light)"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- ‚ïê‚ïê PARAM√àTRES ‚ïê‚ïê -->
      <div id="section-settings" style="display:none">
        <div class="pg-title">Param√®tres</div>
        <div class="pg-sub">Informations de contact de l'application</div>
        <div class="settings-card">
          <div class="settings-title">üìû Coordonn√©es</div>
          <label class="f-label">T√©l√©phone</label>
          <input type="tel" class="f-inp" id="cfg-phone" placeholder="+228 XX XX XX XX"/>
          <label class="f-label">Email de contact</label>
          <input type="email" class="f-inp" id="cfg-email" placeholder="contact@omniservicetg.com"/>
          <label class="f-label">Site web</label>
          <input type="text" class="f-inp" id="cfg-web" placeholder="www.omniservicetg.com"/>
          <button class="modal-save-btn" onclick="saveSettings()">üíæ Enregistrer</button>
        </div>
      </div>

      <!-- ‚ïê‚ïê MOT DE PASSE ‚ïê‚ïê -->
      <div id="section-password" style="display:none">
        <div class="pg-title">Changer le mot de passe</div>
        <div class="pg-sub">S√©curisez votre acc√®s administrateur</div>
        <div class="settings-card">
          <div class="settings-title">üîë Nouveau mot de passe</div>
          <label class="f-label">Mot de passe actuel</label>
          <input type="password" class="f-inp" id="pw-current"/>
          <label class="f-label">Nouveau mot de passe</label>
          <input type="password" class="f-inp" id="pw-new" placeholder="Min. 8 caract√®res"/>
          <label class="f-label">Confirmer</label>
          <input type="password" class="f-inp" id="pw-confirm"/>
          <button class="modal-save-btn" onclick="changePassword()">üîí Modifier</button>
          <div id="pw-msg" style="margin-top:12px;font-size:12px"></div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- Modal D√©tail commande -->
<div class="modal-overlay" id="detail-modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('detail-modal').classList.remove('show')">‚úï</button>
    <div class="modal-title" id="detail-title">D√©tail</div>
    <div id="detail-body"></div>
  </div>
</div>

<!-- Modal Restaurant -->
<div class="modal-overlay" id="rst-modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('rst-modal').classList.remove('show')">‚úï</button>
    <div class="modal-title" id="rst-modal-title">Ajouter un restaurant</div>
    <input type="hidden" id="rst-id"/>
    <div style="display:grid;grid-template-columns:74px 1fr;gap:10px">
      <div>
        <label class="f-label">Emoji</label>
        <input type="text" class="f-inp" id="rst-emoji" placeholder="üçΩÔ∏è" maxlength="4"/>
      </div>
      <div>
        <label class="f-label">Nom du restaurant *</label>
        <input type="text" class="f-inp" id="rst-nom" placeholder="Ex : Le Saveur d'Afrique"/>
      </div>
    </div>
    <label class="f-label">Sp√©cialit√©s *</label>
    <input type="text" class="f-inp" id="rst-specialites" placeholder="Ex : Cuisine togolaise, grillades..."/>
    <label class="f-label">Localit√© *</label>
    <input type="text" class="f-inp" id="rst-localite" placeholder="Ex : Adidogom√©, Lom√©"/>
    <label class="f-label">Description</label>
    <textarea class="f-inp" id="rst-description" rows="3" placeholder="D√©crivez le restaurant en quelques mots..." style="resize:vertical"></textarea>
    <label class="f-label">URL de l'image (optionnel)</label>
    <input type="url" class="f-inp" id="rst-img" placeholder="https://..."/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label class="f-label">Ordre d'affichage</label>
        <input type="number" class="f-inp" id="rst-ordre" placeholder="1" value="1"/>
      </div>
      <div>
        <label class="f-label">Statut</label>
        <select class="f-sel" id="rst-actif">
          <option value="1">‚úÖ Actif (visible)</option>
          <option value="0">üôà Masqu√©</option>
        </select>
      </div>
    </div>
    <button class="modal-save-btn" id="rst-save-btn" onclick="saveRestaurant()">üíæ Enregistrer le restaurant</button>
  </div>
</div>

<!-- Modal Plat / Menu du restaurant -->
<div class="modal-overlay" id="menu-art-modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('menu-art-modal').classList.remove('show')">‚úï</button>
    <div class="modal-title" id="menu-art-modal-title">Ajouter un plat</div>
    <input type="hidden" id="menu-art-id"/>
    <div style="display:grid;grid-template-columns:74px 1fr;gap:10px">
      <div>
        <label class="f-label">Emoji</label>
        <input type="text" class="f-inp" id="menu-art-emoji" placeholder="üçΩÔ∏è" maxlength="4"/>
      </div>
      <div>
        <label class="f-label">Nom du plat *</label>
        <input type="text" class="f-inp" id="menu-art-name" placeholder="Ex : Riz sauce arachide"/>
      </div>
    </div>
    <label class="f-label">Description</label>
    <input type="text" class="f-inp" id="menu-art-desc" placeholder="Ex : Plat traditionnel copieux"/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label class="f-label">Prix (FCFA) *</label>
        <input type="number" class="f-inp" id="menu-art-price" placeholder="2500"/>
      </div>
      <div>
        <label class="f-label">Unit√©</label>
        <input type="text" class="f-inp" id="menu-art-unit" placeholder="plat, portion, pi√®ce‚Ä¶"/>
      </div>
    </div>
    <label class="f-label">URL de l'image (optionnel)</label>
    <input type="url" class="f-inp" id="menu-art-img" placeholder="https://..."/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label class="f-label">Ordre d'affichage</label>
        <input type="number" class="f-inp" id="menu-art-ordre" placeholder="1" value="1"/>
      </div>
      <div>
        <label class="f-label">Disponibilit√©</label>
        <select class="f-sel" id="menu-art-stock">
          <option value="en_stock">‚úÖ En stock</option>
          <option value="epuise">‚ùå √âpuis√©</option>
        </select>
      </div>
    </div>
    <button class="modal-save-btn" id="menu-art-save-btn" onclick="saveMenuArticle()">üíæ Enregistrer le plat</button>
  </div>
</div>

<!-- Modal Article -->
<div class="modal-overlay" id="art-modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('art-modal').classList.remove('show')">‚úï</button>
    <div class="modal-title" id="art-modal-title">Ajouter un article</div>
    <input type="hidden" id="art-id"/>
    <input type="hidden" id="art-is-std" value="0"/>
    <!-- Info : article standard import√© -->
    <div id="art-std-info" style="display:none;background:linear-gradient(135deg,#E3F2FD,#EDE7F6);border:1.5px solid #90CAF9;border-radius:11px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:#1A237E;line-height:1.6">
      üìå <strong>Article standard</strong> ‚Äî Toutes vos modifications (prix, nom, image‚Ä¶) s'appliqueront imm√©diatement c√¥t√© client et remplaceront la version par d√©faut.
    </div>
    <div style="display:grid;grid-template-columns:74px 1fr;gap:10px">
      <div>
        <label class="f-label">Emoji</label>
        <input type="text" class="f-inp" id="art-emoji" placeholder="ü•ò" maxlength="4"/>
      </div>
      <div>
        <label class="f-label">Nom de l'article *</label>
        <input type="text" class="f-inp" id="art-name" placeholder="Ex : Tilapia frais"/>
      </div>
    </div>
    <label class="f-label">Description</label>
    <input type="text" class="f-inp" id="art-desc" placeholder="Ex : Par kg, p√™che locale"/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label class="f-label">Prix (FCFA) *</label>
        <input type="number" class="f-inp" id="art-price" placeholder="3500"/>
      </div>
      <div>
        <label class="f-label">Unit√©</label>
        <input type="text" class="f-inp" id="art-unit" placeholder="kg, pi√®ce, plat‚Ä¶"/>
      </div>
    </div>
    <label class="f-label">URL de l'image (optionnel)</label>
    <input type="url" class="f-inp" id="art-img" placeholder="https://..."/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label class="f-label">Ordre d'affichage</label>
        <input type="number" class="f-inp" id="art-ordre" placeholder="1" value="1"/>
      </div>
      <div>
        <label class="f-label">Disponibilit√©</label>
        <select class="f-sel" id="art-stock">
          <option value="en_stock">‚úÖ En stock</option>
          <option value="epuise">‚ùå √âpuis√©</option>
        </select>
      </div>
    </div>
    <button class="modal-save-btn" id="art-save-btn" onclick="saveArticle()">üíæ Enregistrer l'article</button>
  </div>
</div>

<!-- Modal Kit/PACK (infos g√©n√©rales seulement) -->
<div class="modal-overlay" id="kit-modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="modal" style="max-width:500px">
    <button class="modal-close" onclick="document.getElementById('kit-modal').classList.remove('show')">&#x2715;</button>
    <div class="modal-title" id="kit-modal-title">Creer un Kit/PACK</div>
    <input type="hidden" id="kit-id"/>

    <div id="kit-std-info" style="display:none;background:linear-gradient(135deg,#E3F2FD,#EDE7F6);border:1.5px solid #90CAF9;border-radius:11px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:#1A237E;line-height:1.6">
      &#128204; <strong>Kit standard</strong> - Vos modifications s'appliqueront cote client et remplaceront la version par defaut.
    </div>

    <div style="display:grid;grid-template-columns:74px 1fr;gap:10px">
      <div>
        <label class="f-label">Emoji</label>
        <input type="text" class="f-inp" id="kit-emoji" placeholder="&#127873;" maxlength="4"/>
      </div>
      <div>
        <label class="f-label">Nom du Kit *</label>
        <input type="text" class="f-inp" id="kit-nom" placeholder="Ex : Kit Repas Semaine"/>
      </div>
    </div>
    <label class="f-label">Description</label>
    <textarea class="f-inp" id="kit-description" rows="2" placeholder="Decrivez ce que contient ce kit..." style="resize:vertical"></textarea>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label class="f-label">Categorie</label>
        <select class="f-sel" id="kit-categorie">
          <option value="Alimentation">&#129374; Alimentation</option>
          <option value="Restauration">&#127869;&#65039; Restauration</option>
          <option value="Pret-a-porter">&#128161; Pret-a-porter</option>
          <option value="Nettoyage">&#129529; Nettoyage</option>
          <option value="Evenement">&#127881; Evenement</option>
          <option value="Mixte">&#128230; Mixte</option>
        </select>
      </div>
      <div>
        <label class="f-label">Prix total (FCFA) *</label>
        <input type="number" class="f-inp" id="kit-prix" placeholder="Ex : 28500"/>
      </div>
    </div>
    <label class="f-label">URL de l'image (optionnel)</label>
    <input type="url" class="f-inp" id="kit-img" placeholder="https://..."/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label class="f-label">Ordre d'affichage</label>
        <input type="number" class="f-inp" id="kit-ordre" value="1"/>
      </div>
      <div>
        <label class="f-label">Statut</label>
        <select class="f-sel" id="kit-actif">
          <option value="1">&#x2705; Actif (visible)</option>
          <option value="0">&#x1F648; Masque</option>
        </select>
      </div>
    </div>
    <button class="modal-save-btn" id="kit-save-btn" onclick="saveKit()">&#x1F4BE; Enregistrer le Kit</button>
  </div>
</div>

<!-- Modal Article d'un Kit -->
<div class="modal-overlay" id="kit-art-modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="modal" style="max-width:460px">
    <button class="modal-close" onclick="document.getElementById('kit-art-modal').classList.remove('show')">&#x2715;</button>
    <div class="modal-title" id="kit-art-modal-title">Ajouter un article au Kit</div>
    <input type="hidden" id="kit-art-id"/>
    <div style="display:grid;grid-template-columns:74px 1fr;gap:10px">
      <div>
        <label class="f-label">Emoji</label>
        <input type="text" class="f-inp" id="kit-art-emoji" placeholder="&#128230;" maxlength="4"/>
      </div>
      <div>
        <label class="f-label">Nom de l'article *</label>
        <input type="text" class="f-inp" id="kit-art-name" placeholder="Ex : Tilapia frais"/>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label class="f-label">Quantite</label>
        <input type="number" class="f-inp" id="kit-art-qty" placeholder="1" min="1" value="1"/>
      </div>
      <div>
        <label class="f-label">Unite</label>
        <input type="text" class="f-inp" id="kit-art-unit" placeholder="kg, piece, plat..."/>
      </div>
    </div>
    <div>
      <label class="f-label">Prix unitaire (FCFA)</label>
      <input type="number" class="f-inp" id="kit-art-prix" placeholder="0" min="0"/>
    </div>
    <button class="modal-save-btn" id="kit-art-save-btn" onclick="saveKitArticle()">&#x1F4BE; Enregistrer l'article</button>
  </div>
</div>


<div class="modal-overlay" id="partner-modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="modal" style="max-width:500px">
    <button class="modal-close" onclick="document.getElementById('partner-modal').classList.remove('show')">‚úï</button>
    <div class="modal-title" id="partner-modal-title">Ajouter une publication</div>
    <input type="hidden" id="partner-id"/>

    <!-- ‚îÄ‚îÄ Aper√ßu live (adcard identique au client) ‚îÄ‚îÄ -->
    <div style="margin-bottom:18px">
      <div style="font-size:10px;font-weight:800;color:var(--light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üëÅ Aper√ßu ‚Äî tel qu'affich√© chez le client</div>
      <div class="prev-adcard">
        <div class="prev-adcard-img" id="prev-img-zone">
          <div class="prev-adcard-gradient"></div>
          <div class="prev-adcard-badge" id="prev-badge">ü§ù Partenaire</div>
          <img id="prev-photo" src="" alt="" style="display:none" onerror="this.style.display='none';document.getElementById('prev-emoji').style.display='block'"/>
          <span class="prev-adcard-emoji" id="prev-emoji">ü§ù</span>
        </div>
        <div class="prev-adcard-body">
          <div class="prev-adcard-promo" id="prev-promo">PARTENAIRE OFFICIEL</div>
          <div class="prev-adcard-title" id="prev-title">Nom du partenaire</div>
          <div class="prev-adcard-sub" id="prev-sub">Description ou slogan</div>
          <div class="prev-adcard-cta" id="prev-cta">D√©couvrir ‚Üí</div>
        </div>
      </div>
      <div style="font-size:10px;color:var(--light);text-align:center;margin-top:6px">Le bandeau d√©file horizontalement sur l'√©cran d'accueil</div>
    </div>

    <label class="f-label">Type de publication *</label>
    <select class="f-sel" id="p-promo" onchange="
      const labels={'partenaire':'PARTENAIRE OFFICIEL','sponsor':'SPONSOR','collaborateur':'COLLABORATEUR','nouveaute':'NOUVEAUT√â','promotion':'PROMOTION','evenement':'√âV√âNEMENT','autre':this.options[this.selectedIndex].text.toUpperCase()};
      document.getElementById('prev-promo').textContent=labels[this.value]||this.value.toUpperCase();
    " style="margin-bottom:13px">
      <option value="partenaire">ü§ù Partenaire officiel</option>
      <option value="sponsor">üíº Sponsor</option>
      <option value="collaborateur">üîó Collaborateur</option>
      <option value="nouveaute">‚ú® Nouveaut√©</option>
      <option value="promotion">üè∑Ô∏è Promotion</option>
      <option value="evenement">üéâ √âv√©nement</option>
    </select>

    <label class="f-label">Nom du partenaire / Titre de la pub *</label>
    <input type="text" class="f-inp" id="p-nom" placeholder="Ex : Restaurant Le Palmier"
      oninput="
        const v=this.value||'Nom du partenaire';
        document.getElementById('prev-title').textContent=v;
        if(!document.getElementById('p-badge').value)
          document.getElementById('prev-badge').textContent='ü§ù '+v;
      "/>

    <label class="f-label">Texte du badge (coin de l'image)
      <small style="font-weight:400;text-transform:none;color:var(--light)">(ex : üåø Produits frais, üè∑Ô∏è Promo, ü§ù Partenaire‚Ä¶)</small>
    </label>
    <input type="text" class="f-inp" id="p-badge" placeholder="ü§ù Partenaire"
      oninput="
        const nom=document.getElementById('p-nom').value;
        document.getElementById('prev-badge').textContent=this.value||(nom?'ü§ù '+nom:'ü§ù Partenaire');
      "/>

    <label class="f-label">Description / Slogan (affich√© sous le titre)</label>
    <input type="text" class="f-inp" id="p-desc" placeholder="Ex : La meilleure cuisine togolaise"
      oninput="document.getElementById('prev-sub').textContent=this.value||'Description ou slogan'"/>

    <label class="f-label">URL de l'image de fond
      <small style="font-weight:400;text-transform:none;color:var(--light)">(imgur.com, postimages.org‚Ä¶)</small>
    </label>
    <input type="url" class="f-inp" id="p-img" placeholder="https://..."
      oninput="
        const ph=document.getElementById('prev-photo');
        const em=document.getElementById('prev-emoji');
        if(this.value){
          ph.src=this.value;
          ph.style.display='block';
          em.style.display='none';
        } else {
          ph.style.display='none';
          em.style.display='block';
        }
      "/>

    <label class="f-label">Lien du bouton "D√©couvrir ‚Üí"
      <small style="font-weight:400;text-transform:none;color:var(--light)">(optionnel)</small>
    </label>
    <input type="url" class="f-inp" id="p-lien" placeholder="https://..."
      oninput="
        const cta=document.getElementById('prev-cta');
        cta.classList.toggle('show', !!this.value);
      "/>

    <label class="f-label">Ordre dans le bandeau
      <small style="font-weight:400;text-transform:none;color:var(--light)">(1 = en premier)</small>
    </label>
    <input type="number" class="f-inp" id="p-ordre" placeholder="1" value="1" min="1"/>

    <button class="modal-save-btn" onclick="savePartner()">üíæ Publier dans le bandeau</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê SPLASH SCREEN LOGIC ‚ïê‚ïê‚ïê‚ïê -->
<script>
  // Le splash se masque apr√®s 2.8s ou apr√®s que Firebase confirme l'√©tat auth
  let splashHidden = false;
  function hideSplash() {
    if (splashHidden) return;
    splashHidden = true;
    const splash = document.getElementById('splash-screen');
    splash.classList.add('hidden');
    setTimeout(() => splash.style.display = 'none', 500);
  }
  // Fallback maximal : 3.2 secondes
  setTimeout(hideSplash, 3200);
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê FIREBASE ‚ïê‚ïê‚ïê‚ïê -->
<script type="module">
import { initializeApp }            from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc,
         addDoc, updateDoc, deleteDoc, setDoc, orderBy,
         query, where, serverTimestamp }
                                    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut,
         onAuthStateChanged, updatePassword,
         EmailAuthProvider, reauthenticateWithCredential }
                                    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// ‚îÄ‚îÄ Config Firebase ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyDtDK7-iDRy1E-kjZubjyjkPW7Th33BMyU",
  authDomain: "omniservicetg-59df3.firebaseapp.com",
  projectId: "omniservicetg-59df3",
  storageBucket: "omniservicetg-59df3.firebasestorage.app",
  messagingSenderId: "196278567761",
  appId: "1:196278567761:web:4f6416acaab58b67bf4970"
};
const fbApp = initializeApp(firebaseConfig);
const db    = getFirestore(fbApp);
const auth  = getAuth(fbApp);

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function toast(msg, color="#1A1A2E") {
  const t = document.getElementById("toast");
  t.style.background = color; t.textContent = msg;
  t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 3200);
}

// ‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê
window.doLogin = async function() {
  const email = document.getElementById("l-email").value.trim();
  const pass  = document.getElementById("l-pass").value;
  const err   = document.getElementById("l-err");
  const diag  = document.getElementById("l-diag");
  const btn   = document.getElementById("login-btn");
  err.textContent = ""; diag.style.display="none";
  btn.innerHTML = `<span style="display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px"></span>Connexion...`;
  btn.disabled = true;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e) {
    const msgs = {
      "auth/invalid-credential":"‚ùå Email ou mot de passe incorrect.",
      "auth/user-not-found":"‚ùå Compte inexistant.",
      "auth/wrong-password":"‚ùå Mot de passe incorrect.",
      "auth/invalid-email":"‚ùå Email invalide.",
      "auth/too-many-requests":"‚è≥ Trop de tentatives.",
      "auth/configuration-not-found":"‚ùå Auth non configur√©."
    };
    err.textContent = msgs[e.code]||("‚ùå "+e.message);
    const code = e.code||"";
    let diagHtml = "";
    if(code==="auth/unauthorized-domain"||e.message.includes("unauthorized")) {
      diagHtml=`<div class="diag-box diag-ora"><b>üîê Domaine non autoris√©</b><br/>Allez sur <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a> ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains ‚Üí Ajoutez : <code style="background:rgba(0,0,0,.2);padding:2px 6px;border-radius:4px">${location.hostname}</code></div>`;
    } else if(code==="auth/user-not-found"||code==="auth/invalid-credential") {
      diagHtml=`<div class="diag-box diag-blue"><b>üë§ Compte inexistant</b><br/><a href="https://console.firebase.google.com" target="_blank">Firebase Console</a> ‚Üí Authentication ‚Üí Users ‚Üí Add user ‚Üí Email + mot de passe</div>`;
    } else {
      diagHtml=`<div class="diag-box diag-dark"><b>Code :</b> <code style="background:rgba(255,255,255,.15);padding:2px 6px;border-radius:4px">${code}</code><br/><span style="font-size:11px">${e.message}</span></div>`;
    }
    if(diagHtml){diag.innerHTML=diagHtml;diag.style.display="block";}
    btn.innerHTML="Se connecter ‚Üí"; btn.disabled=false;
  }
};
window.doLogout = async function(){ await signOut(auth); };

// ‚ïê‚ïê‚ïê‚ïê EMAIL ADMIN AUTORIS√â ‚ïê‚ïê‚ïê‚ïê
// Seul cet email peut acc√©der au panneau d'administration.
const ADMIN_EMAIL = "admin@omniservicetg.com";

onAuthStateChanged(auth, async user => {
  // Masquer le splash d√®s que Firebase r√©pond
  if (typeof hideSplash === 'function') hideSplash();

  if (user && user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
    // ‚úÖ Admin v√©rifi√©
    document.getElementById("login-screen").style.display = "none";
    document.getElementById("admin-ui").style.display = "flex";
    document.getElementById("admin-email-disp").textContent = user.email;
    loadOrders();
    loadSettings();
    loadArticles('food', document.querySelector('.svc-tab.on'));
    loadPartners();
  } else {
    // ‚ùå Pas admin ‚Üí d√©connexion forc√©e
    if (user) {
      await signOut(auth);
      document.getElementById("l-err").textContent = "‚õî Acc√®s r√©serv√© √† l'administrateur.";
    }
    document.getElementById("login-screen").style.display = "flex";
    document.getElementById("admin-ui").style.display = "none";
  }
});

// ‚ïê‚ïê‚ïê‚ïê √âTAT ‚ïê‚ïê‚ïê‚ïê
let allOrders=[], activeFilter='all', searchTerm='', currentArtSvc='food', editingArtId=null, editingPartnerId=null, statPeriod='day';
const SC = {
  "En attente":{c:"#F5820A",bg:"#FFF3E0"},
  "Confirm√©e":{c:"#1E6FBE",bg:"#E3F2FD"},
  "En cours":{c:"#7B1FA2",bg:"#F3E5F5"},
  "Termin√©e":{c:"#2E7D32",bg:"#E8F5E9"},
  "Annul√©e":{c:"#C62828",bg:"#FFEBEE"}
};

// ‚ïê‚ïê‚ïê‚ïê COMMANDES ‚ïê‚ïê‚ïê‚ïê
window.loadOrders = async function() {
  document.getElementById("orders-body-desktop").innerHTML=`<div style="text-align:center;padding:40px"><div class="spinner"></div></div>`;
  document.getElementById("orders-body-mobile").innerHTML="";
  try {
    const q = query(collection(db,"commandes"), orderBy("createdAt","desc"));
    const snap = await getDocs(q);
    allOrders = snap.docs.map(d=>({id:d.id,...d.data()}));
    render(); updateStats();
    document.getElementById("last-refresh").textContent=`Mis √† jour : ${new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})} ‚Äî ${allOrders.length} commandes`;
  } catch(e) {
    document.getElementById("orders-body-desktop").innerHTML=`<div class="empty-msg">‚ùå Erreur Firebase : ${e.message}</div>`;
  }
};

function filteredOrders() {
  return allOrders.filter(o=>{
    const mf = activeFilter==='all' || o.statut===activeFilter;
    const ms = !searchTerm || [o.phone,o.serviceName,o.service,o.id,o.clientNom,o.clientPrenom,o.clientVille].some(v=>v&&v.toLowerCase().includes(searchTerm));
    return mf&&ms;
  });
}

function render() {
  const list = filteredOrders();
  document.getElementById("badge-pending").textContent=allOrders.filter(o=>o.statut==="En attente").length;
  if(!list.length){
    document.getElementById("orders-body-desktop").innerHTML=`<div class="empty-msg">Aucune commande trouv√©e.</div>`;
    document.getElementById("orders-body-mobile").innerHTML=`<div class="empty-msg">Aucune commande trouv√©e.</div>`;
    return;
  }
  const sopts=(cur)=>Object.keys(SC).map(s=>`<option value="${s}"${s===cur?' selected':''}>${s}</option>`).join('');
  document.getElementById("orders-body-desktop").innerHTML=list.map(o=>{
    const s=SC[o.statut]||SC["En attente"];
    const d=o.createdAt?new Date(o.createdAt.seconds*1000).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}):'‚Äî';
    const totalStr=o.total?`<br/><small style="color:var(--blue);font-weight:700">${Number(o.total).toLocaleString('fr-FR')} FCFA</small>`:'';
    // Infos client enrichies
    const avatar = o.clientGenre==='femme'?'üë©':o.clientGenre==='homme'?'üë®':'üë§';
    const clientName = [o.clientPrenom,o.clientNom].filter(Boolean).join(' ') || '‚Äî';
    const clientSub  = [o.phone, o.clientVille].filter(Boolean).join(' ¬∑ ') || o.adresse || '‚Äî';
    return `<div class="order-row">
      <div><span class="or-ref" onclick="showDetail('${o.id}')">#${o.id.slice(0,8).toUpperCase()}</span></div>
      <div><div class="or-name">${o.serviceName||o.service||'‚Äî'}</div><div class="or-sub">${o.type||o.modePaiement||''}</div></div>
      <div><div class="or-name">${avatar} ${clientName}</div><div class="or-sub">${clientSub}</div></div>
      <div style="font-size:11px;color:var(--mid)">${d}${totalStr}</div>
      <div><span class="pill" style="background:${s.bg};color:${s.c}">${o.statut}</span></div>
      <div class="or-actions">
        <select class="act-select" id="sel-${o.id}">${sopts(o.statut)}</select>
        <button class="act-save" onclick="updateStatus('${o.id}')">‚úî</button>
        <button class="act-del"  onclick="deleteOrder('${o.id}')">üóë</button>
      </div>
    </div>`;
  }).join('');
  document.getElementById("orders-body-mobile").innerHTML=list.map(o=>{
    const s=SC[o.statut]||SC["En attente"];
    const d=o.createdAt?new Date(o.createdAt.seconds*1000).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'}):'‚Äî';
    const avatar = o.clientGenre==='femme'?'üë©':o.clientGenre==='homme'?'üë®':'üë§';
    const clientName = [o.clientPrenom,o.clientNom].filter(Boolean).join(' ') || o.phone || '‚Äî';
    const clientSub  = [o.phone, o.clientVille].filter(Boolean).join(' ¬∑ ') || '‚Äî';
    return `<div class="order-card-m">
      <div class="ocm-head">
        <div>
          <span class="or-ref" onclick="showDetail('${o.id}')">#${o.id.slice(0,8).toUpperCase()}</span>
          <div style="font-size:12px;font-weight:700;color:var(--dark);margin-top:3px">${o.serviceName||o.service||'‚Äî'}</div>
          <div style="font-size:11px;color:var(--light)">${avatar} ${clientName}</div>
          <div style="font-size:11px;color:var(--light)">${clientSub} ¬∑ ${d}</div>
          ${o.total?`<div style="font-size:12px;font-weight:700;color:var(--blue)">${Number(o.total).toLocaleString('fr-FR')} FCFA</div>`:''}
        </div>
        <span class="pill" style="background:${s.bg};color:${s.c}">${o.statut}</span>
      </div>
      <div class="ocm-actions">
        <select class="ocm-select" id="selm-${o.id}">${sopts(o.statut)}</select>
        <button class="act-save" onclick="updateStatusMobile('${o.id}')">‚úî</button>
        <button class="act-del"  onclick="deleteOrder('${o.id}')">üóë</button>
      </div>
    </div>`;
  }).join('');
}

window.setFilter=function(val,btn){activeFilter=val;document.querySelectorAll(".fbtn").forEach(b=>b.classList.remove("on"));btn.classList.add("on");render();};
window.doSearch=function(val){searchTerm=val.toLowerCase();render();};
window.updateStatus=async function(id){await _upd(id,document.getElementById(`sel-${id}`).value);};
window.updateStatusMobile=async function(id){await _upd(id,document.getElementById(`selm-${id}`).value);};
async function _upd(id,val){
  try{await updateDoc(doc(db,"commandes",id),{statut:val,updatedAt:serverTimestamp()});const o=allOrders.find(x=>x.id===id);if(o)o.statut=val;render();updateStats();toast("‚úÖ Statut mis √† jour !","#2E7D32");}catch(e){toast("‚ùå Erreur","#C62828");}
}
window.deleteOrder=async function(id){
  if(!confirm("Supprimer cette commande ?"))return;
  try{await deleteDoc(doc(db,"commandes",id));allOrders=allOrders.filter(o=>o.id!==id);render();updateStats();toast("üóë Supprim√©e");}catch(e){toast("‚ùå Erreur","#C62828");}
};

// ‚ïê‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê‚ïê
function updateStats(){
  document.getElementById("s-att").textContent=allOrders.filter(o=>o.statut==="En attente").length;
  document.getElementById("s-enc").textContent=allOrders.filter(o=>o.statut==="En cours"||o.statut==="Confirm√©e").length;
  document.getElementById("s-ter").textContent=allOrders.filter(o=>o.statut==="Termin√©e").length;
  document.getElementById("s-tot").textContent=allOrders.length;
  renderStatsByPeriod(statPeriod);
  renderMonthlyChart();
  renderBreakdown();
}

function filterByPeriod(period){
  const now=new Date();
  return allOrders.filter(o=>{
    if(!o.createdAt)return false;
    const t=o.createdAt.seconds*1000;
    if(period==='day')return new Date(t).toDateString()===now.toDateString();
    if(period==='week')return t>=Date.now()-7*86400000;
    if(period==='month')return t>=new Date(now.getFullYear(),now.getMonth(),1).getTime();
    return true;
  });
}

function renderStatsByPeriod(period){
  const orders=filterByPeriod(period);
  const rev=orders.filter(o=>o.total).reduce((s,o)=>s+Number(o.total),0);
  const counts={};orders.forEach(o=>{const k=o.serviceName||o.service||'Autre';counts[k]=(counts[k]||0)+1;});
  const top=Object.entries(counts).sort((a,b)=>b[1]-a[1])[0];
  const lbls={'day':"Aujourd'hui",'week':'Cette semaine','month':'Ce mois','all':'Total'};
  document.getElementById("st-period-cnt").textContent=orders.length;
  document.getElementById("st-period-lbl").textContent=`Commandes (${lbls[period]})`;
  document.getElementById("st-period-rev").textContent=rev>0?`${Number(rev).toLocaleString('fr-FR')} F`:'0 F';
  document.getElementById("st-top").textContent=top?top[0].split(' ')[0]:'‚Äî';
}

function renderMonthlyChart(){
  const now=new Date();
  const months=[];
  for(let i=11;i>=0;i--){
    const d=new Date(now.getFullYear(),now.getMonth()-i,1);
    months.push({year:d.getFullYear(),month:d.getMonth(),label:d.toLocaleString('fr-FR',{month:'short'})});
  }
  const counts=months.map(m=>allOrders.filter(o=>{
    if(!o.createdAt)return false;
    const d=new Date(o.createdAt.seconds*1000);
    return d.getFullYear()===m.year&&d.getMonth()===m.month;
  }).length);
  const maxC=Math.max(...counts,1);
  document.getElementById("monthly-chart").innerHTML=counts.map((c,i)=>`
    <div class="monthly-bar-wrap">
      <div class="monthly-val">${c>0?c:''}</div>
      <div class="monthly-bar" style="height:${Math.max(4,Math.round(c/maxC*90))}px"></div>
      <div class="monthly-lbl">${months[i].label}</div>
    </div>`).join('');
}

function renderBreakdown(){
  const counts={};
  allOrders.forEach(o=>{const k=o.serviceName||o.service||'Autre';counts[k]=(counts[k]||0)+1;});
  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  const maxV=sorted[0]?.[1]||1;
  document.getElementById("st-breakdown").innerHTML=sorted.map(([name,count])=>`
    <div class="bar-row">
      <div class="bar-top"><span>${name}</span><span>${count}</span></div>
      <div class="bar-bg"><div class="bar-fill" style="width:${Math.round(count/maxV*100)}%"></div></div>
    </div>`).join('');
}

window.setPeriod=function(period,btn){
  statPeriod=period;
  document.querySelectorAll(".stat-tab").forEach(b=>b.classList.remove("on"));
  btn.classList.add("on");
  renderStatsByPeriod(period);
};

// ‚ïê‚ïê‚ïê‚ïê D√âTAIL COMMANDE ‚ïê‚ïê‚ïê‚ïê
window.showDetail=function(id){
  const o=allOrders.find(x=>x.id===id); if(!o)return;
  const s=SC[o.statut]||SC["En attente"];
  const dateStr=o.createdAt?new Date(o.createdAt.seconds*1000).toLocaleString('fr-FR'):'‚Äî';
  const avatar  = o.clientGenre==='femme'?'üë©':o.clientGenre==='homme'?'üë®':'üë§';
  const clientName = [o.clientPrenom,o.clientNom].filter(Boolean).join(' ') || '‚Äî';

  // Bloc client en haut du d√©tail
  let rows=`
    <div style="background:linear-gradient(135deg,rgba(30,111,190,.06),rgba(245,130,10,.04));border-radius:12px;padding:14px 16px;margin-bottom:12px;border:1px solid rgba(30,111,190,.12)">
      <div style="font-size:10px;font-weight:800;color:var(--light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">üë§ Informations Client</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div style="font-size:10px;color:var(--light);font-weight:600">Nom complet</div><div style="font-size:13px;font-weight:700;color:var(--dark)">${avatar} ${clientName}</div></div>
        <div><div style="font-size:10px;color:var(--light);font-weight:600">Genre</div><div style="font-size:13px;font-weight:700;color:var(--dark)">${o.clientGenre?o.clientGenre.charAt(0).toUpperCase()+o.clientGenre.slice(1):'‚Äî'}</div></div>
        <div><div style="font-size:10px;color:var(--light);font-weight:600">T√©l√©phone</div><div style="font-size:13px;font-weight:700;color:var(--blue)">${o.phone||'‚Äî'}</div></div>
        <div><div style="font-size:10px;color:var(--light);font-weight:600">Ville</div><div style="font-size:13px;font-weight:700;color:var(--dark)">${o.clientVille||'‚Äî'}</div></div>
      </div>
    </div>`;

  const keys={service:"Service",serviceName:"Nom service",statut:"Statut",adresse:"Adresse livraison",type:"Type",produits:"Produits",commande:"Commande",personnes:"Personnes",detail:"D√©tail",urgence:"Urgence",categorie:"Cat√©gorie",article:"Article",budget:"Budget",superficie:"Superficie (m¬≤)",date:"Date souhait√©e",problem:"Probl√®me",notes:"Notes",modePaiement:"Paiement",total:"Total (FCFA)"};
  // Exclure les champs de localisation bruts ‚Äî on les affiche en bloc d√©di√© ci-dessous
  const excl=["id","createdAt","updatedAt","articles","uid","clientNom","clientPrenom","clientGenre","phone","clientVille","positionType","positionDesc","lat","lng","adresse"];

  rows+=`<div class="modal-row"><span class="modal-key">üìÖ Date</span><span class="modal-val">${dateStr}</span></div>`;

  // ‚îÄ‚îÄ Bloc localisation avec liens itin√©raire ‚îÄ‚îÄ
  if(o.positionType==='GPS'&&o.lat&&o.lng){
    const gm=`https://www.google.com/maps/dir/?api=1&destination=${o.lat},${o.lng}&travelmode=driving`;
    const wz=`https://waze.com/ul?ll=${o.lat},${o.lng}&navigate=yes`;
    rows+=`
    <div style="background:linear-gradient(135deg,rgba(30,111,190,.05),rgba(30,111,190,.02));border:1px solid rgba(30,111,190,.15);border-radius:11px;padding:12px 14px;margin:6px 0">
      <div style="font-size:10px;font-weight:800;color:var(--light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">üìç Point de livraison (GPS)</div>
      <div style="font-size:11px;color:var(--mid);margin-bottom:10px">Lat <strong>${Number(o.lat).toFixed(5)}</strong> ‚Äî Lng <strong>${Number(o.lng).toFixed(5)}</strong></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a href="${gm}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;background:#1E6FBE;color:#fff;border-radius:999px;padding:9px 16px;font-size:12px;font-weight:700;text-decoration:none;box-shadow:0 3px 12px rgba(30,111,190,.35)">üó∫Ô∏è Itin√©raire Google Maps</a>
        <a href="${wz}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;background:#00C8FF;color:#1A1A2E;border-radius:999px;padding:9px 16px;font-size:12px;font-weight:700;text-decoration:none;box-shadow:0 3px 12px rgba(0,200,255,.3)">üöó Naviguer sur Waze</a>
      </div>
    </div>`;
  } else if(o.positionType==='description'&&o.positionDesc){
    const gm=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(o.positionDesc+', Lom√©, Togo')}`;
    rows+=`
    <div style="background:linear-gradient(135deg,rgba(30,111,190,.05),rgba(30,111,190,.02));border:1px solid rgba(30,111,190,.15);border-radius:11px;padding:12px 14px;margin:6px 0">
      <div style="font-size:10px;font-weight:800;color:var(--light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üìç Point de livraison (description)</div>
      <div style="font-size:13px;font-weight:600;color:var(--dark);margin-bottom:10px">${o.positionDesc}</div>
      <a href="${gm}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;background:#1E6FBE;color:#fff;border-radius:999px;padding:9px 16px;font-size:12px;font-weight:700;text-decoration:none;box-shadow:0 3px 12px rgba(30,111,190,.35)">üó∫Ô∏è Rechercher sur Google Maps</a>
    </div>`;
  } else if(o.adresse){
    const gm=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(o.adresse+', Lom√©, Togo')}`;
    rows+=`
    <div style="background:linear-gradient(135deg,rgba(30,111,190,.05),rgba(30,111,190,.02));border:1px solid rgba(30,111,190,.15);border-radius:11px;padding:12px 14px;margin:6px 0">
      <div style="font-size:10px;font-weight:800;color:var(--light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üìç Adresse de livraison</div>
      <div style="font-size:13px;font-weight:600;color:var(--dark);margin-bottom:10px">${o.adresse}</div>
      <a href="${gm}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;background:#1E6FBE;color:#fff;border-radius:999px;padding:9px 16px;font-size:12px;font-weight:700;text-decoration:none;box-shadow:0 3px 12px rgba(30,111,190,.35)">üó∫Ô∏è Rechercher sur Google Maps</a>
    </div>`;
  }

  rows+=Object.entries(o).filter(([k,v])=>!excl.includes(k)&&v!==undefined&&v!=='').map(([k,v])=>`
    <div class="modal-row"><span class="modal-key">${keys[k]||k}</span><span class="modal-val">${k==='statut'?`<span class="pill" style="background:${s.bg};color:${s.c}">${v}</span>`:k==='total'?`${Number(v).toLocaleString('fr-FR')} FCFA`:v}</span></div>`).join('');

  if(o.articles&&o.articles.length){
    rows+=`<div class="modal-row" style="flex-direction:column;gap:5px"><span class="modal-key">üõí Articles command√©s</span>`;
    let subtotal=0;
    o.articles.forEach(a=>{
      const line=a.price*a.qty;subtotal+=line;
      rows+=`<div style="font-size:12px;display:flex;justify-content:space-between;width:100%;padding:5px 0;border-bottom:1px solid #F4F6FA"><span>${a.name} <span style="color:var(--light)">x${a.qty}</span></span><span style="color:var(--blue);font-weight:700">${Number(line).toLocaleString('fr-FR')} FCFA</span></div>`;
    });
    rows+=`<div style="display:flex;justify-content:space-between;font-weight:800;font-size:13px;padding-top:8px"><span>Total</span><span style="color:var(--blue)">${Number(subtotal).toLocaleString('fr-FR')} FCFA</span></div>`;
    rows+=`</div>`;
  }
  document.getElementById("detail-title").textContent=`#${id.slice(0,8).toUpperCase()} ‚Äî ${o.serviceName||o.service}`;
  document.getElementById("detail-body").innerHTML=rows;
  document.getElementById("detail-modal").classList.add("show");
};

// ‚ïê‚ïê‚ïê‚ïê ARTICLES PAR D√âFAUT (r√©f√©rence locale) ‚ïê‚ïê‚ïê‚ïê
const DEFAULT_ARTICLES={
  food:[
    {id:'f1',name:'Tilapia frais',     desc:'Par kg, p√™che locale',             price:3500, unit:'kg',      emoji:'üêü'},
    {id:'f2',name:'Poulet fermier',    desc:'Par pi√®ce, √©levage local',         price:5500, unit:'pi√®ce',   emoji:'üêî'},
    {id:'f3',name:'L√©gumes assortis',  desc:'Tomates, oignons, piment',         price:1500, unit:'panier',  emoji:'ü•¨'},
    {id:'f4',name:'Vin de palme',      desc:'Par bidon de 5L',                  price:4000, unit:'bidon',   emoji:'üç∂'},
    {id:'f5',name:'N√©r√© (soumbara)',   desc:'Condiment traditionnel',           price:1000, unit:'sachet',  emoji:'ü´ò'},
    {id:'f6',name:'Kit repas famille', desc:'Pour 4-6 personnes',               price:8500, unit:'kit',     emoji:'ü•ò'},
  ],
  restaurant:[
    {id:'r1',name:'Riz sauce arachide',  desc:'Plat traditionnel copieux',            price:2500,  unit:'plat',    emoji:'üçö'},
    {id:'r2',name:'Fufu + soupe',        desc:'Fufu de manioc, soupe de viande',      price:3000,  unit:'plat',    emoji:'üç≤'},
    {id:'r3',name:'Brochettes mixtes',   desc:'B≈ìuf, poulet, foie',                   price:2000,  unit:'portion', emoji:'üç¢'},
    {id:'r4',name:'Poulet yassa',        desc:'Marin√© aux oignons et citron',         price:4500,  unit:'plat',    emoji:'üçó'},
    {id:'r5',name:'Atti√©k√© poisson',     desc:'Semoule de manioc + poisson brais√©',   price:2800,  unit:'plat',    emoji:'üê†'},
    {id:'r6',name:'Plateau traiteur',    desc:'Pour 10 personnes (√©v√©nement)',        price:35000, unit:'plateau', emoji:'üéâ'},
  ],
  clothes:[
    {id:'c1',name:'Boubou homme',         desc:'Tissu wax, tailles S-XXL',      price:12000, unit:'pi√®ce', emoji:'üëò'},
    {id:'c2',name:'Robe femme africaine', desc:'Couture locale, color√©e',       price:9500,  unit:'pi√®ce', emoji:'üëó'},
    {id:'c3',name:'Ensemble enfant',      desc:'3-12 ans, tissu wax',           price:6000,  unit:'pi√®ce', emoji:'üßí'},
    {id:'c4',name:'Sac en cuir',          desc:'Fabriqu√© localement',           price:15000, unit:'pi√®ce', emoji:'üëú'},
    {id:'c5',name:'Sandales tress√©es',    desc:'Artisanat togolais',            price:7500,  unit:'paire', emoji:'üë°'},
    {id:'c6',name:'Kit cosm√©tiques',      desc:'Savon karit√© + huile de palme', price:4500,  unit:'kit',   emoji:'‚ú®'},
  ]
};

// ‚ïê‚ïê‚ïê‚ïê ARTICLES ‚ïê‚ïê‚ïê‚ïê
let articlesCache=[];

window.loadArticles=async function(svc,btn){
  currentArtSvc=svc;
  if(btn){document.querySelectorAll(".svc-tab").forEach(b=>b.classList.remove("on"));btn.classList.add("on");}
  const titles={'food':'Alimentation','restaurant':'Restauration','clothes':'Pr√™t-√†-porter'};
  document.getElementById("art-panel-title").textContent=titles[svc]||svc;
  document.getElementById("articles-table").innerHTML=`<div style="text-align:center;padding:30px;color:var(--light)"><div class="spinner"></div></div>`;
  try{
    let snap;
    try{
      const q=query(collection(db,'articles'),where('service','==',svc),orderBy('ordre','asc'));
      snap=await getDocs(q);
    }catch(_){
      const q2=query(collection(db,'articles'),where('service','==',svc));
      snap=await getDocs(q2);
    }
    articlesCache=snap.docs.map(d=>({id:d.id,_src:'db',...d.data()}));
  }catch(e){articlesCache=[];toast('‚ùå Erreur chargement : '+e.message,'#C62828');}
  renderArticleTable();
};

function renderArticleTable(){
  const table=document.getElementById("articles-table");
  const head=`<div class="art-table-row art-table-head"><div></div><div>Article</div><div>Prix</div><div>Description</div><div>Dispo</div><div>Actions</div></div>`;

  // Fusionner Firestore + standards non encore import√©s
  const dbIds=new Set(articlesCache.map(a=>a.id));
  const stds=(DEFAULT_ARTICLES[currentArtSvc]||[])
    .filter(a=>!dbIds.has(a.id))
    .map(a=>({...a,_src:'std',stock:'en_stock',actif:true}));
  const all=[...articlesCache,...stds];
  all.sort((a,b)=>(a.ordre??99)-(b.ordre??99)||(a.name||'').localeCompare(b.name||''));

  if(!all.length){
    table.innerHTML=head+`<div style="text-align:center;padding:28px;color:var(--light);font-size:13px">Aucun article. Ajoutez-en via le bouton ci-dessus.</div>`;
    return;
  }

  table.innerHTML=head+all.map(a=>{
    const isStd=a._src==='std', isHidden=a.actif===false, isEpuise=a.stock==='epuise';

    const badgeSrc=isStd
      ?`<span class="badge-std">STD</span>`
      :`<span class="badge-perso">PERSO</span>`;
    const badgeHidden=isHidden?`<span class="badge-masque">MASQU√â</span>`:'';

    const dispoHtml=isEpuise
      ?`<span style="background:#FFEBEE;color:#C62828;font-size:9px;font-weight:800;padding:3px 9px;border-radius:6px">‚ùå √âpuis√©</span>`
      :`<span style="background:#E8F5E9;color:#2E7D32;font-size:9px;font-weight:800;padding:3px 9px;border-radius:6px">‚úÖ En stock</span>`;

    // Modifier : standard non import√© ‚Üí importer d'abord
    const btnEdit=isStd
      ?`<button class="art-edit" title="Modifier" onclick="importAndEdit('${a.id}')">‚úèÔ∏è Modifier</button>`
      :`<button class="art-edit" title="Modifier" onclick="editArticle('${a.id}')">‚úèÔ∏è</button>`;

    // Stock toggle (seulement si dans Firestore)
    const btnStock=isStd?'':isEpuise
      ?`<button class="stock-btn btn-en-stock" title="Remettre en stock" onclick="setStock('${a.id}','en_stock')">‚úÖ</button>`
      :`<button class="stock-btn btn-epuise" title="Marquer √©puis√©" onclick="setStock('${a.id}','epuise')">‚ùå</button>`;

    // Masquer / R√©afficher
    const btnVisi=isStd
      ?`<button class="stock-btn btn-masquer" title="Masquer aux clients" onclick="maskDefault('${a.id}')">üôà</button>`
      :isHidden
        ?`<button class="stock-btn btn-afficher" title="R√©afficher" onclick="setActif('${a.id}',true)">üëÅ</button>`
        :`<button class="stock-btn btn-masquer" title="Masquer" onclick="setActif('${a.id}',false)">üôà</button>`;

    // Supprimer (seulement Firestore)
    const btnDel=isStd?'':`<button class="art-del" title="Supprimer d√©finitivement" onclick="deleteArticle('${a.id}')">üóë</button>`;

    return `<div class="art-table-row" style="${isHidden?'opacity:.38;':''}">
      <div class="art-emoji">${a.emoji||'üì¶'}</div>
      <div>
        <div style="font-weight:700;font-size:12px;display:flex;gap:4px;flex-wrap:wrap;align-items:center">${a.name} ${badgeSrc}${badgeHidden}</div>
        ${a.unit?`<div style="font-size:10px;color:var(--light)">/ ${a.unit}</div>`:''}
      </div>
      <div style="font-weight:800;color:var(--blue);font-size:13px">${Number(a.price).toLocaleString('fr-FR')} F</div>
      <div style="font-size:11px;color:var(--mid)">${a.desc||''}</div>
      <div>${dispoHtml}</div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;align-items:center">${btnEdit}${btnStock}${btnVisi}${btnDel}</div>
    </div>`;
  }).join('');
}

window.openArticleModal=function(){
  editingArtId=null;
  document.getElementById("art-modal-title").textContent="Ajouter un article";
  document.getElementById("art-is-std").value='0';
  document.getElementById("art-std-info").style.display='none';
  ['art-id','art-emoji','art-name','art-desc','art-price','art-unit','art-img'].forEach(x=>document.getElementById(x).value='');
  document.getElementById("art-ordre").value='1';
  document.getElementById("art-stock").value='en_stock';
  document.getElementById("art-modal").classList.add("show");
};

window.editArticle=function(id){
  const a=articlesCache.find(x=>x.id===id); if(!a)return;
  editingArtId=id;
  document.getElementById("art-modal-title").textContent="Modifier l'article";
  document.getElementById("art-is-std").value='0';
  document.getElementById("art-std-info").style.display='none';
  document.getElementById("art-id").value=id;
  document.getElementById("art-emoji").value=a.emoji||'';
  document.getElementById("art-name").value=a.name||'';
  document.getElementById("art-desc").value=a.desc||'';
  document.getElementById("art-price").value=a.price||'';
  document.getElementById("art-unit").value=a.unit||'';
  document.getElementById("art-img").value=a.imageUrl||'';
  document.getElementById("art-ordre").value=a.ordre||1;
  document.getElementById("art-stock").value=a.stock||'en_stock';
  document.getElementById("art-modal").classList.add("show");
};

// Importer un article standard dans Firestore (m√™me ID) puis ouvrir le modal
window.importAndEdit=async function(stdId){
  const a=(DEFAULT_ARTICLES[currentArtSvc]||[]).find(x=>x.id===stdId);
  if(!a){toast("Article introuvable","#C62828");return;}
  const btn=document.getElementById("art-save-btn");
  if(btn){btn.disabled=true;btn.textContent="‚è≥ Importation...";}
  try{
    // Import dynamique de setDoc (non destructur√© dans les imports du haut)
    const fsMod=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
    await fsMod.setDoc(fsMod.doc(db,'articles',stdId),{
      service:currentArtSvc, name:a.name, desc:a.desc||'', price:a.price,
      unit:a.unit||'', emoji:a.emoji||'üì¶', imageUrl:'',
      ordre:a.ordre??99, stock:'en_stock', actif:true,
      createdAt:serverTimestamp(), updatedAt:serverTimestamp()
    });
    toast("‚úÖ Article import√© ‚Äî modifiez-le ci-dessous","#2E7D32");
    await loadArticles(currentArtSvc,null);
    editArticle(stdId);
    document.getElementById("art-is-std").value='1';
    document.getElementById("art-std-info").style.display='block';
  }catch(e){toast("‚ùå Erreur import : "+e.message,"#C62828");}
  finally{if(btn){btn.disabled=false;btn.textContent="üíæ Enregistrer l'article";}}
};

// Masquer un standard (cr√©e un doc Firestore avec actif:false)
window.maskDefault=async function(stdId){
  if(!confirm("Masquer cet article standard aux clients ?\nVous pourrez le r√©afficher √† tout moment."))return;
  const a=(DEFAULT_ARTICLES[currentArtSvc]||[]).find(x=>x.id===stdId);
  if(!a){toast("Introuvable","#C62828");return;}
  try{
    const fsMod=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
    await fsMod.setDoc(fsMod.doc(db,'articles',stdId),{
      service:currentArtSvc, name:a.name, desc:a.desc||'', price:a.price,
      unit:a.unit||'', emoji:a.emoji||'üì¶', imageUrl:'',
      ordre:a.ordre??99, stock:'en_stock', actif:false,
      createdAt:serverTimestamp(), updatedAt:serverTimestamp()
    });
    toast("üôà Article standard masqu√© aux clients","#E65100");
    loadArticles(currentArtSvc,null);
  }catch(e){toast("‚ùå Erreur : "+e.message,"#C62828");}
};

// Modifier la disponibilit√© d'un article Firestore
window.setStock=async function(id,val){
  try{
    await updateDoc(doc(db,'articles',id),{stock:val,updatedAt:serverTimestamp()});
    const a=articlesCache.find(x=>x.id===id); if(a)a.stock=val;
    renderArticleTable();
    toast(val==='epuise'?"‚ùå Marqu√© √âpuis√© ‚Äî invisible au panier client":"‚úÖ Remis En stock","#1A1A2E");
  }catch(e){toast("‚ùå Erreur : "+e.message,"#C62828");}
};

// Masquer / R√©afficher un article Firestore
window.setActif=async function(id,val){
  try{
    await updateDoc(doc(db,'articles',id),{actif:val,updatedAt:serverTimestamp()});
    const a=articlesCache.find(x=>x.id===id); if(a)a.actif=val;
    renderArticleTable();
    toast(val?"üëÅ Article r√©affich√© aux clients":"üôà Article masqu√© aux clients","#1A1A2E");
  }catch(e){toast("‚ùå Erreur : "+e.message,"#C62828");}
};

window.saveArticle=async function(){
  const name=document.getElementById("art-name").value.trim();
  const price=parseFloat(document.getElementById("art-price").value);
  if(!name||isNaN(price)||price<=0){toast("‚ö†Ô∏è Nom et prix obligatoires","#F5820A");return;}
  const data={
    service:currentArtSvc, name, price,
    emoji:   document.getElementById("art-emoji").value.trim()||'üì¶',
    desc:    document.getElementById("art-desc").value.trim(),
    unit:    document.getElementById("art-unit").value.trim(),
    imageUrl:document.getElementById("art-img").value.trim(),
    ordre:   parseInt(document.getElementById("art-ordre").value)||1,
    stock:   document.getElementById("art-stock").value||'en_stock',
    actif:   true,
    updatedAt:serverTimestamp()
  };
  const btn=document.getElementById("art-save-btn");
  if(btn){btn.disabled=true;btn.textContent="‚è≥ Enregistrement...";}
  try{
    if(editingArtId){
      await updateDoc(doc(db,'articles',editingArtId),data);
      toast("‚úÖ Article modifi√© !","#2E7D32");
    }else{
      data.createdAt=serverTimestamp();
      await addDoc(collection(db,'articles'),data);
      toast("‚úÖ Article ajout√© !","#2E7D32");
    }
    document.getElementById("art-modal").classList.remove("show");
    loadArticles(currentArtSvc,null);
  }catch(e){toast("‚ùå Erreur : "+e.message,"#C62828");}
  finally{if(btn){btn.disabled=false;btn.textContent="üíæ Enregistrer l'article";}}
};

window.deleteArticle=async function(id){
  if(!confirm("Supprimer d√©finitivement cet article ?\nCette action est irr√©versible."))return;
  try{
    await deleteDoc(doc(db,'articles',id));
    articlesCache=articlesCache.filter(a=>a.id!==id);
    renderArticleTable();
    toast("üóë Article supprim√© d√©finitivement","#C62828");
  }catch(e){toast("‚ùå Erreur","#C62828");}
};
// ‚ïê‚ïê‚ïê‚ïê RESTAURANTS ‚ïê‚ïê‚ïê‚ïê
const DEFAULT_RESTAURANTS_ADMIN = [
  {id:'rst1', nom:'Le Saveur d\'Afrique',   specialites:'Cuisine togolaise traditionnelle', localite:'Adidogom√©, Lom√©',     emoji:'ü•ò', description:'Sp√©cialiste du fufu, du riz sauce et des plats locaux authentiques.'},
  {id:'rst2', nom:'Chez Maman Akossiwa',    specialites:'Plats locaux & traiteur',         localite:'B√® Kpota, Lom√©',       emoji:'üç≤', description:'Cuisine familiale, plats du jour et service traiteur pour √©v√©nements.'},
  {id:'rst3', nom:'Grill Palace',           specialites:'Grillades & brochettes',           localite:'Kodjoviakop√©, Lom√©',   emoji:'üî•', description:'Brochettes mixtes, poulet grill√©, c√¥tes de b≈ìuf marin√©es.'},
  {id:'rst4', nom:'La Terrasse Ivoirienne', specialites:'Atti√©k√©, alloco & poissons',      localite:'Agbal√©p√©dogan, Lom√©',  emoji:'üê†', description:'Sp√©cialit√©s ivoiriennes, atti√©k√© poisson, alloco banane.'},
];

const DEFAULT_MENUS_ADMIN = {
  rst1:[
    {id:'rst1_m1',name:'Riz sauce arachide',desc:'Plat traditionnel copieux',price:2500,unit:'plat',emoji:'üçö'},
    {id:'rst1_m2',name:'Fufu + soupe de viande',desc:'Fufu de manioc, bouillon maison',price:3000,unit:'plat',emoji:'üç≤'},
    {id:'rst1_m3',name:'Akum√© + sauce gombo',desc:'P√¢te de ma√Øs, sauce gombo',price:2200,unit:'plat',emoji:'üåΩ'},
    {id:'rst1_m4',name:'Plateau traiteur 10 pers.',desc:'Pour √©v√©nements et r√©ceptions',price:35000,unit:'plateau',emoji:'üéâ'},
  ],
  rst2:[
    {id:'rst2_m1',name:'Plat du jour',desc:'Selon arrivage, servi avec boisson',price:2000,unit:'plat',emoji:'üç±'},
    {id:'rst2_m2',name:'Poulet yassa',desc:'Marin√© aux oignons et citron',price:4500,unit:'plat',emoji:'üçó'},
    {id:'rst2_m3',name:'Riz sauce tomate',desc:'Sauce tomate maison, l√©gumes',price:2000,unit:'plat',emoji:'üçÖ'},
    {id:'rst2_m4',name:'Traiteur √©v√©nement',desc:'Devis sur mesure pour vos √©v√©nements',price:50000,unit:'forfait',emoji:'ü•Ç'},
  ],
  rst3:[
    {id:'rst3_m1',name:'Brochettes mixtes',desc:'B≈ìuf, poulet, foie grill√©s',price:2000,unit:'portion',emoji:'üç¢'},
    {id:'rst3_m2',name:'Poulet grill√© entier',desc:'Avec frites et salade',price:8000,unit:'pi√®ce',emoji:'üêî'},
    {id:'rst3_m3',name:'C√¥tes de b≈ìuf',desc:'Marin√©es au poivre, grill√©es au feu de bois',price:5500,unit:'portion',emoji:'ü•©'},
    {id:'rst3_m4',name:'Poisson brais√©',desc:'Tilapia grill√© entier avec garniture',price:3500,unit:'pi√®ce',emoji:'üêü'},
  ],
  rst4:[
    {id:'rst4_m1',name:'Atti√©k√© poisson',desc:'Semoule de manioc + poisson brais√©',price:2800,unit:'plat',emoji:'üê†'},
    {id:'rst4_m2',name:'Alloco + poulet',desc:'Banane plantain frite, poulet brais√©',price:3200,unit:'plat',emoji:'üçå'},
    {id:'rst4_m3',name:'Garba',desc:'Atti√©k√© + thon frit, sp√©cialit√© ivoirienne',price:2500,unit:'plat',emoji:'üçΩÔ∏è'},
    {id:'rst4_m4',name:'Placali + sauce graine',desc:'P√¢te de manioc, sauce palmiste',price:2800,unit:'plat',emoji:'üå¥'},
  ],
};

let restaurantsCache = [];
let currentRst       = null; // restaurant en cours d'√©dition menus
let editingRstId     = null;
let menuArticlesCache= [];
let editingMenuArtId = null;

function showRstView(v) {
  document.getElementById('rst-view-list').style.display  = v==='list'  ? 'block' : 'none';
  document.getElementById('rst-view-menus').style.display = v==='menus' ? 'block' : 'none';
}
window.showRstView = showRstView;

window.loadRestaurants = async function() {
  const grid = document.getElementById('rst-grid');
  grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--light)"><div class="spinner"></div></div>`;
  try {
    let snap;
    try { snap = await getDocs(query(collection(db,'restaurants'), orderBy('ordre','asc'))); }
    catch(_) { snap = await getDocs(collection(db,'restaurants')); }
    restaurantsCache = snap.docs.map(d => ({id:d.id, _src:'db', ...d.data()}));
  } catch(e) { restaurantsCache = []; }

  // Fusionner avec standards
  const dbIds = new Set(restaurantsCache.map(r=>r.id));
  const stds = DEFAULT_RESTAURANTS_ADMIN.filter(r=>!dbIds.has(r.id)).map(r=>({...r,_src:'std',actif:true}));
  const all = [...restaurantsCache, ...stds];
  all.sort((a,b)=>(a.ordre??99)-(b.ordre??99)||(a.nom||'').localeCompare(b.nom||''));
  renderRestaurantsGrid(all);
};

function renderRestaurantsGrid(list) {
  const grid = document.getElementById('rst-grid');
  if (!list.length) {
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--light)">Aucun restaurant. Ajoutez-en via le bouton ci-dessus.</div>`;
    return;
  }
  grid.innerHTML = list.map(r => {
    const isStd = r._src === 'std';
    const isHidden = r.actif === false;
    return `
    <div class="rst-admin-card">
      <div class="rst-admin-img">
        ${r.imageUrl ? `<img src="${r.imageUrl}" alt="${r.nom||''}" onerror="this.style.display='none'"/>` : ''}
        <span style="${r.imageUrl?'display:none':''}">${r.emoji||'üçΩÔ∏è'}</span>
        ${isStd ? `<div style="position:absolute;top:8px;left:8px;background:rgba(30,111,190,.9);color:#fff;font-size:8px;font-weight:800;padding:3px 8px;border-radius:999px;letter-spacing:.5px">STD</div>` : ''}
        ${isHidden ? `<div style="position:absolute;top:8px;right:8px;background:rgba(198,40,40,.9);color:#fff;font-size:8px;font-weight:800;padding:3px 8px;border-radius:999px">MASQU√â</div>` : ''}
      </div>
      <div class="rst-admin-body">
        <div class="rst-admin-name">${r.nom||'Restaurant'}</div>
        <div class="rst-admin-spec">üç¥ ${r.specialites||''}</div>
        <div class="rst-admin-loc">üìç ${r.localite||''}</div>
      </div>
      <div class="rst-admin-footer">
        <button class="rst-menu-btn" onclick="openRstMenus('${r.id}')">üçΩÔ∏è G√©rer les plats</button>
        <div style="display:flex;gap:6px">
          ${!isStd ? `<button class="art-edit" onclick="editRestaurant('${r.id}')">‚úèÔ∏è</button>` : `<button class="art-edit" onclick="importAndEditRestaurant('${r.id}')">‚úèÔ∏è Modifier</button>`}
          ${!isStd ? `<button class="art-del" onclick="deleteRestaurant('${r.id}')">üóë</button>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

window.openRestaurantModal = function() {
  editingRstId = null;
  document.getElementById('rst-modal-title').textContent = 'Ajouter un restaurant';
  ['rst-id','rst-emoji','rst-nom','rst-specialites','rst-localite','rst-description','rst-img'].forEach(x=>document.getElementById(x).value='');
  document.getElementById('rst-ordre').value = '1';
  document.getElementById('rst-actif').value = '1';
  document.getElementById('rst-modal').classList.add('show');
};

window.editRestaurant = function(id) {
  const r = restaurantsCache.find(x=>x.id===id);
  if (!r) return;
  editingRstId = id;
  document.getElementById('rst-modal-title').textContent = 'Modifier le restaurant';
  document.getElementById('rst-id').value          = id;
  document.getElementById('rst-emoji').value       = r.emoji||'';
  document.getElementById('rst-nom').value         = r.nom||'';
  document.getElementById('rst-specialites').value = r.specialites||'';
  document.getElementById('rst-localite').value    = r.localite||'';
  document.getElementById('rst-description').value = r.description||'';
  document.getElementById('rst-img').value         = r.imageUrl||'';
  document.getElementById('rst-ordre').value       = r.ordre||1;
  document.getElementById('rst-actif').value       = r.actif===false ? '0' : '1';
  document.getElementById('rst-modal').classList.add('show');
};

window.importAndEditRestaurant = async function(stdId) {
  const r = DEFAULT_RESTAURANTS_ADMIN.find(x=>x.id===stdId);
  if (!r) return;
  const fsMod = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
  await fsMod.setDoc(fsMod.doc(db,'restaurants',stdId), {
    nom:r.nom, specialites:r.specialites, localite:r.localite,
    description:r.description||'', emoji:r.emoji||'üçΩÔ∏è', imageUrl:'',
    ordre:1, actif:true, createdAt:serverTimestamp(), updatedAt:serverTimestamp()
  });
  await loadRestaurants();
  editRestaurant(stdId);
};

window.saveRestaurant = async function() {
  const nom = document.getElementById('rst-nom').value.trim();
  const specialites = document.getElementById('rst-specialites').value.trim();
  const localite = document.getElementById('rst-localite').value.trim();
  if (!nom || !localite) { toast('‚ö†Ô∏è Nom et localit√© obligatoires','#F5820A'); return; }
  const data = {
    nom, specialites, localite,
    emoji:       document.getElementById('rst-emoji').value.trim()||'üçΩÔ∏è',
    description: document.getElementById('rst-description').value.trim(),
    imageUrl:    document.getElementById('rst-img').value.trim(),
    ordre:       parseInt(document.getElementById('rst-ordre').value)||1,
    actif:       document.getElementById('rst-actif').value === '1',
    updatedAt:   serverTimestamp()
  };
  const btn = document.getElementById('rst-save-btn');
  if(btn){btn.disabled=true;btn.textContent='‚è≥ Enregistrement...';}
  try {
    if (editingRstId) {
      await updateDoc(doc(db,'restaurants',editingRstId), data);
      toast('‚úÖ Restaurant modifi√© !','#2E7D32');
    } else {
      data.createdAt = serverTimestamp();
      await addDoc(collection(db,'restaurants'), data);
      toast('‚úÖ Restaurant ajout√© !','#2E7D32');
    }
    document.getElementById('rst-modal').classList.remove('show');
    loadRestaurants();
  } catch(e) { toast('‚ùå Erreur : '+e.message,'#C62828'); }
  finally { if(btn){btn.disabled=false;btn.textContent='üíæ Enregistrer le restaurant';} }
};

window.deleteRestaurant = async function(id) {
  if (!confirm('Supprimer ce restaurant et tous ses plats ?')) return;
  try {
    await deleteDoc(doc(db,'restaurants',id));
    // Supprimer aussi les articles de ce restaurant
    const snap = await getDocs(query(collection(db,'articles'), where('restaurantId','==',id)));
    for (const d of snap.docs) await deleteDoc(d.ref);
    restaurantsCache = restaurantsCache.filter(r=>r.id!==id);
    const dbIds = new Set(restaurantsCache.map(r=>r.id));
    const stds = DEFAULT_RESTAURANTS_ADMIN.filter(r=>!dbIds.has(r.id)).map(r=>({...r,_src:'std',actif:true}));
    renderRestaurantsGrid([...restaurantsCache,...stds]);
    toast('üóë Restaurant supprim√©','#C62828');
  } catch(e) { toast('‚ùå Erreur : '+e.message,'#C62828'); }
};

// ‚îÄ‚îÄ Gestion menus d'un restaurant ‚îÄ‚îÄ
window.openRstMenus = async function(rstId) {
  const allRsts = [...restaurantsCache, ...DEFAULT_RESTAURANTS_ADMIN.filter(r=>!new Set(restaurantsCache.map(x=>x.id)).has(r.id))];
  currentRst = allRsts.find(r=>r.id===rstId) || {id:rstId, nom:'Restaurant', emoji:'üçΩÔ∏è'};
  document.getElementById('menu-rst-emoji').textContent = currentRst.emoji||'üçΩÔ∏è';
  document.getElementById('menu-rst-name').textContent  = currentRst.nom||'Restaurant';
  document.getElementById('menu-panel-title').textContent = `Plats ‚Äî ${currentRst.nom}`;
  showRstView('menus');
  loadMenuArticles(rstId);
};

async function loadMenuArticles(rstId) {
  const table = document.getElementById('menu-articles-table');
  table.innerHTML = `<div style="text-align:center;padding:30px;color:var(--light)"><div class="spinner"></div></div>`;
  try {
    let snap;
    try {
      snap = await getDocs(query(collection(db,'articles'), where('service','==','restaurant'), where('restaurantId','==',rstId), orderBy('ordre','asc')));
    } catch(_) {
      snap = await getDocs(query(collection(db,'articles'), where('service','==','restaurant'), where('restaurantId','==',rstId)));
    }
    menuArticlesCache = snap.docs.map(d=>({id:d.id,_src:'db',...d.data()}));
  } catch(e) { menuArticlesCache = []; }

  // Fusionner avec menus standards
  const dbIds = new Set(menuArticlesCache.map(a=>a.id));
  const stds = (DEFAULT_MENUS_ADMIN[rstId]||[]).filter(a=>!dbIds.has(a.id)).map(a=>({...a,_src:'std',stock:'en_stock',actif:true,restaurantId:rstId}));
  const all = [...menuArticlesCache, ...stds];
  all.sort((a,b)=>(a.ordre??99)-(b.ordre??99)||(a.name||'').localeCompare(b.name||''));
  renderMenuArticleTable(all);
}

function renderMenuArticleTable(all) {
  const table = document.getElementById('menu-articles-table');
  const head = `<div class="art-table-row art-table-head"><div></div><div>Plat</div><div>Prix</div><div>Description</div><div>Dispo</div><div>Actions</div></div>`;
  if (!all.length) {
    table.innerHTML = head + `<div style="text-align:center;padding:28px;color:var(--light);font-size:13px">Aucun plat. Ajoutez-en via le bouton ci-dessus.</div>`;
    return;
  }
  table.innerHTML = head + all.map(a => {
    const isStd = a._src==='std', isHidden = a.actif===false, isEpuise = a.stock==='epuise';
    const badgeSrc = isStd ? `<span class="badge-std">STD</span>` : `<span class="badge-perso">PERSO</span>`;
    const badgeHidden = isHidden ? `<span class="badge-masque">MASQU√â</span>` : '';
    const dispoHtml = isEpuise
      ? `<button class="stock-btn btn-en-stock" onclick="setMenuStock('${a.id}','en_stock','${a._src}')">Remettre</button>`
      : `<button class="stock-btn btn-epuise" onclick="setMenuStock('${a.id}','epuise','${a._src}')">√âpuiser</button>`;
    const actionsHtml = isStd
      ? `<button class="art-edit" onclick="importAndEditMenu('${a.id}')">‚úèÔ∏è Modifier</button>
         <button class="art-del" onclick="maskMenuDefault('${a.id}')">üôà</button>`
      : `<button class="art-edit" onclick="editMenuArticle('${a.id}')">‚úèÔ∏è</button>
         ${isHidden
           ? `<button class="stock-btn btn-afficher" style="margin-left:4px" onclick="setMenuActif('${a.id}',true)">üëÅ</button>`
           : `<button class="stock-btn btn-masquer" style="margin-left:4px" onclick="setMenuActif('${a.id}',false)">üôà</button>`}
         <button class="art-del" onclick="deleteMenuArticle('${a.id}')">üóë</button>`;
    return `<div class="art-table-row" style="${isHidden?'opacity:.5':''}">
      <div class="art-emoji">${a.emoji||'üçΩÔ∏è'}</div>
      <div><div style="font-weight:700;font-size:12px">${a.name}</div>${badgeSrc} ${badgeHidden}</div>
      <div style="font-weight:700;font-size:12px;color:var(--blue)">${Number(a.price).toLocaleString('fr-FR')} FCFA</div>
      <div style="font-size:11px;color:var(--light)">${a.desc||'‚Äî'}</div>
      <div>${dispoHtml}</div>
      <div style="display:flex;flex-wrap:wrap;gap:4px">${actionsHtml}</div>
    </div>`;
  }).join('');
}

window.openMenuArticleModal = function() {
  editingMenuArtId = null;
  document.getElementById('menu-art-modal-title').textContent = 'Ajouter un plat';
  ['menu-art-id','menu-art-emoji','menu-art-name','menu-art-desc','menu-art-price','menu-art-unit','menu-art-img'].forEach(x=>document.getElementById(x).value='');
  document.getElementById('menu-art-ordre').value = '1';
  document.getElementById('menu-art-stock').value = 'en_stock';
  document.getElementById('menu-art-modal').classList.add('show');
};

window.editMenuArticle = function(id) {
  const a = menuArticlesCache.find(x=>x.id===id); if(!a) return;
  editingMenuArtId = id;
  document.getElementById('menu-art-modal-title').textContent = 'Modifier le plat';
  document.getElementById('menu-art-id').value    = id;
  document.getElementById('menu-art-emoji').value = a.emoji||'';
  document.getElementById('menu-art-name').value  = a.name||'';
  document.getElementById('menu-art-desc').value  = a.desc||'';
  document.getElementById('menu-art-price').value = a.price||'';
  document.getElementById('menu-art-unit').value  = a.unit||'';
  document.getElementById('menu-art-img').value   = a.imageUrl||'';
  document.getElementById('menu-art-ordre').value = a.ordre||1;
  document.getElementById('menu-art-stock').value = a.stock||'en_stock';
  document.getElementById('menu-art-modal').classList.add('show');
};

window.importAndEditMenu = async function(stdId) {
  if (!currentRst) return;
  const allStds = DEFAULT_MENUS_ADMIN[currentRst.id]||[];
  const a = allStds.find(x=>x.id===stdId); if(!a) return;
  const fsMod = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
  await fsMod.setDoc(fsMod.doc(db,'articles',stdId),{
    service:'restaurant', restaurantId:currentRst.id,
    name:a.name, desc:a.desc||'', price:a.price, unit:a.unit||'',
    emoji:a.emoji||'üçΩÔ∏è', imageUrl:'', ordre:a.ordre??99,
    stock:'en_stock', actif:true, createdAt:serverTimestamp(), updatedAt:serverTimestamp()
  });
  toast('‚úÖ Plat import√© ‚Äî modifiez-le','#2E7D32');
  await loadMenuArticles(currentRst.id);
  editMenuArticle(stdId);
};

window.maskMenuDefault = async function(stdId) {
  if (!currentRst) return;
  if (!confirm('Masquer ce plat standard aux clients ?')) return;
  const allStds = DEFAULT_MENUS_ADMIN[currentRst.id]||[];
  const a = allStds.find(x=>x.id===stdId); if(!a) return;
  const fsMod = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
  await fsMod.setDoc(fsMod.doc(db,'articles',stdId),{
    service:'restaurant', restaurantId:currentRst.id,
    name:a.name, desc:a.desc||'', price:a.price, unit:a.unit||'',
    emoji:a.emoji||'üçΩÔ∏è', imageUrl:'', ordre:a.ordre??99,
    stock:'en_stock', actif:false, createdAt:serverTimestamp(), updatedAt:serverTimestamp()
  });
  toast('üôà Plat masqu√©','#E65100');
  loadMenuArticles(currentRst.id);
};

window.setMenuStock = async function(id, val, src) {
  if (src==='std') { toast('‚ö†Ô∏è Importez d\'abord ce plat pour modifier son stock','#F5820A'); return; }
  try {
    await updateDoc(doc(db,'articles',id),{stock:val,updatedAt:serverTimestamp()});
    const a = menuArticlesCache.find(x=>x.id===id); if(a) a.stock=val;
    const dbIds = new Set(menuArticlesCache.map(x=>x.id));
    const stds = (DEFAULT_MENUS_ADMIN[currentRst.id]||[]).filter(a=>!dbIds.has(a.id)).map(a=>({...a,_src:'std',stock:'en_stock',actif:true}));
    renderMenuArticleTable([...menuArticlesCache,...stds]);
    toast(val==='epuise'?'‚ùå Plat √©puis√©':'‚úÖ Plat remis en stock','#1A1A2E');
  } catch(e) { toast('‚ùå Erreur : '+e.message,'#C62828'); }
};

window.setMenuActif = async function(id, val) {
  try {
    await updateDoc(doc(db,'articles',id),{actif:val,updatedAt:serverTimestamp()});
    const a = menuArticlesCache.find(x=>x.id===id); if(a) a.actif=val;
    const dbIds = new Set(menuArticlesCache.map(x=>x.id));
    const stds = (DEFAULT_MENUS_ADMIN[currentRst.id]||[]).filter(a=>!dbIds.has(a.id)).map(a=>({...a,_src:'std',stock:'en_stock',actif:true}));
    renderMenuArticleTable([...menuArticlesCache,...stds]);
    toast(val?'üëÅ Plat r√©affich√©':'üôà Plat masqu√©','#1A1A2E');
  } catch(e) { toast('‚ùå Erreur : '+e.message,'#C62828'); }
};

window.saveMenuArticle = async function() {
  if (!currentRst) { toast('‚ùå Aucun restaurant s√©lectionn√©','#C62828'); return; }
  const name  = document.getElementById('menu-art-name').value.trim();
  const price = parseFloat(document.getElementById('menu-art-price').value);
  if (!name || isNaN(price) || price <= 0) { toast('‚ö†Ô∏è Nom et prix obligatoires','#F5820A'); return; }
  const data = {
    service: 'restaurant',
    restaurantId: currentRst.id,
    name, price,
    emoji:    document.getElementById('menu-art-emoji').value.trim()||'üçΩÔ∏è',
    desc:     document.getElementById('menu-art-desc').value.trim(),
    unit:     document.getElementById('menu-art-unit').value.trim(),
    imageUrl: document.getElementById('menu-art-img').value.trim(),
    ordre:    parseInt(document.getElementById('menu-art-ordre').value)||1,
    stock:    document.getElementById('menu-art-stock').value||'en_stock',
    actif:    true,
    updatedAt: serverTimestamp()
  };
  const btn = document.getElementById('menu-art-save-btn');
  if(btn){btn.disabled=true;btn.textContent='‚è≥ Enregistrement...';}
  try {
    if (editingMenuArtId) {
      await updateDoc(doc(db,'articles',editingMenuArtId), data);
      toast('‚úÖ Plat modifi√© !','#2E7D32');
    } else {
      data.createdAt = serverTimestamp();
      await addDoc(collection(db,'articles'), data);
      toast('‚úÖ Plat ajout√© !','#2E7D32');
    }
    document.getElementById('menu-art-modal').classList.remove('show');
    loadMenuArticles(currentRst.id);
  } catch(e) { toast('‚ùå Erreur : '+e.message,'#C62828'); }
  finally { if(btn){btn.disabled=false;btn.textContent='üíæ Enregistrer le plat';} }
};

window.deleteMenuArticle = async function(id) {
  if (!confirm('Supprimer d√©finitivement ce plat ?')) return;
  try {
    await deleteDoc(doc(db,'articles',id));
    menuArticlesCache = menuArticlesCache.filter(a=>a.id!==id);
    const dbIds = new Set(menuArticlesCache.map(x=>x.id));
    const stds = (DEFAULT_MENUS_ADMIN[currentRst?.id]||[]).filter(a=>!dbIds.has(a.id)).map(a=>({...a,_src:'std',stock:'en_stock',actif:true}));
    renderMenuArticleTable([...menuArticlesCache,...stds]);
    toast('üóë Plat supprim√©','#C62828');
  } catch(e) { toast('‚ùå Erreur','#C62828'); }
};

// ‚ïê‚ïê‚ïê‚ïê PARTENAIRES ‚ïê‚ïê‚ïê‚ïê
let partnersCache=[];
window.loadPartners=async function(){
  const grid=document.getElementById("partner-grid");
  grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--light)"><div class="spinner"></div></div>`;
  try{
    const q=query(collection(db,'partenaires'),orderBy('ordre','asc'));
    const snap=await getDocs(q);
    partnersCache=snap.docs.map(d=>({id:d.id,...d.data()}));
  }catch(e){partnersCache=[];}
  renderPartners();
};

function renderPartners(){
  const grid=document.getElementById("partner-grid");
  if(!partnersCache.length){
    grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--light)">Aucune publication. Ajoutez-en via le bouton ci-dessus.</div>`;
    return;
  }
  const promoLabels={partenaire:'PARTENAIRE OFFICIEL',sponsor:'SPONSOR',collaborateur:'COLLABORATEUR',nouveaute:'NOUVEAUT√â',promotion:'PROMOTION',evenement:'√âV√âNEMENT'};
  grid.innerHTML=partnersCache.map(p=>{
    const isHidden = p.actif === false;
    const statutBadge = isHidden
      ? `<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:999px;background:#FFF3E0;color:#E65100">Masqu√©</span>`
      : `<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:999px;background:#E8F5E9;color:var(--green)">Actif</span>`;
    return `
    <div style="background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.07);${isHidden?'opacity:.6':''}">
      <!-- Aper√ßu adcard fid√®le au client -->
      <div class="prev-adcard" style="border-radius:0;box-shadow:none;margin:0">
        <div class="prev-adcard-img">
          <div class="prev-adcard-gradient"></div>
          <div class="prev-adcard-badge">${p.badge||(p.nom?'ü§ù '+p.nom:'ü§ù Partenaire')}</div>
          ${p.imageUrl
            ? `<img src="${p.imageUrl}" alt="${p.nom||''}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"/><span class="prev-adcard-emoji" style="display:none">ü§ù</span>`
            : `<span class="prev-adcard-emoji">ü§ù</span>`}
        </div>
        <div class="prev-adcard-body">
          <div class="prev-adcard-promo">${promoLabels[p.promo]||'PARTENAIRE OFFICIEL'}</div>
          <div class="prev-adcard-title">${p.nom||'Sans titre'}</div>
          <div class="prev-adcard-sub">${p.description||'‚Äî'}</div>
          ${p.lien?`<div class="prev-adcard-cta show">D√©couvrir ‚Üí</div>`:''}
        </div>
      </div>
      <!-- Bandeau statut + actions admin -->
      <div style="padding:8px 14px;display:flex;align-items:center;justify-content:space-between;background:var(--bg);border-top:1px solid var(--border)">
        <div style="display:flex;align-items:center;gap:7px">
          ${statutBadge}
          <span style="font-size:10px;color:var(--light);font-weight:600">Ordre : ${p.ordre||1}</span>
          ${p.lien?`<a href="${p.lien}" target="_blank" style="font-size:10px;color:var(--blue)">üîó Voir le lien</a>`:''}
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="art-edit" onclick="editPartner('${p.id}')">‚úèÔ∏è Modifier</button>
          ${isHidden
            ? `<button class="stock-btn btn-afficher" onclick="setPartnerActif('${p.id}',true)">üëÅ Afficher</button>`
            : `<button class="stock-btn btn-masquer"  onclick="setPartnerActif('${p.id}',false)">üôà Masquer</button>`}
          <button class="art-del" onclick="deletePartner('${p.id}')">üóë</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

window.openPartnerModal=function(){
  editingPartnerId=null;
  document.getElementById("partner-modal-title").textContent="Ajouter une publication";
  ['partner-id','p-nom','p-desc','p-img','p-lien','p-badge'].forEach(x=>document.getElementById(x).value='');
  document.getElementById("p-ordre").value='1';
  document.getElementById("p-promo").value='partenaire';
  // R√©initialiser l'aper√ßu
  document.getElementById("prev-promo").textContent="PARTENAIRE OFFICIEL";
  document.getElementById("prev-title").textContent="Nom du partenaire";
  document.getElementById("prev-sub").textContent="Description ou slogan";
  document.getElementById("prev-badge").textContent="ü§ù Partenaire";
  document.getElementById("prev-cta").classList.remove("show");
  const ph=document.getElementById("prev-photo"); ph.src=''; ph.style.display='none';
  document.getElementById("prev-emoji").style.display='block';
  document.getElementById("partner-modal").classList.add("show");
};

window.editPartner=function(id){
  const p=partnersCache.find(x=>x.id===id); if(!p)return;
  editingPartnerId=id;
  document.getElementById("partner-modal-title").textContent="Modifier la publication";
  document.getElementById("partner-id").value=id;
  document.getElementById("p-nom").value=p.nom||'';
  document.getElementById("p-desc").value=p.description||'';
  document.getElementById("p-img").value=p.imageUrl||'';
  document.getElementById("p-lien").value=p.lien||'';
  document.getElementById("p-ordre").value=p.ordre||1;
  document.getElementById("p-promo").value=p.promo||'partenaire';
  document.getElementById("p-badge").value=p.badge||'';
  // Peupler l'aper√ßu
  const promoLabels={partenaire:'PARTENAIRE OFFICIEL',sponsor:'SPONSOR',collaborateur:'COLLABORATEUR',nouveaute:'NOUVEAUT√â',promotion:'PROMOTION',evenement:'√âV√âNEMENT'};
  document.getElementById("prev-promo").textContent=promoLabels[p.promo]||'PARTENAIRE OFFICIEL';
  document.getElementById("prev-title").textContent=p.nom||'Nom du partenaire';
  document.getElementById("prev-sub").textContent=p.description||'Description ou slogan';
  document.getElementById("prev-badge").textContent=p.badge||(p.nom?'ü§ù '+p.nom:'ü§ù Partenaire');
  document.getElementById("prev-cta").classList.toggle("show",!!p.lien);
  const ph=document.getElementById("prev-photo");
  if(p.imageUrl){ph.src=p.imageUrl;ph.style.display='block';document.getElementById("prev-emoji").style.display='none';}
  else{ph.src='';ph.style.display='none';document.getElementById("prev-emoji").style.display='block';}
  document.getElementById("partner-modal").classList.add("show");
};

window.savePartner=async function(){
  const nom=document.getElementById("p-nom").value.trim();
  const img=document.getElementById("p-img").value.trim();
  if(!nom){toast("‚ö†Ô∏è Le nom est obligatoire","#F5820A");return;}
  const data={
    nom, imageUrl:img,
    description:document.getElementById("p-desc").value.trim(),
    lien:document.getElementById("p-lien").value.trim(),
    badge:document.getElementById("p-badge").value.trim(),
    promo:document.getElementById("p-promo").value||'partenaire',
    ordre:parseInt(document.getElementById("p-ordre").value)||1,
    updatedAt:serverTimestamp()
  };
  try{
    if(editingPartnerId){
      await updateDoc(doc(db,'partenaires',editingPartnerId),data);
      toast("‚úÖ Publication modifi√©e !","#2E7D32");
    } else {
      data.createdAt=serverTimestamp();
      await addDoc(collection(db,'partenaires'),data);
      toast("‚úÖ Publication ajout√©e !","#2E7D32");
    }
    document.getElementById("partner-modal").classList.remove("show");
    loadPartners();
  }catch(e){toast("‚ùå Erreur : "+e.message,"#C62828");}
};

window.deletePartner=async function(id){
  if(!confirm("Supprimer cette publication ?"))return;
  try{await deleteDoc(doc(db,'partenaires',id));partnersCache=partnersCache.filter(p=>p.id!==id);renderPartners();toast("üóë Supprim√©e");}catch(e){toast("‚ùå Erreur","#C62828");}
};

window.setPartnerActif = async function(id, actif) {
  try {
    await updateDoc(doc(db,'partenaires',id), {actif, updatedAt:serverTimestamp()});
    const p = partnersCache.find(x=>x.id===id); if(p) p.actif=actif;
    renderPartners();
    toast(actif ? 'üëÅ Publication affich√©e' : 'üôà Publication masqu√©e', actif ? '#2E7D32' : '#F5820A');
  } catch(e) { toast('‚ùå Erreur : '+e.message,'#C62828'); }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KITS & PACKS ADMIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const DEFAULT_KITS_ADMIN = [
  { id:'kit1', nom:'Kit Repas Semaine', emoji:'üç±', description:"Tout ce qu'il faut pour nourrir votre famille pendant 7 jours",
    prix_total:28500, categorie:'Alimentation', ordre:1,
    articles:[
      {emoji:'üêü', name:'Tilapia frais',      qty:2, unit:'kg',        prix:3500},
      {emoji:'üêî', name:'Poulet fermier',      qty:2, unit:'pi√®ces',    prix:5500},
      {emoji:'ü•¨', name:'L√©gumes assortis',    qty:3, unit:'paniers',   prix:1500},
      {emoji:'üç∂', name:'Vin de palme',        qty:1, unit:'bidon',     prix:4000},
      {emoji:'ü´ò', name:'N√©r√© (soumbara)',     qty:2, unit:'sachets',   prix:1000},
    ]},
  { id:'kit2', nom:'Pack F√™te & √âv√©nement', emoji:'üéâ', description:'Pour vos c√©r√©monies, mariages et r√©ceptions (10-15 personnes)',
    prix_total:75000, categorie:'√âv√©nement', ordre:2,
    articles:[
      {emoji:'üéä', name:'Plateau traiteur',   qty:1,  unit:'plateau',  prix:35000},
      {emoji:'üçó', name:'Poulet yassa',       qty:15, unit:'plats',    prix:4500},
      {emoji:'üçö', name:'Riz sauce arachide', qty:15, unit:'plats',    prix:2500},
      {emoji:'ü•§', name:'Boissons vari√©es',   qty:1,  unit:'lot',      prix:8000},
    ]},
  { id:'kit3', nom:'Pack Mode Wax Complet', emoji:'üëó', description:'Ensemble pr√™t-√†-porter africain complet pour homme ou femme',
    prix_total:26000, categorie:'Pret-a-porter', ordre:3,
    articles:[
      {emoji:'üëò', name:'Boubou wax',         qty:1, unit:'pi√®ce',    prix:12000},
      {emoji:'üëú', name:'Sac assorti',        qty:1, unit:'pi√®ce',    prix:15000},
      {emoji:'üë°', name:'Sandales tress√©es',  qty:1, unit:'paire',    prix:7500},
      {emoji:'‚ú®', name:'Kit cosm√©tiques',    qty:1, unit:'kit',      prix:4500},
    ]},
  { id:'kit4', nom:'Kit Nettoyage Maison', emoji:'‚ú®', description:'Service de nettoyage + fournitures pour votre domicile (60m¬≤)',
    prix_total:18000, categorie:'Nettoyage', ordre:4,
    articles:[
      {emoji:'üßπ', name:'Nettoyage complet',  qty:1, unit:'prestation', prix:12000},
      {emoji:'üß¥', name:'Produits m√©nagers',  qty:1, unit:'kit',        prix:3500},
      {emoji:'ü¶†', name:'D√©sinfection',       qty:1, unit:'prestation', prix:2500},
    ]},
];

const KIT_CAT_COLORS = {
  'Alimentation':'#FFF3E0','Restauration':'#E3F2FD','Pret-a-porter':'#FFF0F5',
  'Nettoyage':'#F3E5F5','√âv√©nement':'#E8F5E9','Mixte':'#E8EAF0'
};

let kitsCache        = [];
let editingKitId     = null;
let currentKit       = null; // kit ouvert dans la vue articles
let kitArtCache      = [];   // articles du kit courant (copies locales)
let editingKitArtIdx = null; // index dans kitArtCache

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function _stdKitData(k, extra={}) {
  return {
    nom:k.nom, emoji:k.emoji||'üéÅ', description:k.description||'',
    categorie:k.categorie, prix_total:k.prix_total,
    articles: JSON.parse(JSON.stringify(k.articles||[])),
    imageUrl:'', ordre:k.ordre||99, actif:true, epuise:false,
    createdAt:serverTimestamp(), updatedAt:serverTimestamp(), ...extra
  };
}

function showKitView(v) {
  document.getElementById('kits-view-list').style.display     = v==='list'     ? 'block' : 'none';
  document.getElementById('kits-view-articles').style.display = v==='articles' ? 'block' : 'none';
}
window.showKitView = showKitView;

// ‚îÄ‚îÄ Chargement liste kits ‚îÄ‚îÄ
window.loadKitsAdmin = async function() {
  const grid = document.getElementById('kits-admin-grid');
  if (!grid) return;
  grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--light)"><div class="spinner"></div></div>`;
  try {
    let snap;
    try { snap = await getDocs(query(collection(db,'kits'), orderBy('ordre','asc'))); }
    catch(_) { snap = await getDocs(collection(db,'kits')); }
    kitsCache = snap.docs.map(d => ({id:d.id, _src:'db', ...d.data()}));
  } catch(e) { kitsCache = []; }

  const dbIds   = new Set(kitsCache.map(k => k.id));
  const stdKits = DEFAULT_KITS_ADMIN
    .filter(k => !dbIds.has(k.id))
    .map(k => ({...k, _src:'std', actif:true, epuise:false}));
  const allKits = [...kitsCache, ...stdKits];
  allKits.sort((a,b) => (a.ordre??99)-(b.ordre??99) || (a.nom||'').localeCompare(b.nom||''));
  renderKitsAdmin(allKits);
};

// ‚îÄ‚îÄ Rendu grille kits ‚îÄ‚îÄ
function renderKitsAdmin(allKits) {
  const grid = document.getElementById('kits-admin-grid');
  if (!grid) return;
  if (!allKits || !allKits.length) {
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--light)">Aucun kit. Cr√©ez-en un via le bouton ci-dessus.</div>`;
    return;
  }
  grid.innerHTML = allKits.map(k => {
    const arts     = k.articles || [];
    const isStd    = k._src === 'std';
    const isHidden = k.actif   === false;
    const isEpuise = k.epuise  === true;
    const prixStr  = k.prix_total ? Number(k.prix_total).toLocaleString('fr-FR') + ' FCFA' : '‚Äî';
    const catColor = KIT_CAT_COLORS[k.categorie] || '#E8F5E9';

    const badgeSrc = isStd
      ? `<span class="badge-std" title="Kit standard">STD</span>`
      : `<span class="badge-perso">PERSO</span>`;

    const badges = [
      isEpuise ? `<span style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:999px;background:#FFEBEE;color:var(--red)">√âpuis√©</span>` : '',
      isHidden ? `<span style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:999px;background:#FFF3E0;color:#E65100">Masqu√©</span>` : '',
      (!isHidden && !isEpuise) ? `<span style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:999px;background:#E8F5E9;color:var(--green)">Actif</span>` : ''
    ].filter(Boolean).join('');

    let actions;
    if (isStd) {
      actions = `
        <button class="art-edit"  onclick="importAndEditKit('${k.id}')">‚úèÔ∏è Modifier</button>
        <button class="art-edit"  onclick="openKitArticlesView('${k.id}')" style="background:#E8F5E9;color:var(--green)">üìã Articles</button>
        <button class="stock-btn btn-epuise" onclick="markStdKitEpuise('${k.id}')">‚ùå √âpuiser</button>
        <button class="art-del"  onclick="maskDefaultKit('${k.id}')">üôà Masquer</button>`;
    } else {
      actions = `
        <button class="art-edit"  onclick="editKit('${k.id}')">‚úèÔ∏è Modifier</button>
        <button class="art-edit"  onclick="openKitArticlesView('${k.id}')" style="background:#E8F5E9;color:var(--green)">üìã Articles</button>
        ${isEpuise
          ? `<button class="stock-btn btn-en-stock" onclick="setKitEpuise('${k.id}',false)">‚úÖ Remettre</button>`
          : `<button class="stock-btn btn-epuise"   onclick="setKitEpuise('${k.id}',true)">‚ùå √âpuiser</button>`}
        ${isHidden
          ? `<button class="stock-btn btn-afficher" onclick="setKitActif('${k.id}',true)">üëÅ Afficher</button>`
          : `<button class="stock-btn btn-masquer"  onclick="setKitActif('${k.id}',false)">üôà Masquer</button>`}
        <button class="art-del" onclick="deleteKit('${k.id}')">üóë</button>`;
    }

    return `
    <div style="background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.07);${(isHidden||isEpuise)?'opacity:.65':''}">
      <div style="padding:14px 16px;background:${catColor};display:flex;align-items:flex-start;gap:12px">
        <div style="font-size:30px;line-height:1;flex-shrink:0">${k.emoji||'üéÅ'}</div>
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:5px;margin-bottom:4px;flex-wrap:wrap">
            <span style="font-size:13px;font-weight:700;color:var(--dark)">${k.nom||'Kit'}</span>
            ${badgeSrc} ${badges}
          </div>
          <div style="font-size:11px;color:var(--mid)">${k.categorie||''} ¬∑ ${arts.length} article${arts.length>1?'s':''} ¬∑ <strong style="color:var(--blue)">${prixStr}</strong></div>
        </div>
      </div>
      <div style="padding:10px 16px">
        <div style="font-size:11px;color:var(--light);margin-bottom:6px;line-height:1.5">${k.description||'‚Äî'}</div>
        ${arts.length ? `<div style="display:flex;flex-wrap:wrap;gap:5px">
          ${arts.slice(0,4).map(a=>`<span style="font-size:10px;background:var(--bg);border-radius:9px;padding:3px 9px;color:var(--mid)">${a.emoji||'üì¶'} ${a.name} √ó${a.qty}${a.unit?' '+a.unit:''}</span>`).join('')}
          ${arts.length>4 ? `<span style="font-size:10px;background:var(--bg);border-radius:9px;padding:3px 9px;color:var(--mid)">+${arts.length-4} autres</span>` : ''}
        </div>` : '<div style="font-size:11px;color:var(--light);font-style:italic">Aucun article ‚Äî cliquez Articles pour en ajouter</div>'}
        ${isStd ? `<div style="margin-top:8px;padding:7px 10px;background:linear-gradient(135deg,#E3F2FD,#EDE7F6);border-radius:9px;font-size:10px;color:#1A237E">
          üìå <strong>Kit standard</strong> ‚Äî Cliquez <em>Modifier</em> pour personnaliser dans Firestore.
        </div>` : ''}
      </div>
      <div style="padding:10px 14px;display:flex;justify-content:flex-end;gap:6px;border-top:1px solid var(--border);flex-wrap:wrap">
        ${actions}
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Importer standard ‚Üí Firestore puis ouvrir l'√©dition ‚îÄ‚îÄ
window.importAndEditKit = async function(stdId) {
  const k = DEFAULT_KITS_ADMIN.find(x => x.id === stdId);
  if (!k) return;
  const evtBtn = event?.target;
  if (evtBtn) { evtBtn.disabled=true; evtBtn.textContent='‚è≥‚Ä¶'; }
  try {
    await setDoc(doc(db,'kits', stdId), _stdKitData(k));
    const entry = { id:stdId, _src:'db', ..._stdKitData(k), createdAt:null, updatedAt:null };
    const existing = kitsCache.find(x => x.id===stdId);
    if (existing) Object.assign(existing, entry); else kitsCache.push(entry);
    toast('‚úÖ Kit import√© ‚Äî ouvre la modification‚Ä¶', '#2E7D32');
    editKit(stdId);
  } catch(e) {
    toast('‚ùå Erreur import : ' + e.message, '#C62828');
    if (evtBtn) { evtBtn.disabled=false; evtBtn.textContent='‚úèÔ∏è Modifier'; }
  }
};

// ‚îÄ‚îÄ Masquer un standard (sans modification compl√®te) ‚îÄ‚îÄ
window.maskDefaultKit = async function(stdId) {
  const k = DEFAULT_KITS_ADMIN.find(x => x.id===stdId);
  if (!k) return;
  if (!confirm(`Masquer le kit "${k.nom}" aux clients ?`)) return;
  try {
    await setDoc(doc(db,'kits', stdId), _stdKitData(k, {actif:false}));
    toast('üôà Kit masqu√©', '#F5820A');
    loadKitsAdmin();
  } catch(e) { toast('‚ùå Erreur : ' + e.message, '#C62828'); }
};

// ‚îÄ‚îÄ √âpuiser un standard ‚îÄ‚îÄ
window.markStdKitEpuise = async function(stdId) {
  const k = DEFAULT_KITS_ADMIN.find(x => x.id===stdId);
  if (!k) return;
  if (!confirm(`Marquer le kit "${k.nom}" comme √©puis√© ?`)) return;
  try {
    await setDoc(doc(db,'kits', stdId), _stdKitData(k, {epuise:true}));
    toast('‚ùå Kit √©puis√©', '#C62828');
    loadKitsAdmin();
  } catch(e) { toast('‚ùå Erreur : ' + e.message, '#C62828'); }
};

window.setKitActif = async function(id, actif) {
  try {
    await updateDoc(doc(db,'kits',id), {actif, updatedAt:serverTimestamp()});
    toast(actif ? 'üëÅ Kit affich√©' : 'üôà Kit masqu√©', actif ? '#2E7D32' : '#F5820A');
    loadKitsAdmin();
  } catch(e) { toast('‚ùå Erreur', '#C62828'); }
};

window.setKitEpuise = async function(id, epuise) {
  try {
    await updateDoc(doc(db,'kits',id), {epuise, updatedAt:serverTimestamp()});
    toast(epuise ? '‚ùå Kit √©puis√©' : '‚úÖ Kit remis en stock', epuise ? '#C62828' : '#2E7D32');
    loadKitsAdmin();
  } catch(e) { toast('‚ùå Erreur', '#C62828'); }
};

// ‚îÄ‚îÄ Ouvrir modale cr√©ation ‚îÄ‚îÄ
window.openKitModal = function() {
  editingKitId = null;
  document.getElementById('kit-modal-title').textContent   = 'Cr√©er un Kit/PACK';
  document.getElementById('kit-std-info').style.display    = 'none';
  ['kit-id','kit-nom','kit-description','kit-img'].forEach(x => document.getElementById(x).value='');
  document.getElementById('kit-emoji').value     = 'üéÅ';
  document.getElementById('kit-prix').value      = '';
  document.getElementById('kit-ordre').value     = '1';
  document.getElementById('kit-actif').value     = '1';
  document.getElementById('kit-categorie').value = 'Alimentation';
  document.getElementById('kit-modal').classList.add('show');
};

// ‚îÄ‚îÄ Ouvrir modale √©dition ‚îÄ‚îÄ
window.editKit = function(id) {
  let k = kitsCache.find(x => x.id===id);
  const fromStd = !k;
  if (!k) k = DEFAULT_KITS_ADMIN.find(x => x.id===id);
  if (!k) { toast('‚ùå Kit introuvable','#C62828'); return; }
  editingKitId = id;
  document.getElementById('kit-modal-title').textContent   = 'Modifier le Kit/PACK';
  document.getElementById('kit-std-info').style.display    = fromStd ? 'block' : 'none';
  document.getElementById('kit-id').value          = id;
  document.getElementById('kit-nom').value         = k.nom           || '';
  document.getElementById('kit-emoji').value       = k.emoji         || 'üéÅ';
  document.getElementById('kit-description').value = k.description   || '';
  document.getElementById('kit-img').value         = k.imageUrl      || '';
  document.getElementById('kit-prix').value        = k.prix_total    || '';
  document.getElementById('kit-ordre').value       = k.ordre         || 1;
  document.getElementById('kit-actif').value       = k.actif===false ? '0' : '1';
  document.getElementById('kit-categorie').value   = k.categorie     || 'Alimentation';
  document.getElementById('kit-modal').classList.add('show');
};

// ‚îÄ‚îÄ Sauvegarder kit (infos g√©n√©rales) ‚îÄ‚îÄ
window.saveKit = async function() {
  const nom  = document.getElementById('kit-nom').value.trim();
  const prix = parseFloat(document.getElementById('kit-prix').value) || 0;
  if (!nom)  { toast('‚ö†Ô∏è Le nom est obligatoire','#F5820A'); return; }
  if (!prix) { toast('‚ö†Ô∏è Le prix total est obligatoire','#F5820A'); return; }

  const data = {
    nom,
    emoji:       document.getElementById('kit-emoji').value       || 'üéÅ',
    description: document.getElementById('kit-description').value.trim(),
    imageUrl:    document.getElementById('kit-img').value.trim(),
    categorie:   document.getElementById('kit-categorie').value,
    prix_total:  prix,
    ordre:       parseInt(document.getElementById('kit-ordre').value) || 1,
    actif:       document.getElementById('kit-actif').value === '1',
    updatedAt:   serverTimestamp()
  };

  const btn = document.getElementById('kit-save-btn');
  if (btn) { btn.disabled=true; btn.textContent='‚è≥ Enregistrement‚Ä¶'; }
  try {
    if (editingKitId) {
      await setDoc(doc(db,'kits', editingKitId), data, {merge:true});
      toast('‚úÖ Kit modifi√© !','#2E7D32');
    } else {
      data.createdAt   = serverTimestamp();
      data.epuise      = false;
      data.articles    = [];
      await addDoc(collection(db,'kits'), data);
      toast('‚úÖ Kit cr√©√© ! Ajoutez maintenant les articles via üìã Articles','#2E7D32');
    }
    document.getElementById('kit-modal').classList.remove('show');
    loadKitsAdmin();
  } catch(e) {
    toast('‚ùå Erreur : ' + e.message,'#C62828');
  } finally {
    if (btn) { btn.disabled=false; btn.textContent='üíæ Enregistrer le Kit'; }
  }
};

// ‚îÄ‚îÄ Supprimer un kit ‚îÄ‚îÄ
window.deleteKit = async function(id) {
  const k   = kitsCache.find(x => x.id===id);
  const nom = k ? k.nom : id;
  const isStdId = DEFAULT_KITS_ADMIN.some(x => x.id===id);
  const msg = isStdId
    ? `Supprimer les personnalisations du kit "${nom}" ?\n\nIl reviendra √† sa version standard.`
    : `Supprimer d√©finitivement le kit "${nom}" ?`;
  if (!confirm(msg)) return;
  try {
    await deleteDoc(doc(db,'kits', id));
    kitsCache = kitsCache.filter(x => x.id!==id);
    toast('üóë Kit supprim√©','#C62828');
    loadKitsAdmin();
  } catch(e) { toast('‚ùå Erreur : ' + e.message,'#C62828'); }
};

// ‚ïê‚ïê‚ïê‚ïê GESTION ARTICLES D'UN KIT ‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Ouvrir la vue articles d'un kit ‚îÄ‚îÄ
window.openKitArticlesView = async function(kitId) {
  // Trouver le kit (DB ou standard)
  let k = kitsCache.find(x => x.id===kitId);
  if (!k) {
    // Standard non import√© : l'importer d'abord silencieusement
    const std = DEFAULT_KITS_ADMIN.find(x => x.id===kitId);
    if (!std) return;
    await setDoc(doc(db,'kits', kitId), _stdKitData(std));
    const entry = {id:kitId, _src:'db', ..._stdKitData(std), createdAt:null, updatedAt:null};
    kitsCache.push(entry);
    k = entry;
    toast('‚úÖ Kit import√© automatiquement','#2E7D32');
    loadKitsAdmin();
  }
  currentKit  = k;
  kitArtCache = JSON.parse(JSON.stringify(k.articles || []));

  document.getElementById('kit-detail-emoji').textContent     = k.emoji || 'üéÅ';
  document.getElementById('kit-detail-name').textContent      = k.nom   || 'Kit';
  document.getElementById('kit-articles-panel-title').textContent = `Articles ‚Äî ${k.nom}`;

  showKitView('articles');
  renderKitArticleTable();
};

function renderKitArticleTable() {
  const table = document.getElementById('kit-articles-table');
  const head  = `<div class="art-table-row art-table-head"><div></div><div>Article</div><div>Qt√© / Unit√©</div><div>Prix unitaire</div><div>Actions</div></div>`;
  if (!kitArtCache.length) {
    table.innerHTML = head + `<div style="text-align:center;padding:28px;color:var(--light);font-size:13px">Aucun article dans ce kit. Ajoutez-en via le bouton ci-dessus.</div>`;
    return;
  }
  table.innerHTML = head + kitArtCache.map((a, i) => `
    <div class="art-table-row">
      <div class="art-emoji">${a.emoji||'üì¶'}</div>
      <div><div style="font-weight:700;font-size:12px">${a.name||'‚Äî'}</div></div>
      <div style="font-size:12px;color:var(--mid)">${a.qty||1} ${a.unit||''}</div>
      <div style="font-weight:700;font-size:12px;color:var(--blue)">${a.prix ? Number(a.prix).toLocaleString('fr-FR')+' FCFA' : '‚Äî'}</div>
      <div style="display:flex;gap:5px">
        <button class="art-edit" onclick="editKitArticle(${i})">‚úèÔ∏è</button>
        <button class="art-del"  onclick="deleteKitArticle(${i})">üóë</button>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ Sauvegarder le tableau d'articles dans Firestore ‚îÄ‚îÄ
async function persistKitArticles() {
  if (!currentKit) return;
  await updateDoc(doc(db,'kits', currentKit.id), {
    articles:  kitArtCache,
    updatedAt: serverTimestamp()
  });
  // Mettre √† jour le cache local
  const cached = kitsCache.find(x => x.id===currentKit.id);
  if (cached) cached.articles = JSON.parse(JSON.stringify(kitArtCache));
}

// ‚îÄ‚îÄ Ouvrir modale ajout d'article ‚îÄ‚îÄ
window.openKitArticleModal = function() {
  editingKitArtIdx = null;
  document.getElementById('kit-art-modal-title').textContent = 'Ajouter un article au Kit';
  ['kit-art-id','kit-art-emoji','kit-art-name','kit-art-unit'].forEach(x => document.getElementById(x).value='');
  document.getElementById('kit-art-emoji').value = 'üì¶';
  document.getElementById('kit-art-qty').value   = '1';
  document.getElementById('kit-art-prix').value  = '';
  document.getElementById('kit-art-modal').classList.add('show');
};

// ‚îÄ‚îÄ Ouvrir modale √©dition d'article ‚îÄ‚îÄ
window.editKitArticle = function(i) {
  const a = kitArtCache[i];
  if (!a) return;
  editingKitArtIdx = i;
  document.getElementById('kit-art-modal-title').textContent = 'Modifier l\'article';
  document.getElementById('kit-art-emoji').value = a.emoji || '';
  document.getElementById('kit-art-name').value  = a.name  || '';
  document.getElementById('kit-art-qty').value   = a.qty   || 1;
  document.getElementById('kit-art-unit').value  = a.unit  || '';
  document.getElementById('kit-art-prix').value  = a.prix  || '';
  document.getElementById('kit-art-modal').classList.add('show');
};

// ‚îÄ‚îÄ Sauvegarder article du kit ‚îÄ‚îÄ
window.saveKitArticle = async function() {
  const name = document.getElementById('kit-art-name').value.trim();
  if (!name) { toast('‚ö†Ô∏è Le nom est obligatoire','#F5820A'); return; }
  const art = {
    emoji: document.getElementById('kit-art-emoji').value.trim() || 'üì¶',
    name,
    qty:  parseInt(document.getElementById('kit-art-qty').value)   || 1,
    unit: document.getElementById('kit-art-unit').value.trim(),
    prix: parseFloat(document.getElementById('kit-art-prix').value) || 0,
  };
  const btn = document.getElementById('kit-art-save-btn');
  if (btn) { btn.disabled=true; btn.textContent='‚è≥‚Ä¶'; }
  try {
    if (editingKitArtIdx !== null) {
      kitArtCache[editingKitArtIdx] = art;
      toast('‚úÖ Article modifi√©','#2E7D32');
    } else {
      kitArtCache.push(art);
      toast('‚úÖ Article ajout√©','#2E7D32');
    }
    await persistKitArticles();
    document.getElementById('kit-art-modal').classList.remove('show');
    renderKitArticleTable();
  } catch(e) {
    toast('‚ùå Erreur : ' + e.message,'#C62828');
  } finally {
    if (btn) { btn.disabled=false; btn.textContent='üíæ Enregistrer l\'article'; }
  }
};

// ‚îÄ‚îÄ Supprimer article du kit ‚îÄ‚îÄ
window.deleteKitArticle = async function(i) {
  if (!confirm('Supprimer cet article du kit ?')) return;
  kitArtCache.splice(i, 1);
  try {
    await persistKitArticles();
    renderKitArticleTable();
    toast('üóë Article supprim√©','#C62828');
  } catch(e) { toast('‚ùå Erreur : ' + e.message,'#C62828'); }
};

// ‚ïê‚ïê‚ïê‚ïê SECTIONS ‚ïê‚ïê‚ïê‚ïê
window.showSection=function(id,btn){
  ['orders','stats','articles','restaurants','kits','partenaires','settings','password'].forEach(s=>{
    const el=document.getElementById("section-"+s); if(el)el.style.display=s===id?'block':'none';
  });
  document.querySelectorAll(".sb-item").forEach(b=>b.classList.remove("on"));
  if(btn)btn.classList.add("on");
  if(id==='stats'){updateStats();}
  if(id==='restaurants'){loadRestaurants();showRstView('list');}
  if(id==='kits'){loadKitsAdmin();showKitView('list');}
  if(window.innerWidth<769)document.getElementById("sidebar").classList.remove("open");
};

window.toggleSidebar=function(){document.getElementById("sidebar").classList.toggle("open");};

// ‚ïê‚ïê‚ïê‚ïê PARAM√àTRES ‚ïê‚ïê‚ïê‚ïê
function loadSettings(){['phone','email','web'].forEach(k=>{const v=localStorage.getItem("cfg_"+k);if(v)document.getElementById("cfg-"+k).value=v;});}
window.saveSettings=function(){['phone','email','web'].forEach(k=>localStorage.setItem("cfg_"+k,document.getElementById("cfg-"+k).value));toast("‚úÖ Enregistr√© !","#2E7D32");};

// ‚ïê‚ïê‚ïê‚ïê MOT DE PASSE ‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê PWA Service Worker ‚ïê‚ïê‚ïê‚ïê
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('admin-sw.js')
      .then(reg=>console.log('[Admin PWA] SW enregistr√©:',reg.scope))
      .catch(err=>console.warn('[Admin PWA] SW erreur:',err));
  });
}

window.changePassword=async function(){
  const cur=document.getElementById("pw-current").value;
  const nw=document.getElementById("pw-new").value;
  const conf=document.getElementById("pw-confirm").value;
  const msg=document.getElementById("pw-msg");
  if(nw.length<8){msg.style.color="var(--red)";msg.textContent="‚ùå Min. 8 caract√®res.";return;}
  if(nw!==conf){msg.style.color="var(--red)";msg.textContent="‚ùå Les mots de passe ne correspondent pas.";return;}
  try{
    const user=auth.currentUser;
    const cred=EmailAuthProvider.credential(user.email,cur);
    await reauthenticateWithCredential(user,cred);
    await updatePassword(user,nw);
    msg.style.color="var(--green)";msg.textContent="‚úÖ Mot de passe modifi√© !";
    ['pw-current','pw-new','pw-confirm'].forEach(x=>document.getElementById(x).value='');
    toast("‚úÖ Mot de passe mis √† jour !","#2E7D32");
  }catch(e){
    msg.style.color="var(--red)";
    msg.textContent=(e.code==="auth/wrong-password"||e.code==="auth/invalid-credential")?"‚ùå Mot de passe actuel incorrect.":"‚ùå "+e.message;
  }
};
</script>
</body>
</html>
