<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OmniService TG â€” Administration</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--blue:#1E6FBE;--blue-d:#155A9C;--blue-s:rgba(30,111,190,.1);--ora:#F5820A;--ora-d:#D96E00;--dark:#1A1A2E;--mid:#4A4A6A;--light:#9999BB;--border:#E8EAF0;--bg:#F4F6FA;--green:#2E7D32;--red:#C62828;--purple:#7B1FA2}
html,body{height:100%;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--dark)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPLASH SCREEN ADMIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#splash-screen{
  position:fixed;inset:0;z-index:9999;
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
  background:#0a1220;
}
/* Fond animÃ© â€” version sombre pour l'admin */
#splash-screen::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,#0a1220 0%,#1a2a50 40%,#0a1220 100%);
  animation:adminBgPulse 3s ease-in-out infinite alternate;
}
@keyframes adminBgPulse{
  from{background:linear-gradient(135deg,#0a1220 0%,#122040 40%,#0a1220 100%)}
  to{background:linear-gradient(135deg,#0a1220 0%,#1a2a50 50%,#0d1830 100%)}
}
/* Grille dÃ©corative faÃ§on dashboard */
#splash-screen::after{
  content:'';position:absolute;inset:0;
  background-image:
    linear-gradient(rgba(30,111,190,.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(30,111,190,.04) 1px, transparent 1px);
  background-size:40px 40px;
  animation:gridFade 0.8s ease 0.2s both;
}
@keyframes gridFade{from{opacity:0}to{opacity:1}}

/* Orbes lumineux */
.splash-orb{
  position:absolute;border-radius:50%;pointer-events:none;
  animation:orbFloat 4s ease-in-out infinite alternate;
}
.splash-orb-1{
  width:400px;height:400px;
  background:radial-gradient(circle,rgba(30,111,190,.18) 0%,transparent 70%);
  top:-100px;right:-100px;
}
.splash-orb-2{
  width:300px;height:300px;
  background:radial-gradient(circle,rgba(245,130,10,.12) 0%,transparent 70%);
  bottom:-80px;left:-80px;
  animation-delay:.8s;animation-direction:alternate-reverse;
}
@keyframes orbFloat{
  from{transform:scale(1) translate(0,0)}
  to{transform:scale(1.15) translate(10px,-10px)}
}

.splash-content{
  position:relative;z-index:2;
  display:flex;flex-direction:column;align-items:center;
  text-align:center;padding:32px;
}

/* Badge ADMIN au-dessus du logo */
.splash-admin-badge{
  background:linear-gradient(135deg,rgba(245,130,10,.2),rgba(245,130,10,.1));
  border:1px solid rgba(245,130,10,.35);
  border-radius:999px;padding:5px 16px;
  font-size:10px;font-weight:800;letter-spacing:1.5px;
  color:var(--ora);text-transform:uppercase;
  margin-bottom:20px;
  animation:splashTextIn 0.5s ease 0.3s both;
}

/* Logo */
.splash-logo-wrap{
  position:relative;margin-bottom:24px;
  animation:splashLogoIn 0.8s cubic-bezier(.34,1.56,.64,1) 0.4s both;
}
@keyframes splashLogoIn{
  from{transform:scale(0) rotate(-15deg);opacity:0}
  to{transform:scale(1) rotate(0);opacity:1}
}
/* Anneaux tournants */
.splash-ring-outer{
  position:absolute;inset:-18px;border-radius:50%;
  border:1.5px solid rgba(30,111,190,.2);
  animation:ringRotate 8s linear infinite;
}
.splash-ring-outer::before{
  content:'';position:absolute;top:-3px;left:50%;
  width:6px;height:6px;border-radius:50%;
  background:var(--blue);transform:translateX(-50%);
  box-shadow:0 0 8px var(--blue);
}
.splash-ring-inner{
  position:absolute;inset:-8px;border-radius:50%;
  border:1px solid rgba(245,130,10,.15);
  animation:ringRotate 5s linear infinite reverse;
}
.splash-ring-inner::before{
  content:'';position:absolute;bottom:-2px;left:50%;
  width:4px;height:4px;border-radius:50%;
  background:var(--ora);transform:translateX(-50%);
  box-shadow:0 0 6px var(--ora);
}
@keyframes ringRotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}

.splash-logo-box{
  width:110px;height:110px;border-radius:28px;
  background:linear-gradient(135deg,rgba(30,111,190,.15),rgba(21,90,156,.1));
  border:1.5px solid rgba(30,111,190,.25);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 0 1px rgba(255,255,255,.04),0 24px 60px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.07);
  backdrop-filter:blur(10px);overflow:hidden;
}
.splash-logo-box img{
  width:80px;height:80px;object-fit:contain;
  filter:drop-shadow(0 4px 16px rgba(30,111,190,.4));
}
.splash-fallback{font-size:50px;line-height:1}

.splash-brand{
  font-family:'Nunito',sans-serif;font-size:30px;font-weight:900;
  color:#fff;letter-spacing:-0.5px;margin-bottom:4px;
  animation:splashTextIn 0.6s ease 0.8s both;
}
.splash-blue{color:rgba(255,255,255,.9)}
.splash-ora{color:var(--ora)}
.splash-tagline{
  font-size:11px;color:rgba(255,255,255,.35);font-weight:500;
  letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;
  animation:splashTextIn 0.6s ease 1s both;
}
.splash-sep{
  width:40px;height:1px;background:linear-gradient(90deg,transparent,rgba(30,111,190,.5),transparent);
  margin:16px auto;
  animation:splashTextIn 0.5s ease 1.1s both;
}

/* Stats mini dÃ©co */
.splash-stats{
  display:flex;gap:24px;margin-bottom:32px;
  animation:splashTextIn 0.6s ease 1.2s both;
}
.splash-stat{text-align:center}
.splash-stat-num{font-family:'Nunito',sans-serif;font-size:18px;font-weight:900;color:#fff}
.splash-stat-lbl{font-size:9px;color:rgba(255,255,255,.25);font-weight:600;letter-spacing:.5px;text-transform:uppercase;margin-top:1px}

/* Barre de chargement */
.splash-loader{
  width:200px;height:2px;background:rgba(255,255,255,.07);
  border-radius:2px;overflow:hidden;
  animation:splashTextIn 0.5s ease 1.3s both;
}
.splash-loader-bar{
  height:100%;width:0;border-radius:2px;
  background:linear-gradient(90deg,var(--blue),rgba(255,255,255,.6),var(--ora));
  animation:splashLoad 1.6s cubic-bezier(.4,0,.2,1) 1.4s both;
}
@keyframes splashLoad{
  0%{width:0}55%{width:75%}100%{width:100%}
}
.splash-load-txt{
  margin-top:10px;font-size:10px;color:rgba(255,255,255,.2);
  letter-spacing:.5px;
  animation:splashTextIn 0.5s ease 1.4s both;
}

@keyframes splashTextIn{
  from{transform:translateY(12px);opacity:0}
  to{transform:translateY(0);opacity:1}
}

/* Masquage avec animation */
#splash-screen.hidden{
  animation:splashFadeOut 0.5s cubic-bezier(.4,0,.2,1) forwards;
  pointer-events:none;
}
@keyframes splashFadeOut{
  0%{opacity:1;transform:scale(1)}
  100%{opacity:0;transform:scale(1.03)}
}

/* â”€â”€ LOGIN â”€â”€ */
#login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0e1420,#1a2540);display:flex;align-items:center;justify-content:center;z-index:1000;padding:16px}
.login-box{background:#fff;border-radius:22px;padding:36px 32px;width:100%;max-width:380px;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.4)}
.login-logo{width:70px;height:70px;background:linear-gradient(135deg,var(--blue),var(--blue-d));border-radius:18px;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.login-logo img{width:58px;height:58px;object-fit:contain}
.login-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:var(--dark);margin-bottom:4px}
.login-label{display:block;font-size:11px;font-weight:700;color:var(--mid);text-align:left;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.login-inp{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:11px;font-size:13px;font-family:'Poppins',sans-serif;margin-bottom:13px;outline:none;background:var(--bg);transition:border-color .2s}
.login-inp:focus{border-color:var(--blue);background:#fff}
.login-btn{width:100%;background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border:none;border-radius:999px;padding:14px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;box-shadow:0 4px 16px rgba(30,111,190,.35);transition:all .2s}
.login-err{color:var(--red);font-size:12px;font-weight:600;margin-top:10px;min-height:18px}
#l-diag{margin-top:12px;text-align:left;display:none}
.diag-box{border-radius:11px;padding:13px 14px;font-size:11px;line-height:1.8;color:#fff}
.diag-ora{background:linear-gradient(135deg,#E65100,#F5820A)}
.diag-blue{background:linear-gradient(135deg,#155A9C,#1E6FBE)}
.diag-dark{background:linear-gradient(135deg,#1A1A2E,#2d2d4e)}
.diag-box a{color:rgba(255,255,255,.9);font-weight:700}
.login-hint{margin-top:14px;font-size:11px;color:var(--light);line-height:1.7;background:var(--bg);border-radius:9px;padding:10px 12px;text-align:left}
.login-hint b{color:var(--dark)}
/* â”€â”€ LAYOUT â”€â”€ */
.layout{display:flex;height:100vh;overflow:hidden}
.sidebar{width:240px;background:#1A1A2E;flex-shrink:0;display:flex;flex-direction:column;transition:transform .3s;z-index:100}
.sb-brand{padding:22px 20px 18px;border-bottom:1px solid rgba(255,255,255,.07)}
.sb-logo{font-family:'Nunito',sans-serif;font-size:17px;font-weight:900}
.sb-logo .b{color:var(--blue)}.sb-logo .o{color:var(--ora)}
.sb-sub{font-size:10px;color:rgba(255,255,255,.3);margin-top:2px}
.sb-nav{padding:16px 12px;flex:1;overflow-y:auto}
.sb-sec{font-size:9px;font-weight:800;color:rgba(255,255,255,.2);text-transform:uppercase;letter-spacing:1px;padding:0 10px;margin:14px 0 6px}
.sb-item{display:flex;align-items:center;gap:10px;padding:11px 12px;border-radius:10px;cursor:pointer;margin-bottom:3px;transition:background .15s;font-size:13px;font-weight:600;color:rgba(255,255,255,.5);border:none;background:transparent;width:100%;text-align:left;font-family:'Poppins',sans-serif}
.sb-item:hover{background:rgba(255,255,255,.06);color:rgba(255,255,255,.85)}
.sb-item.on{background:rgba(30,111,190,.25);color:#fff}
.sb-ico{font-size:16px;width:22px;text-align:center;flex-shrink:0}
.sb-badge{margin-left:auto;background:var(--ora);color:#fff;font-size:9px;font-weight:700;padding:2px 7px;border-radius:999px}
.sb-footer{padding:14px;border-top:1px solid rgba(255,255,255,.07)}
.sb-email{font-size:11px;color:rgba(255,255,255,.3);margin-bottom:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.logout-btn{width:100%;background:rgba(198,40,40,.2);color:#ff8a80;border:none;border-radius:9px;padding:10px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Poppins',sans-serif;transition:background .2s}
.logout-btn:hover{background:rgba(198,40,40,.35)}
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:300;background:var(--blue);color:#fff;border:none;border-radius:10px;width:40px;height:40px;font-size:18px;cursor:pointer;align-items:center;justify-content:center}
/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;overflow-y:auto;background:var(--bg)}
.main-inner{max-width:1100px;margin:0 auto;padding:28px 24px 48px}
.pg-title{font-family:'Nunito',sans-serif;font-size:24px;font-weight:900;color:var(--dark);margin-bottom:4px}
.pg-sub{font-size:12px;color:var(--light);margin-bottom:24px}
/* â”€â”€ STATS â”€â”€ */
.stats-row{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:24px}
.stat-card{background:#fff;border-radius:14px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.07)}
.stat-ico{font-size:22px;margin-bottom:6px}
.stat-val{font-family:'Nunito',sans-serif;font-size:30px;font-weight:900;color:var(--dark)}
.stat-lbl{font-size:11px;color:var(--light);font-weight:600}
.stats-tabs{display:flex;gap:6px;margin-bottom:18px;background:#fff;border-radius:12px;padding:5px;box-shadow:0 2px 10px rgba(0,0,0,.07);width:fit-content}
.stat-tab{padding:8px 18px;border-radius:9px;border:none;background:transparent;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;color:var(--mid);transition:all .2s}
.stat-tab.on{background:var(--blue);color:#fff}
/* â”€â”€ FILTRES â”€â”€ */
.filters-bar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.fbtn{background:#fff;border:1.5px solid var(--border);border-radius:999px;padding:7px 14px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;color:var(--mid);transition:all .15s;white-space:nowrap}
.fbtn.on,.fbtn:hover{background:var(--blue);color:#fff;border-color:var(--blue)}
.fsearch input{padding:9px 14px;border:1.5px solid var(--border);border-radius:999px;font-size:12px;outline:none;font-family:'Poppins',sans-serif;background:#fff;min-width:180px}
.fsearch input:focus{border-color:var(--blue)}
.refresh-btn{background:var(--blue);color:#fff;border:none;border-radius:999px;padding:9px 18px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;white-space:nowrap}
.refresh-btn:hover{background:var(--blue-d)}
/* â”€â”€ TABLE COMMANDES â”€â”€ */
.orders-wrap{background:#fff;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.07);overflow:hidden}
.orders-head{display:grid;grid-template-columns:100px 1fr 130px 110px 120px 170px;gap:10px;padding:11px 16px;background:var(--bg);font-size:10px;font-weight:700;color:var(--light);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.order-row{display:grid;grid-template-columns:100px 1fr 130px 110px 120px 170px;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border);align-items:center;transition:background .1s}
.order-row:last-child{border-bottom:none}
.order-row:hover{background:#FAFBFC}
.or-ref{font-size:11px;font-weight:700;color:var(--blue);cursor:pointer;text-decoration:underline;text-underline-offset:2px}
.or-name{font-size:12px;font-weight:600;color:var(--dark)}
.or-sub{font-size:10px;color:var(--light);margin-top:2px}
.pill{font-size:10px;font-weight:700;padding:4px 10px;border-radius:999px;display:inline-block}
.or-actions{display:flex;gap:6px;align-items:center}
.act-select{padding:6px 8px;border:1.5px solid var(--border);border-radius:8px;font-size:11px;font-family:'Poppins',sans-serif;cursor:pointer;outline:none;background:#fff;max-width:110px}
.act-save{background:var(--blue);color:#fff;border:none;border-radius:8px;padding:7px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;white-space:nowrap}
.act-save:hover{background:var(--blue-d)}
.act-del{background:#FFEBEE;color:var(--red);border:none;border-radius:8px;padding:7px 9px;font-size:13px;cursor:pointer}
.act-del:hover{background:#FFCDD2}
/* Mobile cards */
.order-card-m{background:#fff;border-radius:14px;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,.07);margin-bottom:10px;display:none}
.ocm-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.ocm-actions{display:flex;gap:6px;margin-top:12px;align-items:center}
.ocm-select{flex:1;padding:9px 10px;border:1.5px solid var(--border);border-radius:9px;font-size:12px;font-family:'Poppins',sans-serif;cursor:pointer;outline:none;background:var(--bg)}
/* â”€â”€ ARTICLES PANEL â”€â”€ */
.articles-panel{background:#fff;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.07);overflow:hidden;margin-top:20px}
.panel-hdr{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border)}
.panel-title{font-size:15px;font-weight:700;color:var(--dark)}
.add-btn{background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border:none;border-radius:999px;padding:9px 18px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;display:flex;align-items:center;gap:6px}
.add-btn:hover{opacity:.9}
.art-table-row{display:grid;grid-template-columns:50px 1fr 100px 120px 80px;gap:10px;padding:12px 20px;border-bottom:1px solid var(--border);align-items:center;font-size:12px}
.art-table-head{background:var(--bg);font-size:10px;font-weight:700;color:var(--light);text-transform:uppercase;letter-spacing:.5px}
.art-table-row:last-child{border-bottom:none}
.art-emoji{font-size:26px;text-align:center}
.art-edit{background:var(--blue-s);color:var(--blue);border:none;border-radius:7px;padding:5px 9px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif}
.art-del{background:#FFEBEE;color:var(--red);border:none;border-radius:7px;padding:5px 8px;font-size:12px;cursor:pointer;margin-left:4px}
.svc-tabs{display:flex;gap:6px;padding:14px 20px 0;flex-wrap:wrap}
.svc-tab{padding:8px 16px;border-radius:999px;border:1.5px solid var(--border);font-size:12px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif;color:var(--mid);transition:all .2s;background:var(--bg)}
.svc-tab.on{background:var(--blue);color:#fff;border-color:var(--blue)}
/* â”€â”€ PARTENAIRES â”€â”€ */
.partner-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-top:16px}
.partner-card{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.07)}
.partner-img{height:140px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:40px;overflow:hidden}
.partner-img img{width:100%;height:100%;object-fit:cover}
.partner-body{padding:12px 14px}
.partner-name{font-size:13px;font-weight:700;color:var(--dark);margin-bottom:3px}
.partner-desc{font-size:11px;color:var(--light);margin-bottom:8px}
.partner-actions{display:flex;gap:7px}
/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:none;align-items:center;justify-content:center;padding:16px}
.modal-overlay.show{display:flex}
.modal{background:#fff;border-radius:18px;padding:28px;max-width:480px;width:100%;max-height:90vh;overflow-y:auto;position:relative}
.modal-close{position:absolute;top:14px;right:14px;background:var(--bg);border:none;border-radius:9px;width:34px;height:34px;font-size:16px;cursor:pointer;color:var(--mid)}
.modal-title{font-family:'Nunito',sans-serif;font-size:19px;font-weight:900;color:var(--dark);margin-bottom:18px}
.f-label{display:block;font-size:11px;font-weight:700;color:var(--mid);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.f-inp{width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:11px;font-family:'Poppins',sans-serif;font-size:13px;background:var(--bg);outline:none;margin-bottom:13px;transition:border-color .2s}
.f-inp:focus{border-color:var(--blue);background:#fff}
.f-sel{width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:11px;font-family:'Poppins',sans-serif;font-size:13px;background:var(--bg);outline:none;margin-bottom:13px;cursor:pointer}
.modal-save-btn{width:100%;background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border:none;border-radius:999px;padding:13px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif}
.modal-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--bg);font-size:12px}
.modal-key{color:var(--light);font-weight:600;min-width:110px}
.modal-val{color:var(--dark);font-weight:600;text-align:right;word-break:break-word;max-width:65%}
/* â”€â”€ SETTINGS â”€â”€ */
.settings-card{background:#fff;border-radius:16px;padding:24px;box-shadow:0 2px 10px rgba(0,0,0,.07);max-width:500px;margin-bottom:20px}
.settings-title{font-size:14px;font-weight:700;color:var(--dark);margin-bottom:18px;padding-bottom:12px;border-bottom:1px solid var(--border)}
/* â”€â”€ CHART BARS â”€â”€ */
.bar-row{margin-bottom:13px}
.bar-top{display:flex;justify-content:space-between;font-size:12px;font-weight:600;margin-bottom:5px}
.bar-bg{height:8px;background:var(--bg);border-radius:999px;overflow:hidden}
.bar-fill{height:100%;background:linear-gradient(135deg,var(--blue),var(--ora));border-radius:999px;transition:width .6s ease}
.monthly-chart{display:flex;align-items:flex-end;gap:6px;height:120px;padding:10px 0}
.monthly-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.monthly-bar{width:100%;background:linear-gradient(to top,var(--blue),rgba(30,111,190,.4));border-radius:4px 4px 0 0;min-height:4px;transition:height .5s ease}
.monthly-lbl{font-size:9px;color:var(--light);font-weight:600}
.monthly-val{font-size:9px;color:var(--dark);font-weight:700}
/* â”€â”€ MISC â”€â”€ */
.empty-msg{text-align:center;padding:54px;color:var(--light);font-size:13px}
.spinner{display:inline-block;width:24px;height:24px;border:3px solid rgba(30,111,190,.2);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:24px;right:24px;background:#1A1A2E;color:#fff;border-radius:12px;padding:13px 20px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;box-shadow:0 8px 28px rgba(0,0,0,.3)}
.toast.show{opacity:1}
@media(max-width:768px){
  .sidebar{position:fixed;top:0;bottom:0;left:0;z-index:200;transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .hamburger{display:flex}
  .main-inner{padding:60px 16px 40px}
  .orders-head,.order-row{display:none}
  .order-card-m{display:block}
  .stats-row{grid-template-columns:1fr 1fr}
  .partner-grid{grid-template-columns:1fr}
  .art-table-row{grid-template-columns:40px 1fr 90px 100px}
  .splash-stats{gap:16px}
}
@media(min-width:769px){.order-card-m{display:none!important}}
@media(min-width:1000px){.stats-row{grid-template-columns:repeat(4,1fr)}}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SPLASH SCREEN ADMIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="splash-screen">
  <div class="splash-orb splash-orb-1"></div>
  <div class="splash-orb splash-orb-2"></div>

  <div class="splash-content">
    <div class="splash-admin-badge">âš™ï¸ &nbsp;Administration</div>

    <div class="splash-logo-wrap">
      <div class="splash-ring-outer"></div>
      <div class="splash-ring-inner"></div>
      <div class="splash-logo-box">
        <img src="../assets/logo.png" alt="OmniService TG" id="splash-img"
             onerror="this.outerHTML='<div class=splash-fallback>ğŸ›¡ï¸</div>'"/>
      </div>
    </div>

    <div class="splash-brand">
      <span class="splash-blue">Omni</span><span class="splash-ora">Service</span> <span class="splash-blue">TG</span>
    </div>
    <div class="splash-tagline">Tableau de bord administrateur</div>

    <div class="splash-sep"></div>

    <div class="splash-stats">
      <div class="splash-stat">
        <div class="splash-stat-num">ğŸ“¦</div>
        <div class="splash-stat-lbl">Commandes</div>
      </div>
      <div class="splash-stat">
        <div class="splash-stat-num">ğŸ“Š</div>
        <div class="splash-stat-lbl">Statistiques</div>
      </div>
      <div class="splash-stat">
        <div class="splash-stat-num">ğŸ·ï¸</div>
        <div class="splash-stat-lbl">Catalogue</div>
      </div>
    </div>

    <div class="splash-loader">
      <div class="splash-loader-bar"></div>
    </div>
    <div class="splash-load-txt">Chargement du panneau d'administration...</div>
  </div>
</div>

<!-- â•â•â•â• LOGIN â•â•â•â• -->
<div id="login-screen" style="display:none">
  <div class="login-box">
    <div class="login-logo">
      <img src="../assets/logo.png" alt="OmniService TG" onerror="this.parentElement.innerHTML='ğŸ›¡ï¸'"/>
    </div>
    <div class="login-title">OmniService <span style="color:var(--ora)">TG</span></div>
    <div style="font-size:12px;color:var(--light);margin-bottom:22px">Interface d'administration</div>
    <label class="login-label">Email</label>
    <input type="email" class="login-inp" id="l-email" placeholder="admin@omniservicetg.com" autocomplete="username"/>
    <label class="login-label">Mot de passe</label>
    <input type="password" class="login-inp" id="l-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"/>
    <button class="login-btn" onclick="doLogin()" id="login-btn">Se connecter â†’</button>
    <div class="login-err" id="l-err"></div>
    <div id="l-diag"></div>
  </div>
</div>

<!-- â•â•â•â• INTERFACE ADMIN â•â•â•â• -->
<div class="layout" id="admin-ui" style="display:none">
  <button class="hamburger" onclick="toggleSidebar()">â˜°</button>

  <aside class="sidebar" id="sidebar">
    <div class="sb-brand">
      <div class="sb-logo"><span class="b">Omni</span><span class="o">Service</span> <span style="color:#fff">TG</span></div>
      <div class="sb-sub">Administration</div>
    </div>
    <nav class="sb-nav">
      <div class="sb-sec">Principal</div>
      <button class="sb-item on" onclick="showSection('orders',this)"><span class="sb-ico">ğŸ“¦</span>Commandes<span class="sb-badge" id="badge-pending">0</span></button>
      <button class="sb-item" onclick="showSection('stats',this)"><span class="sb-ico">ğŸ“Š</span>Statistiques</button>
      <div class="sb-sec">Catalogue</div>
      <button class="sb-item" onclick="showSection('articles',this)"><span class="sb-ico">ğŸ·ï¸</span>Articles &amp; Prix</button>
      <button class="sb-item" onclick="showSection('partenaires',this)"><span class="sb-ico">ğŸ¤</span>Publications Partenaires</button>
      <div class="sb-sec">RÃ©glages</div>
      <button class="sb-item" onclick="showSection('settings',this)"><span class="sb-ico">âš™ï¸</span>ParamÃ¨tres</button>
      <button class="sb-item" onclick="showSection('password',this)"><span class="sb-ico">ğŸ”‘</span>Mot de passe</button>
    </nav>
    <div class="sb-footer">
      <div class="sb-email" id="admin-email-disp">â€”</div>
      <button class="logout-btn" onclick="doLogout()">ğŸšª Se dÃ©connecter</button>
    </div>
  </aside>

  <main class="main">
    <div class="main-inner">

      <!-- â•â• COMMANDES â•â• -->
      <div id="section-orders">
        <div class="pg-title">Gestion des Commandes</div>
        <div class="pg-sub" id="last-refresh">Chargement...</div>
        <div class="stats-row">
          <div class="stat-card"><div class="stat-ico">â³</div><div class="stat-val" id="s-att">0</div><div class="stat-lbl">En attente</div></div>
          <div class="stat-card"><div class="stat-ico">ğŸŸ£</div><div class="stat-val" id="s-enc">0</div><div class="stat-lbl">En cours</div></div>
          <div class="stat-card"><div class="stat-ico">âœ…</div><div class="stat-val" id="s-ter">0</div><div class="stat-lbl">TerminÃ©es</div></div>
          <div class="stat-card"><div class="stat-ico">ğŸ“¦</div><div class="stat-val" id="s-tot">0</div><div class="stat-lbl">Total</div></div>
        </div>
        <div class="filters-bar">
          <button class="fbtn on" onclick="setFilter('all',this)">Toutes</button>
          <button class="fbtn" onclick="setFilter('En attente',this)">â³ Attente</button>
          <button class="fbtn" onclick="setFilter('ConfirmÃ©e',this)">ğŸ”µ ConfirmÃ©es</button>
          <button class="fbtn" onclick="setFilter('En cours',this)">ğŸŸ£ En cours</button>
          <button class="fbtn" onclick="setFilter('TerminÃ©e',this)">âœ… TerminÃ©es</button>
          <button class="fbtn" onclick="setFilter('AnnulÃ©e',this)">âŒ AnnulÃ©es</button>
          <div class="fsearch"><input type="text" placeholder="ğŸ” TÃ©lÃ©phone, service, rÃ©f..." oninput="doSearch(this.value)"/></div>
          <button class="refresh-btn" onclick="loadOrders()">ğŸ”„ Actualiser</button>
        </div>
        <div class="orders-wrap">
          <div class="orders-head"><div>RÃ©fÃ©rence</div><div>Service</div><div>Client</div><div>Date</div><div>Statut</div><div>Actions</div></div>
          <div id="orders-body-desktop"><div style="text-align:center;padding:40px"><div class="spinner"></div></div></div>
        </div>
        <div id="orders-body-mobile"></div>
      </div>

      <!-- â•â• STATISTIQUES â•â• -->
      <div id="section-stats" style="display:none">
        <div class="pg-title">Statistiques</div>
        <div class="pg-sub">Vue d'ensemble des performances</div>
        <div class="stats-tabs">
          <button class="stat-tab on" onclick="setPeriod('day',this)">Aujourd'hui</button>
          <button class="stat-tab" onclick="setPeriod('week',this)">Cette semaine</button>
          <button class="stat-tab" onclick="setPeriod('month',this)">Ce mois</button>
          <button class="stat-tab" onclick="setPeriod('all',this)">Tout</button>
        </div>
        <div class="stats-row" style="grid-template-columns:repeat(3,1fr);max-width:700px;margin-top:16px">
          <div class="stat-card"><div class="stat-ico">ğŸ“¦</div><div class="stat-val" id="st-period-cnt">0</div><div class="stat-lbl" id="st-period-lbl">Commandes</div></div>
          <div class="stat-card"><div class="stat-ico">ğŸ’°</div><div class="stat-val" id="st-period-rev" style="font-size:18px;margin-top:4px">0</div><div class="stat-lbl">Chiffre d'affaires</div></div>
          <div class="stat-card"><div class="stat-ico">ğŸ†</div><div class="stat-val" id="st-top" style="font-size:16px;margin-top:4px">â€”</div><div class="stat-lbl">Service le + demandÃ©</div></div>
        </div>
        <div class="settings-card" style="max-width:700px">
          <div class="settings-title">ğŸ“… Commandes des 12 derniers mois</div>
          <div class="monthly-chart" id="monthly-chart"></div>
        </div>
        <div class="settings-card" style="max-width:600px">
          <div class="settings-title">RÃ©partition par service</div>
          <div id="st-breakdown"></div>
        </div>
      </div>

      <!-- â•â• ARTICLES & PRIX â•â• -->
      <div id="section-articles" style="display:none">
        <div class="pg-title">Articles &amp; Prix</div>
        <div class="pg-sub">GÃ©rez les articles affichÃ©s dans le catalogue client</div>
        <div class="articles-panel">
          <div class="svc-tabs">
            <button class="svc-tab on" onclick="loadArticles('food',this)">ğŸ¥˜ Alimentation</button>
            <button class="svc-tab" onclick="loadArticles('restaurant',this)">ğŸ½ï¸ Restauration</button>
            <button class="svc-tab" onclick="loadArticles('clothes',this)">ğŸ‘— PrÃªt-Ã -porter</button>
          </div>
          <div class="panel-hdr" style="margin-top:0;border-top:1px solid var(--border)">
            <div class="panel-title" id="art-panel-title">Alimentation</div>
            <button class="add-btn" onclick="openArticleModal()">+ Ajouter un article</button>
          </div>
          <div id="articles-table">
            <div class="art-table-row art-table-head"><div></div><div>Article</div><div>Prix</div><div>Description</div><div>Actions</div></div>
            <div style="text-align:center;padding:30px;color:var(--light)"><div class="spinner"></div></div>
          </div>
        </div>
      </div>

      <!-- â•â• PARTENAIRES â•â• -->
      <div id="section-partenaires" style="display:none">
        <div class="pg-title">Publications Partenaires</div>
        <div class="pg-sub">Les publications s'afficheront dans le slider de l'application client</div>
        <button class="add-btn" onclick="openPartnerModal()" style="margin-bottom:16px">+ Ajouter une publication</button>
        <div class="partner-grid" id="partner-grid">
          <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--light)"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- â•â• PARAMÃˆTRES â•â• -->
      <div id="section-settings" style="display:none">
        <div class="pg-title">ParamÃ¨tres</div>
        <div class="pg-sub">Informations de contact de l'application</div>
        <div class="settings-card">
          <div class="settings-title">ğŸ“ CoordonnÃ©es</div>
          <label class="f-label">TÃ©lÃ©phone</label>
          <input type="tel" class="f-inp" id="cfg-phone" placeholder="+228 XX XX XX XX"/>
          <label class="f-label">Email de contact</label>
          <input type="email" class="f-inp" id="cfg-email" placeholder="contact@omniservicetg.com"/>
          <label class="f-label">Site web</label>
          <input type="text" class="f-inp" id="cfg-web" placeholder="www.omniservicetg.com"/>
          <button class="modal-save-btn" onclick="saveSettings()">ğŸ’¾ Enregistrer</button>
        </div>
      </div>

      <!-- â•â• MOT DE PASSE â•â• -->
      <div id="section-password" style="display:none">
        <div class="pg-title">Changer le mot de passe</div>
        <div class="pg-sub">SÃ©curisez votre accÃ¨s administrateur</div>
        <div class="settings-card">
          <div class="settings-title">ğŸ”‘ Nouveau mot de passe</div>
          <label class="f-label">Mot de passe actuel</label>
          <input type="password" class="f-inp" id="pw-current"/>
          <label class="f-label">Nouveau mot de passe</label>
          <input type="password" class="f-inp" id="pw-new" placeholder="Min. 8 caractÃ¨res"/>
          <label class="f-label">Confirmer</label>
          <input type="password" class="f-inp" id="pw-confirm"/>
          <button class="modal-save-btn" onclick="changePassword()">ğŸ”’ Modifier</button>
          <div id="pw-msg" style="margin-top:12px;font-size:12px"></div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- Modal DÃ©tail commande -->
<div class="modal-overlay" id="detail-modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('detail-modal').classList.remove('show')">âœ•</button>
    <div class="modal-title" id="detail-title">DÃ©tail</div>
    <div id="detail-body"></div>
  </div>
</div>

<!-- Modal Article -->
<div class="modal-overlay" id="art-modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('art-modal').classList.remove('show')">âœ•</button>
    <div class="modal-title" id="art-modal-title">Ajouter un article</div>
    <input type="hidden" id="art-id"/>
    <label class="f-label">Emoji / IcÃ´ne</label>
    <input type="text" class="f-inp" id="art-emoji" placeholder="ğŸ¥˜" maxlength="4"/>
    <label class="f-label">Nom de l'article *</label>
    <input type="text" class="f-inp" id="art-name" placeholder="Ex : Tilapia frais"/>
    <label class="f-label">Description</label>
    <input type="text" class="f-inp" id="art-desc" placeholder="Ex : Par kg, pÃªche locale"/>
    <label class="f-label">Prix (FCFA) *</label>
    <input type="number" class="f-inp" id="art-price" placeholder="Ex : 3500"/>
    <label class="f-label">UnitÃ©</label>
    <input type="text" class="f-inp" id="art-unit" placeholder="Ex : kg, piÃ¨ce, plat, kit..."/>
    <label class="f-label">URL de l'image (optionnel)</label>
    <input type="url" class="f-inp" id="art-img" placeholder="https://..."/>
    <label class="f-label">Ordre d'affichage</label>
    <input type="number" class="f-inp" id="art-ordre" placeholder="1" value="1"/>
    <button class="modal-save-btn" onclick="saveArticle()">ğŸ’¾ Enregistrer l'article</button>
  </div>
</div>

<!-- Modal Partenaire -->
<div class="modal-overlay" id="partner-modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('partner-modal').classList.remove('show')">âœ•</button>
    <div class="modal-title" id="partner-modal-title">Ajouter une publication partenaire</div>
    <input type="hidden" id="partner-id"/>
    <label class="f-label">Nom du partenaire *</label>
    <input type="text" class="f-inp" id="p-nom" placeholder="Ex : Restaurant Le Palmier"/>
    <label class="f-label">Description / Slogan</label>
    <input type="text" class="f-inp" id="p-desc" placeholder="Ex : La meilleure cuisine togolaise"/>
    <label class="f-label">URL de l'image / affiche * <small style="font-weight:400;text-transform:none;color:var(--light)">(utilisez imgur.com, postimages.org ou similaire)</small></label>
    <input type="url" class="f-inp" id="p-img" placeholder="https://..."/>
    <label class="f-label">Lien vers le partenaire (optionnel)</label>
    <input type="url" class="f-inp" id="p-lien" placeholder="https://..."/>
    <label class="f-label">Ordre dans le slider</label>
    <input type="number" class="f-inp" id="p-ordre" placeholder="1" value="1"/>
    <button class="modal-save-btn" onclick="savePartner()">ğŸ’¾ Publier</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- â•â•â•â• SPLASH SCREEN LOGIC â•â•â•â• -->
<script>
  // Le splash se masque aprÃ¨s 2.8s ou aprÃ¨s que Firebase confirme l'Ã©tat auth
  let splashHidden = false;
  function hideSplash() {
    if (splashHidden) return;
    splashHidden = true;
    const splash = document.getElementById('splash-screen');
    splash.classList.add('hidden');
    setTimeout(() => splash.style.display = 'none', 500);
  }
  // Fallback maximal : 3.2 secondes
  setTimeout(hideSplash, 3200);
</script>

<!-- â•â•â•â• FIREBASE â•â•â•â• -->
<script type="module">
import { initializeApp }            from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc,
         addDoc, updateDoc, deleteDoc, orderBy,
         query, where, serverTimestamp }
                                    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut,
         onAuthStateChanged, updatePassword,
         EmailAuthProvider, reauthenticateWithCredential }
                                    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// â”€â”€ Config Firebase â”€â”€
const firebaseConfig = {
  apiKey: "AIzaSyDtDK7-iDRy1E-kjZubjyjkPW7Th33BMyU",
  authDomain: "omniservicetg-59df3.firebaseapp.com",
  projectId: "omniservicetg-59df3",
  storageBucket: "omniservicetg-59df3.firebasestorage.app",
  messagingSenderId: "196278567761",
  appId: "1:196278567761:web:4f6416acaab58b67bf4970"
};
const fbApp = initializeApp(firebaseConfig);
const db    = getFirestore(fbApp);
const auth  = getAuth(fbApp);

// â”€â”€ Toast â”€â”€
function toast(msg, color="#1A1A2E") {
  const t = document.getElementById("toast");
  t.style.background = color; t.textContent = msg;
  t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 3200);
}

// â•â•â•â• LOGIN â•â•â•â•
window.doLogin = async function() {
  const email = document.getElementById("l-email").value.trim();
  const pass  = document.getElementById("l-pass").value;
  const err   = document.getElementById("l-err");
  const diag  = document.getElementById("l-diag");
  const btn   = document.getElementById("login-btn");
  err.textContent = ""; diag.style.display="none";
  btn.innerHTML = `<span style="display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px"></span>Connexion...`;
  btn.disabled = true;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e) {
    const msgs = {
      "auth/invalid-credential":"âŒ Email ou mot de passe incorrect.",
      "auth/user-not-found":"âŒ Compte inexistant.",
      "auth/wrong-password":"âŒ Mot de passe incorrect.",
      "auth/invalid-email":"âŒ Email invalide.",
      "auth/too-many-requests":"â³ Trop de tentatives.",
      "auth/configuration-not-found":"âŒ Auth non configurÃ©."
    };
    err.textContent = msgs[e.code]||("âŒ "+e.message);
    const code = e.code||"";
    let diagHtml = "";
    if(code==="auth/unauthorized-domain"||e.message.includes("unauthorized")) {
      diagHtml=`<div class="diag-box diag-ora"><b>ğŸ” Domaine non autorisÃ©</b><br/>Allez sur <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a> â†’ Authentication â†’ Settings â†’ Authorized domains â†’ Ajoutez : <code style="background:rgba(0,0,0,.2);padding:2px 6px;border-radius:4px">${location.hostname}</code></div>`;
    } else if(code==="auth/user-not-found"||code==="auth/invalid-credential") {
      diagHtml=`<div class="diag-box diag-blue"><b>ğŸ‘¤ Compte inexistant</b><br/><a href="https://console.firebase.google.com" target="_blank">Firebase Console</a> â†’ Authentication â†’ Users â†’ Add user â†’ Email + mot de passe</div>`;
    } else {
      diagHtml=`<div class="diag-box diag-dark"><b>Code :</b> <code style="background:rgba(255,255,255,.15);padding:2px 6px;border-radius:4px">${code}</code><br/><span style="font-size:11px">${e.message}</span></div>`;
    }
    if(diagHtml){diag.innerHTML=diagHtml;diag.style.display="block";}
    btn.innerHTML="Se connecter â†’"; btn.disabled=false;
  }
};
window.doLogout = async function(){ await signOut(auth); };

onAuthStateChanged(auth, user => {
  // Masquer le splash dÃ¨s que Firebase rÃ©pond (connectÃ© ou non)
  if (typeof hideSplash === 'function') hideSplash();

  if(user){
    document.getElementById("login-screen").style.display="none";
    document.getElementById("admin-ui").style.display="flex";
    document.getElementById("admin-email-disp").textContent=user.email;
    loadOrders();
    loadSettings();
    loadArticles('food', document.querySelector('.svc-tab.on'));
    loadPartners();
  } else {
    document.getElementById("login-screen").style.display="flex";
    document.getElementById("admin-ui").style.display="none";
  }
});

// â•â•â•â• Ã‰TAT â•â•â•â•
let allOrders=[], activeFilter='all', searchTerm='', currentArtSvc='food', editingArtId=null, editingPartnerId=null, statPeriod='day';
const SC = {
  "En attente":{c:"#F5820A",bg:"#FFF3E0"},
  "ConfirmÃ©e":{c:"#1E6FBE",bg:"#E3F2FD"},
  "En cours":{c:"#7B1FA2",bg:"#F3E5F5"},
  "TerminÃ©e":{c:"#2E7D32",bg:"#E8F5E9"},
  "AnnulÃ©e":{c:"#C62828",bg:"#FFEBEE"}
};

// â•â•â•â• COMMANDES â•â•â•â•
window.loadOrders = async function() {
  document.getElementById("orders-body-desktop").innerHTML=`<div style="text-align:center;padding:40px"><div class="spinner"></div></div>`;
  document.getElementById("orders-body-mobile").innerHTML="";
  try {
    const q = query(collection(db,"commandes"), orderBy("createdAt","desc"));
    const snap = await getDocs(q);
    allOrders = snap.docs.map(d=>({id:d.id,...d.data()}));
    render(); updateStats();
    document.getElementById("last-refresh").textContent=`Mis Ã  jour : ${new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})} â€” ${allOrders.length} commandes`;
  } catch(e) {
    document.getElementById("orders-body-desktop").innerHTML=`<div class="empty-msg">âŒ Erreur Firebase : ${e.message}</div>`;
  }
};

function filteredOrders() {
  return allOrders.filter(o=>{
    const mf = activeFilter==='all' || o.statut===activeFilter;
    const ms = !searchTerm || [o.phone,o.serviceName,o.service,o.id,o.clientNom,o.clientPrenom,o.clientVille].some(v=>v&&v.toLowerCase().includes(searchTerm));
    return mf&&ms;
  });
}

function render() {
  const list = filteredOrders();
  document.getElementById("badge-pending").textContent=allOrders.filter(o=>o.statut==="En attente").length;
  if(!list.length){
    document.getElementById("orders-body-desktop").innerHTML=`<div class="empty-msg">Aucune commande trouvÃ©e.</div>`;
    document.getElementById("orders-body-mobile").innerHTML=`<div class="empty-msg">Aucune commande trouvÃ©e.</div>`;
    return;
  }
  const sopts=(cur)=>Object.keys(SC).map(s=>`<option value="${s}"${s===cur?' selected':''}>${s}</option>`).join('');
  document.getElementById("orders-body-desktop").innerHTML=list.map(o=>{
    const s=SC[o.statut]||SC["En attente"];
    const d=o.createdAt?new Date(o.createdAt.seconds*1000).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}):'â€”';
    const totalStr=o.total?`<br/><small style="color:var(--blue);font-weight:700">${Number(o.total).toLocaleString('fr-FR')} FCFA</small>`:'';
    // Infos client enrichies
    const avatar = o.clientGenre==='femme'?'ğŸ‘©':o.clientGenre==='homme'?'ğŸ‘¨':'ğŸ‘¤';
    const clientName = [o.clientPrenom,o.clientNom].filter(Boolean).join(' ') || 'â€”';
    const clientSub  = [o.phone, o.clientVille].filter(Boolean).join(' Â· ') || o.adresse || 'â€”';
    return `<div class="order-row">
      <div><span class="or-ref" onclick="showDetail('${o.id}')">#${o.id.slice(0,8).toUpperCase()}</span></div>
      <div><div class="or-name">${o.serviceName||o.service||'â€”'}</div><div class="or-sub">${o.type||o.modePaiement||''}</div></div>
      <div><div class="or-name">${avatar} ${clientName}</div><div class="or-sub">${clientSub}</div></div>
      <div style="font-size:11px;color:var(--mid)">${d}${totalStr}</div>
      <div><span class="pill" style="background:${s.bg};color:${s.c}">${o.statut}</span></div>
      <div class="or-actions">
        <select class="act-select" id="sel-${o.id}">${sopts(o.statut)}</select>
        <button class="act-save" onclick="updateStatus('${o.id}')">âœ”</button>
        <button class="act-del"  onclick="deleteOrder('${o.id}')">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
  document.getElementById("orders-body-mobile").innerHTML=list.map(o=>{
    const s=SC[o.statut]||SC["En attente"];
    const d=o.createdAt?new Date(o.createdAt.seconds*1000).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'}):'â€”';
    const avatar = o.clientGenre==='femme'?'ğŸ‘©':o.clientGenre==='homme'?'ğŸ‘¨':'ğŸ‘¤';
    const clientName = [o.clientPrenom,o.clientNom].filter(Boolean).join(' ') || o.phone || 'â€”';
    const clientSub  = [o.phone, o.clientVille].filter(Boolean).join(' Â· ') || 'â€”';
    return `<div class="order-card-m">
      <div class="ocm-head">
        <div>
          <span class="or-ref" onclick="showDetail('${o.id}')">#${o.id.slice(0,8).toUpperCase()}</span>
          <div style="font-size:12px;font-weight:700;color:var(--dark);margin-top:3px">${o.serviceName||o.service||'â€”'}</div>
          <div style="font-size:11px;color:var(--light)">${avatar} ${clientName}</div>
          <div style="font-size:11px;color:var(--light)">${clientSub} Â· ${d}</div>
          ${o.total?`<div style="font-size:12px;font-weight:700;color:var(--blue)">${Number(o.total).toLocaleString('fr-FR')} FCFA</div>`:''}
        </div>
        <span class="pill" style="background:${s.bg};color:${s.c}">${o.statut}</span>
      </div>
      <div class="ocm-actions">
        <select class="ocm-select" id="selm-${o.id}">${sopts(o.statut)}</select>
        <button class="act-save" onclick="updateStatusMobile('${o.id}')">âœ”</button>
        <button class="act-del"  onclick="deleteOrder('${o.id}')">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

window.setFilter=function(val,btn){activeFilter=val;document.querySelectorAll(".fbtn").forEach(b=>b.classList.remove("on"));btn.classList.add("on");render();};
window.doSearch=function(val){searchTerm=val.toLowerCase();render();};
window.updateStatus=async function(id){await _upd(id,document.getElementById(`sel-${id}`).value);};
window.updateStatusMobile=async function(id){await _upd(id,document.getElementById(`selm-${id}`).value);};
async function _upd(id,val){
  try{await updateDoc(doc(db,"commandes",id),{statut:val,updatedAt:serverTimestamp()});const o=allOrders.find(x=>x.id===id);if(o)o.statut=val;render();updateStats();toast("âœ… Statut mis Ã  jour !","#2E7D32");}catch(e){toast("âŒ Erreur","#C62828");}
}
window.deleteOrder=async function(id){
  if(!confirm("Supprimer cette commande ?"))return;
  try{await deleteDoc(doc(db,"commandes",id));allOrders=allOrders.filter(o=>o.id!==id);render();updateStats();toast("ğŸ—‘ SupprimÃ©e");}catch(e){toast("âŒ Erreur","#C62828");}
};

// â•â•â•â• STATS â•â•â•â•
function updateStats(){
  document.getElementById("s-att").textContent=allOrders.filter(o=>o.statut==="En attente").length;
  document.getElementById("s-enc").textContent=allOrders.filter(o=>o.statut==="En cours"||o.statut==="ConfirmÃ©e").length;
  document.getElementById("s-ter").textContent=allOrders.filter(o=>o.statut==="TerminÃ©e").length;
  document.getElementById("s-tot").textContent=allOrders.length;
  renderStatsByPeriod(statPeriod);
  renderMonthlyChart();
  renderBreakdown();
}

function filterByPeriod(period){
  const now=new Date();
  return allOrders.filter(o=>{
    if(!o.createdAt)return false;
    const t=o.createdAt.seconds*1000;
    if(period==='day')return new Date(t).toDateString()===now.toDateString();
    if(period==='week')return t>=Date.now()-7*86400000;
    if(period==='month')return t>=new Date(now.getFullYear(),now.getMonth(),1).getTime();
    return true;
  });
}

function renderStatsByPeriod(period){
  const orders=filterByPeriod(period);
  const rev=orders.filter(o=>o.total).reduce((s,o)=>s+Number(o.total),0);
  const counts={};orders.forEach(o=>{const k=o.serviceName||o.service||'Autre';counts[k]=(counts[k]||0)+1;});
  const top=Object.entries(counts).sort((a,b)=>b[1]-a[1])[0];
  const lbls={'day':"Aujourd'hui",'week':'Cette semaine','month':'Ce mois','all':'Total'};
  document.getElementById("st-period-cnt").textContent=orders.length;
  document.getElementById("st-period-lbl").textContent=`Commandes (${lbls[period]})`;
  document.getElementById("st-period-rev").textContent=rev>0?`${Number(rev).toLocaleString('fr-FR')} F`:'0 F';
  document.getElementById("st-top").textContent=top?top[0].split(' ')[0]:'â€”';
}

function renderMonthlyChart(){
  const now=new Date();
  const months=[];
  for(let i=11;i>=0;i--){
    const d=new Date(now.getFullYear(),now.getMonth()-i,1);
    months.push({year:d.getFullYear(),month:d.getMonth(),label:d.toLocaleString('fr-FR',{month:'short'})});
  }
  const counts=months.map(m=>allOrders.filter(o=>{
    if(!o.createdAt)return false;
    const d=new Date(o.createdAt.seconds*1000);
    return d.getFullYear()===m.year&&d.getMonth()===m.month;
  }).length);
  const maxC=Math.max(...counts,1);
  document.getElementById("monthly-chart").innerHTML=counts.map((c,i)=>`
    <div class="monthly-bar-wrap">
      <div class="monthly-val">${c>0?c:''}</div>
      <div class="monthly-bar" style="height:${Math.max(4,Math.round(c/maxC*90))}px"></div>
      <div class="monthly-lbl">${months[i].label}</div>
    </div>`).join('');
}

function renderBreakdown(){
  const counts={};
  allOrders.forEach(o=>{const k=o.serviceName||o.service||'Autre';counts[k]=(counts[k]||0)+1;});
  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  const maxV=sorted[0]?.[1]||1;
  document.getElementById("st-breakdown").innerHTML=sorted.map(([name,count])=>`
    <div class="bar-row">
      <div class="bar-top"><span>${name}</span><span>${count}</span></div>
      <div class="bar-bg"><div class="bar-fill" style="width:${Math.round(count/maxV*100)}%"></div></div>
    </div>`).join('');
}

window.setPeriod=function(period,btn){
  statPeriod=period;
  document.querySelectorAll(".stat-tab").forEach(b=>b.classList.remove("on"));
  btn.classList.add("on");
  renderStatsByPeriod(period);
};

// â•â•â•â• DÃ‰TAIL COMMANDE â•â•â•â•
window.showDetail=function(id){
  const o=allOrders.find(x=>x.id===id); if(!o)return;
  const s=SC[o.statut]||SC["En attente"];
  const dateStr=o.createdAt?new Date(o.createdAt.seconds*1000).toLocaleString('fr-FR'):'â€”';
  const avatar  = o.clientGenre==='femme'?'ğŸ‘©':o.clientGenre==='homme'?'ğŸ‘¨':'ğŸ‘¤';
  const clientName = [o.clientPrenom,o.clientNom].filter(Boolean).join(' ') || 'â€”';

  // Bloc client en haut du dÃ©tail
  let rows=`
    <div style="background:linear-gradient(135deg,rgba(30,111,190,.06),rgba(245,130,10,.04));border-radius:12px;padding:14px 16px;margin-bottom:12px;border:1px solid rgba(30,111,190,.12)">
      <div style="font-size:10px;font-weight:800;color:var(--light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">ğŸ‘¤ Informations Client</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div style="font-size:10px;color:var(--light);font-weight:600">Nom complet</div><div style="font-size:13px;font-weight:700;color:var(--dark)">${avatar} ${clientName}</div></div>
        <div><div style="font-size:10px;color:var(--light);font-weight:600">Genre</div><div style="font-size:13px;font-weight:700;color:var(--dark)">${o.clientGenre?o.clientGenre.charAt(0).toUpperCase()+o.clientGenre.slice(1):'â€”'}</div></div>
        <div><div style="font-size:10px;color:var(--light);font-weight:600">TÃ©lÃ©phone</div><div style="font-size:13px;font-weight:700;color:var(--blue)">${o.phone||'â€”'}</div></div>
        <div><div style="font-size:10px;color:var(--light);font-weight:600">Ville</div><div style="font-size:13px;font-weight:700;color:var(--dark)">${o.clientVille||'â€”'}</div></div>
      </div>
    </div>`;

  const keys={service:"Service",serviceName:"Nom service",statut:"Statut",adresse:"Adresse livraison",type:"Type",produits:"Produits",commande:"Commande",personnes:"Personnes",detail:"DÃ©tail",urgence:"Urgence",categorie:"CatÃ©gorie",article:"Article",budget:"Budget",superficie:"Superficie (mÂ²)",date:"Date souhaitÃ©e",problem:"ProblÃ¨me",notes:"Notes",modePaiement:"Paiement",total:"Total (FCFA)",positionType:"Localisation",positionDesc:"Description pos.",lat:"Latitude",lng:"Longitude"};
  const excl=["id","createdAt","updatedAt","articles","uid","clientNom","clientPrenom","clientGenre","phone","clientVille"];

  rows+=`<div class="modal-row"><span class="modal-key">ğŸ“… Date</span><span class="modal-val">${dateStr}</span></div>`;
  rows+=Object.entries(o).filter(([k,v])=>!excl.includes(k)&&v!==undefined&&v!=='').map(([k,v])=>`
    <div class="modal-row"><span class="modal-key">${keys[k]||k}</span><span class="modal-val">${k==='statut'?`<span class="pill" style="background:${s.bg};color:${s.c}">${v}</span>`:k==='total'?`${Number(v).toLocaleString('fr-FR')} FCFA`:v}</span></div>`).join('');

  if(o.articles&&o.articles.length){
    rows+=`<div class="modal-row" style="flex-direction:column;gap:5px"><span class="modal-key">ğŸ›’ Articles commandÃ©s</span>`;
    let subtotal=0;
    o.articles.forEach(a=>{
      const line=a.price*a.qty;subtotal+=line;
      rows+=`<div style="font-size:12px;display:flex;justify-content:space-between;width:100%;padding:5px 0;border-bottom:1px solid #F4F6FA"><span>${a.name} <span style="color:var(--light)">x${a.qty}</span></span><span style="color:var(--blue);font-weight:700">${Number(line).toLocaleString('fr-FR')} FCFA</span></div>`;
    });
    rows+=`<div style="display:flex;justify-content:space-between;font-weight:800;font-size:13px;padding-top:8px"><span>Total</span><span style="color:var(--blue)">${Number(subtotal).toLocaleString('fr-FR')} FCFA</span></div>`;
    rows+=`</div>`;
  }
  document.getElementById("detail-title").textContent=`#${id.slice(0,8).toUpperCase()} â€” ${o.serviceName||o.service}`;
  document.getElementById("detail-body").innerHTML=rows;
  document.getElementById("detail-modal").classList.add("show");
};

// â•â•â•â• ARTICLES â•â•â•â•
let articlesCache=[];
window.loadArticles=async function(svc, btn){
  currentArtSvc=svc;
  if(btn){document.querySelectorAll(".svc-tab").forEach(b=>b.classList.remove("on"));btn.classList.add("on");}
  const titles={'food':'Alimentation','restaurant':'Restauration','clothes':'PrÃªt-Ã -porter'};
  document.getElementById("art-panel-title").textContent=titles[svc]||svc;
  const table=document.getElementById("articles-table");
  table.innerHTML=`<div class="art-table-row art-table-head"><div></div><div>Article</div><div>Prix</div><div>Description</div><div>Actions</div></div><div style="text-align:center;padding:30px;color:var(--light)"><div class="spinner"></div></div>`;
  try{
    const q=query(collection(db,'articles'),where('service','==',svc),orderBy('ordre','asc'));
    const snap=await getDocs(q);
    articlesCache=snap.docs.map(d=>({id:d.id,...d.data()}));
  }catch(e){articlesCache=[];}
  renderArticleTable();
};

function renderArticleTable(){
  const table=document.getElementById("articles-table");
  const head=`<div class="art-table-row art-table-head"><div></div><div>Article</div><div>Prix</div><div>Description</div><div>Actions</div></div>`;
  if(!articlesCache.length){
    table.innerHTML=head+`<div style="text-align:center;padding:28px;color:var(--light);font-size:13px">Aucun article. Ajoutez-en via le bouton ci-dessus.</div>`;
    return;
  }
  table.innerHTML=head+articlesCache.map(a=>`
    <div class="art-table-row">
      <div class="art-emoji">${a.emoji||'ğŸ“¦'}</div>
      <div><div style="font-weight:700;font-size:12px">${a.name}</div>${a.unit?`<div style="font-size:10px;color:var(--light)">/${a.unit}</div>`:''}</div>
      <div style="font-weight:800;color:var(--blue);font-size:13px">${Number(a.price).toLocaleString('fr-FR')} F</div>
      <div style="font-size:11px;color:var(--mid)">${a.desc||''}</div>
      <div><button class="art-edit" onclick="editArticle('${a.id}')">âœï¸</button><button class="art-del" onclick="deleteArticle('${a.id}')">ğŸ—‘</button></div>
    </div>`).join('');
}

window.openArticleModal=function(){
  editingArtId=null;
  document.getElementById("art-modal-title").textContent="Ajouter un article";
  ['art-id','art-emoji','art-name','art-desc','art-price','art-unit','art-img'].forEach(x=>document.getElementById(x).value='');
  document.getElementById("art-ordre").value='1';
  document.getElementById("art-modal").classList.add("show");
};

window.editArticle=function(id){
  const a=articlesCache.find(x=>x.id===id); if(!a)return;
  editingArtId=id;
  document.getElementById("art-modal-title").textContent="Modifier l'article";
  document.getElementById("art-id").value=id;
  document.getElementById("art-emoji").value=a.emoji||'';
  document.getElementById("art-name").value=a.name||'';
  document.getElementById("art-desc").value=a.desc||'';
  document.getElementById("art-price").value=a.price||'';
  document.getElementById("art-unit").value=a.unit||'';
  document.getElementById("art-img").value=a.imageUrl||'';
  document.getElementById("art-ordre").value=a.ordre||1;
  document.getElementById("art-modal").classList.add("show");
};

window.saveArticle=async function(){
  const name=document.getElementById("art-name").value.trim();
  const price=parseFloat(document.getElementById("art-price").value);
  if(!name||isNaN(price)||price<=0){toast("âš ï¸ Nom et prix obligatoires","#F5820A");return;}
  const data={
    service:currentArtSvc, name, price,
    emoji:document.getElementById("art-emoji").value.trim()||'ğŸ“¦',
    desc:document.getElementById("art-desc").value.trim(),
    unit:document.getElementById("art-unit").value.trim(),
    imageUrl:document.getElementById("art-img").value.trim(),
    ordre:parseInt(document.getElementById("art-ordre").value)||1,
    updatedAt:serverTimestamp()
  };
  try{
    if(editingArtId){
      await updateDoc(doc(db,'articles',editingArtId),data);
      toast("âœ… Article modifiÃ© !","#2E7D32");
    } else {
      data.createdAt=serverTimestamp();
      await addDoc(collection(db,'articles'),data);
      toast("âœ… Article ajoutÃ© !","#2E7D32");
    }
    document.getElementById("art-modal").classList.remove("show");
    loadArticles(currentArtSvc,null);
  }catch(e){toast("âŒ Erreur : "+e.message,"#C62828");}
};

window.deleteArticle=async function(id){
  if(!confirm("Supprimer cet article ?"))return;
  try{await deleteDoc(doc(db,'articles',id));articlesCache=articlesCache.filter(a=>a.id!==id);renderArticleTable();toast("ğŸ—‘ Article supprimÃ©");}catch(e){toast("âŒ Erreur","#C62828");}
};

// â•â•â•â• PARTENAIRES â•â•â•â•
let partnersCache=[];
window.loadPartners=async function(){
  const grid=document.getElementById("partner-grid");
  grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--light)"><div class="spinner"></div></div>`;
  try{
    const q=query(collection(db,'partenaires'),orderBy('ordre','asc'));
    const snap=await getDocs(q);
    partnersCache=snap.docs.map(d=>({id:d.id,...d.data()}));
  }catch(e){partnersCache=[];}
  renderPartners();
};

function renderPartners(){
  const grid=document.getElementById("partner-grid");
  if(!partnersCache.length){
    grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--light)">Aucune publication. Ajoutez-en via le bouton ci-dessus.</div>`;
    return;
  }
  grid.innerHTML=partnersCache.map(p=>`
    <div class="partner-card">
      <div class="partner-img">${p.imageUrl?`<img src="${p.imageUrl}" alt="${p.nom}" onerror="this.parentElement.innerHTML='ğŸ–¼ï¸'"/>`:'ğŸ–¼ï¸'}</div>
      <div class="partner-body">
        <div class="partner-name">${p.nom||'Sans titre'}</div>
        <div class="partner-desc">${p.description||''}</div>
        ${p.lien?`<div style="font-size:11px;color:var(--blue);margin-bottom:8px"><a href="${p.lien}" target="_blank">ğŸ”— Voir le lien</a></div>`:''}
        <div class="partner-actions">
          <button class="art-edit" onclick="editPartner('${p.id}')">âœï¸ Modifier</button>
          <button class="art-del" onclick="deletePartner('${p.id}')">ğŸ—‘</button>
        </div>
      </div>
    </div>`).join('');
}

window.openPartnerModal=function(){
  editingPartnerId=null;
  document.getElementById("partner-modal-title").textContent="Ajouter une publication partenaire";
  ['partner-id','p-nom','p-desc','p-img','p-lien'].forEach(x=>document.getElementById(x).value='');
  document.getElementById("p-ordre").value='1';
  document.getElementById("partner-modal").classList.add("show");
};

window.editPartner=function(id){
  const p=partnersCache.find(x=>x.id===id); if(!p)return;
  editingPartnerId=id;
  document.getElementById("partner-modal-title").textContent="Modifier la publication";
  document.getElementById("partner-id").value=id;
  document.getElementById("p-nom").value=p.nom||'';
  document.getElementById("p-desc").value=p.description||'';
  document.getElementById("p-img").value=p.imageUrl||'';
  document.getElementById("p-lien").value=p.lien||'';
  document.getElementById("p-ordre").value=p.ordre||1;
  document.getElementById("partner-modal").classList.add("show");
};

window.savePartner=async function(){
  const nom=document.getElementById("p-nom").value.trim();
  const img=document.getElementById("p-img").value.trim();
  if(!nom){toast("âš ï¸ Le nom est obligatoire","#F5820A");return;}
  const data={
    nom, imageUrl:img,
    description:document.getElementById("p-desc").value.trim(),
    lien:document.getElementById("p-lien").value.trim(),
    ordre:parseInt(document.getElementById("p-ordre").value)||1,
    updatedAt:serverTimestamp()
  };
  try{
    if(editingPartnerId){
      await updateDoc(doc(db,'partenaires',editingPartnerId),data);
      toast("âœ… Publication modifiÃ©e !","#2E7D32");
    } else {
      data.createdAt=serverTimestamp();
      await addDoc(collection(db,'partenaires'),data);
      toast("âœ… Publication ajoutÃ©e !","#2E7D32");
    }
    document.getElementById("partner-modal").classList.remove("show");
    loadPartners();
  }catch(e){toast("âŒ Erreur : "+e.message,"#C62828");}
};

window.deletePartner=async function(id){
  if(!confirm("Supprimer cette publication ?"))return;
  try{await deleteDoc(doc(db,'partenaires',id));partnersCache=partnersCache.filter(p=>p.id!==id);renderPartners();toast("ğŸ—‘ SupprimÃ©e");}catch(e){toast("âŒ Erreur","#C62828");}
};

// â•â•â•â• SECTIONS â•â•â•â•
window.showSection=function(id,btn){
  ['orders','stats','articles','partenaires','settings','password'].forEach(s=>{
    const el=document.getElementById("section-"+s); if(el)el.style.display=s===id?'block':'none';
  });
  document.querySelectorAll(".sb-item").forEach(b=>b.classList.remove("on"));
  if(btn)btn.classList.add("on");
  if(id==='stats'){updateStats();}
  if(window.innerWidth<769)document.getElementById("sidebar").classList.remove("open");
};

window.toggleSidebar=function(){document.getElementById("sidebar").classList.toggle("open");};

// â•â•â•â• PARAMÃˆTRES â•â•â•â•
function loadSettings(){['phone','email','web'].forEach(k=>{const v=localStorage.getItem("cfg_"+k);if(v)document.getElementById("cfg-"+k).value=v;});}
window.saveSettings=function(){['phone','email','web'].forEach(k=>localStorage.setItem("cfg_"+k,document.getElementById("cfg-"+k).value));toast("âœ… EnregistrÃ© !","#2E7D32");};

// â•â•â•â• MOT DE PASSE â•â•â•â•
window.changePassword=async function(){
  const cur=document.getElementById("pw-current").value;
  const nw=document.getElementById("pw-new").value;
  const conf=document.getElementById("pw-confirm").value;
  const msg=document.getElementById("pw-msg");
  if(nw.length<8){msg.style.color="var(--red)";msg.textContent="âŒ Min. 8 caractÃ¨res.";return;}
  if(nw!==conf){msg.style.color="var(--red)";msg.textContent="âŒ Les mots de passe ne correspondent pas.";return;}
  try{
    const user=auth.currentUser;
    const cred=EmailAuthProvider.credential(user.email,cur);
    await reauthenticateWithCredential(user,cred);
    await updatePassword(user,nw);
    msg.style.color="var(--green)";msg.textContent="âœ… Mot de passe modifiÃ© !";
    ['pw-current','pw-new','pw-confirm'].forEach(x=>document.getElementById(x).value='');
    toast("âœ… Mot de passe mis Ã  jour !","#2E7D32");
  }catch(e){
    msg.style.color="var(--red)";
    msg.textContent=(e.code==="auth/wrong-password"||e.code==="auth/invalid-credential")?"âŒ Mot de passe actuel incorrect.":"âŒ "+e.message;
  }
};
</script>
</body>
</html>
