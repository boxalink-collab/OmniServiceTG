<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OmniService TG ‚Äî Communication</title>
<link rel="icon" href="../assets/logo.png" type="image/png"/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--blue:#1E6FBE;--blue-d:#155A9C;--blue-s:rgba(30,111,190,.1);--ora:#F5820A;--dark:#1A1A2E;--mid:#4A4A6A;--light:#9999BB;--border:#E8EAF0;--bg:#F4F6FA;--green:#2E7D32;--red:#C62828;--pink:#C2185B}
html,body{height:100%;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--dark)}
#splash{position:fixed;inset:0;z-index:9999;background:#0a1220;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px}
.sp-logo{font-size:52px;animation:popIn .6s cubic-bezier(.34,1.56,.64,1) .3s both}
.sp-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:#fff;animation:fadeUp .5s ease .7s both}
.sp-sub{font-size:11px;color:rgba(255,255,255,.4);letter-spacing:1px;text-transform:uppercase;animation:fadeUp .5s ease .9s both}
.sp-bar{width:160px;height:2px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden;animation:fadeUp .4s ease 1s both}
.sp-bar-fill{height:100%;background:linear-gradient(90deg,var(--pink),var(--ora));animation:load 1.4s ease 1.1s both}
@keyframes load{0%{width:0}100%{width:100%}}
#splash.out{animation:splashOut .4s ease forwards}
@keyframes splashOut{to{opacity:0;pointer-events:none}}
@keyframes popIn{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes fadeUp{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}

/* LOGIN */
#login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0e1420,#1a2540);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;display:none}
.login-box{background:#fff;border-radius:24px;padding:36px 28px;width:100%;max-width:360px;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.4)}
.login-logo{font-size:44px;margin-bottom:10px}
.login-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:var(--dark);margin-bottom:4px}
.login-sub{font-size:12px;color:var(--light);margin-bottom:20px}
.login-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(194,24,91,.08);color:var(--pink);border:1px solid rgba(194,24,91,.2);border-radius:999px;padding:4px 14px;font-size:11px;font-weight:700;margin-bottom:18px}
.inp{width:100%;padding:13px 16px;border:1.5px solid var(--border);border-radius:12px;font-size:14px;font-family:'Poppins',sans-serif;outline:none;transition:.2s;background:#fafbfd;margin-bottom:12px}
.inp:focus{border-color:var(--pink);box-shadow:0 0 0 3px rgba(194,24,91,.1)}
.btn-login{width:100%;padding:14px;background:linear-gradient(135deg,var(--pink),#880E4F);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer}
.login-err{color:var(--red);font-size:12px;margin-top:8px;min-height:18px}

/* LAYOUT */
#app{display:none;min-height:100vh}
.top-header{background:linear-gradient(135deg,#1A1A2E,#4A0E2E);padding:16px 24px;display:flex;align-items:center;justify-content:space-between}
.th-left{display:flex;align-items:center;gap:12px}
.th-icon{font-size:28px}
.th-name{font-family:'Nunito',sans-serif;font-size:18px;font-weight:900;color:#fff}
.th-role{font-size:11px;color:rgba(255,255,255,.4);margin-top:1px}
.btn-logout-top{background:rgba(255,255,255,.1);border:none;color:rgba(255,255,255,.7);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:12px;font-family:'Poppins',sans-serif}

/* TABS */
.tabs{background:#fff;border-bottom:1px solid var(--border);display:flex;padding:0 20px}
.tab-btn{padding:14px 20px;border:none;background:none;font-size:13px;font-weight:600;font-family:'Poppins',sans-serif;color:var(--light);cursor:pointer;position:relative;transition:.2s}
.tab-btn.on{color:var(--pink)}
.tab-btn.on::after{content:'';position:absolute;bottom:0;left:10%;right:10%;height:2px;background:var(--pink);border-radius:2px}

/* MAIN */
.main-content{padding:20px;max-width:1100px;margin:0 auto}

/* STATS TOP */
.stat-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px}
.stat-mini{background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);text-align:center;border-top:3px solid var(--pink)}
.stat-mini-n{font-family:'Nunito',sans-serif;font-size:26px;font-weight:900;color:var(--dark)}
.stat-mini-l{font-size:11px;color:var(--light);margin-top:2px}

/* SECTION CARD */
.section-card{background:#fff;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.06);margin-bottom:20px;overflow:hidden}
.section-head{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.section-title{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px}
.btn-add{background:linear-gradient(135deg,var(--pink),#880E4F);color:#fff;border:none;padding:9px 16px;border-radius:10px;font-size:12px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer;display:flex;align-items:center;gap:6px}

/* PARTENAIRE CARD */
.part-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;padding:20px}
.part-card{border-radius:14px;border:1.5px solid var(--border);overflow:hidden;transition:.2s}
.part-card:hover{box-shadow:0 4px 20px rgba(0,0,0,.1);transform:translateY(-2px)}
.part-preview{height:100px;position:relative;overflow:hidden;background:linear-gradient(135deg,var(--dark),var(--blue))}
.part-preview img{width:100%;height:100%;object-fit:cover}
.part-preview-badge{position:absolute;top:8px;left:8px;background:rgba(0,0,0,.6);color:#fff;padding:3px 10px;border-radius:999px;font-size:10px;font-weight:700}
.part-preview-status{position:absolute;top:8px;right:8px;border-radius:999px;padding:3px 8px;font-size:10px;font-weight:700}
.ps-actif{background:rgba(46,125,50,.9);color:#fff}
.ps-inactif{background:rgba(198,40,40,.9);color:#fff}
.part-body{padding:14px}
.part-name{font-size:14px;font-weight:700;margin-bottom:4px}
.part-desc{font-size:11px;color:var(--light);margin-bottom:10px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.part-actions{display:flex;gap:6px}
.btn-edit{flex:1;padding:8px;border-radius:8px;border:1.5px solid var(--blue);background:transparent;color:var(--blue);font-size:11px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer}
.btn-toggle{flex:1;padding:8px;border-radius:8px;border:none;font-size:11px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer}
.btn-activer{background:rgba(46,125,50,.1);color:var(--green)}
.btn-masquer{background:rgba(198,40,40,.1);color:var(--red)}
.btn-del{padding:8px 10px;border-radius:8px;border:1.5px solid rgba(198,40,40,.3);background:transparent;color:var(--red);font-size:11px;cursor:pointer}

/* PLANNING TABLE */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
th{padding:10px 14px;text-align:left;font-weight:700;color:var(--light);font-size:11px;border-bottom:1px solid var(--border);background:#FAFBFD;white-space:nowrap}
td{padding:12px 14px;border-bottom:1px solid var(--border);vertical-align:middle}
tr:last-child td{border-bottom:none}
.pill{border-radius:999px;padding:3px 10px;font-size:10px;font-weight:700}
.p-actif{background:#E8F5E9;color:var(--green)}
.p-planifie{background:#E3F2FD;color:var(--blue)}
.p-expire{background:#FFEBEE;color:var(--red)}
.p-masque{background:#F3E5F5;color:#7B1FA2}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:.25s;padding:20px}
.modal-overlay.show{opacity:1;pointer-events:all}
.modal-box{background:#fff;border-radius:20px;padding:28px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;transform:translateY(20px) scale(.97);transition:.3s}
.modal-overlay.show .modal-box{transform:none}
.modal-title{font-size:18px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between}
.modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--light);padding:4px}
.form-group{margin-bottom:14px}
.form-label{font-size:12px;font-weight:600;color:var(--mid);margin-bottom:6px;display:block}
.form-inp{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:10px;font-size:13px;font-family:'Poppins',sans-serif;outline:none;transition:.2s}
.form-inp:focus{border-color:var(--pink)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn-save{width:100%;padding:13px;background:linear-gradient(135deg,var(--pink),#880E4F);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer;margin-top:4px}
.preview-band{border-radius:12px;height:80px;overflow:hidden;position:relative;margin-bottom:4px;background:linear-gradient(135deg,var(--dark),var(--blue))}
.preview-band img{width:100%;height:100%;object-fit:cover}
.preview-band .pb-badge{position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,.6);color:#fff;padding:3px 10px;border-radius:999px;font-size:10px;font-weight:700}
.preview-band .pb-title{position:absolute;bottom:8px;right:8px;color:#fff;font-size:12px;font-weight:700;text-shadow:0 1px 3px rgba(0,0,0,.5)}

/* TOAST */
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:#1A1A2E;color:#fff;padding:12px 22px;border-radius:12px;font-size:13px;font-weight:600;z-index:9998;transition:.35s;opacity:0;max-width:90%;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div id="splash">
  <div class="sp-logo">üì£</div>
  <div class="sp-title">OmniService TG</div>
  <div class="sp-sub">Interface Communication</div>
  <div class="sp-bar"><div class="sp-bar-fill"></div></div>
</div>

<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">üì£</div>
    <div class="login-title">Espace Communication</div>
    <div class="login-sub">OmniService TG</div>
    <div class="login-badge">üîê Acc√®s Communication</div>
    <input class="inp" type="email" id="login-email" placeholder="Email"/>
    <input class="inp" type="password" id="login-password" placeholder="Mot de passe"/>
    <button class="btn-login" onclick="doLogin()" id="btn-login">Se connecter</button>
    <div class="login-err" id="login-err"></div>
  </div>
</div>

<div id="app">
  <div class="top-header">
    <div class="th-left">
      <div class="th-icon">üì£</div>
      <div>
        <div class="th-name" id="top-name">Communication</div>
        <div class="th-role">Gestion Partenaires & Publications ¬∑ OmniService TG</div>
      </div>
    </div>
    <button class="btn-logout-top" onclick="doLogout()">‚Ü© D√©connexion</button>
  </div>

  <div class="tabs">
    <button class="tab-btn on" id="tab-partenaires" onclick="showTab('partenaires')">ü§ù Partenaires</button>
    <button class="tab-btn" id="tab-planning" onclick="showTab('planning')">üìÖ Planning</button>
    <button class="tab-btn" id="tab-preview" onclick="showTab('preview')">üëÅ Aper√ßu live</button>
  </div>

  <div class="main-content">
    <!-- STATS ROW -->
    <div class="stat-row">
      <div class="stat-mini"><div class="stat-mini-n" id="s-total">‚Äî</div><div class="stat-mini-l">Partenaires total</div></div>
      <div class="stat-mini" style="border-color:var(--green)"><div class="stat-mini-n" id="s-actifs">‚Äî</div><div class="stat-mini-l">Actifs</div></div>
      <div class="stat-mini" style="border-color:var(--red)"><div class="stat-mini-n" id="s-masques">‚Äî</div><div class="stat-mini-l">Masqu√©s</div></div>
      <div class="stat-mini" style="border-color:var(--blue)"><div class="stat-mini-n" id="s-planifies">‚Äî</div><div class="stat-mini-l">Planifi√©s</div></div>
    </div>

    <!-- PARTENAIRES -->
    <div id="view-partenaires">
      <div class="section-card">
        <div class="section-head">
          <div class="section-title">ü§ù Bandeaux partenaires</div>
          <button class="btn-add" onclick="openModal()">+ Nouveau partenaire</button>
        </div>
        <div class="part-grid" id="part-grid">
          <div style="padding:30px;color:var(--light);font-size:13px">Chargement...</div>
        </div>
      </div>
    </div>

    <!-- PLANNING -->
    <div id="view-planning" style="display:none">
      <div class="section-card">
        <div class="section-head">
          <div class="section-title">üìÖ Planification des publications</div>
          <button class="btn-add" onclick="openModal()">+ Programmer</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Partenaire</th><th>D√©but</th><th>Fin</th><th>Statut</th><th>Actions</th></tr></thead>
            <tbody id="planning-tbody"><tr><td colspan="5" style="text-align:center;padding:30px;color:var(--light)">Chargement...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- APER√áU LIVE -->
    <div id="view-preview" style="display:none">
      <div class="section-card">
        <div class="section-head">
          <div class="section-title">üëÅ Aper√ßu ‚Äî Bandeau tel qu'il appara√Æt sur l'app</div>
          <button class="btn-add" style="background:var(--blue)" onclick="loadPreview()">üîÑ Actualiser</button>
        </div>
        <div style="padding:20px">
          <div style="background:var(--bg);border-radius:16px;padding:16px;max-width:400px;margin:0 auto">
            <div style="font-size:11px;color:var(--light);margin-bottom:8px;text-align:center">üì± Aper√ßu mobile</div>
            <div id="live-preview" style="border-radius:12px;overflow:hidden">Chargement...</div>
          </div>
          <div style="margin-top:20px">
            <div style="font-size:13px;font-weight:700;margin-bottom:10px">Partenaires visibles actuellement :</div>
            <div id="preview-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PARTENAIRE -->
<div class="modal-overlay" id="modal-part">
  <div class="modal-box">
    <div class="modal-title">
      <span id="modal-title-txt">‚ûï Nouveau partenaire</span>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <input type="hidden" id="edit-id"/>
    
    <!-- PREVIEW TEMPS R√âEL -->
    <div style="margin-bottom:16px">
      <div style="font-size:11px;color:var(--light);margin-bottom:6px">Aper√ßu bandeau :</div>
      <div class="preview-band" id="form-preview">
        <div class="pb-badge" id="fp-badge">ü§ù Partenaire</div>
        <div class="pb-title" id="fp-title">Nom partenaire</div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Nom *</label>
        <input class="form-inp" id="f-nom" placeholder="Nom du partenaire" oninput="updatePreview()"/>
      </div>
      <div class="form-group">
        <label class="form-label">Badge</label>
        <input class="form-inp" id="f-badge" placeholder="ü§ù Partenaire" oninput="updatePreview()"/>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <input class="form-inp" id="f-desc" placeholder="Courte description visible sur le bandeau"/>
    </div>
    <div class="form-group">
      <label class="form-label">URL Image (bandeau)</label>
      <input class="form-inp" id="f-img" placeholder="https://..." oninput="updatePreview()"/>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Lien cliquable</label>
        <input class="form-inp" id="f-lien" placeholder="https://..."/>
      </div>
      <div class="form-group">
        <label class="form-label">Type promo</label>
        <select class="form-inp" id="f-promo">
          <option value="">S√©lectionner...</option>
          <option value="partenaire">PARTENAIRE OFFICIEL</option>
          <option value="sponsor">SPONSOR</option>
          <option value="collaborateur">COLLABORATEUR</option>
          <option value="nouveaute">NOUVEAUT√â</option>
          <option value="promotion">PROMOTION</option>
          <option value="evenement">√âV√âNEMENT</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Ordre d'affichage</label>
        <input class="form-inp" type="number" id="f-ordre" placeholder="1, 2, 3..." min="1"/>
      </div>
      <div class="form-group">
        <label class="form-label">Statut</label>
        <select class="form-inp" id="f-actif">
          <option value="true">‚úÖ Actif (visible)</option>
          <option value="false">üî¥ Masqu√©</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">üìÖ Date d√©but (optionnel)</label>
        <input class="form-inp" type="datetime-local" id="f-debut"/>
      </div>
      <div class="form-group">
        <label class="form-label">üìÖ Date fin (optionnel)</label>
        <input class="form-inp" type="datetime-local" id="f-fin"/>
      </div>
    </div>
    <button class="btn-save" id="modal-save-btn" onclick="savePartenaire()">üíæ Enregistrer</button>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, query, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtDK7-iDRy1E-kjZubjyjkPW7Th33BMyU",
  authDomain: "omniservicetg-59df3.firebaseapp.com",
  projectId: "omniservicetg-59df3",
  storageBucket: "omniservicetg-59df3.firebasestorage.app",
  messagingSenderId: "196278567761",
  appId: "1:196278567761:web:4f6416acaab58b67bf4970"
};
const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);
const auth = getAuth(fbApp);

let partenaires = [];

// SPLASH
setTimeout(() => {
  document.getElementById('splash').classList.add('out');
  setTimeout(() => document.getElementById('splash').style.display = 'none', 400);
}, 2500);

// AUTH
onAuthStateChanged(auth, async user => {
  if (user) {
    const snap = await getDoc(doc(db,'agents',user.uid));
    if (!snap.exists() || !['comm','admin'].includes(snap.data().role)) {
      await signOut(auth); showLogin('‚ùå Acc√®s non autoris√©'); return;
    }
    document.getElementById('top-name').textContent = snap.data().nom || user.email;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    loadPartenaires();
  } else { showLogin(); }
});

function showLogin(err='') {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  if (err) document.getElementById('login-err').textContent = err;
}
window.doLogin = async function() {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-password').value;
  const btn = document.getElementById('btn-login');
  if (!email||!pass) { document.getElementById('login-err').textContent='‚ö†Ô∏è Champs requis'; return; }
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span>';
  try { await signInWithEmailAndPassword(auth,email,pass); }
  catch(e) { document.getElementById('login-err').textContent='‚ùå Identifiants incorrects'; }
  finally { btn.disabled=false; btn.textContent='Se connecter'; }
};
window.doLogout = async () => await signOut(auth);

// TABS
window.showTab = function(tab) {
  ['partenaires','planning','preview'].forEach(t => {
    document.getElementById('view-'+t).style.display = t===tab?'block':'none';
    document.getElementById('tab-'+t).classList.toggle('on', t===tab);
  });
  if (tab === 'preview') loadPreview();
  if (tab === 'planning') renderPlanning();
};

// LOAD
async function loadPartenaires() {
  try {
    const snap = await getDocs(query(collection(db,'partenaires'), orderBy('ordre','asc')));
    partenaires = snap.docs.map(d => ({id:d.id,...d.data()}));
    renderPartenaires();
    renderStats();
  } catch(e) { showToast('‚ùå Erreur chargement'); }
}

function renderStats() {
  const actifs = partenaires.filter(p=>p.actif!==false).length;
  const masques = partenaires.filter(p=>p.actif===false).length;
  const planifies = partenaires.filter(p=>p.dateDebut||p.dateFin).length;
  document.getElementById('s-total').textContent = partenaires.length;
  document.getElementById('s-actifs').textContent = actifs;
  document.getElementById('s-masques').textContent = masques;
  document.getElementById('s-planifies').textContent = planifies;
}

function renderPartenaires() {
  const grid = document.getElementById('part-grid');
  if (!partenaires.length) {
    grid.innerHTML = '<div style="padding:40px;text-align:center;color:var(--light)">Aucun partenaire. Cliquez sur "+ Nouveau partenaire"</div>';
    return;
  }
  grid.innerHTML = partenaires.map(p => {
    const isActif = p.actif !== false;
    const imgHtml = p.imageUrl ? `<img src="${p.imageUrl}" alt="${p.nom||''}" onerror="this.style.display='none'"/>` : '';
    return `<div class="part-card">
      <div class="part-preview">
        ${imgHtml}
        <div class="part-preview-badge">${p.badge||'ü§ù '+p.nom}</div>
        <div class="part-preview-status ${isActif?'ps-actif':'ps-inactif'}">${isActif?'‚úÖ Actif':'üî¥ Masqu√©'}</div>
      </div>
      <div class="part-body">
        <div class="part-name">${p.nom||'‚Äî'}</div>
        <div class="part-desc">${p.description||p.promo||'Aucune description'}</div>
        <div class="part-actions">
          <button class="btn-edit" onclick="editPartenaire('${p.id}')">‚úèÔ∏è Modifier</button>
          <button class="btn-toggle ${isActif?'btn-masquer':'btn-activer'}" onclick="toggleActif('${p.id}',${isActif})">
            ${isActif?'üëÅ Masquer':'üëÅ Activer'}
          </button>
          <button class="btn-del" onclick="deletePartenaire('${p.id}')">üóë</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderPlanning() {
  const tbody = document.getElementById('planning-tbody');
  const withDates = partenaires.filter(p => p.dateDebut || p.dateFin);
  if (!withDates.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--light)">Aucune publication planifi√©e</td></tr>';
    return;
  }
  const now = new Date();
  tbody.innerHTML = withDates.map(p => {
    const debut = p.dateDebut ? new Date(p.dateDebut.seconds*1000) : null;
    const fin = p.dateFin ? new Date(p.dateFin.seconds*1000) : null;
    let statut, sc;
    if (fin && fin < now) { statut='Expir√©'; sc='p-expire'; }
    else if (debut && debut > now) { statut='Planifi√©'; sc='p-planifie'; }
    else if (p.actif===false) { statut='Masqu√©'; sc='p-masque'; }
    else { statut='Actif'; sc='p-actif'; }
    const fmtDate = d => d ? d.toLocaleDateString('fr-FR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '‚Äî';
    return `<tr>
      <td><strong>${p.nom||'‚Äî'}</strong></td>
      <td>${fmtDate(debut)}</td>
      <td>${fmtDate(fin)}</td>
      <td><span class="pill ${sc}">${statut}</span></td>
      <td><button class="btn-edit" onclick="editPartenaire('${p.id}')">‚úèÔ∏è</button></td>
    </tr>`;
  }).join('');
}

window.loadPreview = function() {
  const actifs = partenaires.filter(p=>p.actif!==false);
  const preview = document.getElementById('live-preview');
  const list = document.getElementById('preview-list');
  if (!actifs.length) {
    preview.innerHTML = '<div style="padding:20px;text-align:center;color:var(--light);font-size:12px">Aucun bandeau actif</div>';
    list.innerHTML = '';
    return;
  }
  // Show first active card
  const p = actifs[0];
  const imgHtml = p.imageUrl ? `<img src="${p.imageUrl}" style="width:100%;height:80px;object-fit:cover" onerror="this.style.display='none'"/>` : '';
  preview.innerHTML = `<div style="background:linear-gradient(135deg,var(--dark),var(--blue));height:80px;position:relative;display:flex;align-items:flex-end;padding:8px 12px">
    ${imgHtml}
    <div style="z-index:1;flex:1">
      <div style="font-size:10px;color:rgba(255,255,255,.7)">${p.badge||'ü§ù Partenaire'}</div>
      <div style="font-size:13px;font-weight:700;color:#fff">${p.nom||'Partenaire'}</div>
    </div>
    <div style="font-size:9px;color:rgba(255,255,255,.5)">1/${actifs.length}</div>
  </div>
  <div style="padding:8px 12px;font-size:11px;color:var(--mid)">${p.description||''}</div>`;
  
  list.innerHTML = actifs.map((p,i) => `
    <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
      <div style="width:24px;height:24px;border-radius:6px;background:var(--blue-s);display:flex;align-items:center;justify-content:center;font-size:12px">ü§ù</div>
      <div style="flex:1;font-size:12px;font-weight:600">${p.nom}</div>
      <div style="font-size:10px;color:var(--light)">Position ${p.ordre||i+1}</div>
    </div>`).join('');
};

// MODAL
window.openModal = function() {
  document.getElementById('edit-id').value = '';
  document.getElementById('modal-title-txt').textContent = '‚ûï Nouveau partenaire';
  ['f-nom','f-badge','f-desc','f-img','f-lien','f-debut','f-fin'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('f-promo').value = '';
  document.getElementById('f-ordre').value = partenaires.length + 1;
  document.getElementById('f-actif').value = 'true';
  updatePreview();
  document.getElementById('modal-part').classList.add('show');
};

window.editPartenaire = function(id) {
  const p = partenaires.find(x=>x.id===id);
  if (!p) return;
  document.getElementById('edit-id').value = id;
  document.getElementById('modal-title-txt').textContent = '‚úèÔ∏è Modifier ‚Äî '+p.nom;
  document.getElementById('f-nom').value = p.nom||'';
  document.getElementById('f-badge').value = p.badge||'';
  document.getElementById('f-desc').value = p.description||'';
  document.getElementById('f-img').value = p.imageUrl||'';
  document.getElementById('f-lien').value = p.lien||'';
  document.getElementById('f-promo').value = p.promo||'';
  document.getElementById('f-ordre').value = p.ordre||1;
  document.getElementById('f-actif').value = p.actif===false ? 'false' : 'true';
  if (p.dateDebut) document.getElementById('f-debut').value = new Date(p.dateDebut.seconds*1000).toISOString().slice(0,16);
  if (p.dateFin) document.getElementById('f-fin').value = new Date(p.dateFin.seconds*1000).toISOString().slice(0,16);
  updatePreview();
  document.getElementById('modal-part').classList.add('show');
};

window.closeModal = () => document.getElementById('modal-part').classList.remove('show');

window.updatePreview = function() {
  const nom = document.getElementById('f-nom').value || 'Nom partenaire';
  const badge = document.getElementById('f-badge').value || 'ü§ù '+nom;
  const img = document.getElementById('f-img').value;
  document.getElementById('fp-badge').textContent = badge;
  document.getElementById('fp-title').textContent = nom;
  const prev = document.getElementById('form-preview');
  if (img) {
    let imgEl = prev.querySelector('img');
    if (!imgEl) { imgEl = document.createElement('img'); imgEl.style.cssText='position:absolute;inset:0;width:100%;height:100%;object-fit:cover'; prev.prepend(imgEl); }
    imgEl.src = img;
  }
};

window.savePartenaire = async function() {
  const nom = document.getElementById('f-nom').value.trim();
  if (!nom) { showToast('‚ö†Ô∏è Le nom est obligatoire'); return; }
  const btn = document.getElementById('modal-save-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Enregistrement...';
  const data = {
    nom, badge: document.getElementById('f-badge').value.trim()||null,
    description: document.getElementById('f-desc').value.trim()||null,
    imageUrl: document.getElementById('f-img').value.trim()||null,
    lien: document.getElementById('f-lien').value.trim()||null,
    promo: document.getElementById('f-promo').value||null,
    ordre: parseInt(document.getElementById('f-ordre').value)||1,
    actif: document.getElementById('f-actif').value === 'true',
    updatedAt: serverTimestamp()
  };
  const debutVal = document.getElementById('f-debut').value;
  const finVal = document.getElementById('f-fin').value;
  if (debutVal) data.dateDebut = new Date(debutVal);
  if (finVal) data.dateFin = new Date(finVal);
  
  const editId = document.getElementById('edit-id').value;
  try {
    if (editId) {
      await updateDoc(doc(db,'partenaires',editId), data);
      showToast('‚úÖ Partenaire mis √† jour !');
    } else {
      data.createdAt = serverTimestamp();
      await addDoc(collection(db,'partenaires'), data);
      showToast('‚úÖ Partenaire cr√©√© !');
    }
    closeModal();
    loadPartenaires();
  } catch(e) { showToast('‚ùå Erreur : ' + e.message); }
  finally { btn.disabled=false; btn.textContent='üíæ Enregistrer'; }
};

window.toggleActif = async function(id, isActif) {
  try {
    await updateDoc(doc(db,'partenaires',id), {actif: !isActif, updatedAt: serverTimestamp()});
    showToast(isActif ? 'üëÅ Masqu√©' : '‚úÖ Activ√© !');
    loadPartenaires();
  } catch(e) { showToast('‚ùå Erreur'); }
};

window.deletePartenaire = async function(id) {
  const p = partenaires.find(x=>x.id===id);
  if (!confirm(`Supprimer "${p?.nom||id}" ?`)) return;
  try {
    await deleteDoc(doc(db,'partenaires',id));
    showToast('üóë Supprim√©');
    loadPartenaires();
  } catch(e) { showToast('‚ùå Erreur'); }
};

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2800);
}

document.getElementById('modal-part').addEventListener('click', e => {
  if (e.target === document.getElementById('modal-part')) closeModal();
});
</script>
</body>
</html>
