<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OmniService TG ‚Äî Communication</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--blue:#1565C0;--blue2:#1E88E5;--blue-s:rgba(21,101,192,.1);--blue-d:#0D47A1;--ora:#F5820A;--ora-s:rgba(245,130,10,.1);--ora-d:#E65100;--dark:#0D2137;--mid:#3A5068;--light:#7A95B0;--border:#D6E4F0;--bg:#F0F4FF;--card:#fff;--green:#2E7D32;--red:#C62828;}
html,body{height:100%;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--dark);overflow-x:hidden}
#splash{position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#0D2137,#1565C0);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px}
.sp-logo{font-size:56px;animation:popIn .6s cubic-bezier(.34,1.56,.64,1) .3s both}
.sp-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:#fff;animation:fadeUp .5s ease .7s both}
.sp-sub{font-size:11px;color:rgba(255,255,255,.5);letter-spacing:1px;text-transform:uppercase;animation:fadeUp .5s ease .9s both}
.sp-bar{width:160px;height:3px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;margin-top:8px;animation:fadeUp .4s ease 1s both}
.sp-bar-fill{height:100%;background:linear-gradient(90deg,var(--ora),var(--blue2));animation:load 1.4s ease 1.1s both}
@keyframes load{0%{width:0}100%{width:100%}}
#splash.out{animation:splashOut .4s ease forwards}
@keyframes splashOut{to{opacity:0;pointer-events:none}}
@keyframes popIn{from{transform:scale(0) rotate(-20deg);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes fadeUp{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
#login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0D2137,#1565C0 60%,#0D47A1);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
.login-box{background:#fff;border-radius:24px;padding:36px 28px;width:100%;max-width:380px;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.35)}
.login-logo{font-size:52px;margin-bottom:8px}
.login-title{font-family:'Nunito',sans-serif;font-size:22px;font-weight:900;color:var(--dark);margin-bottom:4px}
.login-sub{font-size:12px;color:var(--light);margin-bottom:16px}
.login-badge{display:inline-flex;align-items:center;gap:6px;background:var(--ora-s);color:var(--ora-d);border:1px solid rgba(245,130,10,.3);border-radius:999px;padding:4px 14px;font-size:11px;font-weight:700;letter-spacing:.5px;margin-bottom:20px}
.code-lbl{font-size:11px;font-weight:700;color:var(--mid);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;text-align:left;display:block}
.code-inp{width:100%;padding:16px;border:2px solid var(--border);border-radius:14px;font-size:24px;font-weight:900;font-family:'Nunito',sans-serif;text-align:center;letter-spacing:4px;text-transform:uppercase;outline:none;transition:.2s;background:#f8faff;color:var(--dark)}
.code-inp:focus{border-color:var(--blue);background:#fff;box-shadow:0 0 0 4px var(--blue-s)}
.code-inp::placeholder{font-size:14px;letter-spacing:1px;font-weight:400;color:var(--light)}
.btn-login{width:100%;padding:14px;background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;font-family:'Poppins',sans-serif;cursor:pointer;margin-top:6px;transition:.2s}
.btn-login:active{transform:scale(.98)}
.login-err{color:var(--red);font-size:12px;margin-top:10px;min-height:18px;font-weight:600}
.login-hint{font-size:11px;color:var(--light);margin-top:12px;line-height:1.6}
.top-header{background:linear-gradient(135deg,#0D2137,#1565C0);padding:16px 20px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 12px rgba(13,33,55,.3)}
.th-left{display:flex;align-items:center;gap:12px}
.th-icon{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--ora),var(--ora-d));display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 2px 8px rgba(245,130,10,.4)}
.th-name{font-family:'Nunito',sans-serif;font-size:17px;font-weight:900;color:#fff}
.th-role{font-size:10px;color:rgba(255,255,255,.5);margin-top:1px}
.th-code{background:rgba(245,130,10,.2);border:1px solid rgba(245,130,10,.4);color:#FFB74D;border-radius:999px;padding:3px 12px;font-size:10px;font-weight:800;font-family:'Nunito',sans-serif;letter-spacing:1px}
.btn-logout-top{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;font-family:'Poppins',sans-serif}
.tabs{display:flex;background:#fff;border-bottom:2px solid var(--border)}
.tab-btn{flex:1;padding:13px 0;border:none;background:none;font-size:12px;font-weight:700;font-family:'Poppins',sans-serif;color:var(--light);cursor:pointer;position:relative;transition:.2s}
.tab-btn.on{color:var(--blue)}
.tab-btn.on::after{content:'';position:absolute;bottom:-2px;left:15%;right:15%;height:2px;background:var(--ora);border-radius:2px}
.main-content{padding:20px;max-width:900px;margin:0 auto}
.stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
.stat-mini{background:#fff;border-radius:12px;padding:14px;text-align:center;border-left:3px solid var(--blue);box-shadow:0 2px 8px rgba(21,101,192,.07)}
.stat-mini-n{font-family:'Nunito',sans-serif;font-size:26px;font-weight:900;color:var(--blue)}
.stat-mini-l{font-size:10px;color:var(--light);margin-top:2px;text-transform:uppercase;letter-spacing:.5px}
.section-card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 2px 12px rgba(21,101,192,.08);margin-bottom:20px}
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.section-title{font-size:15px;font-weight:700;color:var(--dark)}
.btn-add{background:linear-gradient(135deg,var(--ora),var(--ora-d));color:#fff;border:none;padding:8px 16px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif}
.part-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.part-card{background:var(--bg);border-radius:14px;overflow:hidden;border:1.5px solid var(--border)}
.part-preview{height:80px;position:relative;background:linear-gradient(135deg,#0D2137,#1565C0);display:flex;align-items:flex-end;padding:8px 12px}
.part-preview-badge{font-size:11px;color:rgba(255,255,255,.9);font-weight:700;flex:1}
.part-preview-status{font-size:10px;font-weight:700;padding:3px 8px;border-radius:999px}
.ps-actif{background:rgba(46,125,50,.3);color:#81C784}
.ps-inactif{background:rgba(198,40,40,.3);color:#EF9A9A}
.part-body{padding:12px}
.part-name{font-size:13px;font-weight:700;color:var(--dark);margin-bottom:4px}
.part-desc{font-size:11px;color:var(--light);margin-bottom:10px;line-height:1.4}
.part-actions{display:flex;gap:6px;flex-wrap:wrap}
.btn-edit{background:var(--blue-s);color:var(--blue);border:1px solid rgba(21,101,192,.2);padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif}
.btn-masquer{background:rgba(198,40,40,.08);color:var(--red);border:1px solid rgba(198,40,40,.2);padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif}
.btn-activer{background:rgba(46,125,50,.08);color:var(--green);border:1px solid rgba(46,125,50,.2);padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Poppins',sans-serif}
.btn-del{background:rgba(198,40,40,.08);color:var(--red);border:1px solid rgba(198,40,40,.2);width:30px;border-radius:8px;font-size:14px;cursor:pointer;font-family:'Poppins',sans-serif}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
th{background:var(--bg);color:var(--mid);font-weight:700;padding:10px 12px;text-align:left;border-bottom:2px solid var(--border)}
td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
.pill{border-radius:999px;padding:3px 10px;font-size:10px;font-weight:700}
.p-actif{background:#E8F5E9;color:var(--green)}
.p-expire{background:#FFEBEE;color:var(--red)}
.p-planifie{background:#E3F2FD;color:var(--blue)}
.p-masque{background:#FFF3E0;color:#E65100}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:.25s;padding:20px}
.modal-overlay.show{opacity:1;pointer-events:all}
.modal-box{background:#fff;border-radius:20px;padding:24px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;transform:scale(.95);transition:.3s}
.modal-overlay.show .modal-box{transform:scale(1)}
.modal-title{font-size:16px;font-weight:700;margin-bottom:16px;color:var(--dark)}
.form-row{margin-bottom:12px}
.form-label{font-size:11px;font-weight:700;color:var(--mid);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;display:block}
.form-inp{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:10px;font-family:'Poppins',sans-serif;font-size:13px;outline:none}
.form-inp:focus{border-color:var(--blue)}
.form-select{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:10px;font-family:'Poppins',sans-serif;font-size:13px;outline:none;background:#fff}
.form-preview-wrap{background:linear-gradient(135deg,#0D2137,#1565C0);border-radius:12px;height:80px;position:relative;display:flex;align-items:flex-end;padding:8px 12px;margin-bottom:12px;overflow:hidden}
.btn-save{width:100%;padding:13px;background:linear-gradient(135deg,var(--blue),var(--blue-d));color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;margin-top:4px;font-family:'Poppins',sans-serif}
.btn-cancel-modal{width:100%;padding:11px;background:none;border:1.5px solid var(--border);border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;margin-top:8px;color:var(--mid);font-family:'Poppins',sans-serif}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--dark);color:#fff;padding:12px 22px;border-radius:12px;font-size:13px;font-weight:600;z-index:9998;transition:.35s;opacity:0;max-width:90vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}
@media(max-width:600px){.stat-row{grid-template-columns:1fr 1fr}.part-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="splash">
  <div class="sp-logo">üì£</div>
  <div class="sp-title">OmniService TG</div>
  <div class="sp-sub">Interface Communication</div>
  <div class="sp-bar"><div class="sp-bar-fill"></div></div>
</div>

<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">üì£</div>
    <div class="login-title">Espace Communication</div>
    <div class="login-sub">OmniService TG</div>
    <div class="login-badge">üîë Connexion par code</div>
    <span class="code-lbl">Votre code d'acc√®s</span>
    <input class="code-inp" type="text" id="login-code" placeholder="Cm0001"
      maxlength="10" autocomplete="off" spellcheck="false"
      oninput="this.value=this.value.toUpperCase()"
      onkeydown="if(event.key==='Enter') doLogin()"/>
    <button class="btn-login" onclick="doLogin()" id="btn-login">üöÄ Se connecter</button>
    <div class="login-err" id="login-err"></div>
    <div class="login-hint">Code fourni par votre responsable RH.</div>
  </div>
</div>

<div id="app" style="display:none">
  <div class="top-header">
    <div class="th-left">
      <div class="th-icon">üì£</div>
      <div>
        <div class="th-name" id="top-name">Communication</div>
        <div class="th-role">Gestion Partenaires & Publications ¬∑ OmniService TG</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <span class="th-code" id="top-code">‚Äî</span>
      <button class="btn-logout-top" onclick="doLogout()">‚Ü© D√©connexion</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn on" id="tab-partenaires" onclick="showTab('partenaires')">ü§ù Partenaires</button>
    <button class="tab-btn" id="tab-planning" onclick="showTab('planning')">üìÖ Planning</button>
    <button class="tab-btn" id="tab-preview" onclick="showTab('preview')">üëÅ Aper√ßu live</button>
  </div>

  <div class="main-content">
    <div class="stat-row">
      <div class="stat-mini"><div class="stat-mini-n" id="s-total">‚Äî</div><div class="stat-mini-l">Total</div></div>
      <div class="stat-mini" style="border-color:var(--green)"><div class="stat-mini-n" id="s-actifs" style="color:var(--green)">‚Äî</div><div class="stat-mini-l">Actifs</div></div>
      <div class="stat-mini" style="border-color:var(--red)"><div class="stat-mini-n" id="s-masques" style="color:var(--red)">‚Äî</div><div class="stat-mini-l">Masqu√©s</div></div>
      <div class="stat-mini" style="border-color:var(--ora)"><div class="stat-mini-n" id="s-planifies" style="color:var(--ora)">‚Äî</div><div class="stat-mini-l">Planifi√©s</div></div>
    </div>

    <div id="view-partenaires">
      <div class="section-card">
        <div class="section-head">
          <div class="section-title">ü§ù Bandeaux partenaires</div>
          <button class="btn-add" onclick="openModal()">+ Nouveau partenaire</button>
        </div>
        <div class="part-grid" id="part-grid"><div style="padding:30px;color:var(--light);font-size:13px">Chargement...</div></div>
      </div>
    </div>

    <div id="view-planning" style="display:none">
      <div class="section-card">
        <div class="section-head">
          <div class="section-title">üìÖ Planification des publications</div>
          <button class="btn-add" onclick="openModal()">+ Programmer</button>
        </div>
        <div class="table-wrap">
          <table><thead><tr><th>Partenaire</th><th>D√©but</th><th>Fin</th><th>Statut</th><th>Actions</th></tr></thead>
          <tbody id="planning-tbody"><tr><td colspan="5" style="text-align:center;padding:30px;color:var(--light)">Chargement...</td></tr></tbody></table>
        </div>
      </div>
    </div>

    <div id="view-preview" style="display:none">
      <div class="section-card">
        <div class="section-head">
          <div class="section-title">üëÅ Aper√ßu ‚Äî Bandeau tel qu'il appara√Æt sur l'app</div>
          <button class="btn-add" style="background:var(--blue2)" onclick="loadPreview()">üîÑ Actualiser</button>
        </div>
        <div style="padding:20px">
          <div style="background:var(--bg);border-radius:16px;padding:16px;max-width:400px;margin:0 auto">
            <div style="border-radius:14px;overflow:hidden;margin-bottom:12px" id="live-preview"></div>
            <div id="preview-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PARTENAIRE -->
<div class="modal-overlay" id="modal-part">
  <div class="modal-box">
    <div class="modal-title" id="modal-title-txt">Nouveau partenaire</div>
    <input type="hidden" id="edit-id"/>
    <div style="margin-bottom:12px;padding:12px;background:var(--bg);border-radius:12px">
      <div style="font-size:10px;font-weight:700;color:var(--mid);margin-bottom:6px;text-transform:uppercase">Aper√ßu</div>
      <div class="form-preview-wrap">
        <div style="z-index:1;flex:1"><div id="fp-badge" style="font-size:10px;color:rgba(255,255,255,.8)">ü§ù Badge</div><div id="fp-title" style="font-size:13px;font-weight:700;color:#fff">Nom partenaire</div></div>
      </div>
    </div>
    <div class="form-row"><span class="form-label">Nom *</span><input class="form-inp" id="f-nom" placeholder="Nom du partenaire" oninput="updatePreview()"/></div>
    <div class="form-row"><span class="form-label">Badge (texte du bandeau)</span><input class="form-inp" id="f-badge" placeholder="ü§ù Partenaire officiel" oninput="updatePreview()"/></div>
    <div class="form-row"><span class="form-label">Description</span><input class="form-inp" id="f-desc" placeholder="Courte description"/></div>
    <div class="form-row"><span class="form-label">URL Image</span><input class="form-inp" id="f-img" placeholder="https://..." oninput="updatePreview()"/></div>
    <div class="form-row"><span class="form-label">Lien (optionnel)</span><input class="form-inp" id="f-lien" placeholder="https://..."/></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="form-row"><span class="form-label">Type de promo</span>
        <select class="form-select" id="f-promo"><option value="">‚Äî Aucun ‚Äî</option><option value="partenaire">Partenaire</option><option value="sponsor">Sponsor</option><option value="nouveaute">Nouveaut√©</option><option value="promotion">Promotion</option></select>
      </div>
      <div class="form-row"><span class="form-label">Ordre d'affichage</span><input class="form-inp" id="f-ordre" type="number" value="1" min="1"/></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="form-row"><span class="form-label">Date d√©but</span><input class="form-inp" id="f-debut" type="datetime-local"/></div>
      <div class="form-row"><span class="form-label">Date fin</span><input class="form-inp" id="f-fin" type="datetime-local"/></div>
    </div>
    <div class="form-row"><span class="form-label">Statut</span>
      <select class="form-select" id="f-actif"><option value="true">‚úÖ Actif</option><option value="false">üî¥ Masqu√©</option></select>
    </div>
    <button class="btn-save" id="modal-save-btn" onclick="savePartenaire()">üíæ Enregistrer</button>
    <button class="btn-cancel-modal" onclick="closeModal()">Annuler</button>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, query, getDocs, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const fbApp = initializeApp({apiKey:"AIzaSyDtDK7-iDRy1E-kjZubjyjkPW7Th33BMyU",authDomain:"omniservicetg-59df3.firebaseapp.com",projectId:"omniservicetg-59df3",storageBucket:"omniservicetg-59df3.firebasestorage.app",messagingSenderId:"196278567761",appId:"1:196278567761:web:4f6416acaab58b67bf4970"});
const db = getFirestore(fbApp);
const auth = getAuth(fbApp);
let partenaires = [], agentData = null;

setTimeout(()=>{const s=document.getElementById('splash');s.classList.add('out');setTimeout(()=>s.style.display='none',400);},2500);

// ‚îÄ‚îÄ Auth : uniquement sessions anonymes (comm se connecte par code = anonyme) ‚îÄ‚îÄ
onAuthStateChanged(auth, async user => {
  if (user && user.isAnonymous) {
    try {
      const snap = await getDoc(doc(db,'agents',user.uid));
      if (snap.exists() && ['comm','admin'].includes(snap.data().role) && snap.data().actif!==false) {
        agentData = {uid:user.uid,...snap.data()};
        document.getElementById('top-name').textContent = snap.data().prenom||snap.data().nom||'Communication';
        document.getElementById('top-code').textContent = snap.data().code||'‚Äî';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        loadPartenaires();
      } else { await signOut(auth); showLogin('‚ùå Acc√®s non autoris√©'); }
    } catch(e) { showLogin(); }
  } else if (!user) { showLogin(); }
});

function showLogin(err='') {
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('app').style.display='none';
  if(err) document.getElementById('login-err').textContent=err;
}

window.doLogin = async function() {
  const code = document.getElementById('login-code').value.trim().toUpperCase();
  const errEl = document.getElementById('login-err');
  const btn = document.getElementById('btn-login');
  if (!code) { errEl.textContent='‚ö†Ô∏è Saisissez votre code'; return; }
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> V√©rification...';
  errEl.textContent='';
  try {
    const loginSnap = await getDoc(doc(db,'agents_login',code));
    if (!loginSnap.exists()) { errEl.textContent='‚ùå Code inconnu. Contactez votre RH.'; return; }
    const ld = loginSnap.data();
    if (!['comm','admin'].includes(ld.role)) { errEl.textContent='‚ùå Ce code n\'est pas un code Communication.'; return; }
    if (ld.actif===false) { errEl.textContent='‚õî Compte d√©sactiv√©.'; return; }
    btn.innerHTML='<span class="spinner"></span> Connexion...';
    const cred = await signInAnonymously(auth);
    const aUid = cred.user.uid;
    const profSnap = await getDoc(doc(db,'agents',ld.agentUid));
    const profData = profSnap.exists()?profSnap.data():{code,role:ld.role,actif:true};
    const {getFirestore:_,collection:__,...rest}={};
    const {doc:d2,setDoc} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
    const {setDoc:sd} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
    await sd(d2(db,'agents',aUid),{...profData,uid:aUid,codeRef:ld.agentUid,derniere_connexion:serverTimestamp()});
  } catch(e) { console.error(e); errEl.textContent='‚ùå Erreur r√©seau. R√©essayez.'; }
  finally { btn.disabled=false; btn.textContent='üöÄ Se connecter'; }
};

window.doLogout = async () => { agentData=null; await signOut(auth); };

window.showTab = function(tab) {
  ['partenaires','planning','preview'].forEach(t=>{
    document.getElementById('view-'+t).style.display=t===tab?'block':'none';
    document.getElementById('tab-'+t).classList.toggle('on',t===tab);
  });
  if(tab==='preview') loadPreview();
  if(tab==='planning') renderPlanning();
};

async function loadPartenaires() {
  try {
    const snap = await getDocs(query(collection(db,'partenaires'),orderBy('ordre','asc')));
    partenaires = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderPartenaires(); renderStats();
  } catch(e) { toast('‚ùå Erreur chargement'); }
}

function renderStats() {
  document.getElementById('s-total').textContent = partenaires.length;
  document.getElementById('s-actifs').textContent = partenaires.filter(p=>p.actif!==false).length;
  document.getElementById('s-masques').textContent = partenaires.filter(p=>p.actif===false).length;
  document.getElementById('s-planifies').textContent = partenaires.filter(p=>p.dateDebut||p.dateFin).length;
}

function renderPartenaires() {
  const grid = document.getElementById('part-grid');
  if(!partenaires.length){grid.innerHTML='<div style="padding:40px;text-align:center;color:var(--light)">Aucun partenaire. Cliquez sur "+ Nouveau partenaire"</div>';return;}
  grid.innerHTML = partenaires.map(p=>{
    const isActif=p.actif!==false;
    const imgHtml=p.imageUrl?`<img src="${p.imageUrl}" alt="${p.nom||''}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"/>`:'';
    return `<div class="part-card">
      <div class="part-preview">${imgHtml}<div class="part-preview-badge">${p.badge||'ü§ù '+p.nom}</div><div class="part-preview-status ${isActif?'ps-actif':'ps-inactif'}">${isActif?'‚úÖ Actif':'üî¥ Masqu√©'}</div></div>
      <div class="part-body"><div class="part-name">${p.nom||'‚Äî'}</div><div class="part-desc">${p.description||p.promo||'Aucune description'}</div>
      <div class="part-actions">
        <button class="btn-edit" onclick="editPartenaire('${p.id}')">‚úèÔ∏è Modifier</button>
        <button class="${isActif?'btn-masquer':'btn-activer'}" onclick="toggleActif('${p.id}',${isActif})">${isActif?'üëÅ Masquer':'üëÅ Activer'}</button>
        <button class="btn-del" onclick="deletePartenaire('${p.id}')">üóë</button>
      </div></div></div>`;
  }).join('');
}

function renderPlanning(){
  const tbody=document.getElementById('planning-tbody');
  const withDates=partenaires.filter(p=>p.dateDebut||p.dateFin);
  if(!withDates.length){tbody.innerHTML='<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--light)">Aucune publication planifi√©e</td></tr>';return;}
  const now=new Date();
  tbody.innerHTML=withDates.map(p=>{
    const debut=p.dateDebut?new Date(p.dateDebut.seconds*1000):null;
    const fin=p.dateFin?new Date(p.dateFin.seconds*1000):null;
    let statut,sc;
    if(fin&&fin<now){statut='Expir√©';sc='p-expire';}
    else if(debut&&debut>now){statut='Planifi√©';sc='p-planifie';}
    else if(p.actif===false){statut='Masqu√©';sc='p-masque';}
    else{statut='Actif';sc='p-actif';}
    const fd=d=>d?d.toLocaleDateString('fr-FR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}):'‚Äî';
    return `<tr><td><strong>${p.nom||'‚Äî'}</strong></td><td>${fd(debut)}</td><td>${fd(fin)}</td><td><span class="pill ${sc}">${statut}</span></td><td><button class="btn-edit" onclick="editPartenaire('${p.id}')">‚úèÔ∏è</button></td></tr>`;
  }).join('');
}

window.loadPreview = function(){
  const actifs=partenaires.filter(p=>p.actif!==false);
  const preview=document.getElementById('live-preview');
  const list=document.getElementById('preview-list');
  if(!actifs.length){preview.innerHTML='<div style="padding:20px;text-align:center;color:var(--light);font-size:12px">Aucun bandeau actif</div>';list.innerHTML='';return;}
  const p=actifs[0];
  preview.innerHTML=`<div style="background:linear-gradient(135deg,#0D2137,#1565C0);height:80px;position:relative;display:flex;align-items:flex-end;padding:8px 12px">${p.imageUrl?`<img src="${p.imageUrl}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">`:''}
    <div style="z-index:1;flex:1"><div style="font-size:10px;color:rgba(255,255,255,.7)">${p.badge||'ü§ù Partenaire'}</div><div style="font-size:13px;font-weight:700;color:#fff">${p.nom||'Partenaire'}</div></div>
    <div style="font-size:9px;color:rgba(255,255,255,.5)">1/${actifs.length}</div></div>
    <div style="padding:8px 12px;font-size:11px;color:var(--mid)">${p.description||''}</div>`;
  list.innerHTML=actifs.map((p,i)=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><div style="width:24px;height:24px;border-radius:6px;background:var(--blue-s);display:flex;align-items:center;justify-content:center;font-size:12px">ü§ù</div><div style="flex:1;font-size:12px;font-weight:600">${p.nom}</div><div style="font-size:10px;color:var(--light)">Position ${p.ordre||i+1}</div></div>`).join('');
};

window.openModal = function(){
  document.getElementById('edit-id').value='';
  document.getElementById('modal-title-txt').textContent='‚ûï Nouveau partenaire';
  ['f-nom','f-badge','f-desc','f-img','f-lien','f-debut','f-fin'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-promo').value='';
  document.getElementById('f-ordre').value=partenaires.length+1;
  document.getElementById('f-actif').value='true';
  updatePreview();
  document.getElementById('modal-part').classList.add('show');
};
window.editPartenaire = function(id){
  const p=partenaires.find(x=>x.id===id);if(!p)return;
  document.getElementById('edit-id').value=id;
  document.getElementById('modal-title-txt').textContent='‚úèÔ∏è Modifier ‚Äî '+p.nom;
  document.getElementById('f-nom').value=p.nom||'';
  document.getElementById('f-badge').value=p.badge||'';
  document.getElementById('f-desc').value=p.description||'';
  document.getElementById('f-img').value=p.imageUrl||'';
  document.getElementById('f-lien').value=p.lien||'';
  document.getElementById('f-promo').value=p.promo||'';
  document.getElementById('f-ordre').value=p.ordre||1;
  document.getElementById('f-actif').value=p.actif===false?'false':'true';
  if(p.dateDebut)document.getElementById('f-debut').value=new Date(p.dateDebut.seconds*1000).toISOString().slice(0,16);
  if(p.dateFin)document.getElementById('f-fin').value=new Date(p.dateFin.seconds*1000).toISOString().slice(0,16);
  updatePreview();
  document.getElementById('modal-part').classList.add('show');
};
window.closeModal = ()=>document.getElementById('modal-part').classList.remove('show');
window.updatePreview = function(){
  const nom=document.getElementById('f-nom').value||'Nom partenaire';
  const badge=document.getElementById('f-badge').value||'ü§ù '+nom;
  const img=document.getElementById('f-img').value;
  document.getElementById('fp-badge').textContent=badge;
  document.getElementById('fp-title').textContent=nom;
  const prev=document.getElementById('form-preview');
  if(prev&&img){let imgEl=prev.querySelector('img');if(!imgEl){imgEl=document.createElement('img');imgEl.style.cssText='position:absolute;inset:0;width:100%;height:100%;object-fit:cover';prev.prepend(imgEl);}imgEl.src=img;}
};

window.savePartenaire = async function(){
  const nom=document.getElementById('f-nom').value.trim();
  if(!nom){toast('‚ö†Ô∏è Le nom est obligatoire');return;}
  const btn=document.getElementById('modal-save-btn');
  btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Enregistrement...';
  const data={nom,badge:document.getElementById('f-badge').value.trim()||null,description:document.getElementById('f-desc').value.trim()||null,imageUrl:document.getElementById('f-img').value.trim()||null,lien:document.getElementById('f-lien').value.trim()||null,promo:document.getElementById('f-promo').value||null,ordre:parseInt(document.getElementById('f-ordre').value)||1,actif:document.getElementById('f-actif').value==='true',updatedAt:serverTimestamp()};
  const dv=document.getElementById('f-debut').value;const fv=document.getElementById('f-fin').value;
  if(dv)data.dateDebut=new Date(dv);if(fv)data.dateFin=new Date(fv);
  const editId=document.getElementById('edit-id').value;
  try{
    if(editId){await updateDoc(doc(db,'partenaires',editId),data);toast('‚úÖ Partenaire mis √† jour !');}
    else{data.createdAt=serverTimestamp();await addDoc(collection(db,'partenaires'),data);toast('‚úÖ Partenaire cr√©√© !');}
    closeModal();loadPartenaires();
  }catch(e){toast('‚ùå Erreur : '+e.message);}
  finally{btn.disabled=false;btn.textContent='üíæ Enregistrer';}
};

window.toggleActif = async function(id,isActif){
  try{await updateDoc(doc(db,'partenaires',id),{actif:!isActif,updatedAt:serverTimestamp()});toast(isActif?'üëÅ Masqu√©':'‚úÖ Activ√© !');loadPartenaires();}catch(e){toast('‚ùå Erreur');}
};
window.deletePartenaire = async function(id){
  const p=partenaires.find(x=>x.id===id);
  if(!confirm(`Supprimer "${p?.nom||id}" ?`))return;
  try{await deleteDoc(doc(db,'partenaires',id));toast('üóë Supprim√©');loadPartenaires();}catch(e){toast('‚ùå Erreur');}
};
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);}
document.getElementById('modal-part').addEventListener('click',e=>{if(e.target===document.getElementById('modal-part'))closeModal();});
</script>
</body>
</html>
